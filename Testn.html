<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me √âducatif - Admin & Exercice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-height: 90vh;
        }
        .navbar-custom {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        .timer-display {
            font-size: 3em;
            font-weight: bold;
            color: #7c3aed;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }
        .question-box {
            background: #f8fafc;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #4f46e5;
            margin: 20px 0;
        }
        .answer-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .answer-option:hover {
            background: #f1f5f9;
            border-color: #c7d2fe;
        }
        .answer-option.selected {
            background: #c7d2fe;
            border-color: #4f46e5;
            font-weight: bold;
        }
        .answer-option.correct {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }
        .answer-option.wrong {
            background: #fee2e2;
            border-color: #ef4444;
            color: #7f1d1d;
        }
        .result-item {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .result-item.correct {
            background: #d1fae5;
            border-left: 5px solid #10b981;
        }
        .result-item.wrong {
            background: #fee2e2;
            border-left: 5px solid #ef4444;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin: 10px;
        }
        .stat-card.success {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }
        .stat-card.danger {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
        }
        .stat-card.info {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .admin-badge {
            background: #7c3aed;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .student-badge {
            background: #10b981;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .tab-content {
            padding: 20px;
            background: #f8fafc;
            border-radius: 15px;
            margin-top: 20px;
        }
        .nav-tabs {
            border-bottom: 3px solid #e2e8f0;
        }
        .nav-tabs .nav-link {
            border: none;
            color: #64748b;
            font-weight: 600;
            padding: 15px 30px;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }
        .nav-tabs .nav-link.active {
            background: #4f46e5;
            color: white;
            border: none;
        }
        .question-preview {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #e2e8f0;
        }
        .highlight {
            background: #fef3c7;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Application Container -->
    <div class="container main-container" id="app-container">
        <!-- Login Screen (initial) -->
        <div id="login-screen" class="login-container">
            <h2 class="text-center mb-4" style="color: #4f46e5;">üìö Syst√®me √âducatif</h2>
            <h4 class="text-center mb-4">Connexion</h4>
            
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" id="login-email" class="form-control" placeholder="admin@match.com" value="admin@match.com">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Mot de passe</label>
                <input type="password" id="login-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="admin123">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Mode</label>
                <select id="login-mode" class="form-select">
                    <option value="admin">Administrateur</option>
                    <option value="student">√âl√®ve (Credo Singa)</option>
                </select>
            </div>
            
            <button onclick="login()" class="btn btn-primary w-100">Se connecter</button>
            
            <div class="mt-3 text-center">
                <small class="text-muted">
                    Admin: admin@match.com / admin123<br>
                    √âtudiant: credo@match.com / credo123
                </small>
            </div>
        </div>

        <!-- Main Application (hidden initially) -->
        <div id="main-app" style="display: none;">
            <!-- Navigation -->
            <nav class="navbar navbar-expand-lg navbar-custom">
                <div class="container-fluid">
                    <span class="navbar-brand">
                        üìò Syst√®me √âducatif
                        <span id="user-badge" class="admin-badge">Admin</span>
                    </span>
                    <div class="d-flex">
                        <span id="current-user" class="text-white me-3"></span>
                        <button onclick="logout()" class="btn btn-light">D√©connexion</button>
                    </div>
                </div>
            </nav>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" id="mainTabs">
                <li class="nav-item">
                    <button class="nav-link active" onclick="showTab('admin')">Admin Panel</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showTab('exercise')">Exercice Fran√ßais</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showTab('results')">R√©sultats</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="showTab('create')">Cr√©er Exercice</button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- ADMIN PANEL TAB -->
                <div id="admin-tab">
                    <h3 class="mb-4">üìä Tableau de Bord Administrateur</h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stat-card success">
                                <h5>Exercices Complets</h5>
                                <h2 id="completed-exercises">0</h2>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card danger">
                                <h5>Taux de R√©ussite</h5>
                                <h2 id="success-rate">0%</h2>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card info">
                                <h5>Temps Moyen</h5>
                                <h2 id="avg-time">0s</h2>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Gestion des Utilisateurs</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Ajouter un √©tudiant</label>
                                        <input type="email" id="new-student-email" class="form-control mb-2" placeholder="email@exemple.com">
                                        <input type="password" id="new-student-password" class="form-control mb-2" placeholder="Mot de passe">
                                        <button onclick="addStudent()" class="btn btn-primary">Ajouter √âtudiant</button>
                                    </div>
                                    <div id="students-list"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Exercices Cr√©√©s</h5>
                                </div>
                                <div class="card-body">
                                    <div id="exercises-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EXERCICE TAB -->
                <div id="exercise-tab" style="display: none;">
                    <h3 class="mb-4">üìù Exercice de Fran√ßais - Credo Singa</h3>
                    <div class="alert alert-info">
                        <strong>Consigne :</strong> Pour chaque phrase, coche la bonne r√©ponse parmi les propositions. 
                        Tu as <span class="highlight">15 secondes par question</span>. 
                        Aucune aide ext√©rieure n'est autoris√©e.
                    </div>

                    <div class="timer-display" id="timer">
                        15
                    </div>

                    <div id="exercise-container">
                        <!-- Questions will be loaded here -->
                    </div>

                    <div class="text-center mt-4">
                        <button id="submit-exercise" onclick="submitExercise()" class="btn btn-primary btn-lg" disabled>
                            Soumettre les r√©ponses
                        </button>
                        <button id="start-exercise" onclick="startExercise()" class="btn btn-success btn-lg">
                            D√©marrer l'exercice
                        </button>
                    </div>
                </div>

                <!-- RESULTS TAB -->
                <div id="results-tab" style="display: none;">
                    <h3 class="mb-4">üìà R√©sultats de Credo Singa</h3>
                    
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Statistiques Globales</h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="global-stats"></div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">D√©tail des Exercices</h5>
                        </div>
                        <div class="card-body">
                            <div id="results-detail"></div>
                        </div>
                    </div>
                </div>

                <!-- CREATE EXERCISE TAB -->
                <div id="create-tab" style="display: none;">
                    <h3 class="mb-4">‚úèÔ∏è Cr√©er un Nouvel Exercice</h3>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Titre de l'exercice</label>
                                <input type="text" id="exercise-title" class="form-control" placeholder="Ex: Participe pass√© - Niveau 1">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Th√®me</label>
                                <input type="text" id="exercise-theme" class="form-control" placeholder="Ex: Conjugaison des verbes">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Temps par question (secondes)</label>
                                <input type="number" id="exercise-time" class="form-control" value="15" min="5" max="60">
                            </div>

                            <div id="questions-container">
                                <!-- Questions will be added here -->
                            </div>

                            <div class="text-center mt-4">
                                <button onclick="addQuestion()" class="btn btn-primary me-2">
                                    + Ajouter une question
                                </button>
                                <button onclick="saveExercise()" class="btn btn-success">
                                    üíæ Sauvegarder l'exercice
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">Aper√ßu de l'exercice</h5>
                        </div>
                        <div class="card-body">
                            <div id="exercise-preview"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAUYpCBlPUnnsCyvqrfMmY5uacjHLGVRh0",
            authDomain: "match-a2ac6.firebaseapp.com",
            projectId: "match-a2ac6",
            storageBucket: "match-a2ac6.firebasestorage.app",
            messagingSenderId: "376894292796",
            appId: "1:376894292796:web:1eb138830c92aae8df5439",
            measurementId: "G-2RSRSSFCDZ"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let userMode = 'admin';
        let currentExercise = null;
        let timer = null;
        let timeLeft = 15;
        let currentQuestionIndex = 0;
        let answers = {};
        let exerciseStarted = false;

        // ==================== DEFAULT EXERCISE DATA ====================
        const defaultExercise = {
            title: "Devoir de Fran√ßais - Participe pass√©",
            theme: "Le participe pass√© et les terminaisons verbales",
            timePerQuestion: 15,
            questions: [
                {
                    id: 1,
                    question: "Il a ______ son sac sur la table.",
                    options: ["pos√©", "poser", "posait", "posera"],
                    correctAnswer: 0,
                    explanation: "Avec l'auxiliaire 'avoir', le participe pass√© ne s'accorde pas avec le sujet."
                },
                {
                    id: 2,
                    question: "Les lettres qu'elle a ______ √©taient tr√®s touchantes.",
                    options: ["√©crire", "√©crites", "√©crite", "√©crivait"],
                    correctAnswer: 1,
                    explanation: "Accord avec 'lettres' (f√©minin pluriel) plac√© avant le participe pass√©."
                },
                {
                    id: 3,
                    question: "Nous avons ______ toute la journ√©e.",
                    options: ["marcher", "march√©", "marchait", "marchera"],
                    correctAnswer: 1,
                    explanation: "Participe pass√© avec 'avoir' - pas d'accord avec le sujet."
                },
                {
                    id: 4,
                    question: "La chanson que j'ai ______ hier √©tait magnifique.",
                    options: ["√©couter", "√©cout√©e", "√©cout√©", "√©coutait"],
                    correctAnswer: 1,
                    explanation: "Accord avec 'chanson' (f√©minin singulier) plac√© avant."
                },
                {
                    id: 5,
                    question: "Les enfants ont ______ trop tard.",
                    options: ["arriver", "arriv√©s", "arriv√©", "arrivaient"],
                    correctAnswer: 1,
                    explanation: "Accord avec 'enfants' (masculin pluriel) plac√© avant."
                }
            ]
        };

        // ==================== AUTHENTICATION ====================
        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const mode = document.getElementById('login-mode').value;
            
            userMode = mode;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    showMainApp();
                    initializeApp();
                })
                .catch((error) => {
                    alert("Erreur de connexion: " + error.message);
                });
        }

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('main-app').style.display = 'none';
            });
        }

        // ==================== UI FUNCTIONS ====================
        function showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const userBadge = document.getElementById('user-badge');
            if (userMode === 'admin') {
                userBadge.className = 'admin-badge';
                userBadge.textContent = 'Admin';
            } else {
                userBadge.className = 'student-badge';
                userBadge.textContent = '√âl√®ve';
            }
            
            document.getElementById('current-user').textContent = currentUser.email;
            showTab('admin');
        }

        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('admin-tab').style.display = 'none';
            document.getElementById('exercise-tab').style.display = 'none';
            document.getElementById('results-tab').style.display = 'none';
            document.getElementById('create-tab').style.display = 'none';
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Update active tab button
            const tabButtons = document.querySelectorAll('.nav-link');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Load content based on tab
            switch(tabName) {
                case 'admin':
                    loadAdminDashboard();
                    break;
                case 'exercise':
                    if (userMode === 'student') {
                        loadExercise();
                    }
                    break;
                case 'results':
                    loadResults();
                    break;
                case 'create':
                    if (userMode === 'admin') {
                        loadCreateExercise();
                    }
                    break;
            }
        }

        // ==================== ADMIN DASHBOARD ====================
        function loadAdminDashboard() {
            // Load statistics
            db.collection('results').get().then(snapshot => {
                let totalExercises = 0;
                let totalCorrect = 0;
                let totalQuestions = 0;
                let totalTime = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalExercises++;
                    totalCorrect += data.correctAnswers || 0;
                    totalQuestions += data.totalQuestions || 0;
                    totalTime += data.totalTime || 0;
                });
                
                const successRate = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
                const avgTime = totalExercises > 0 ? Math.round(totalTime / totalExercises) : 0;
                
                document.getElementById('completed-exercises').textContent = totalExercises;
                document.getElementById('success-rate').textContent = successRate + '%';
                document.getElementById('avg-time').textContent = avgTime + 's';
                
                // Load students
                loadStudentsList();
                // Load exercises
                loadExercisesList();
            });
        }

        function loadStudentsList() {
            db.collection('users').where('role', '==', 'student').get().then(snapshot => {
                let html = '<h6>√âtudiants inscrits:</h6>';
                snapshot.forEach(doc => {
                    const student = doc.data();
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                            <span>${student.email}</span>
                            <button onclick="deleteUser('${doc.id}')" class="btn btn-sm btn-danger">Supprimer</button>
                        </div>
                    `;
                });
                document.getElementById('students-list').innerHTML = html;
            });
        }

        function loadExercisesList() {
            db.collection('exercises').get().then(snapshot => {
                let html = '<div class="list-group">';
                snapshot.forEach(doc => {
                    const exercise = doc.data();
                    html += `
                        <div class="list-group-item">
                            <h6>${exercise.title}</h6>
                            <small class="text-muted">${exercise.theme} ‚Ä¢ ${exercise.questions?.length || 0} questions</small>
                            <div class="mt-2">
                                <button onclick="deleteExercise('${doc.id}')" class="btn btn-sm btn-danger">Supprimer</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('exercises-list').innerHTML = html;
            });
        }

        function addStudent() {
            const email = document.getElementById('new-student-email').value;
            const password = document.getElementById('new-student-password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    return db.collection('users').doc(userCredential.user.uid).set({
                        email: email,
                        role: 'student',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    alert('√âtudiant ajout√© avec succ√®s!');
                    loadStudentsList();
                    document.getElementById('new-student-email').value = '';
                    document.getElementById('new-student-password').value = '';
                })
                .catch(error => alert('Erreur: ' + error.message));
        }

        // ==================== EXERCICE FUNCTIONS ====================
        function loadExercise() {
            // Load default exercise for demo
            currentExercise = defaultExercise;
            timeLeft = currentExercise.timePerQuestion;
            
            let html = '<h4 class="mb-4">' + currentExercise.title + '</h4>';
            html += '<div class="alert alert-info mb-4">' + currentExercise.theme + '</div>';
            
            currentExercise.questions.forEach((q, index) => {
                html += `
                    <div class="question-box" id="question-${q.id}">
                        <h5>Question ${index + 1}:</h5>
                        <p class="lead">${q.question}</p>
                        <div id="options-${q.id}">
                `;
                
                q.options.forEach((option, optIndex) => {
                    html += `
                        <div class="answer-option" 
                             onclick="selectAnswer(${q.id}, ${optIndex})"
                             id="option-${q.id}-${optIndex}">
                            ‚òê ${option}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div class="mt-3" id="explanation-${q.id}" style="display: none;">
                            <div class="alert alert-success">
                                <strong>Explication:</strong> ${q.explanation}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('exercise-container').innerHTML = html;
            document.getElementById('submit-exercise').disabled = true;
            document.getElementById('start-exercise').style.display = 'block';
        }

        function startExercise() {
            exerciseStarted = true;
            currentQuestionIndex = 0;
            answers = {};
            document.getElementById('start-exercise').style.display = 'none';
            document.getElementById('submit-exercise').disabled = false;
            startTimer();
            showQuestion(0);
        }

        function showQuestion(index) {
            // Hide all questions
            currentExercise.questions.forEach(q => {
                document.getElementById(`question-${q.id}`).style.display = 'none';
            });
            
            // Show current question
            const currentQ = currentExercise.questions[index];
            document.getElementById(`question-${currentQ.id}`).style.display = 'block';
            
            // Reset timer
            timeLeft = currentExercise.timePerQuestion;
            document.getElementById('timer').textContent = timeLeft;
        }

        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    nextQuestion();
                }
            }, 1000);
        }

        function selectAnswer(questionId, optionIndex) {
            answers[questionId] = optionIndex;
            
            // Update UI
            const question = currentExercise.questions.find(q => q.id === questionId);
            question.options.forEach((_, index) => {
                const optionElement = document.getElementById(`option-${questionId}-${index}`);
                optionElement.classList.remove('selected');
                if (index === optionIndex) {
                    optionElement.classList.add('selected');
                }
            });
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentExercise.questions.length) {
                showQuestion(currentQuestionIndex);
                timeLeft = currentExercise.timePerQuestion;
            } else {
                clearInterval(timer);
                submitExercise();
            }
        }

        function submitExercise() {
            clearInterval(timer);
            exerciseStarted = false;
            
            // Calculate results
            let correctAnswers = 0;
            const results = [];
            
            currentExercise.questions.forEach(q => {
                const userAnswer = answers[q.id];
                const isCorrect = userAnswer === q.correctAnswer;
                if (isCorrect) correctAnswers++;
                
                results.push({
                    questionId: q.id,
                    question: q.question,
                    userAnswer: q.options[userAnswer],
                    correctAnswer: q.options[q.correctAnswer],
                    isCorrect: isCorrect,
                    explanation: q.explanation
                });
                
                // Show explanations
                document.getElementById(`explanation-${q.id}`).style.display = 'block';
                
                // Mark answers
                q.options.forEach((_, index) => {
                    const optionElement = document.getElementById(`option-${q.id}-${index}`);
                    optionElement.classList.remove('selected');
                    if (index === q.correctAnswer) {
                        optionElement.classList.add('correct');
                    } else if (index === userAnswer && !isCorrect) {
                        optionElement.classList.add('wrong');
                    }
                    optionElement.style.cursor = 'default';
                    optionElement.onclick = null;
                });
            });
            
            // Save results to Firebase
            const resultData = {
                studentId: currentUser.uid,
                studentEmail: currentUser.email,
                exerciseId: 'default-exercise',
                exerciseTitle: currentExercise.title,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                correctAnswers: correctAnswers,
                totalQuestions: currentExercise.questions.length,
                score: Math.round((correctAnswers / currentExercise.questions.length) * 100),
                totalTime: (currentExercise.timePerQuestion * currentExercise.questions.length) - timeLeft,
                details: results
            };
            
            db.collection('results').add(resultData)
                .then(() => {
                    alert(`Exercice termin√©! Score: ${resultData.score}% (${correctAnswers}/${currentExercise.questions.length} correctes)`);
                    showTab('results');
                    loadResults();
                });
            
            document.getElementById('submit-exercise').disabled = true;
        }

        // ==================== RESULTS FUNCTIONS ====================
        function loadResults() {
            const userId = userMode === 'admin' ? null : currentUser.uid;
            let query = db.collection('results').orderBy('date', 'desc');
            
            if (userId) {
                query = query.where('studentId', '==', userId);
            }
            
            query.get().then(snapshot => {
                let globalStatsHtml = '';
                let detailHtml = '';
                let totalExercises = 0;
                let totalScore = 0;
                let totalTime = 0;
                
                snapshot.forEach(doc => {
                    const result = doc.data();
                    totalExercises++;
                    totalScore += result.score;
                    totalTime += result.totalTime;
                    
                    const date = result.date?.toDate?.() || new Date();
                    const formattedDate = date.toLocaleDateString('fr-FR');
                    
                    globalStatsHtml += `
                        <div class="col-md-4">
                            <div class="stat-card ${result.score >= 70 ? 'success' : 'danger'}">
                                <h6>${result.exerciseTitle}</h6>
                                <h3>${result.score}%</h3>
                                <small>${formattedDate}</small>
                            </div>
                        </div>
                    `;
                    
                    detailHtml += `
                        <div class="card mb-3">
                            <div class="card-header ${result.score >= 70 ? 'bg-success' : 'bg-danger'} text-white">
                                <h6 class="mb-0">${result.exerciseTitle} - ${formattedDate}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Score:</strong> ${result.score}%
                                    </div>
                                    <div class="col-md-3">
                                        <strong>R√©ponses:</strong> ${result.correctAnswers}/${result.totalQuestions}
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Temps:</strong> ${result.totalTime}s
                                    </div>
                                    <div class="col-md-3">
                                        <button onclick="viewResultDetails('${doc.id}')" class="btn btn-sm btn-info">
                                            Voir d√©tails
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                const avgScore = totalExercises > 0 ? Math.round(totalScore / totalExercises) : 0;
                const avgTime = totalExercises > 0 ? Math.round(totalTime / totalExercises) : 0;
                
                document.getElementById('global-stats').innerHTML = globalStatsHtml;
                document.getElementById('results-detail').innerHTML = detailHtml;
            });
        }

        function viewResultDetails(resultId) {
            db.collection('results').doc(resultId).get().then(doc => {
                if (doc.exists) {
                    const result = doc.data();
                    let detailHtml = '<h5>D√©tail des r√©ponses:</h5>';
                    
                    result.details.forEach((detail, index) => {
                        detailHtml += `
                            <div class="result-item ${detail.isCorrect ? 'correct' : 'wrong'}">
                                <h6>Question ${index + 1}:</h6>
                                <p><strong>${detail.question}</strong></p>
                                <p><strong>Ta r√©ponse:</strong> ${detail.userAnswer || 'Non r√©pondue'}</p>
                                <p><strong>R√©ponse correcte:</strong> ${detail.correctAnswer}</p>
                                <p><strong>Explication:</strong> ${detail.explanation}</p>
                            </div>
                        `;
                    });
                    
                    document.getElementById('results-detail').innerHTML = detailHtml;
                }
            });
        }

        // ==================== CREATE EXERCISE FUNCTIONS ====================
        function loadCreateExercise() {
            document.getElementById('questions-container').innerHTML = '';
            document.getElementById('exercise-preview').innerHTML = '';
            
            // Add first question by default
            addQuestion();
        }

        function addQuestion() {
            const questionsContainer = document.getElementById('questions-container');
            const questionCount = questionsContainer.children.length + 1;
            
            const questionHtml = `
                <div class="question-preview mb-4" id="question-${questionCount}">
                    <h5>Question ${questionCount}</h5>
                    <div class="mb-3">
                        <label class="form-label">Phrase/Question</label>
                        <input type="text" class="form-control question-text" 
                               placeholder="Entrez la phrase avec le trou (______)">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Option 1 (correcte)</label>
                            <input type="text" class="form-control option" placeholder="R√©ponse correcte">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Option 2</label>
                            <input type="text" class="form-control option" placeholder="Autre option">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Option 3</label>
                            <input type="text" class="form-control option" placeholder="Autre option">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Option 4</label>
                            <input type="text" class="form-control option" placeholder="Autre option">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="form-label">Explication</label>
                        <textarea class="form-control explanation" rows="2" 
                                  placeholder="Explication de la r√®gle de grammaire"></textarea>
                    </div>
                    <button onclick="removeQuestion(${questionCount})" class="btn btn-sm btn-danger mt-2">
                        Supprimer cette question
                    </button>
                </div>
            `;
            
            questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
            updateExercisePreview();
        }

        function removeQuestion(questionNumber) {
            const questionElement = document.getElementById(`question-${questionNumber}`);
            if (questionElement) {
                questionElement.remove();
                updateExercisePreview();
            }
        }

        function updateExercisePreview() {
            const title = document.getElementById('exercise-title').value || 'Nouvel exercice';
            const theme = document.getElementById('exercise-theme').value || 'Grammaire fran√ßaise';
            
            let previewHtml = `
                <h4>${title}</h4>
                <p><strong>Th√®me:</strong> ${theme}</p>
                <hr>
            `;
            
            const questions = document.querySelectorAll('.question-preview');
            questions.forEach((question, index) => {
                const questionText = question.querySelector('.question-text').value || `Question ${index + 1}`;
                const options = Array.from(question.querySelectorAll('.option')).map(input => input.value).filter(val => val);
                const explanation = question.querySelector('.explanation').value || '';
                
                previewHtml += `
                    <div class="mb-3">
                        <h6>Question ${index + 1}: ${questionText}</h6>
                        <ul>
                            ${options.map(opt => `<li>${opt}</li>`).join('')}
                        </ul>
                        ${explanation ? `<small><strong>Explication:</strong> ${explanation}</small>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('exercise-preview').innerHTML = previewHtml;
        }

        function saveExercise() {
            const title = document.getElementById('exercise-title').value;
            const theme = document.getElementById('exercise-theme').value;
            const timePerQuestion = parseInt(document.getElementById('exercise-time').value) || 15;
            
            if (!title || !theme) {
                alert('Veuillez remplir le titre et le th√®me de l\'exercice');
                return;
            }
            
            const questions = [];
            const questionElements = document.querySelectorAll('.question-preview');
            
            questionElements.forEach((element, index) => {
                const questionText = element.querySelector('.question-text').value;
                const options = Array.from(element.querySelectorAll('.option')).map(input => input.value);
                const explanation = element.querySelector('.explanation').value;
                
                if (questionText && options.filter(opt => opt).length >= 2) {
                    questions.push({
                        id: index + 1,
                        question: questionText,
                        options: options,
                        correctAnswer: 0, // First option is correct
                        explanation: explanation
                    });
                }
            });
            
            if (questions.length === 0) {
                alert('Veuillez ajouter au moins une question valide');
                return;
            }
            
            const exerciseData = {
                title: title,
                theme: theme,
                timePerQuestion: timePerQuestion,
                questions: questions,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.email
            };
            
            db.collection('exercises').add(exerciseData)
                .then(() => {
                    alert('Exercice sauvegard√© avec succ√®s!');
                    document.getElementById('exercise-title').value = '';
                    document.getElementById('exercise-theme').value = '';
                    document.getElementById('questions-container').innerHTML = '';
                    document.getElementById('exercise-preview').innerHTML = '';
                    loadExercisesList();
                    addQuestion();
                })
                .catch(error => alert('Erreur: ' + error.message));
        }

        // ==================== UTILITY FUNCTIONS ====================
        function deleteUser(userId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur?')) {
                db.collection('users').doc(userId).delete()
                    .then(() => {
                        alert('Utilisateur supprim√©');
                        loadStudentsList();
                    })
                    .catch(error => alert('Erreur: ' + error.message));
            }
        }

        function deleteExercise(exerciseId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet exercice?')) {
                db.collection('exercises').doc(exerciseId).delete()
                    .then(() => {
                        alert('Exercice supprim√©');
                        loadExercisesList();
                    })
                    .catch(error => alert('Erreur: ' + error.message));
            }
        }

        function initializeApp() {
            // Check if default users exist, create them if not
            const adminEmail = 'admin@match.com';
            const adminPassword = 'admin123';
            const studentEmail = 'credo@match.com';
            const studentPassword = 'credo123';
            
            // Try to sign in as admin to check if exists
            auth.signInWithEmailAndPassword(adminEmail, adminPassword)
                .catch(() => {
                    // Create admin user if doesn't exist
                    auth.createUserWithEmailAndPassword(adminEmail, adminPassword)
                        .then(userCredential => {
                            return db.collection('users').doc(userCredential.user.uid).set({
                                email: adminEmail,
                                role: 'admin',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        })
                        .then(() => {
                            // Create student user
                            return auth.createUserWithEmailAndPassword(studentEmail, studentPassword);
                        })
                        .then(userCredential => {
                            return db.collection('users').doc(userCredential.user.uid).set({
                                email: studentEmail,
                                role: 'student',
                                name: 'Credo Singa',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        })
                        .then(() => {
                            console.log('Default users created');
                            // Sign back in as original user
                            return login();
                        })
                        .catch(error => console.log('Setup error:', error));
                });
            
            // Save default exercise if not exists
            db.collection('exercises').where('title', '==', defaultExercise.title).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        db.collection('exercises').add({
                            ...defaultExercise,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: 'system'
                        });
                    }
                });
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for input changes in create exercise
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('question-text') || 
                    e.target.classList.contains('option') ||
                    e.target.classList.contains('explanation')) {
                    updateExercisePreview();
                }
            });
            
            // Auto-update preview when title/theme changes
            const titleInput = document.getElementById('exercise-title');
            const themeInput = document.getElementById('exercise-theme');
            if (titleInput && themeInput) {
                titleInput.addEventListener('input', updateExercisePreview);
                themeInput.addEventListener('input', updateExercisePreview);
            }
        });

        // Initialize Firebase app
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase already initialized');
        }
    </script>
</body>
</html>