<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devoirs de Français - Famille Singa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .admin-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .admin-btn:hover {
            background-color: #ff5252;
            transform: scale(1.05);
        }
        
        .admin-panel {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border: 3px solid #182848;
        }
        
        .admin-panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            color: #182848;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .admin-header h2 {
            font-size: 2rem;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 5px solid #4b6cb7;
        }
        
        .stat-card h3 {
            color: #182848;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4b6cb7;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .results-table th {
            background-color: #182848;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .results-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .export-btn {
            background-color: #4b6cb7;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background-color: #3a56a4;
            transform: scale(1.05);
        }
        
        .auth-form {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #182848;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background-color: #4b6cb7;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-form button:hover {
            background-color: #3a56a4;
        }
        
        .auth-message {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
        }
        
        .auth-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .auth-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .family-members {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .member-btn {
            padding: 18px 30px;
            font-size: 1.3rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .member-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .member-btn i {
            font-size: 1.5rem;
        }
        
        #aubaine-btn {
            background-color: #3498db;
            color: white;
        }
        
        #moise-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        #credo-btn {
            background-color: #9b59b6;
            color: white;
        }
        
        .instructions {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #4b6cb7;
        }
        
        .instructions h3 {
            color: #182848;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .content-area {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
        }
        
        .active-content {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .content-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .content-header h2 {
            color: #182848;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .content-header .member-role {
            font-size: 1.1rem;
            color: #4b6cb7;
            font-weight: 600;
        }
        
        .questions-container {
            margin-bottom: 30px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .question-number {
            display: inline-block;
            background-color: #4b6cb7;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .question-text {
            font-size: 1rem;
            margin-bottom: 15px;
            font-weight: 500;
            color: #333;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }
        
        .option {
            padding: 10px 15px;
            background-color: white;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
        }
        
        .option:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }
        
        .option.selected {
            background-color: #d1ecf1;
            border-color: #3498db;
            color: #0c5460;
        }
        
        .option.correct {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .option.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .option input {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .results-panel {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            text-align: center;
        }
        
        .results-panel h3 {
            margin-bottom: 20px;
            color: #182848;
        }
        
        .score {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4b6cb7;
            margin: 20px 0;
        }
        
        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .feedback.good {
            background-color: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }
        
        .feedback.average {
            background-color: #fff3cd;
            color: #856404;
            border-left: 5px solid #ffc107;
        }
        
        .feedback.poor {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        
        .coaching-area {
            background-color: #e8f4fc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            border-left: 5px solid #3498db;
        }
        
        .coaching-area h4 {
            color: #182848;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .coaching-area p {
            margin-bottom: 15px;
        }
        
        .coaching-tip {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-style: italic;
            border-left: 4px solid #9b59b6;
        }
        
        .submit-btn {
            display: block;
            margin: 30px auto;
            padding: 15px 40px;
            background-color: #4b6cb7;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            background-color: #3a56a4;
            transform: scale(1.05);
        }
        
        .submit-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        /* Styles pour les erreurs dans le panel admin */
        .error-details {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #ddd;
        }
        
        .error-details h4 {
            color: #182848;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .error-list {
            list-style-type: none;
        }
        
        .error-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            background-color: white;
            border-left: 4px solid #dc3545;
            border-radius: 5px;
        }
        
        .error-question {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .error-answer {
            color: #666;
            font-size: 0.9rem;
        }
        
        .error-correct {
            color: #28a745;
            font-weight: 500;
        }
        
        .error-wrong {
            color: #dc3545;
            font-weight: 500;
        }
        
        .member-selector {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .member-selector-btn {
            padding: 8px 15px;
            background-color: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .member-selector-btn:hover {
            background-color: #dee2e6;
        }
        
        .member-selector-btn.active {
            background-color: #4b6cb7;
            color: white;
            border-color: #4b6cb7;
        }
        
        @media (max-width: 768px) {
            .member-btn {
                width: 100%;
                justify-content: center;
            }
            
            .options {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .admin-btn {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .results-table {
                font-size: 0.9rem;
            }
            
            .results-table th, .results-table td {
                padding: 10px;
            }
            
            .questions-container {
                max-height: 500px;
            }
            
            .member-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-book-open"></i> Devoirs de Français - Famille Singa</h1>
        <p>Thème : Accord du participe passé - 50 questions par personne<br>Chaque membre a son propre questionnaire unique</p>
        <button class="admin-btn" id="admin-panel-btn">
            <i class="fas fa-lock"></i> Accès Admin
        </button>
    </div>
    
    <!-- Admin Panel -->
    <div class="admin-panel" id="admin-panel">
        <div class="admin-header">
            <i class="fas fa-chart-bar fa-2x"></i>
            <h2>Tableau de Bord Administrateur</h2>
        </div>
        
        <div id="auth-form" class="auth-form">
            <h2><i class="fas fa-user-shield"></i> Connexion Admin</h2>
            <input type="password" id="admin-password" placeholder="Mot de passe admin" autocomplete="off">
            <button id="admin-login-btn">Se connecter</button>
            <div id="auth-message" class="auth-message"></div>
        </div>
        
        <div id="admin-content" style="display: none;">
            <div class="admin-stats">
                <div class="stat-card">
                    <h3>Total Participants</h3>
                    <div class="stat-value" id="total-participants">0</div>
                </div>
                <div class="stat-card">
                    <h3>Moyenne Générale</h3>
                    <div class="stat-value" id="average-score">0%</div>
                </div>
                <div class="stat-card">
                    <h3>Meilleur Score</h3>
                    <div class="stat-value" id="best-score">0/50</div>
                </div>
                <div class="stat-card">
                    <h3>Dernière Activité</h3>
                    <div class="stat-value" id="last-activity">--</div>
                </div>
            </div>
            
            <h3><i class="fas fa-table"></i> Résultats Détailés</h3>
            
            <!-- Sélecteur de membre pour filtrer les résultats -->
            <div class="member-selector" id="member-selector">
                <button class="member-selector-btn active" data-member="all">Tous</button>
                <button class="member-selector-btn" data-member="credo">Credo</button>
                <button class="member-selector-btn" data-member="moise">Moïse</button>
                <button class="member-selector-btn" data-member="aubaine">Aubaine</button>
            </div>
            
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Participant</th>
                        <th>Score</th>
                        <th>Pourcentage</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
            
            <!-- Zone d'affichage des erreurs détaillées -->
            <div class="error-details" id="error-details" style="display: none;">
                <h4><i class="fas fa-exclamation-circle"></i> Erreurs détaillées - <span id="selected-member-name"></span></h4>
                <div id="errors-list"></div>
            </div>
            
            <button class="export-btn" id="export-btn">
                <i class="fas fa-download"></i> Exporter les Résultats
            </button>
        </div>
    </div>
    
    <div class="family-members">
        <button class="member-btn" id="aubaine-btn">
            <i class="fas fa-user-graduate"></i> Aubaine
        </button>
        
        <button class="member-btn" id="moise-btn">
            <i class="fas fa-user-graduate"></i> Moïse
        </button>
        
        <button class="member-btn" id="credo-btn">
            <i class="fas fa-user-graduate"></i> Credo
        </button>
    </div>
    
    <div class="instructions">
        <h3><i class="fas fa-info-circle"></i> Instructions</h3>
        <ul>
            <li>Chaque membre de la famille a <strong>50 questions uniques et différentes</strong>.</li>
            <li><strong>Cliquez sur votre nom pour commencer votre devoir.</strong> Aucun exercice ne s'affiche avant que vous ne cliquiez.</li>
            <li><strong>Credo (Niveau Intermédiaire)</strong> : 50 questions sur l'accord du participe passé</li>
            <li><strong>Moïse (Niveau Moyen)</strong> : 50 questions plus exigeantes sur l'accord du participe passé</li>
            <li><strong>Aubaine (Niveau Difficile)</strong> : 50 questions sur les verbes pronominaux et constructions complexes</li>
            <li><strong>Les résultats sont automatiquement sauvegardés dans la base de données.</strong></li>
        </ul>
    </div>
    
    <!-- Message initial -->
    <div id="no-content" style="display: block; text-align: center; padding: 50px; background-color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); margin-top: 20px;">
        <h2><i class="fas fa-hand-pointer fa-2x" style="color: #4b6cb7; margin-bottom: 20px;"></i></h2>
        <h2 style="color: #182848; margin-bottom: 15px;">Sélectionnez votre nom pour commencer</h2>
        <p style="color: #666; font-size: 1.1rem;">Cliquez sur votre nom dans les boutons ci-dessus pour afficher votre devoir.</p>
    </div>
    
    <!-- Credo's Content -->
    <div id="credo-content" class="content-area">
        <div class="content-header">
            <h2>Devoir de Credo - Niveau Intermédiaire</h2>
            <p class="member-role">50 questions sur l'accord du participe passé</p>
        </div>
        
        <div class="coaching-area">
            <h4><i class="fas fa-chalkboard-teacher"></i> Rôle du Coach</h4>
            <p>En tant que coach, vous devez non seulement répondre aux questions, mais aussi comprendre les règles derrière chaque réponse.</p>
            <p>Pour chaque question, nous vous fournirons un conseil pédagogique pour vous aider à expliquer la bonne réponse.</p>
            
            <div class="coaching-tip">
                <strong>Conseil du jour :</strong> Le participe passé s'accorde avec le complément d'objet direct (COD) quand il est placé avant le verbe.
            </div>
        </div>
        
        <div class="questions-container" id="credo-questions">
            <!-- Questions will be inserted here by JavaScript -->
        </div>
        
        <button class="submit-btn" id="credo-submit">Soumettre mes réponses</button>
        
        <div class="results-panel" id="credo-results" style="display: none;">
            <h3>Résultats de Credo</h3>
            <div class="score">Score: <span id="credo-score">0</span>/50</div>
            <div class="feedback" id="credo-feedback"></div>
            <p><i class="fas fa-database"></i> Résultats sauvegardés dans la base de données</p>
        </div>
    </div>
    
    <!-- Moïse's Content -->
    <div id="moise-content" class="content-area">
        <div class="content-header">
            <h2>Devoir de Moïse - Niveau Moyen</h2>
            <p class="member-role">50 questions plus exigeantes sur l'accord du participe passé</p>
        </div>
        
        <div class="questions-container" id="moise-questions">
            <!-- Questions will be inserted here by JavaScript -->
        </div>
        
        <button class="submit-btn" id="moise-submit">Soumettre mes réponses</button>
        
        <div class="results-panel" id="moise-results" style="display: none;">
            <h3>Résultats de Moïse</h3>
            <div class="score">Score: <span id="moise-score">0</span>/50</div>
            <div class="feedback" id="moise-feedback"></div>
            <p><i class="fas fa-database"></i> Résultats sauvegardés dans la base de données</p>
        </div>
    </div>
    
    <!-- Aubaine's Content -->
    <div id="aubaine-content" class="content-area">
        <div class="content-header">
            <h2>Devoir d'Aubaine - Niveau Difficile</h2>
            <p class="member-role">50 questions sur les verbes pronominaux et constructions complexes</p>
        </div>
        
        <div class="questions-container" id="aubaine-questions">
            <!-- Questions will be inserted here by JavaScript -->
        </div>
        
        <button class="submit-btn" id="aubaine-submit">Soumettre mes réponses</button>
        
        <div class="results-panel" id="aubaine-results" style="display: none;">
            <h3>Résultats d'Aubaine</h3>
            <div class="score">Score: <span id="aubaine-score">0</span>/50</div>
            <div class="feedback" id="aubaine-feedback"></div>
            <p><i class="fas fa-database"></i> Résultats sauvegardés dans la base de données</p>
        </div>
    </div>
    
    <div class="footer">
        <p>Devoirs de français - Famille Singa © 2023 | Thème : Accord du participe passé</p>
        <p>Total : 150 questions uniques (50 par personne) | Système de suivi administrateur activé</p>
    </div>

    <script>
        // NOUVELLE Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBPBq1uT7lbL9Xp_neAJh2lSe0MRErlYdo",
            authDomain: "evoir-1.firebaseapp.com",
            projectId: "evoir-1",
            storageBucket: "evoir-1.firebasestorage.app",
            messagingSenderId: "504718469638",
            appId: "1:504718469638:web:72707fd51d0ce6ff773187",
            measurementId: "G-ZXPC2SKJHT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Admin credentials
        const ADMIN_PASSWORD = "legende360@";
        const ADMIN_EMAIL = "admin@familiesinga.com";

        // Questions data - 50 UNIQUE questions for each family member
        const credoQuestions = [
            { question: "Les exercices que j'ai ___ sont faciles.", options: ["faire", "fait", "faits", "faite"], correct: 2 },
            { question: "La lettre que j'ai ___ est partie.", options: ["écrire", "écrit", "écrite", "écrivait"], correct: 2 },
            { question: "Les livres que tu as ___ sont intéressants.", options: ["lire", "lu", "lus", "lue"], correct: 2 },
            { question: "La porte qu'il a ___ était fermée.", options: ["ouvrir", "ouvert", "ouverte", "ouvrait"], correct: 2 },
            { question: "Les leçons que les élèves ont ___ sont longues.", options: ["apprendre", "appris", "apprises", "apprenait"], correct: 2 },
            { question: "La faute qu'elle a ___ est grave.", options: ["faire", "fait", "faite", "faisait"], correct: 2 },
            { question: "Les fleurs qu'ils ont ___ sont fanées.", options: ["cueillir", "cueilli", "cueillies", "cueillait"], correct: 2 },
            { question: "Les réponses que vous avez ___ sont justes.", options: ["donner", "donné", "données", "donnait"], correct: 2 },
            { question: "Le message que j'ai ___ était clair.", options: ["écrire", "écrit", "écrite", "écrivait"], correct: 2 },
            { question: "Les films que nous avons ___ étaient longs.", options: ["voir", "vu", "vus", "voyait"], correct: 2 },
            { question: "La maison qu'ils ont ___ est neuve.", options: ["construire", "construit", "construite", "construisait"], correct: 2 },
            { question: "Les phrases que tu as ___ sont correctes.", options: ["écrire", "écrit", "écrites", "écrivait"], correct: 2 },
            { question: "Le travail qu'elle a ___ est terminé.", options: ["finir", "fini", "finie", "finissait"], correct: 2 },
            { question: "Les cadeaux qu'ils ont ___ ont plu.", options: ["offrir", "offert", "offerts", "offrait"], correct: 2 },
            { question: "La réponse qu'il a ___ est exacte.", options: ["donner", "donné", "donnée", "donnait"], correct: 2 },
            { question: "Les vêtements qu'elle a ___ sont propres.", options: ["laver", "lavé", "lavés", "lavait"], correct: 2 },
            { question: "La leçon que le professeur a ___ est claire.", options: ["expliquer", "expliqué", "expliquée", "expliquait"], correct: 2 },
            { question: "Les devoirs que vous avez ___ sont terminés.", options: ["faire", "fait", "faits", "faisait"], correct: 2 },
            { question: "La chanson que nous avons ___ est connue.", options: ["chanter", "chanté", "chantée", "chantait"], correct: 2 },
            { question: "Les fruits que nous avons ___ sont mûrs.", options: ["cueillir", "cueilli", "cueillis", "cueillait"], correct: 2 },
            { question: "La robe qu'elle a ___ est belle.", options: ["acheter", "acheté", "achetée", "achetait"], correct: 2 },
            { question: "Les règles que tu as ___ sont claires.", options: ["lire", "lu", "lues", "lisait"], correct: 2 },
            { question: "Le film que j'ai ___ était émouvant.", options: ["voir", "vu", "vue", "voyait"], correct: 2 },
            { question: "Les photos qu'ils ont ___ sont belles.", options: ["prendre", "pris", "prises", "prenait"], correct: 2 },
            { question: "La décision qu'il a ___ est juste.", options: ["prendre", "pris", "prise", "prenait"], correct: 2 },
            { question: "Les messages que tu as ___ sont clairs.", options: ["envoyer", "envoyé", "envoyés", "envoyait"], correct: 2 },
            { question: "La faute qu'il a ___ est reconnue.", options: ["commettre", "commis", "commise", "commettait"], correct: 2 },
            { question: "Les livres que nous avons ___ sont nouveaux.", options: ["acheter", "acheté", "achetés", "achetait"], correct: 2 },
            { question: "La promesse qu'il a ___ est tenue.", options: ["faire", "fait", "faite", "faisait"], correct: 2 },
            { question: "Les erreurs qu'ils ont ___ sont corrigées.", options: ["faire", "fait", "faites", "faisait"], correct: 2 },
            { question: "Le texte que j'ai ___ est clair.", options: ["écrire", "écrit", "écrite", "écrivait"], correct: 2 },
            { question: "Les films que vous avez ___ sont récents.", options: ["voir", "vu", "vus", "voyait"], correct: 2 },
            { question: "La maison qu'elle a ___ est grande.", options: ["acheter", "acheté", "achetée", "achetait"], correct: 2 },
            { question: "Les phrases qu'ils ont ___ sont justes.", options: ["écrire", "écrit", "écrites", "écrivait"], correct: 2 },
            { question: "La réponse qu'elle a ___ est correcte.", options: ["donner", "donné", "donnée", "donnait"], correct: 2 },
            { question: "Les devoirs qu'ils ont ___ sont faits.", options: ["faire", "fait", "faits", "faisait"], correct: 2 },
            { question: "La chanson qu'elle a ___ est belle.", options: ["chanter", "chanté", "chantée", "chantait"], correct: 2 },
            { question: "Les livres que tu as ___ sont lourds.", options: ["porter", "porté", "portés", "portait"], correct: 2 },
            { question: "La robe qu'il a ___ est neuve.", options: ["choisir", "choisi", "choisie", "choisissait"], correct: 2 },
            { question: "Les photos que nous avons ___ sont nettes.", options: ["prendre", "pris", "prises", "prenait"], correct: 2 },
            { question: "Le message que tu as ___ est court.", options: ["envoyer", "envoyé", "envoyée", "envoyait"], correct: 2 },
            { question: "Les réponses que j'ai ___ sont bonnes.", options: ["recevoir", "reçu", "reçues", "recevait"], correct: 2 },
            { question: "La règle qu'il a ___ est importante.", options: ["expliquer", "expliqué", "expliquée", "expliquait"], correct: 2 },
            { question: "Les cadeaux que nous avons ___ ont plu.", options: ["offrir", "offert", "offerts", "offrait"], correct: 2 },
            { question: "La faute qu'elle a ___ est grave.", options: ["faire", "fait", "faite", "faisait"], correct: 2 },
            { question: "Les films qu'il a ___ sont intéressants.", options: ["voir", "vu", "vus", "voyait"], correct: 2 },
            { question: "La lettre qu'elle a ___ est longue.", options: ["écrire", "écrit", "écrite", "écrivait"], correct: 2 },
            { question: "Les décisions qu'ils ont ___ sont justes.", options: ["prendre", "pris", "prises", "prenait"], correct: 2 },
            { question: "Le travail qu'il a ___ est bien fait.", options: ["finir", "fini", "finie", "finissait"], correct: 2 },
            { question: "Les réponses que vous avez ___ sont exactes.", options: ["donner", "donné", "données", "donnait"], correct: 2 }
        ];

        const moiseQuestions = [
            { question: "Les lettres que j'ai ___ sont arrivées.", options: ["écrit", "écrite", "écrits", "écrites"], correct: 3 },
            { question: "Les fautes qu'il a ___ doivent être corrigées.", options: ["fait", "faite", "faites", "faisait"], correct: 2 },
            { question: "Les décisions qu'elle a ___ sont justes.", options: ["pris", "prise", "prises", "prenait"], correct: 2 },
            { question: "Les réponses qu'on lui a ___ étaient fausses.", options: ["donné", "donnée", "donnés", "donnait"], correct: 1 },
            { question: "Les erreurs qu'elle a ___ sont graves.", options: ["commis", "commise", "commises", "commettait"], correct: 2 },
            { question: "Les livres qu'ils ont ___ sont anciens.", options: ["lire", "lu", "lus", "lisait"], correct: 2 },
            { question: "Les promesses qu'il a ___ n'ont pas été tenues.", options: ["fait", "faite", "faites", "faisait"], correct: 2 },
            { question: "Les fleurs qu'elle a ___ ont fané.", options: ["cueilli", "cueillie", "cueillies", "cueillir"], correct: 2 },
            { question: "Les films que nous avons ___ sont intéressants.", options: ["vu", "vus", "vue", "voyait"], correct: 1 },
            { question: "Les fautes qu'ils ont ___ sont nombreuses.", options: ["commis", "commise", "commises", "commettait"], correct: 2 },
            { question: "Les lettres qu'elle a ___ sont longues.", options: ["écrit", "écrite", "écrites", "écrivait"], correct: 2 },
            { question: "Les règles que tu as ___ sont claires.", options: ["suivi", "suivies", "suivre", "suivait"], correct: 1 },
            { question: "Les réponses que j'ai ___ étaient exactes.", options: ["reçu", "reçus", "reçues", "recevoir"], correct: 2 },
            { question: "Les maisons qu'ils ont ___ sont neuves.", options: ["construit", "construite", "construites", "construire"], correct: 2 },
            { question: "Les fautes qu'elle a ___ sont pardonnées.", options: ["fait", "faite", "faites", "faisait"], correct: 2 },
            { question: "Les paroles qu'il a ___ ont choqué.", options: ["dit", "dite", "dites", "dire"], correct: 2 },
            { question: "Les photos qu'elle a ___ sont belles.", options: ["pris", "prise", "prises", "prendre"], correct: 2 },
            { question: "Les textes que nous avons ___ sont clairs.", options: ["écrit", "écrite", "écrits", "écrire"], correct: 2 },
            { question: "Les devoirs qu'ils ont ___ sont lourds.", options: ["fait", "faite", "faits", "faire"], correct: 2 },
            { question: "Les décisions qu'il a ___ étaient justes.", options: ["pris", "prise", "prises", "prendre"], correct: 2 },
            { question: "Les réponses qu'elle a ___ étaient bonnes.", options: ["donné", "donnée", "données", "donner"], correct: 2 },
            { question: "Les livres que j'ai ___ sont intéressants.", options: ["lu", "lus", "lue", "lire"], correct: 1 },
            { question: "Les lettres qu'ils ont ___ sont arrivées.", options: ["envoyé", "envoyée", "envoyées", "envoyer"], correct: 2 },
            { question: "Les promesses qu'elle a ___ sont tenues.", options: ["fait", "faite", "faites", "faire"], correct: 2 },
            { question: "Les films que tu as ___ sont longs.", options: ["vu", "vus", "vue", "voir"], correct: 1 },
            { question: "Les fautes qu'il a ___ sont reconnues.", options: ["commis", "commise", "commises", "commettre"], correct: 2 },
            { question: "Les réponses qu'ils ont ___ sont justes.", options: ["reçu", "reçus", "reçues", "recevoir"], correct: 2 },
            { question: "Les décisions que nous avons ___ sont finales.", options: ["pris", "prise", "prises", "prendre"], correct: 2 },
            { question: "Les lettres qu'elle a ___ sont courtes.", options: ["écrit", "écrite", "écrites", "écrire"], correct: 2 },
            { question: "Les efforts qu'ils ont ___ sont visibles.", options: ["fait", "faite", "faits", "faire"], correct: 2 },
            { question: "Les fautes qu'on a ___ sont graves.", options: ["commis", "commise", "commises", "commettre"], correct: 2 },
            { question: "Les films que nous avons ___ hier étaient longs.", options: ["vu", "vus", "vue", "voir"], correct: 1 },
            { question: "Les promesses qu'il a ___ étaient sincères.", options: ["fait", "faite", "faites", "faire"], correct: 2 },
            { question: "Les réponses que tu as ___ sont correctes.", options: ["donné", "donnée", "données", "donner"], correct: 2 },
            { question: "Les maisons qu'ils ont ___ sont solides.", options: ["bâti", "bâtie", "bâties", "bâtir"], correct: 2 },
            { question: "Les lettres qu'elle a ___ sont belles.", options: ["écrit", "écrite", "écrites", "écrire"], correct: 2 },
            { question: "Les fautes qu'ils ont ___ sont lourdes.", options: ["fait", "faite", "faites", "faire"], correct: 2 },
            { question: "Les décisions qu'il a ___ sont respectées.", options: ["pris", "prise", "prises", "prendre"], correct: 2 },
            { question: "Les réponses qu'on lui a ___ étaient claires.", options: ["donné", "donnée", "données", "donner"], correct: 1 },
            { question: "Les erreurs qu'il a ___ sont minimes.", options: ["commis", "commise", "commises", "commettre"], correct: 2 },
            { question: "Les maisons qu'ils ont ___ sont belles.", options: ["peint", "peinte", "peintes", "peindre"], correct: 2 },
            { question: "Les chansons que nous avons ___ sont connues.", options: ["apprendre", "appris", "apprises", "apprenait"], correct: 2 },
            { question: "Les fautes qu'elle s'est ___ sont graves.", options: ["permis", "permise", "permises", "permettre"], correct: 2 },
            { question: "Les lettres que j'ai ___ sont courtes.", options: ["écrit", "écrite", "écrites", "écrivait"], correct: 2 },
            { question: "Les décisions qu'ils ont ___ étaient difficiles.", options: ["prendre", "pris", "prises", "prenait"], correct: 2 },
            { question: "Les réponses que vous avez ___ sont exactes.", options: ["donner", "donné", "données", "donnait"], correct: 2 },
            { question: "Les livres qu'elle a ___ sont intéressants.", options: ["lire", "lu", "lus", "lisait"], correct: 2 },
            { question: "Les promesses qu'il s'est ___ sont tenues.", options: ["faire", "fait", "faites", "faisait"], correct: 2 },
            { question: "Les fautes qu'on a ___ sont nombreuses.", options: ["commettre", "commis", "commises", "commettait"], correct: 2 },
            { question: "Les décisions que j'ai ___ étaient justes.", options: ["prendre", "pris", "prises", "prenait"], correct: 2 },
            { question: "Les réponses qu'ils ont ___ sont bonnes.", options: ["recevoir", "reçu", "reçues", "recevait"], correct: 2 }
        ];

        const aubaineQuestions = [
            { question: "Les fautes qu'elle s'est ___ sont graves.", options: ["permise", "permis", "permises", "permettre"], correct: 2 },
            { question: "Les efforts qu'il a ___ faire ont payé.", options: ["dû", "dues", "dûs", "devoir"], correct: 2 },
            { question: "Les blessures qu'ils se sont ___ sont profondes.", options: ["infligé", "infligée", "infligés", "infligées"], correct: 3 },
            { question: "Les lettres qu'il s'est ___ écrire étaient longues.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les chansons qu'elle s'est ___ chanter ont plu.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les kilomètres qu'ils ont ___ à pied les ont épuisés.", options: ["parcouru", "parcourus", "parcourue", "parcourir"], correct: 1 },
            { question: "Les fautes qu'elle a ___ commettre sont graves.", options: ["cru", "crues", "crû", "croire"], correct: 0 },
            { question: "Les décisions qu'il a ___ prendre étaient difficiles.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les promesses qu'elle s'est ___ faites étaient irréalistes.", options: ["fait", "faite", "faites", "faire"], correct: 0 },
            { question: "Les sacrifices qu'ils ont ___ consentir étaient énormes.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les erreurs qu'il s'est ___ reprocher sont mineures.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les paroles qu'elle s'est ___ entendre ont choqué.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les critiques qu'elle a ___ essuyées l'ont blessée.", options: ["essuyé", "essuyés", "essuyées", "essuyer"], correct: 2 },
            { question: "Les sommes qu'il a ___ payer étaient élevées.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les promesses qu'il a ___ tenir étaient nombreuses.", options: ["cru", "crues", "crû", "croire"], correct: 0 },
            { question: "Les réponses qu'elle a ___ reçues sont claires.", options: ["reçu", "reçus", "reçue", "recevoir"], correct: 2 },
            { question: "Les vérités qu'elle a ___ dites ont choqué.", options: ["dit", "dite", "dites", "dire"], correct: 2 },
            { question: "Les sanctions qu'ils se sont ___ infliger étaient sévères.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les difficultés qu'elle a ___ rencontrées sont nombreuses.", options: ["rencontré", "rencontrées", "rencontrer", "rencontrait"], correct: 1 },
            { question: "Les efforts qu'ils ont ___ fournir ont payé.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les fautes qu'il s'est ___ permettre sont graves.", options: ["permis", "permise", "permises", "permettre"], correct: 0 },
            { question: "Les tâches qu'elle a ___ accomplir étaient lourdes.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les reproches qu'il s'est ___ faits étaient injustes.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les paroles qu'elle a ___ voulu dire étaient dures.", options: ["cru", "crues", "crû", "croire"], correct: 0 },
            { question: "Les dépenses qu'ils ont ___ faire dépassent le budget.", options: ["cru", "crues", "crû", "croire"], correct: 0 },
            { question: "Les fautes qu'elle s'est ___ avouer étaient graves.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les efforts qu'il a ___ consentir ont payé.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les erreurs qu'elle a ___ pu éviter sont nombreuses.", options: ["pu", "pue", "pouvoir", "pouvait"], correct: 0 },
            { question: "Les décisions qu'il a ___ voulu prendre étaient risquées.", options: ["cru", "crues", "crû", "croire"], correct: 0 },
            { question: "Les blessures qu'ils se sont ___ causées sont sérieuses.", options: ["causé", "causée", "causés", "causées"], correct: 3 },
            { question: "Les promesses qu'elle s'est ___ données étaient irréalistes.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les difficultés qu'il a ___ surmonter étaient grandes.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les erreurs qu'ils se sont ___ avouer étaient graves.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les efforts qu'elle a ___ fournir ont été récompensés.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les fautes qu'il s'est ___ reprochées étaient légères.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les décisions qu'ils ont ___ prendre étaient difficiles.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les promesses qu'elle s'est ___ tenues étaient nombreuses.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les difficultés qu'il a ___ rencontrer étaient imprévues.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les erreurs qu'ils se sont ___ permettre étaient graves.", options: ["permis", "permise", "permises", "permettre"], correct: 0 },
            { question: "Les efforts qu'elle a ___ consentir étaient énormes.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les fautes qu'il s'est ___ reprocher étaient sincères.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les décisions qu'ils ont ___ vouloir prendre étaient risquées.", options: ["cru", "crues", "crû", "croire"], correct: 0 },
            { question: "Les promesses qu'elle s'est ___ faites étaient tenues.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les difficultés qu'il a ___ rencontrées étaient nombreuses.", options: ["rencontré", "rencontrées", "rencontrer", "rencontrait"], correct: 1 },
            { question: "Les erreurs qu'ils se sont ___ avouées étaient graves.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les efforts qu'elle a ___ consentis étaient importants.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les fautes qu'il s'est ___ permises étaient graves.", options: ["permis", "permise", "permises", "permettre"], correct: 2 },
            { question: "Les décisions qu'ils ont ___ prendre étaient courageuses.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 },
            { question: "Les promesses qu'elle s'est ___ tenues étaient sincères.", options: ["fait", "faite", "faits", "faire"], correct: 0 },
            { question: "Les difficultés qu'il a ___ surmonter étaient réelles.", options: ["dû", "dues", "dûes", "devoir"], correct: 2 }
        ];

        // Variable pour stocker les résultats chargés
        let allResults = [];
        let selectedMemberFilter = 'all';

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Afficher le message "Sélectionnez votre nom" au départ
            document.getElementById('no-content').style.display = 'block';
            
            // Cacher tous les contenus des membres au départ
            document.getElementById('credo-content').style.display = 'none';
            document.getElementById('moise-content').style.display = 'none';
            document.getElementById('aubaine-content').style.display = 'none';
            
            // Set up button click events - CORRECTION ICI
            document.getElementById('aubaine-btn').addEventListener('click', function() {
                showContent('aubaine');
            });
            document.getElementById('moise-btn').addEventListener('click', function() {
                showContent('moise');
            });
            document.getElementById('credo-btn').addEventListener('click', function() {
                showContent('credo');
            });
            
            // Admin panel events
            document.getElementById('admin-panel-btn').addEventListener('click', toggleAdminPanel);
            document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
            document.getElementById('export-btn').addEventListener('click', exportResults);
            
            // Set up member selector events
            document.querySelectorAll('.member-selector-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.member-selector-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedMemberFilter = this.getAttribute('data-member');
                    displayResultsTable();
                });
            });
            
            // Check if admin is already logged in
            checkAdminAuth();
        });
        
        function showContent(member) {
            console.log("Affichage du contenu pour:", member); // Debug
            
            // Cacher le message "Sélectionnez votre nom"
            document.getElementById('no-content').style.display = 'none';
            
            // Cacher tous les contenus
            document.getElementById('credo-content').style.display = 'none';
            document.getElementById('moise-content').style.display = 'none';
            document.getElementById('aubaine-content').style.display = 'none';
            
            // Créer les questions pour ce membre si elles n'existent pas encore
            const questionsContainer = document.getElementById(`${member}-questions`);
            if (questionsContainer.children.length === 0) {
                console.log("Création des questions pour:", member); // Debug
                
                let questionsArray;
                switch(member) {
                    case 'credo': 
                        questionsArray = credoQuestions; 
                        break;
                    case 'moise': 
                        questionsArray = moiseQuestions; 
                        break;
                    case 'aubaine': 
                        questionsArray = aubaineQuestions; 
                        break;
                }
                
                createQuestions(member, questionsArray);
                
                // Set up submit button event pour ce membre
                const submitBtn = document.getElementById(`${member}-submit`);
                if (submitBtn) {
                    submitBtn.onclick = function() {
                        submitAnswers(member, questionsArray);
                    };
                }
            }
            
            // Afficher le contenu du membre sélectionné
            const memberContent = document.getElementById(`${member}-content`);
            if (memberContent) {
                memberContent.style.display = 'block';
            }
            
            // Reset button styles
            document.querySelectorAll('.member-btn').forEach(btn => {
                btn.style.transform = 'translateY(0)';
                btn.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
            });
            
            // Highlight selected button
            const selectedBtn = document.getElementById(`${member}-btn`);
            if (selectedBtn) {
                selectedBtn.style.transform = 'translateY(-5px)';
                selectedBtn.style.boxShadow = '0 10px 20px rgba(0, 0, 0, 0.15)';
            }
            
            // Hide results when switching members
            const resultsPanel = document.getElementById(`${member}-results`);
            if (resultsPanel) {
                resultsPanel.style.display = 'none';
            }
        }
        
        function createQuestions(member, questionsArray) {
            const container = document.getElementById(`${member}-questions`);
            if (!container) {
                console.error("Container non trouvé pour:", member);
                return;
            }
            
            container.innerHTML = '';
            
            questionsArray.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                
                let optionsHtml = '';
                q.options.forEach((option, optIndex) => {
                    optionsHtml += `
                        <div class="option" data-index="${optIndex}">
                            <input type="radio" name="${member}-q${index}" id="${member}-q${index}-opt${optIndex}" value="${optIndex}">
                            <label for="${member}-q${index}-opt${optIndex}">${option}</label>
                        </div>
                    `;
                });
                
                questionDiv.innerHTML = `
                    <div class="question-text">
                        <span class="question-number">${index + 1}</span>
                        ${q.question}
                    </div>
                    <div class="options">
                        ${optionsHtml}
                    </div>
                `;
                
                container.appendChild(questionDiv);
            });
            
            // Add click events to options
            container.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const questionDiv = this.closest('.question');
                    const options = questionDiv.querySelectorAll('.option');
                    const input = this.querySelector('input');
                    
                    // Deselect all options in this question
                    options.forEach(opt => {
                        opt.classList.remove('selected');
                        const optInput = opt.querySelector('input');
                        if (optInput) optInput.checked = false;
                    });
                    
                    // Select clicked option
                    this.classList.add('selected');
                    if (input) input.checked = true;
                });
            });
        }
        
        async function submitAnswers(member, questionsArray) {
            let score = 0;
            const totalQuestions = questionsArray.length;
            let answers = [];
            
            // Check each question
            for (let i = 0; i < totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="${member}-q${i}"]:checked`);
                const selectedValue = selectedOption ? parseInt(selectedOption.value) : null;
                const isCorrect = selectedValue === questionsArray[i].correct;
                
                if (isCorrect) {
                    score++;
                }
                
                answers.push({
                    questionIndex: i,
                    question: questionsArray[i].question,
                    selected: selectedValue,
                    correct: questionsArray[i].correct,
                    isCorrect: isCorrect,
                    selectedText: selectedValue !== null ? questionsArray[i].options[selectedValue] : 'Non répondu',
                    correctText: questionsArray[i].options[questionsArray[i].correct]
                });
                
                // Show correct/incorrect
                const questionDiv = document.getElementById(`${member}-questions`).children[i];
                if (questionDiv) {
                    const options = questionDiv.querySelectorAll('.option');
                    
                    options.forEach((option, index) => {
                        option.classList.remove('correct', 'incorrect');
                        
                        if (index === questionsArray[i].correct) {
                            option.classList.add('correct');
                        } else if (index === selectedValue && selectedValue !== questionsArray[i].correct) {
                            option.classList.add('incorrect');
                        }
                    });
                }
            }
            
            // Save results to Firebase
            await saveResultsToFirebase(member, score, answers, totalQuestions);
            
            // Display results
            const resultsPanel = document.getElementById(`${member}-results`);
            const scoreElement = document.getElementById(`${member}-score`);
            const feedbackElement = document.getElementById(`${member}-feedback`);
            
            if (scoreElement) scoreElement.textContent = `${score}/${totalQuestions}`;
            
            // Calculate percentage
            const percentage = (score / totalQuestions) * 100;
            
            // Provide feedback based on score
            let feedback = '';
            let feedbackClass = '';
            
            if (percentage >= 80) {
                feedback = `Excellent travail ! Tu as bien maîtrisé l'accord du participe passé.`;
                feedbackClass = 'good';
            } else if (percentage >= 60) {
                feedback = `Bon travail ! Tu as compris la majorité des règles, mais il reste quelques points à revoir.`;
                feedbackClass = 'average';
            } else {
                feedback = `Continue à t'entraîner ! N'oublie pas que le participe passé s'accorde avec le COD quand il est placé avant le verbe.`;
                feedbackClass = 'poor';
            }
            
            // Add additional feedback for Credo
            if (member === 'credo') {
                feedback += ` En tant que coach, tu peux maintenant expliquer ces règles à tes frères et sœurs.`;
                
                if (percentage >= 80) {
                    feedback += ` Tu es prêt à les coacher efficacement !`;
                } else if (percentage >= 60) {
                    feedback += ` Revois les questions que tu as ratées pour mieux expliquer les règles.`;
                } else {
                    feedback += ` Étudie bien les explications avant de coacher les autres.`;
                }
            }
            
            if (feedbackElement) {
                feedbackElement.textContent = feedback;
                feedbackElement.className = `feedback ${feedbackClass}`;
            }
            
            // Show results panel
            if (resultsPanel) {
                resultsPanel.style.display = 'block';
                resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        async function saveResultsToFirebase(member, score, answers, totalQuestions) {
            try {
                const resultData = {
                    member: member,
                    score: score,
                    totalQuestions: totalQuestions,
                    percentage: Math.round((score / totalQuestions) * 100),
                    answers: answers,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: new Date().toISOString(),
                    niveau: getNiveau(member)
                };
                
                await db.collection('resultats_devoirs').add(resultData);
                console.log(`Résultats sauvegardés pour ${member} dans la nouvelle base de données`);
            } catch (error) {
                console.error("Erreur lors de la sauvegarde des résultats:", error);
                alert("Erreur de connexion à la base de données. Veuillez réessayer.");
            }
        }
        
        function getNiveau(member) {
            switch(member) {
                case 'credo': return 'intermédiaire';
                case 'moise': return 'moyen';
                case 'aubaine': return 'difficile';
                default: return 'inconnu';
            }
        }
        
        function toggleAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            adminPanel.classList.toggle('active');
        }
        
        function checkAdminAuth() {
            auth.onAuthStateChanged((user) => {
                if (user && user.email === ADMIN_EMAIL) {
                    showAdminContent();
                } else {
                    hideAdminContent();
                }
            });
        }
        
        async function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const messageDiv = document.getElementById('auth-message');
            
            if (password === ADMIN_PASSWORD) {
                try {
                    // Create user with email and password
                    await auth.createUserWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PASSWORD);
                    messageDiv.textContent = "Connexion réussie !";
                    messageDiv.className = "auth-message success";
                    showAdminContent();
                    loadResults();
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        // User already exists, try to sign in
                        try {
                            await auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PASSWORD);
                            messageDiv.textContent = "Connexion réussie !";
                            messageDiv.className = "auth-message success";
                            showAdminContent();
                            loadResults();
                        } catch (signInError) {
                            messageDiv.textContent = "Erreur de connexion. Vérifiez le mot de passe.";
                            messageDiv.className = "auth-message error";
                        }
                    } else {
                        messageDiv.textContent = "Erreur de connexion.";
                        messageDiv.className = "auth-message error";
                    }
                }
            } else {
                messageDiv.textContent = "Mot de passe incorrect.";
                messageDiv.className = "auth-message error";
            }
        }
        
        function showAdminContent() {
            document.getElementById('auth-form').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
        }
        
        function hideAdminContent() {
            document.getElementById('auth-form').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
            document.getElementById('error-details').style.display = 'none';
        }
        
        async function loadResults() {
            try {
                const snapshot = await db.collection('resultats_devoirs')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                allResults = [];
                let totalScore = 0;
                let bestScore = 0;
                let lastActivity = null;
                const members = new Set();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allResults.push({
                        ...data,
                        id: doc.id
                    });
                    
                    totalScore += data.percentage;
                    if (data.score > bestScore) {
                        bestScore = data.score;
                    }
                    members.add(data.member);
                    
                    if (!lastActivity || data.timestamp > lastActivity) {
                        lastActivity = data.timestamp;
                    }
                });
                
                // Update statistics
                document.getElementById('total-participants').textContent = members.size;
                document.getElementById('average-score').textContent = allResults.length > 0 ? 
                    Math.round(totalScore / allResults.length) + '%' : '0%';
                document.getElementById('best-score').textContent = bestScore + '/50';
                document.getElementById('last-activity').textContent = lastActivity ? 
                    new Date(lastActivity.toDate()).toLocaleDateString('fr-FR') : '--';
                
                // Display results table
                displayResultsTable();
                
            } catch (error) {
                console.error("Erreur lors du chargement des résultats:", error);
                document.getElementById('results-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: #dc3545;">
                            Erreur de connexion à la base de données. Veuillez réessayer.
                        </td>
                    </tr>
                `;
            }
        }
        
        function displayResultsTable() {
            const tableBody = document.getElementById('results-table-body');
            tableBody.innerHTML = '';
            
            // Filtrer les résultats selon le membre sélectionné
            const filteredResults = selectedMemberFilter === 'all' 
                ? allResults 
                : allResults.filter(result => result.member === selectedMemberFilter);
            
            if (filteredResults.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px;">
                            Aucun résultat trouvé pour ce filtre.
                        </td>
                    </tr>
                `;
                document.getElementById('error-details').style.display = 'none';
                return;
            }
            
            filteredResults.forEach((result, index) => {
                const row = document.createElement('tr');
                const date = result.timestamp ? 
                    new Date(result.timestamp.toDate()).toLocaleString('fr-FR') : 
                    new Date(result.date).toLocaleString('fr-FR');
                
                let statusClass = '';
                if (result.percentage >= 80) {
                    statusClass = 'Excellent';
                } else if (result.percentage >= 60) {
                    statusClass = 'Bon';
                } else {
                    statusClass = 'À revoir';
                }
                
                row.innerHTML = `
                    <td>${result.member.charAt(0).toUpperCase() + result.member.slice(1)} (${result.niveau})</td>
                    <td>${result.score}/${result.totalQuestions}</td>
                    <td>${result.percentage}%</td>
                    <td>${date}</td>
                    <td>
                        <button class="member-selector-btn" onclick="showErrorDetails('${result.id}', '${result.member}')">
                            <i class="fas fa-search"></i> Voir les erreurs
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function showErrorDetails(resultId, memberName) {
            const result = allResults.find(r => r.id === resultId);
            if (!result) return;
            
            document.getElementById('selected-member-name').textContent = 
                memberName.charAt(0).toUpperCase() + memberName.slice(1);
            
            const errorsList = document.getElementById('errors-list');
            errorsList.innerHTML = '';
            
            // Trouver les réponses incorrectes
            const incorrectAnswers = result.answers.filter(answer => !answer.isCorrect);
            
            if (incorrectAnswers.length === 0) {
                errorsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #28a745;">
                        <i class="fas fa-check-circle fa-2x"></i>
                        <p style="margin-top: 10px;">Aucune erreur ! Excellent travail !</p>
                    </div>
                `;
            } else {
                errorsList.innerHTML = `<p>${incorrectAnswers.length} erreur(s) trouvée(s) :</p>`;
                
                const errorList = document.createElement('ul');
                errorList.className = 'error-list';
                
                incorrectAnswers.forEach(answer => {
                    const errorItem = document.createElement('li');
                    errorItem.className = 'error-item';
                    
                    errorItem.innerHTML = `
                        <div class="error-question">
                            <strong>Question ${answer.questionIndex + 1}:</strong> ${answer.question}
                        </div>
                        <div class="error-answer">
                            <span class="error-wrong">Votre réponse: ${answer.selectedText}</span> | 
                            <span class="error-correct">Réponse correcte: ${answer.correctText}</span>
                        </div>
                    `;
                    errorList.appendChild(errorItem);
                });
                
                errorsList.appendChild(errorList);
            }
            
            document.getElementById('error-details').style.display = 'block';
            document.getElementById('error-details').scrollIntoView({ behavior: 'smooth' });
        }
        
        function exportResults() {
            const filteredResults = selectedMemberFilter === 'all' 
                ? allResults 
                : allResults.filter(result => result.member === selectedMemberFilter);
            
            let csv = "Participant,Niveau,Score,Pourcentage,Date,Nombre d'erreurs\n";
            
            filteredResults.forEach(result => {
                const date = result.timestamp ? 
                    new Date(result.timestamp.toDate()).toLocaleString('fr-FR') : 
                    new Date(result.date).toLocaleString('fr-FR');
                
                const errorCount = result.answers.filter(a => !a.isCorrect).length;
                
                csv += `"${result.member.charAt(0).toUpperCase() + result.member.slice(1)}","${result.niveau}",${result.score}/${result.totalQuestions},${result.percentage}%,"${date}",${errorCount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resultats_famille_singa_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Exposer la fonction au scope global pour le bouton
        window.showErrorDetails = showErrorDetails;
    </script>
</body>
</html>