

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu Multijoueur - Connexion par Code</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: white;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            font-size: 42px;
            background: linear-gradient(45deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .logo p {
            color: #aaa;
            font-size: 16px;
        }
        
        .player-info {
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ddd;
        }
        
        input, select {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #00dbde;
            box-shadow: 0 0 15px rgba(0, 219, 222, 0.3);
        }
        
        input::placeholder {
            color: #aaa;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 3px solid white;
        }
        
        .game-mode {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }
        
        .mode-btn {
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-3px);
            border-color: rgba(0, 219, 222, 0.5);
        }
        
        .mode-btn i {
            font-size: 24px;
        }
        
        .create-mode {
            color: #00dbde;
        }
        
        .join-mode {
            color: #fc00ff;
        }
        
        .room-section {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .room-code-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            border: 2px dashed rgba(0, 219, 222, 0.5);
        }
        
        .code {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 5px;
            background: linear-gradient(45deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 20px 0;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .code-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .action-btns {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .action-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .copy-btn {
            background: linear-gradient(45deg, #00dbde, #0083b0);
            color: white;
        }
        
        .share-btn {
            background: linear-gradient(45deg, #fc00ff, #8a2be2);
            color: white;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #00b09b, #96c93d);
            color: white;
            width: 100%;
            padding: 20px;
            font-size: 18px;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-top: 20px;
        }
        
        .players-list {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .player-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .player-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .player-name {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
        }
        
        .player-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-online {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }
        
        .status-offline {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
        }
        
        .game-screen {
            display: none;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .game-canvas {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            width: 100%;
            height: 400px;
            border: 3px solid rgba(255, 255, 255, 0.1);
        }
        
        .game-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        .control-btn {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(0, 219, 222, 0.3);
            transform: scale(1.05);
        }
        
        .quit-btn {
            background: rgba(255, 0, 0, 0.3);
            color: white;
            border: 2px solid rgba(255, 0, 0, 0.5);
        }
        
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-left: 5px solid #00dbde;
            display: none;
            z-index: 1000;
            max-width: 350px;
            animation: slideIn 0.5s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            display: block;
            background: linear-gradient(45deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 25px 20px;
            }
            
            .logo h1 {
                font-size: 32px;
            }
            
            .code {
                font-size: 36px;
            }
            
            .action-btns {
                flex-direction: column;
            }
            
            .game-controls {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <!-- √âcran Principal -->
    <div id="mainScreen" class="container">
        <div class="logo">
            <h1><i class="fas fa-gamepad"></i> MULTIPLAYER</h1>
            <p>Connectez-vous et jouez avec vos amis en temps r√©el</p>
        </div>
        
        <div class="player-info">
            <div class="input-group">
                <label for="playerName"><i class="fas fa-user"></i> Votre Pseudo</label>
                <input type="text" id="playerName" placeholder="Entrez votre nom de joueur" maxlength="15" value="Joueur">
            </div>
            
            <div class="input-group">
                <label for="playerColor"><i class="fas fa-palette"></i> Votre Couleur</label>
                <div class="color-picker">
                    <input type="color" id="playerColor" value="#ff4757">
                    <div id="colorPreview" class="color-preview"></div>
                </div>
            </div>
            
            <div class="input-group">
                <label for="gameType"><i class="fas fa-chess-board"></i> Type de Jeu</label>
                <select id="gameType">
                    <option value="arena">üèüÔ∏è Arena Battle</option>
                    <option value="race">üèéÔ∏è Course Rapide</option>
                    <option value="quiz">‚ùì Quiz Challenge</option>
                    <option value="puzzle">üß© Puzzle Coop</option>
                    <option value="custom">üéÆ Jeu Personnalis√©</option>
                </select>
            </div>
        </div>
        
        <div class="game-mode">
            <button class="mode-btn create-mode" onclick="showCreateRoom()">
                <i class="fas fa-plus-circle"></i>
                <span>Cr√©er une Salle</span>
            </button>
            
            <button class="mode-btn join-mode" onclick="showJoinRoom()">
                <i class="fas fa-sign-in-alt"></i>
                <span>Rejoindre une Salle</span>
            </button>
        </div>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-value" id="onlineCount">0</span>
                <span>En ligne</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="activeRoomsCount">0</span>
                <span>Salles actives</span>
            </div>
        </div>
    </div>
    
    <!-- √âcran Cr√©ation de Salle -->
    <div id="createScreen" class="container" style="display: none;">
        <div class="logo">
            <h2><i class="fas fa-crown"></i> CR√âER UNE SALLE</h2>
            <p>Cr√©ez votre propre espace de jeu</p>
        </div>
        
        <div class="input-group">
            <label for="roomName"><i class="fas fa-door-open"></i> Nom de la Salle</label>
            <input type="text" id="roomName" placeholder="Nom de votre salle (ex: 'Arena des Champions')" value="Salle de Jeu">
        </div>
        
        <div class="input-group">
            <label for="maxPlayers"><i class="fas fa-users"></i> Nombre Maximum de Joueurs</label>
            <select id="maxPlayers">
                <option value="2">2 Joueurs</option>
                <option value="4" selected>4 Joueurs</option>
                <option value="6">6 Joueurs</option>
                <option value="8">8 Joueurs</option>
                <option value="10">10 Joueurs</option>
            </select>
        </div>
        
        <div class="input-group">
            <label><i class="fas fa-lock"></i> Visibilit√©</label>
            <div style="display: flex; gap: 20px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="visibility" value="public" checked> 
                    <i class="fas fa-globe"></i> Publique
                </label>
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="visibility" value="private"> 
                    <i class="fas fa-lock"></i> Priv√©e
                </label>
            </div>
        </div>
        
        <button class="action-btn start-btn" onclick="createRoom()">
            <i class="fas fa-play-circle"></i> Cr√©er la Salle et G√©n√©rer le Code
        </button>
        
        <button class="action-btn back-btn" onclick="showMainScreen()">
            <i class="fas fa-arrow-left"></i> Retour
        </button>
    </div>
    
    <!-- √âcran Code G√©n√©r√© -->
    <div id="roomCreatedScreen" class="container" style="display: none;">
        <div class="logo">
            <h2 style="color: #00dbde;"><i class="fas fa-check-circle"></i> SALLE CR√â√âE !</h2>
            <p>Partagez ce code avec vos amis pour qu'ils vous rejoignent</p>
        </div>
        
        <div class="room-code-display">
            <div class="code-label">CODE DE LA SALLE</div>
            <div id="roomCode" class="code">ABCD12</div>
            <div class="code-label">Donnez ce code √† vos amis</div>
        </div>
        
        <div class="action-btns">
            <button class="action-btn copy-btn" onclick="copyRoomCode()">
                <i class="far fa-copy"></i> Copier le Code
            </button>
            <button class="action-btn share-btn" onclick="shareRoomCode()">
                <i class="fas fa-share-alt"></i> Partager
            </button>
        </div>
        
        <div class="players-list" id="waitingPlayers">
            <h3><i class="fas fa-users"></i> Joueurs en attente (1/4)</h3>
            <div id="playersContainer"></div>
        </div>
        
        <button class="action-btn start-btn" id="startGameBtn" style="display: none;" onclick="startGame()">
            <i class="fas fa-play"></i> D√©marrer la Partie (1/4)
        </button>
        
        <button class="action-btn back-btn" onclick="leaveRoom()">
            <i class="fas fa-sign-out-alt"></i> Quitter la Salle
        </button>
    </div>
    
    <!-- √âcran Rejoindre Salle -->
    <div id="joinScreen" class="container" style="display: none;">
        <div class="logo">
            <h2><i class="fas fa-sign-in-alt"></i> REJOINDRE UNE SALLE</h2>
            <p>Entrez le code de la salle pour rejoindre vos amis</p>
        </div>
        
        <div class="input-group">
            <label for="joinCode"><i class="fas fa-key"></i> Code de la Salle</label>
            <input type="text" id="joinCode" placeholder="Entrez le code (ex: ABCD12)" maxlength="6" style="text-transform: uppercase; letter-spacing: 3px; font-size: 24px; text-align: center;">
        </div>
        
        <div style="margin: 30px 0; text-align: center;">
            <div style="font-size: 14px; color: #aaa; margin-bottom: 10px;">OU</div>
            <button class="mode-btn" onclick="showPublicRooms()" style="background: rgba(0, 219, 222, 0.2);">
                <i class="fas fa-globe-europe"></i>
                <span>Voir les salles publiques disponibles</span>
            </button>
        </div>
        
        <button class="action-btn start-btn" onclick="joinRoom()">
            <i class="fas fa-door-open"></i> Rejoindre la Salle
        </button>
        
        <button class="action-btn back-btn" onclick="showMainScreen()">
            <i class="fas fa-arrow-left"></i> Retour
        </button>
    </div>
    
    <!-- √âcran Liste des Salles Publiques -->
    <div id="publicRoomsScreen" class="container" style="display: none;">
        <div class="logo">
            <h2><i class="fas fa-globe"></i> SALLES PUBLIQUES</h2>
            <p>S√©lectionnez une salle pour rejoindre</p>
        </div>
        
        <div class="players-list" id="publicRoomsList">
            <!-- Les salles seront ajout√©es ici dynamiquement -->
        </div>
        
        <button class="action-btn back-btn" onclick="showJoinScreen()">
            <i class="fas fa-arrow-left"></i> Retour
        </button>
    </div>
    
    <!-- √âcran de Jeu -->
    <div id="gameScreen" class="container" style="display: none;">
        <div class="game-header">
            <div>
                <h3><span id="currentRoomCode">ABCD12</span></h3>
                <p id="gameStatus">En attente...</p>
            </div>
            <div>
                <button class="control-btn quit-btn" onclick="quitGame()">
                    <i class="fas fa-sign-out-alt"></i> Quitter
                </button>
            </div>
        </div>
        
        <canvas id="gameCanvas" class="game-canvas" width="800" height="400"></canvas>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-value" id="gameTime">00:00</span>
                <span>Temps</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="playerScore">0</span>
                <span>Score</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalPlayers">0</span>
                <span>Joueurs</span>
            </div>
        </div>
        
        <div class="game-controls">
            <div></div>
            <button class="control-btn" onclick="movePlayer('up')">
                <i class="fas fa-arrow-up"></i>
            </button>
            <div></div>
            
            <button class="control-btn" onclick="movePlayer('left')">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="control-btn" style="background: rgba(0, 219, 222, 0.3);">
                <i class="fas fa-crosshairs"></i>
            </div>
            <button class="control-btn" onclick="movePlayer('right')">
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <div></div>
            <button class="control-btn" onclick="movePlayer('down')">
                <i class="fas fa-arrow-down"></i>
            </button>
            <div></div>
        </div>
        
        <div class="players-list" id="gamePlayersList">
            <h4><i class="fas fa-trophy"></i> Classement en direct</h4>
        </div>
    </div>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js"></script>

    <script>
        // ================= CONFIGURATION FIREBASE =================
        const firebaseConfig = {
            apiKey: "AIzaSyBr8Fzdvh1En3rAxGFipOYfgr0YDeeM_Bo",
            authDomain: "match-en-ligne.firebaseapp.com",
            databaseURL: "https://match-en-ligne-default-rtdb.firebaseio.com",
            projectId: "match-en-ligne",
            storageBucket: "match-en-ligne.firebasestorage.app",
            messagingSenderId: "706011207623",
            appId: "1:706011207623:web:17374990a6202b64f0abe2",
            measurementId: "G-D9XYRE3W2M"
        };

        // Initialiser Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // ================= VARIABLES GLOBALES =================
        let playerId = null;
        let playerName = "Joueur";
        let playerColor = "#ff4757";
        let currentRoomId = null;
        let isHost = false;
        let gameActive = false;
        let gameStartTime = null;
        let gameTimerInterval = null;
        let canvas, ctx;

        // ================= INITIALISATION =================
        window.onload = function() {
            // Initialiser les √©l√©ments
            initializeElements();
            
            // Connexion anonyme
            auth.signInAnonymously()
                .then((userCredential) => {
                    playerId = userCredential.user.uid;
                    console.log("Connect√© avec ID:", playerId);
                    updateOnlineStatus();
                    updateStats();
                })
                .catch((error) => {
                    showNotification("Erreur de connexion: " + error.message);
                });
        };

        function initializeElements() {
            // Gestion de la couleur
            const colorInput = document.getElementById('playerColor');
            const colorPreview = document.getElementById('colorPreview');
            
            playerColor = colorInput.value;
            colorPreview.style.backgroundColor = playerColor;
            
            colorInput.addEventListener('input', function() {
                playerColor = this.value;
                colorPreview.style.backgroundColor = playerColor;
            });
            
            // Initialiser le canvas
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Rendre le canvas responsive
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Mettre √† jour les stats toutes les 5 secondes
            setInterval(updateStats, 5000);
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            const width = container.clientWidth;
            const height = Math.min(400, width * 0.5);
            
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
        }

        // ================= GESTION DES √âCRANS =================
        function showMainScreen() {
            hideAllScreens();
            document.getElementById('mainScreen').style.display = 'block';
        }

        function showCreateRoom() {
            playerName = document.getElementById('playerName').value.trim() || "Joueur";
            if (!playerName) {
                showNotification("‚ö†Ô∏è Entrez un nom de joueur");
                return;
            }
            
            hideAllScreens();
            document.getElementById('createScreen').style.display = 'block';
        }

        function showJoinRoom() {
            playerName = document.getElementById('playerName').value.trim() || "Joueur";
            hideAllScreens();
            document.getElementById('joinScreen').style.display = 'block';
            
            // Focus sur le champ de code
            setTimeout(() => {
                document.getElementById('joinCode').focus();
            }, 100);
        }

        function showJoinScreen() {
            hideAllScreens();
            document.getElementById('joinScreen').style.display = 'block';
        }

        function showPublicRooms() {
            hideAllScreens();
            document.getElementById('publicRoomsScreen').style.display = 'block';
            loadPublicRooms();
        }

        function hideAllScreens() {
            const screens = ['mainScreen', 'createScreen', 'roomCreatedScreen', 
                           'joinScreen', 'publicRoomsScreen', 'gameScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).style.display = 'none';
            });
        }

        // ================= CR√âATION DE SALLE =================
        function createRoom() {
            const roomName = document.getElementById('roomName').value.trim() || "Salle de Jeu";
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const isPrivate = document.querySelector('input[name="visibility"]:checked').value === 'private';
            
            // G√©n√©rer un code unique de 6 caract√®res
            const roomCode = generateRoomCode();
            currentRoomId = roomCode;
            isHost = true;
            
            // Cr√©er la salle dans Firebase
            database.ref('rooms/' + roomCode).set({
                name: roomName,
                host: playerId,
                hostName: playerName,
                gameType: document.getElementById('gameType').value,
                players: {
                    [playerId]: {
                        name: playerName,
                        color: playerColor,
                        score: 0,
                        x: Math.random() * 700 + 50,
                        y: Math.random() * 300 + 50,
                        online: true,
                        isHost: true,
                        joinedAt: Date.now()
                    }
                },
                maxPlayers: maxPlayers,
                status: 'waiting',
                isPrivate: isPrivate,
                createdAt: Date.now()
            }).then(() => {
                // Afficher l'√©cran avec le code
                showRoomCreatedScreen(roomCode);
                
                // √âcouter les joueurs qui rejoignent
                listenToRoom(roomCode);
                
                showNotification("‚úÖ Salle cr√©√©e avec succ√®s!");
            }).catch(error => {
                showNotification("‚ùå Erreur: " + error.message);
            });
        }

        function showRoomCreatedScreen(roomCode) {
            hideAllScreens();
            document.getElementById('roomCreatedScreen').style.display = 'block';
            document.getElementById('roomCode').textContent = roomCode;
            
            // Mettre √† jour la liste des joueurs
            updatePlayersList();
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ================= REJOINDRE UNE SALLE =================
        function joinRoom() {
            const roomCode = document.getElementById('joinCode').value.trim().toUpperCase();
            
            if (!roomCode || roomCode.length !== 6) {
                showNotification("‚ö†Ô∏è Entrez un code de 6 caract√®res");
                return;
            }
            
            currentRoomId = roomCode;
            isHost = false;
            
            // V√©rifier si la salle existe
            database.ref('rooms/' + roomCode).once('value').then((snapshot) => {
                const room = snapshot.val();
                
                if (!room) {
                    showNotification("‚ùå Code incorrect. Aucune salle trouv√©e.");
                    return;
                }
                
                if (room.status !== 'waiting') {
                    showNotification("‚ùå La partie est d√©j√† en cours ou termin√©e.");
                    return;
                }
                
                const playerCount = room.players ? Object.keys(room.players).length : 0;
                if (playerCount >= room.maxPlayers) {
                    showNotification("‚ùå La salle est pleine (" + playerCount + "/" + room.maxPlayers + ")");
                    return;
                }
                
                // Rejoindre la salle
                database.ref('rooms/' + roomCode + '/players/' + playerId).set({
                    name: playerName,
                    color: playerColor,
                    score: 0,
                    x: Math.random() * 700 + 50,
                    y: Math.random() * 300 + 50,
                    online: true,
                    isHost: false,
                    joinedAt: Date.now()
                }).then(() => {
                    // √âcouter les changements dans la salle
                    listenToRoom(roomCode);
                    
                    // Afficher l'√©cran d'attente
                    showRoomCreatedScreen(roomCode);
                    showNotification("‚úÖ Connect√© √† la salle " + roomCode);
                });
                
            }).catch(error => {
                showNotification("‚ùå Erreur: " + error.message);
            });
        }

        function loadPublicRooms() {
            database.ref('rooms').on('value', (snapshot) => {
                const rooms = snapshot.val();
                const roomsList = document.getElementById('publicRoomsList');
                roomsList.innerHTML = '';
                
                if (!rooms) {
                    roomsList.innerHTML = '<p style="text-align: center; padding: 30px; color: #aaa;">Aucune salle publique disponible</p>';
                    return;
                }
                
                let publicRoomsCount = 0;
                
                for (let roomCode in rooms) {
                    const room = rooms[roomCode];
                    
                    // Afficher seulement les salles publiques en attente
                    if (!room.isPrivate && room.status === 'waiting') {
                        const playerCount = room.players ? Object.keys(room.players).length : 0;
                        
                        if (playerCount < room.maxPlayers) {
                            publicRoomsCount++;
                            
                            const roomElement = document.createElement('div');
                            roomElement.className = 'player-item';
                            roomElement.style.cursor = 'pointer';
                            roomElement.onclick = function() {
                                document.getElementById('joinCode').value = roomCode;
                                showJoinScreen();
                            };
                            
                            roomElement.innerHTML = `
                                <div style="flex: 1;">
                                    <div class="player-name">${room.name}</div>
                                    <div style="font-size: 12px; color: #aaa;">
                                        <i class="fas fa-user"></i> ${playerCount}/${room.maxPlayers} joueurs
                                        <span style="margin-left: 15px;">${room.gameType}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: bold; color: #00dbde;">${roomCode}</div>
                                    <div style="font-size: 12px; color: #aaa;">Code</div>
                                </div>
                            `;
                            
                            roomsList.appendChild(roomElement);
                        }
                    }
                }
                
                if (publicRoomsCount === 0) {
                    roomsList.innerHTML = '<p style="text-align: center; padding: 30px; color: #aaa;">Aucune salle publique disponible</p>';
                }
            });
        }

        // ================= GESTION DE LA SALLE =================
        function listenToRoom(roomCode) {
            // √âcouter les changements dans la salle
            database.ref('rooms/' + roomCode).on('value', (snapshot) => {
                const room = snapshot.val();
                
                if (!room) {
                    showNotification("La salle a √©t√© supprim√©e");
                    leaveRoom();
                    return;
                }
                
                // Mettre √† jour la liste des joueurs
                updatePlayersList(room.players);
                
                // Mettre √† jour le bouton d√©marrer
                const playerCount = room.players ? Object.keys(room.players).length : 0;
                const startBtn = document.getElementById('startGameBtn');
                
                if (isHost && playerCount >= 2) {
                    startBtn.style.display = 'block';
                    startBtn.innerHTML = `<i class="fas fa-play"></i> D√©marrer la Partie (${playerCount}/${room.maxPlayers})`;
                } else {
                    startBtn.style.display = 'none';
                }
                
                // Si le jeu d√©marre
                if (room.status === 'playing' && !gameActive) {
                    gameActive = true;
                    startGame();
                }
            });
        }

        function updatePlayersList(players = {}) {
            const container = document.getElementById('playersContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            let playerCount = 0;
            
            for (let id in players) {
                const player = players[id];
                playerCount++;
                
  const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                playerElement.innerHTML = `
                    <div class="player-color" style="background-color: ${player.color};"></div>
                    <div class="player-name">
                        ${player.name} ${id === playerId ? '(Vous)' : ''}
                        ${player.isHost ? ' üëë' : ''}
                    </div>
                    <div class="player-status status-online">
                        ${player.score} pts
                    </div>
                `;
                
                container.appendChild(playerElement);
            }
            
            // Mettre √† jour le compteur
            const waitingTitle = document.querySelector('#waitingPlayers h3');
            if (waitingTitle) {
                const roomRef = database.ref('rooms/' + currentRoomId);
                roomRef.once('value').then((snapshot) => {
                    const room = snapshot.val();
                    if (room) {
                        waitingTitle.innerHTML = `<i class="fas fa-users"></i> Joueurs en attente (${playerCount}/${room.maxPlayers})`;
                    }
                });
            }
        }

        function startGame() {
            if (!currentRoomId || !isHost) return;
            
            // Changer le statut de la salle
            database.ref('rooms/' + currentRoomId).update({
                status: 'playing',
                gameStartTime: Date.now()
            }).then(() => {
                showNotification("üéÆ La partie commence !");
                hideAllScreens();
                document.getElementById('gameScreen').style.display = 'block';
                
                // Initialiser le jeu
                initializeGame();
                
                // D√©marrer le timer
                startGameTimer();
                
                // D√©marrer la boucle de jeu
                gameLoop();
            });
        }

        // ================= JEU EN TEMPS R√âEL =================
        function initializeGame() {
            // Initialiser le canvas
            canvas.width = 800;
            canvas.height = 400;
            
            // Mettre √† jour l'affichage
            document.getElementById('currentRoomCode').textContent = currentRoomId;
            document.getElementById('gameStatus').textContent = "Partie en cours";
            
            // √âcouter les positions des joueurs
            database.ref('rooms/' + currentRoomId + '/players').on('value', (snapshot) => {
                const players = snapshot.val();
                if (players) {
                    updateGamePlayersList(players);
                    drawGamePlayers(players);
                }
            });
            
            // √âcouter les √©v√©nements du jeu
            database.ref('rooms/' + currentRoomId + '/gameEvents').on('child_added', (snapshot) => {
                const event = snapshot.val();
                handleGameEvent(event);
            });
        }

        function gameLoop() {
            if (!gameActive) return;
            
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dessiner l'arri√®re-plan
            drawGameBackground();
            
            // Dessiner tous les joueurs (sera fait dans drawGamePlayers via l'√©couteur)
            
            // Continuer la boucle
            requestAnimationFrame(gameLoop);
        }

        function drawGameBackground() {
            // D√©grad√© de fond
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Grille
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Centre du jeu
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, 50, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawGamePlayers(players) {
            for (let id in players) {
                const player = players[id];
                if (!player.online) continue;
                
                // Corps du joueur
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(player.x, player.y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Bordure
                ctx.strokeStyle = id === playerId ? '#00ff00' : '#ffffff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x, player.y, 23, 0, Math.PI * 2);
                ctx.stroke();
                
                // Nom
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(player.name, player.x, player.y - 30);
                
                // Score
                ctx.fillStyle = 'yellow';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(player.score.toString(), player.x, player.y + 5);
            }
        }

        function updateGamePlayersList(players) {
            const container = document.getElementById('gamePlayersList');
            if (!container) return;
            
            // Trier par score
            const sortedPlayers = Object.entries(players)
                .sort((a, b) => b[1].score - a[1].score);
            
            container.innerHTML = '<h4><i class="fas fa-trophy"></i> Classement en direct</h4>';
            
            sortedPlayers.forEach(([id, player], index) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                playerElement.style.background = id === playerId ? 'rgba(0, 219, 222, 0.2)' : '';
                
                playerElement.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold; width: 40px; text-align: center;">
                        ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : (index + 1)}
                    </div>
                    <div class="player-color" style="background-color: ${player.color};"></div>
                    <div class="player-name">
                        ${player.name} ${id === playerId ? '(Vous)' : ''}
                    </div>
                    <div style="font-size: 20px; font-weight: bold; color: #ffd700;">
                        ${player.score}
                    </div>
                `;
                
                container.appendChild(playerElement);
            });
            
            // Mettre √† jour les stats
            document.getElementById('totalPlayers').textContent = sortedPlayers.length;
            document.getElementById('playerScore').textContent = players[playerId]?.score || 0;
        }

        function movePlayer(direction) {
            if (!currentRoomId || !playerId || !gameActive) return;
            
            database.ref('rooms/' + currentRoomId + '/players/' + playerId).once('value').then((snapshot) => {
                const player = snapshot.val();
                if (!player) return;
                
                let newX = player.x;
                let newY = player.y;
                const moveAmount = 10;
                
                switch(direction) {
                    case 'up': newY -= moveAmount; break;
                    case 'down': newY += moveAmount; break;
                    case 'left': newX -= moveAmount; break;
                    case 'right': newX += moveAmount; break;
                }
                
                // Limites du canvas
                newX = Math.max(20, Math.min(canvas.width - 20, newX));
                newY = Math.max(20, Math.min(canvas.height - 20, newY));
                
                // Mettre √† jour la position
                database.ref('rooms/' + currentRoomId + '/players/' + playerId).update({
                    x: newX,
                    y: newY,
                    lastMove: Date.now()
                });
                
                // V√©rifier les collisions (exemple: gagner des points)
                checkCollisions(newX, newY);
            });
        }

        function checkCollisions(x, y) {
            // Exemple simple: gagner des points en touchant le centre
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            
            if (distance < 70) {
                // Ajouter un point
                database.ref('rooms/' + currentRoomId + '/players/' + playerId).once('value').then((snapshot) => {
                    const player = snapshot.val();
                    const newScore = (player.score || 0) + 1;
                    
                    database.ref('rooms/' + currentRoomId + '/players/' + playerId).update({
                        score: newScore
                    });
                    
                    // Cr√©er un √©v√©nement de jeu
                    database.ref('rooms/' + currentRoomId + '/gameEvents').push({
                        type: 'score',
                        playerId: playerId,
                        playerName: playerName,
                        points: 1,
                        timestamp: Date.now()
                    });
                });
            }
        }

        function handleGameEvent(event) {
            switch(event.type) {
                case 'score':
                    showNotification(`üèÜ ${event.playerName} a gagn√© 1 point!`);
                    break;
            }
        }

        function startGameTimer() {
            clearInterval(gameTimerInterval);
            gameStartTime = Date.now();
            
            gameTimerInterval = setInterval(() => {
                const elapsed = Date.now() - gameStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('gameTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Arr√™ter apr√®s 5 minutes (exemple)
                if (elapsed > 5 * 60 * 1000) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            if (!currentRoomId) return;
            
            gameActive = false;
            clearInterval(gameTimerInterval);
            
            // D√©terminer le gagnant
            database.ref('rooms/' + currentRoomId + '/players').once('value').then((snapshot) => {
                const players = snapshot.val();
                let winner = null;
                let maxScore = -1;
                
                for (let id in players) {
                    if (players[id].score > maxScore) {
                        maxScore = players[id].score;
                        winner = players[id];
                    }
                }
                
                if (winner) {
                    showNotification(`üéâ ${winner.name} gagne la partie avec ${winner.score} points!`);
                }
                
                // Mettre √† jour le statut de la salle
                database.ref('rooms/' + currentRoomId).update({
                    status: 'finished',
                    endedAt: Date.now(),
                    winner: winner?.name
                });
            });
        }

        // ================= FONCTIONS UTILITAIRES =================
        function copyRoomCode() {
            const code = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(code)
                .then(() => showNotification("‚úÖ Code copi√© dans le presse-papier!"))
                .catch(() => {
                    // Fallback pour anciens navigateurs
                    const textArea = document.createElement('textarea');
                    textArea.value = code;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification("‚úÖ Code copi√©!");
                });
        }

        function shareRoomCode() {
            const code = document.getElementById('roomCode').textContent;
            const gameType = document.getElementById('gameType').options[document.getElementById('gameType').selectedIndex].text;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Rejoins ma partie multijoueur!',
                    text: `Rejoins ma partie ${gameType}. Code: ${code}`,
                    url: window.location.href
                }).then(() => {
                    showNotification("‚úÖ Partage r√©ussi!");
                }).catch((error) => {
                    console.log('Erreur de partage:', error);
                });
            } else {
                // Fallback: copier dans le presse-papier
                const shareText = `Rejoins ma partie ${gameType}! Code: ${code}\nLien: ${window.location.href}`;
                navigator.clipboard.writeText(shareText)
                    .then(() => showNotification("‚úÖ Lien copi√©! Partagez-le avec vos amis."));
            }
        }

        function leaveRoom() {
            if (currentRoomId && playerId) {
                // Retirer le joueur de la salle
                database.ref('rooms/' + currentRoomId + '/players/' + playerId).remove().then(() => {
                    // V√©rifier si la salle est vide
                    database.ref('rooms/' + currentRoomId + '/players').once('value').then((snapshot) => {
                        if (!snapshot.exists() || snapshot.numChildren() === 0) {
                            // Supprimer la salle si vide
                            database.ref('rooms/' + currentRoomId).remove();
                        }
                    });
                });
            }
            
            resetGame();
            showMainScreen();
            showNotification("üëã Vous avez quitt√© la salle");
        }

        function quitGame() {
            leaveRoom();
        }

        function resetGame() {
            gameActive = false;
            currentRoomId = null;
            isHost = false;
            clearInterval(gameTimerInterval);
            
            // Arr√™ter les √©couteurs Firebase
            if (currentRoomId) {
                database.ref('rooms/' + currentRoomId).off();
                database.ref('rooms/' + currentRoomId + '/players').off();
                database.ref('rooms/' + currentRoomId + '/gameEvents').off();
            }
        }

        function updateOnlineStatus() {
            if (!playerId) return;
            
            // Mettre √† jour le statut en ligne
            database.ref('online/' + playerId).set({
                name: playerName,
                lastSeen: Date.now(),
                color: playerColor
            });
            
            // Nettoyer quand le joueur quitte
            window.addEventListener('beforeunload', () => {
                if (playerId) {
                    database.ref('online/' + playerId).remove();
                }
                if (currentRoomId && playerId) {
                    database.ref('rooms/' + currentRoomId + '/players/' + playerId).update({
                        online: false
                    });
                }
            });
        }

        function updateStats() {
            // Compter les joueurs en ligne
            database.ref('online').once('value').then((snapshot) => {
                const online = snapshot.val();
                const count = online ? Object.keys(online).length : 0;
                document.getElementById('onlineCount').textContent = count;
            });
            
            // Compter les salles actives
            database.ref('rooms').once('value').then((snapshot) => {
                const rooms = snapshot.val();
                let activeCount = 0;
                
                if (rooms) {
                    for (let roomId in rooms) {
                        if (rooms[roomId].status === 'waiting' || rooms[roomId].status === 'playing') {
                            activeCount++;
                        }
                    }
                }
                
                document.getElementById('activeRoomsCount').textContent = activeCount;
            });
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // ================= CONTROLES CLAVIER =================
        document.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            
            switch(e.key) {
                case 'ArrowUp': case 'w': case 'W': 
                    movePlayer('up'); 
                    break;
                case 'ArrowDown': case 's': case 'S': 
                    movePlayer('down'); 
                    break;
                case 'ArrowLeft': case 'a': case 'A': 
                    movePlayer('left'); 
                    break;
                case 'ArrowRight': case 'd': case 'D': 
                    movePlayer('right'); 
                    break;
            }
        });

        // ================= INITIALISATION AUTO =================
        // V√©rifier si un code est pr√©sent dans l'URL
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCodeFromUrl = urlParams.get('code');
            
            if (roomCodeFromUrl) {
                document.getElementById('joinCode').value = roomCodeFromUrl.toUpperCase();
                showJoinRoom();
            }
            
            // Mettre √† jour le nom du joueur avec un nom al√©atoire si vide
            if (!document.getElementById('playerName').value) {
                const randomNames = ['GamerPro', 'Ninja', 'Champion', 'Warrior', 'Master', 'Hero', 'Legend', 'Star'];
                const randomName = randomNames[Math.floor(Math.random() * randomNames.length)] + Math.floor(Math.random() * 100);
                document.getElementById('playerName').value = randomName;
                playerName = randomName;
            }
        });
    </script>
</body>
</html>