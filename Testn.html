<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Français - Participe Passé</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #1a1a2e;
            --light: #f8f9fa;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            padding: 20px;
        }
        
        .container-main {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: 95vh;
        }
        
        .header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .admin-access {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        
        .admin-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .admin-btn:hover {
            background: white;
            color: var(--primary);
        }
        
        .quiz-section, .admin-section {
            padding: 30px;
        }
        
        .timer-container {
            background: var(--dark);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .timer {
            font-size: 4em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #4cc9f0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.5);
        }
        
        .question-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .question-card:hover {
            transform: translateY(-5px);
        }
        
        .question-number {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .options-container {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .option {
            padding: 15px 20px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            font-size: 1.1em;
        }
        
        .option:hover {
            background: #e9ecef;
            border-color: var(--primary);
        }
        
        .option.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: bold;
        }
        
        .option.correct {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .option.wrong {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .option-mark {
            margin-right: 15px;
            font-size: 1.2em;
        }
        
        .btn-custom {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-custom:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.4);
            color: white;
        }
        
        .results-container {
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0% 75%, #e9ecef 75% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            position: relative;
        }
        
        .score-inner {
            width: 160px;
            height: 160px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
        }
        
        .admin-panel {
            background: #1a1a2e;
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .stats-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .student-result {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--success);
        }
        
        .modal-admin {
            background: rgba(0,0,0,0.9);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .input-admin {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .explanation-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid var(--success);
            display: none;
        }
        
        @media (max-width: 768px) {
            .container-main {
                border-radius: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .timer {
                font-size: 2.5em;
            }
            
            .question-card {
                padding: 15px;
            }
            
            .option {
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Admin Access Modal -->
    <div id="adminModal" class="modal-admin" style="display: none;">
        <div class="modal-content">
            <h3 class="mb-4"><i class="fas fa-lock"></i> Accès Administrateur</h3>
            <input type="password" id="adminPassword" class="input-admin" placeholder="Mot de passe admin" autocomplete="off">
            <button onclick="verifyAdmin()" class="btn-custom w-100">Accéder au Panel</button>
            <p class="mt-3 text-muted">Mot de passe: <strong>Légende360@</strong></p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container-main">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-graduation-cap"></i> Quiz de Français</h1>
            <h4>Participe passé et terminaisons verbales</h4>
            <p>Testez vos connaissances en grammaire française</p>
            
            <div class="admin-access">
                <button class="admin-btn" onclick="showAdminModal()">
                    <i class="fas fa-user-shield"></i> Admin
                </button>
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="quizSection" class="quiz-section">
            <!-- Student Info -->
            <div id="studentInfo" style="text-align: center; margin-bottom: 30px;">
                <h3>Bonjour, <span id="studentName">Étudiant</span> !</h3>
                <p class="text-muted">Prêt à tester vos connaissances ?</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="globalProgress"></div>
                </div>
            </div>

            <!-- Timer -->
            <div class="timer-container" id="timerContainer" style="display: none;">
                <h4><i class="fas fa-clock"></i> Temps restant</h4>
                <div class="timer" id="timerDisplay">15</div>
                <p>Question <span id="currentQuestionNum">1</span> sur <span id="totalQuestions">30</span></p>
            </div>

            <!-- Instructions -->
            <div id="instructions" class="question-card">
                <h4><i class="fas fa-info-circle"></i> Instructions</h4>
                <p>Pour chaque phrase, cochez la bonne réponse parmi les propositions.</p>
                <ul>
                    <li><strong>Chronomètre :</strong> 15 secondes par question</li>
                    <li><strong>Mode :</strong> Sans aide extérieure</li>
                    <li><strong>Objectif :</strong> S'améliorer en grammaire</li>
                    <li><strong>Pour :</strong> Credo Singa</li>
                </ul>
                <div class="text-center mt-4">
                    <button onclick="startQuiz()" class="btn-custom btn-lg">
                        <i class="fas fa-play"></i> Commencer le Quiz
                    </button>
                </div>
            </div>

            <!-- Questions Container -->
            <div id="questionsContainer" style="display: none;"></div>

            <!-- Navigation Buttons -->
            <div id="navigationButtons" style="display: none; text-align: center; margin-top: 30px;">
                <button onclick="previousQuestion()" class="btn-custom" id="prevBtn" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button onclick="nextQuestion()" class="btn-custom" id="nextBtn">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
                <button onclick="submitQuiz()" class="btn-custom" id="submitBtn" style="display: none;">
                    <i class="fas fa-paper-plane"></i> Soumettre
                </button>
            </div>

            <!-- Results -->
            <div id="resultsSection" style="display: none;"></div>
        </div>

        <!-- Admin Section (Hidden by default) -->
        <div id="adminSection" class="admin-section" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-chart-line"></i> Panel Administrateur</h2>
            
            <!-- Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-users fa-2x"></i>
                        <div class="stats-number" id="totalStudents">0</div>
                        <p>Étudiants</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-check-circle fa-2x"></i>
                        <div class="stats-number" id="totalQuizzes">0</div>
                        <p>Quiz complétés</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-percentage fa-2x"></i>
                        <div class="stats-number" id="avgScore">0%</div>
                        <p>Moyenne</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-clock fa-2x"></i>
                        <div class="stats-number" id="avgTime">0s</div>
                        <p>Temps moyen</p>
                    </div>
                </div>
            </div>

            <!-- Results List -->
            <div class="admin-panel">
                <h4 class="mb-4"><i class="fas fa-list"></i> Résultats détaillés</h4>
                <div id="resultsList"></div>
            </div>

            <!-- Create Exercise -->
            <div class="mt-5">
                <h4><i class="fas fa-plus-circle"></i> Créer un nouvel exercice</h4>
                <div class="question-card">
                    <div class="mb-3">
                        <label class="form-label">Titre de l'exercice</label>
                        <input type="text" id="newExerciseTitle" class="form-control" placeholder="Participe passé - Niveau avancé">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Temps par question (secondes)</label>
                        <input type="number" id="newExerciseTime" class="form-control" value="15" min="5" max="60">
                    </div>
                    <button onclick="createNewExercise()" class="btn-custom">
                        <i class="fas fa-save"></i> Créer l'exercice
                    </button>
                </div>
            </div>

            <div class="text-center mt-4">
                <button onclick="backToQuiz()" class="btn-custom">
                    <i class="fas fa-arrow-left"></i> Retour au Quiz
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAUYpCBlPUnnsCyvqrfMmY5uacjHLGVRh0",
            authDomain: "match-a2ac6.firebaseapp.com",
            projectId: "match-a2ac6",
            storageBucket: "match-a2ac6.firebasestorage.app",
            messagingSenderId: "376894292796",
            appId: "1:376894292796:web:1eb138830c92aae8df5439",
            measurementId: "G-2RSRSSFCDZ"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // ==================== QUIZ DATA ====================
        const quizData = {
            title: "Participe passé et terminaisons verbales",
            timePerQuestion: 15,
            questions: [
                {
                    id: 1,
                    question: "Il a ______ son sac sur la table.",
                    options: ["posé", "poser", "posait", "posera"],
                    correct: 0,
                    explanation: "Avec l'auxiliaire 'avoir', le participe passé ne s'accorde pas avec le sujet."
                },
                {
                    id: 2,
                    question: "Les lettres qu'elle a ______ étaient très touchantes.",
                    options: ["écrire", "écrites", "écrite", "écrivait"],
                    correct: 1,
                    explanation: "Accord avec 'lettres' (féminin pluriel) placé avant le participe passé."
                },
                {
                    id: 3,
                    question: "Nous avons ______ toute la journée.",
                    options: ["marcher", "marché", "marchait", "marchera"],
                    correct: 1,
                    explanation: "Participe passé avec 'avoir' - pas d'accord avec le sujet."
                },
                {
                    id: 4,
                    question: "La chanson que j'ai ______ hier était magnifique.",
                    options: ["écouter", "écoutée", "écouté", "écoutait"],
                    correct: 1,
                    explanation: "Accord avec 'chanson' (féminin singulier) placé avant."
                },
                {
                    id: 5,
                    question: "Les enfants ont ______ trop tard.",
                    options: ["arriver", "arrivés", "arrivé", "arrivaient"],
                    correct: 1,
                    explanation: "Accord avec 'enfants' (masculin pluriel) placé avant."
                },
                {
                    id: 6,
                    question: "Elle s'est ______ les mains avant de manger.",
                    options: ["laver", "lavée", "lavées", "lavait"],
                    correct: 2,
                    explanation: "Avec l'auxiliaire 'être', le participe passé s'accorde avec le sujet."
                },
                {
                    id: 7,
                    question: "Ils avaient ______ le travail avant la nuit.",
                    options: ["terminer", "terminé", "terminaient", "termina"],
                    correct: 1,
                    explanation: "Participe passé avec 'avoir' - pas d'accord."
                },
                {
                    id: 8,
                    question: "La robe qu'elle a ______ hier est très belle.",
                    options: ["acheter", "achetée", "acheté", "achetait"],
                    correct: 1,
                    explanation: "Accord avec 'robe' (féminin singulier) placé avant."
                },
                {
                    id: 9,
                    question: "Il ______ partir plus tôt, mais il a oublié.",
                    options: ["a", "est", "avait", "aurait"],
                    correct: 3,
                    explanation: "Conditionnel passé pour une action non réalisée."
                },
                {
                    id: 10,
                    question: "Les histoires que nous avons ______ sont vraies.",
                    options: ["raconter", "raconté", "racontées", "racontait"],
                    correct: 2,
                    explanation: "Accord avec 'histoires' (féminin pluriel) placé avant."
                },
                {
                    id: 11,
                    question: "Elle a ______ ses erreurs.",
                    options: ["corriger", "corrigé", "corrigée", "corrigeait"],
                    correct: 1,
                    explanation: "Participe passé avec 'avoir' - pas d'accord."
                },
                {
                    id: 12,
                    question: "Les fleurs qu'il a ______ sont fanées.",
                    options: ["cueillir", "cueilli", "cueillies", "cueillait"],
                    correct: 2,
                    explanation: "Accord avec 'fleurs' (féminin pluriel) placé avant."
                },
                {
                    id: 13,
                    question: "Tu aurais ______ me prévenir.",
                    options: ["dû", "du", "devoir", "dues"],
                    correct: 0,
                    explanation: "Participe passé du verbe 'devoir' au conditionnel passé."
                },
                {
                    id: 14,
                    question: "La leçon qu'ils ont ______ était difficile.",
                    options: ["apprendre", "appris", "apprise", "apprenaient"],
                    correct: 1,
                    explanation: "Participe passé avec 'avoir' - pas d'accord."
                },
                {
                    id: 15,
                    question: "Elle s'est ______ tard cette nuit.",
                    options: ["coucher", "couchée", "couché", "couchait"],
                    correct: 1,
                    explanation: "Accord avec le sujet 'elle' avec l'auxiliaire 'être'."
                }
            ]
        };

        // ==================== GLOBAL VARIABLES ====================
        let currentStudent = {
            id: null,
            name: "Credo Singa",
            email: "credo@quiz.fr"
        };
        
        let currentAnswers = {};
        let currentQuestionIndex = 0;
        let timerInterval = null;
        let timeLeft = quizData.timePerQuestion;
        let quizStarted = false;
        let quizCompleted = false;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeStudent();
            displayQuestions();
            loadGlobalStats();
        });

        // ==================== STUDENT MANAGEMENT ====================
        function initializeStudent() {
            // Generate unique student ID
            let studentId = localStorage.getItem('quiz_student_id');
            if (!studentId) {
                studentId = 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('quiz_student_id', studentId);
            }
            
            currentStudent.id = studentId;
            document.getElementById('studentName').textContent = currentStudent.name;
            
            // Load previous progress
            loadStudentProgress();
        }

        function loadStudentProgress() {
            const progress = localStorage.getItem('quiz_progress');
            if (progress) {
                const progressData = JSON.parse(progress);
                const progressPercent = (progressData.answered / quizData.questions.length) * 100;
                document.getElementById('globalProgress').style.width = progressPercent + '%';
            }
        }

        // ==================== QUIZ FUNCTIONS ====================
        function startQuiz() {
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('questionsContainer').style.display = 'block';
            document.getElementById('timerContainer').style.display = 'block';
            document.getElementById('navigationButtons').style.display = 'block';
            
            quizStarted = true;
            currentQuestionIndex = 0;
            currentAnswers = {};
            
            showQuestion(currentQuestionIndex);
            startTimer();
            updateNavigationButtons();
        }

        function displayQuestions() {
            const container = document.getElementById('questionsContainer');
            document.getElementById('totalQuestions').textContent = quizData.questions.length;
            
            quizData.questions.forEach((q, index) => {
                const questionHTML = `
                    <div class="question-card" id="question-${q.id}" style="display: ${index === 0 ? 'block' : 'none'};">
                        <div class="question-number">${index + 1}</div>
                        <h4>${q.question}</h4>
                        <div class="options-container" id="options-${q.id}">
                            ${q.options.map((option, optIndex) => `
                                <div class="option" onclick="selectAnswer(${q.id}, ${optIndex})" id="option-${q.id}-${optIndex}">
                                    <span class="option-mark">${String.fromCharCode(65 + optIndex)}.</span>
                                    ${option}
                                </div>
                            `).join('')}
                        </div>
                        <div class="explanation-box" id="explanation-${q.id}">
                            <strong><i class="fas fa-lightbulb"></i> Explication :</strong> ${q.explanation}
                        </div>
                    </div>
                `;
                container.innerHTML += questionHTML;
            });
        }

        function showQuestion(index) {
            // Hide all questions
            quizData.questions.forEach(q => {
                document.getElementById(`question-${q.id}`).style.display = 'none';
            });
            
            // Show current question
            const currentQ = quizData.questions[index];
            document.getElementById(`question-${currentQ.id}`).style.display = 'block';
            document.getElementById('currentQuestionNum').textContent = index + 1;
            
            // Reset timer
            timeLeft = quizData.timePerQuestion;
            document.getElementById('timerDisplay').textContent = timeLeft;
            
            // Update selected answer if exists
            if (currentAnswers[currentQ.id] !== undefined) {
                selectAnswer(currentQ.id, currentAnswers[currentQ.id]);
            }
        }

        function selectAnswer(questionId, optionIndex) {
            currentAnswers[questionId] = optionIndex;
            
            // Update UI
            const question = quizData.questions.find(q => q.id === questionId);
            question.options.forEach((_, index) => {
                const optionElement = document.getElementById(`option-${questionId}-${index}`);
                optionElement.classList.remove('selected');
                if (index === optionIndex) {
                    optionElement.classList.add('selected');
                }
            });
            
            // Save progress
            saveProgress();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    nextQuestion();
                }
            }, 1000);
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizData.questions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
                startTimer();
                updateNavigationButtons();
            } else {
                submitQuiz();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
                startTimer();
                updateNavigationButtons();
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prevBtn').style.display = currentQuestionIndex > 0 ? 'inline-block' : 'none';
            document.getElementById('nextBtn').style.display = currentQuestionIndex < quizData.questions.length - 1 ? 'inline-block' : 'none';
            document.getElementById('submitBtn').style.display = currentQuestionIndex === quizData.questions.length - 1 ? 'inline-block' : 'none';
        }

        function submitQuiz() {
            clearInterval(timerInterval);
            quizCompleted = true;
            
            // Calculate results
            let correctCount = 0;
            const results = [];
            
            quizData.questions.forEach(q => {
                const userAnswer = currentAnswers[q.id];
                const isCorrect = userAnswer === q.correct;
                
                if (isCorrect) correctCount++;
                
                results.push({
                    questionId: q.id,
                    question: q.question,
                    userAnswer: userAnswer !== undefined ? q.options[userAnswer] : "Non répondue",
                    correctAnswer: q.options[q.correct],
                    isCorrect: isCorrect,
                    explanation: q.explanation
                });
                
                // Show correct/wrong answers
                if (userAnswer !== undefined) {
                    const userOption = document.getElementById(`option-${q.id}-${userAnswer}`);
                    const correctOption = document.getElementById(`option-${q.id}-${q.correct}`);
                    
                    userOption.classList.add(isCorrect ? 'correct' : 'wrong');
                    if (!isCorrect) {
                        correctOption.classList.add('correct');
                    }
                    
                    // Show explanation
                    document.getElementById(`explanation-${q.id}`).style.display = 'block';
                }
            });
            
            // Calculate score
            const score = Math.round((correctCount / quizData.questions.length) * 100);
            const totalTime = (quizData.timePerQuestion * quizData.questions.length) - timeLeft;
            
            // Display results
            displayResults(score, correctCount, results, totalTime);
            
            // Save to Firebase
            saveResultsToFirebase(score, correctCount, results, totalTime);
            
            // Disable further selection
            quizData.questions.forEach(q => {
                q.options.forEach((_, index) => {
                    const optionElement = document.getElementById(`option-${q.id}-${index}`);
                    optionElement.style.cursor = 'default';
                    optionElement.onclick = null;
                });
            });
        }

        function displayResults(score, correctCount, results, totalTime) {
            const resultsHTML = `
                <div class="results-container">
                    <h2 class="text-center mb-4"><i class="fas fa-trophy"></i> Résultats du Quiz</h2>
                    
                    <div class="score-circle">
                        <div class="score-inner">
                            ${score}%
                        </div>
                    </div>
                    
                    <div class="text-center mb-4">
                        <h3>${correctCount} sur ${quizData.questions.length} correctes</h3>
                        <p class="text-muted">Temps total: ${totalTime} secondes</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-card" style="background: #d4edda; color: #155724;">
                                <i class="fas fa-check fa-2x"></i>
                                <div class="stats-number">${correctCount}</div>
                                <p>Bonnes réponses</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card" style="background: #f8d7da; color: #721c24;">
                                <i class="fas fa-times fa-2x"></i>
                                <div class="stats-number">${quizData.questions.length - correctCount}</div>
                                <p>Mauvaises réponses</p>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4">Détail des réponses:</h4>
                    ${results.map((result, index) => `
                        <div class="student-result ${result.isCorrect ? '' : 'border-left: 4px solid var(--danger);'}">
                            <strong>Question ${index + 1}:</strong> ${result.question}<br>
                            <strong>Ta réponse:</strong> ${result.userAnswer}<br>
                            <strong>Réponse correcte:</strong> ${result.correctAnswer}<br>
                            <strong>Explication:</strong> ${result.explanation}
                        </div>
                    `).join('')}
                    
                    <div class="text-center mt-4">
                        <button onclick="restartQuiz()" class="btn-custom">
                            <i class="fas fa-redo"></i> Recommencer le Quiz
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('resultsSection').innerHTML = resultsHTML;
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('questionsContainer').style.display = 'none';
            document.getElementById('timerContainer').style.display = 'none';
            document.getElementById('navigationButtons').style.display = 'none';
        }

        function restartQuiz() {
            currentAnswers = {};
            currentQuestionIndex = 0;
            quizCompleted = false;
            
            // Reset UI
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('instructions').style.display = 'block';
            
            // Reset questions
            quizData.questions.forEach(q => {
                q.options.forEach((_, index) => {
                    const optionElement = document.getElementById(`option-${q.id}-${index}`);
                    optionElement.classList.remove('selected', 'correct', 'wrong');
                    optionElement.style.cursor = 'pointer';
                    optionElement.onclick = function() { selectAnswer(q.id, index); };
                });
                document.getElementById(`explanation-${q.id}`).style.display = 'none';
            });
            
            // Clear progress
            localStorage.removeItem('quiz_progress');
            document.getElementById('globalProgress').style.width = '0%';
        }

        function saveProgress() {
            const answered = Object.keys(currentAnswers).length;
            const progress = {
                answered: answered,
                total: quizData.questions.length,
                timestamp: Date.now()
            };
            
            localStorage.setItem('quiz_progress', JSON.stringify(progress));
            
            const progressPercent = (answered / quizData.questions.length) * 100;
            document.getElementById('globalProgress').style.width = progressPercent + '%';
        }

        // ==================== FIREBASE FUNCTIONS ====================
        function saveResultsToFirebase(score, correctCount, results, totalTime) {
            const resultData = {
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                studentEmail: currentStudent.email,
                quizTitle: quizData.title,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                score: score,
                correctAnswers: correctCount,
                totalQuestions: quizData.questions.length,
                totalTime: totalTime,
                answers: results
            };
            
            db.collection('quiz_results').add(resultData)
                .then(docRef => {
                    console.log('Résultats sauvegardés avec ID: ', docRef.id);
                    
                    // Update student record
                    updateStudentRecord(score, totalTime);
                    
                    // Update admin stats
                    loadGlobalStats();
                })
                .catch(error => {
                    console.error('Erreur sauvegarde: ', error);
                });
        }

        function updateStudentRecord(score, totalTime) {
            const studentRef = db.collection('students').doc(currentStudent.id);
            
            studentRef.get().then(doc => {
                if (doc.exists) {
                    // Update existing student
                    const data = doc.data();
                    const totalQuizzes = (data.totalQuizzes || 0) + 1;
                    const avgScore = ((data.avgScore || 0) * (totalQuizzes - 1) + score) / totalQuizzes;
                    const avgTime = ((data.avgTime || 0) * (totalQuizzes - 1) + totalTime) / totalQuizzes;
                    
                    studentRef.update({
                        totalQuizzes: totalQuizzes,
                        avgScore: Math.round(avgScore),
                        avgTime: Math.round(avgTime),
                        lastAttempt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Create new student
                    studentRef.set({
                        id: currentStudent.id,
                        name: currentStudent.name,
                        email: currentStudent.email,
                        totalQuizzes: 1,
                        avgScore: score,
                        avgTime: totalTime,
                        firstAttempt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastAttempt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            });
        }

        function loadGlobalStats() {
            // Load total students
            db.collection('students').get().then(snapshot => {
                document.getElementById('totalStudents').textContent = snapshot.size;
            });
            
            // Load total quizzes and average score
            db.collection('quiz_results').get().then(snapshot => {
                let totalQuizzes = 0;
                let totalScore = 0;
                let totalTime = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalQuizzes++;
                    totalScore += data.score || 0;
                    totalTime += data.totalTime || 0;
                });
                
                const avgScore = totalQuizzes > 0 ? Math.round(totalScore / totalQuizzes) : 0;
                const avgTime = totalQuizzes > 0 ? Math.round(totalTime / totalQuizzes) : 0;
                
                document.getElementById('totalQuizzes').textContent = totalQuizzes;
                document.getElementById('avgScore').textContent = avgScore + '%';
                document.getElementById('avgTime').textContent = avgTime + 's';
                
                // Load detailed results
                loadDetailedResults();
            });
        }

        function loadDetailedResults() {
            db.collection('quiz_results')
                .orderBy('date', 'desc')
                .limit(10)
                .get()
                .then(snapshot => {
                    let resultsHTML = '';
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.date?.toDate?.() || new Date();
                        const formattedDate = date.toLocaleDateString('fr-FR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        resultsHTML += `
                            <div class="student-result">
                                <strong>${data.studentName}</strong><br>
                                <small>${formattedDate}</small><br>
                                Score: <strong>${data.score}%</strong> (${data.correctAnswers}/${data.totalQuestions})<br>
                                Temps: ${data.totalTime}s
                                <button onclick="viewStudentResult('${doc.id}')" class="btn btn-sm btn-primary mt-2">
                                    Voir détails
                                </button>
                            </div>
                        `;
                    });
                    
                    document.getElementById('resultsList').innerHTML = resultsHTML;
                });
        }

        function viewStudentResult(resultId) {
            db.collection('quiz_results').doc(resultId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    alert(`Détails du résultat:\n\nÉtudiant: ${data.studentName}\nScore: ${data.score}%\nBonnes réponses: ${data.correctAnswers}/${data.totalQuestions}\nTemps: ${data.totalTime}s`);
                }
            });
        }

        // ==================== ADMIN FUNCTIONS ====================
        function showAdminModal() {
            document.getElementById('adminModal').style.display = 'flex';
        }

        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'Légende360@') {
                document.getElementById('adminModal').style.display = 'none';
                document.getElementById('quizSection').style.display = 'none';
                document.getElementById('adminSection').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                
                // Load admin data
                loadGlobalStats();
            } else {
                alert('Mot de passe incorrect!');
            }
        }

        function backToQuiz() {
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('quizSection').style.display = 'block';
        }

        function createNewExercise() {
            const title = document.getElementById('newExerciseTitle').value;
            const time = parseInt(document.getElementById('newExerciseTime').value);
            
            if (!title) {
                alert('Veuillez entrer un titre pour l\'exercice');
                return;
            }
            
            const exerciseData = {
                title: title,
                timePerQuestion: time,
                questions: quizData.questions, // Using same questions for demo
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: 'Admin'
            };
            
            db.collection('exercises').add(exerciseData)
                .then(() => {
                    alert('Exercice créé avec succès!');
                    document.getElementById('newExerciseTitle').value = '';
                })
                .catch(error => {
                    alert('Erreur: ' + error.message);
                });
        }

        // ==================== ANALYTICS ====================
        function trackEvent(eventName, eventData) {
            if (analytics) {
                analytics.logEvent(eventName, eventData);
            }
        }

        // Track page view
        trackEvent('page_view', {
            page_title: 'Quiz Français',
            student_id: currentStudent.id
        });
    </script>
</body>
</html>