<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu Multijoueur en Temps R√©el</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .player-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
        }
        
        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #6a11cb;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        
        .btn-secondary {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .game-area {
            display: none;
            margin-top: 30px;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .player-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .player-card:hover {
            transform: scale(1.05);
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
        }
        
        .control-btn {
            margin: 5px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #6a11cb;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        #gameCanvas {
            border: 3px solid #6a11cb;
            border-radius: 10px;
            background: #1a1a2e;
            margin-top: 20px;
            display: none;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }
        
        .message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 15px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Jeu Multijoueur en Temps R√©el</h1>
        
        <!-- √âcran de connexion -->
        <div id="loginScreen">
            <div class="player-info">
                <h2>üë§ Cr√©er votre profil</h2>
                <input type="text" id="playerName" placeholder="Votre pseudo (ex: Player1)" maxlength="15">
                <input type="color" id="playerColor" value="#ff4757" title="Choisir votre couleur">
            </div>
            
            <button class="btn btn-primary" onclick="createGameRoom()">
                üè† Cr√©er une partie priv√©e
            </button>
            
            <button class="btn btn-secondary" onclick="joinPublicGame()">
                üåê Rejoindre partie publique
            </button>
            
            <div style="margin-top: 20px;">
                <input type="text" id="roomCodeInput" placeholder="Code de la salle (ex: ABC123)">
                <button class="btn" onclick="joinPrivateGame()" 
                        style="background: #ff6b81; color: white;">
                    üîë Rejoindre avec code
                </button>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-value" id="onlinePlayers">0</span>
                    <span>En ligne</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="activeRooms">0</span>
                    <span>Parties</span>
                </div>
            </div>
        </div>
        
        <!-- √âcran d'attente -->
        <div id="waitingScreen" style="display: none;">
            <h2>‚è≥ En attente des joueurs...</h2>
            <div class="player-info">
                <h3>Salle: <span id="roomCodeDisplay">ABC123</span></h3>
                <p>Partagez ce code avec vos amis :</p>
                <div style="background: #f1f3f4; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <code id="shareCode" style="font-size: 24px; font-weight: bold; letter-spacing: 3px;"></code>
                </div>
                <button class="btn" onclick="copyRoomCode()" style="background: #17a2b8; color: white;">
                    üìã Copier le code
                </button>
            </div>
            
            <h3 style="margin-top: 30px;">üë• Joueurs connect√©s:</h3>
            <div id="connectedPlayers" class="players-grid"></div>
            
            <div class="controls">
                <button class="btn btn-secondary" onclick="startGame()" id="startBtn" style="display: none;">
                    ‚ñ∂Ô∏è D√©marrer la partie (2+ joueurs)
                </button>
                <button class="btn btn-danger" onclick="leaveRoom()">
                    üö™ Quitter la salle
                </button>
            </div>
        </div>
        
        <!-- √âcran de jeu -->
        <div id="gameScreen" style="display: none;">
            <h2>üéÆ Partie en cours</h2>
            
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-value" id="playerCount">0</span>
                    <span>Joueurs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="gameTimer">00:00</span>
                    <span>Temps</span>
                </div>
            </div>
            
            <div class="players-grid" id="gamePlayers"></div>
            
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            
            <div class="controls" style="margin-top: 20px;">
                <button class="control-btn" onclick="movePlayer('up')">‚¨ÜÔ∏è Haut</button>
                <button class="control-btn" onclick="movePlayer('left')">‚¨ÖÔ∏è Gauche</button>
                <button class="control-btn" onclick="movePlayer('right')">‚û°Ô∏è Droite</button>
                <button class="control-btn" onclick="movePlayer('down')">‚¨áÔ∏è Bas</button>
                <button class="btn btn-danger" onclick="leaveGame()" style="margin-top: 15px;">
                    üèÅ Quitter la partie
                </button>
            </div>
        </div>
    </div>
    
    <!-- Message de notification -->
    <div id="notification" class="message"></div>
    
    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js"></script>
    
    <script>
        // ================= CONFIGURATION FIREBASE =================
        const firebaseConfig = {
            apiKey: "AIzaSyBr8Fzdvh1En3rAxGFipOYfgr0YDeeM_Bo",
            authDomain: "match-en-ligne.firebaseapp.com",
            databaseURL: "https://match-en-ligne-default-rtdb.firebaseio.com",
            projectId: "match-en-ligne",
            storageBucket: "match-en-ligne.firebasestorage.app",
            messagingSenderId: "706011207623",
            appId: "1:706011207623:web:17374990a6202b64f0abe2",
            measurementId: "G-D9XYRE3W2M"
        };

        // Initialiser Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // ================= VARIABLES GLOBALES =================
        let playerId = null;
        let playerName = "";
        let playerColor = "#ff4757";
        let currentRoomId = null;
        let gameActive = false;
        let gameStartTime = null;
        let gameTimerInterval = null;
        let canvas, ctx;

        // ================= INITIALISATION =================
        window.onload = function() {
            // Initialiser le canvas
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Configurer la couleur par d√©faut
            document.getElementById('playerColor').addEventListener('change', function(e) {
                playerColor = e.target.value;
            });
            
            // Connexion anonyme automatique
            auth.signInAnonymously()
                .then((userCredential) => {
                    playerId = userCredential.user.uid;
                    console.log("Connect√© avec ID:", playerId);
                    updateOnlineStatus();
                })
                .catch((error) => {
                    console.error("Erreur de connexion:", error);
                });
            
            // Mettre √† jour les statistiques
            updateStats();
            setInterval(updateStats, 5000);
        };

        // ================= FONCTIONS DES BOUTONS =================

        // BOUTON 1: Cr√©er une partie priv√©e
        function createGameRoom() {
            playerName = document.getElementById('playerName').value.trim() || "Joueur" + Math.floor(Math.random() * 1000);
            playerColor = document.getElementById('playerColor').value;
            
            // G√©n√©rer un code de salle unique
            const roomCode = generateRoomCode();
            currentRoomId = roomCode;
            
            // Cr√©er la salle dans Firebase
            database.ref('rooms/' + roomCode).set({
                host: playerId,
                hostName: playerName,
                players: {
                    [playerId]: {
                        name: playerName,
                        color: playerColor,
                        score: 0,
                        x: 200,
                        y: 200,
                        online: true,
                        isHost: true
                    }
                },
                status: 'waiting',
                maxPlayers: 8,
                createdAt: Date.now(),
                isPrivate: true
            }).then(() => {
                // Afficher l'√©cran d'attente
                showScreen('waitingScreen');
                document.getElementById('roomCodeDisplay').textContent = roomCode;
                document.getElementById('shareCode').textContent = roomCode;
                
                // √âcouter les changements dans la salle
                listenToRoom(roomCode);
                
                showNotification("‚úÖ Salle cr√©√©e! Code: " + roomCode);
            }).catch(error => {
                showNotification("‚ùå Erreur: " + error.message);
            });
        }

        // BOUTON 2: Rejoindre une partie publique
        function joinPublicGame() {
            playerName = document.getElementById('playerName').value.trim() || "Joueur" + Math.floor(Math.random() * 1000);
            playerColor = document.getElementById('playerColor').value;
            
            // Chercher une salle publique avec de la place
            database.ref('rooms').once('value').then((snapshot) => {
                const rooms = snapshot.val();
                let roomFound = null;
                
                if (rooms) {
                    for (let roomId in rooms) {
                        const room = rooms[roomId];
                        const playerCount = room.players ? Object.keys(room.players).length : 0;
                        
                        // Trouver une salle publique avec de la place
                        if (!room.isPrivate && 
                            room.status === 'waiting' && 
                            playerCount < room.maxPlayers) {
                            roomFound = roomId;
                            break;
                        }
                    }
                }
                
                if (roomFound) {
                    joinRoom(roomFound);
                } else {
                    // Cr√©er une nouvelle salle publique
                    const roomCode = generateRoomCode();
                    currentRoomId = roomCode;
                    
                    database.ref('rooms/' + roomCode).set({
                        host: playerId,
                        hostName: playerName,
                        players: {
                            [playerId]: {
                                name: playerName,
                                color: playerColor,
                                score: 0,
                                x: 200,
                                y: 200,
                                online: true,
                                isHost: true
                            }
                        },
                        status: 'waiting',
                        maxPlayers: 8,
                        createdAt: Date.now(),
                        isPrivate: false
                    }).then(() => {
                        joinRoom(roomCode);
                    });
                }
            });
        }

        // BOUTON 3: Rejoindre avec un code
        function joinPrivateGame() {
            playerName = document.getElementById('playerName').value.trim() || "Joueur" + Math.floor(Math.random() * 1000);
            playerColor = document.getElementById('playerColor').value;
            
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!roomCode) {
                showNotification("‚ö†Ô∏è Entrez un code de salle");
                return;
            }
            
            joinRoom(roomCode);
        }

        // ================= FONCTIONS DE SALLE =================

        function joinRoom(roomCode) {
            currentRoomId = roomCode;
            
            // V√©rifier si la salle existe
            database.ref('rooms/' + roomCode).once('value').then((snapshot) => {
                const room = snapshot.val();
                
                if (!room) {
                    showNotification("‚ùå Salle introuvable");
                    return;
                }
                
                const playerCount = room.players ? Object.keys(room.players).length : 0;
                
                if (playerCount >= room.maxPlayers) {
                    showNotification("‚ùå Salle compl√®te");
                    return;
                }
                
                if (room.status !== 'waiting') {
                    showNotification("‚ùå Partie d√©j√† en cours");
                    return;
                }
                
                // Rejoindre la salle
                database.ref('rooms/' + roomCode + '/players/' + playerId).set({
                    name: playerName,
                    color: playerColor,
                    score: 0,
                    x: Math.random() * 300 + 50,
                    y: Math.random() * 300 + 50,
                    online: true,
                    isHost: false,
                    joinedAt: Date.now()
                }).then(() => {
                    // Afficher l'√©cran d'attente ou de jeu
                    if (room.status === 'waiting') {
                        showScreen('waitingScreen');
                        document.getElementById('roomCodeDisplay').textContent = roomCode;
                        document.getElementById('shareCode').textContent = roomCode;
                        listenToRoom(roomCode);
                    } else {
                        showScreen('gameScreen');
                        startGameVisual();
                    }
                    
                    showNotification("‚úÖ Connect√© √† la salle " + roomCode);
                });
            });
        }

        function listenToRoom(roomCode) {
            // √âcouter les changements dans la salle
            database.ref('rooms/' + roomCode).on('value', (snapshot) => {
                const room = snapshot.val();
                
                if (!room) {
                    showNotification("La salle a √©t√© ferm√©e");
                    leaveRoom();
                    return;
                }
                
                // Mettre √† jour la liste des joueurs
                updatePlayerList(room.players || {});
                
                // Afficher/masquer le bouton d√©marrer
                const playerCount = room.players ? Object.keys(room.players).length : 0;
                const startBtn = document.getElementById('startBtn');
                
                if (room.host === playerId && playerCount >= 2) {
                    startBtn.style.display = 'block';
                } else {
                    startBtn.style.display = 'none';
                }
                
                // Si le jeu d√©marre
                if (room.status === 'playing' && !gameActive) {
                    gameActive = true;
                    showScreen('gameScreen');
                    startGameVisual();
                }
            });
        }

        // BOUTON: D√©marrer la partie
        function startGame() {
            if (!currentRoomId) return;
            
            // Changer le statut de la salle
            database.ref('rooms/' + currentRoomId).update({
                status: 'playing',
                startedAt: Date.now()
            }).then(() => {
                gameStartTime = Date.now();
                startGameTimer();
                showNotification("üéÆ La partie commence!");
            });
        }

        // BOUTON: Quitter la salle
        function leaveRoom() {
            if (currentRoomId && playerId) {
                // Retirer le joueur de la salle
                database.ref('rooms/' + currentRoomId + '/players/' + playerId).remove().then(() => {
                    // V√©rifier si la salle est vide
                    database.ref('rooms/' + currentRoomId + '/players').once('value').then((snapshot) => {
                        if (!snapshot.exists() || snapshot.numChildren() === 0) {
                            // Supprimer la salle si vide
                            database.ref('rooms/' + currentRoomId).remove();
                        }
                    });
                });
            }
            
            resetGame();
            showScreen('loginScreen');
            showNotification("üëã Vous avez quitt√© la salle");
        }

        // BOUTON: Quitter la partie
        function leaveGame() {
            leaveRoom();
        }

        // ================= FONCTIONS DE JEU =================

        function startGameVisual() {
            // Afficher le canvas
            canvas.style.display = 'block';
            
            // D√©marrer la boucle de jeu
            requestAnimationFrame(gameLoop);
            
            // √âcouter les positions des joueurs
            database.ref('rooms/' + currentRoomId + '/players').on('value', (snapshot) => {
                const players = snapshot.val();
                updateGamePlayers(players || {});
            });
        }

        function gameLoop() {
            if (!gameActive) return;
            
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dessiner l'arri√®re-plan
            drawBackground();
            
            // Dessiner tous les joueurs
            database.ref('rooms/' + currentRoomId + '/players').once('value').then((snapshot) => {
                const players = snapshot.val();
                if (players) {
                    for (let id in players) {
                        const player = players[id];
                        if (player.online) {
                            drawPlayer(player);
                        }
                    }
                }
            });
            
            // Continuer la boucle
            requestAnimationFrame(gameLoop);
        }

        function drawBackground() {
            // D√©grad√© de fond
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Grille
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function drawPlayer(player) {
            // Corps du joueur
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Bordure
            ctx.strokeStyle = player.id === playerId ? '#00ff00' : '#ffffff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(player.x, player.y, 18, 0, Math.PI * 2);
            ctx.stroke();
            
            // Nom
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(player.name, player.x, player.y - 25);
            
            // Score
            ctx.fillStyle = 'yellow';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(player.score.toString(), player.x, player.y + 5);
        }

        // BOUTONS de d√©placement
        function movePlayer(direction) {
            if (!currentRoomId || !playerId || !gameActive) return;
            
            database.ref('rooms/' + currentRoomId + '/players/' + playerId).once('value').then((snapshot) => {
                const player = snapshot.val();
                if (!player) return;
                
                let newX = player.x;
                let newY = player.y;
                const moveAmount = 20;
                
                switch(direction) {
                    case 'up': newY -= moveAmount; break;
                    case 'down': newY += moveAmount; break;
                    case 'left': newX -= moveAmount; break;
                    case 'right': newX += moveAmount; break;
                }
                
                // Limites du canvas
                newX = Math.max(15, Math.min(canvas.width - 15, newX));
                newY = Math.max(15, Math.min(canvas.height - 15, newY));
                
                // Mettre √† jour la position
                database.ref('rooms/' + currentRoomId + '/players/' + playerId).update({
                    x: newX,
                    y: newY,
                    lastMove: Date.now()
                });
            });
        }

        // ================= FONCTIONS UTILITAIRES =================

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function updatePlayerList(players) {
            const container = document.getElementById('connectedPlayers');
            container.innerHTML = '';
            
            let playerCount = 0;
            
            for (let id in players) {
                const player = players[id];
                if (player.online) {
                    playerCount++;
                    
                    const playerCard = document.createElement('div');
                    playerCard.className = 'player-card';
                    playerCard.innerHTML = `
                        <div class="player-avatar" style="background: ${player.color}">
                            ${player.name.charAt(0).toUpperCase()}
                        </div>
                        <h4>${player.name}</h4>
                        <div class="status status-online">‚úÖ En ligne</div>
                        ${player.isHost ? '<div style="color: #ff6b6b; margin-top: 5px;">üëë H√¥te</div>' : ''}
                    `;
                    
                    container.appendChild(playerCard);
                }
            }
            
            // Mettre √† jour le compteur
            document.getElementById('playerCount').textContent = playerCount;
            
            // Si moins de 2 joueurs, cacher le bouton d√©marrer
            if (playerCount < 2) {
                document.getElementById('startBtn').style.display = 'none';
            }
        }

        function updateGamePlayers(players) {
            const container = document.getElementById('gamePlayers');
            container.innerHTML = '';
            
            let playerCount = 0;
            
            for (let id in players) {
                const player = players[id];
                playerCount++;
                
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.innerHTML = `
                    <div class="player-avatar" style="background: ${player.color}">
                        ${player.name.charAt(0).toUpperCase()}
                    </div>
                    <h4>${player.name} ${id === playerId ? '(Vous)' : ''}</h4>
                    <div style="font-size: 24px; font-weight: bold; color: #ffd700;">
                        ${player.score} pts
                    </div>
                    <div class="status ${player.online ? 'status-online' : 'status-offline'}">
                        ${player.online ? '‚úÖ En ligne' : '‚ùå Hors ligne'}
                    </div>
                `;
                
                container.appendChild(playerCard);
            }
            
            document.getElementById('playerCount').textContent = playerCount;
        }

        function startGameTimer() {
            clearInterval(gameTimerInterval);
            gameTimerInterval = setInterval(() => {
                if (!gameStartTime) return;
                
                const elapsed = Date.now() - gameStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('gameTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function updateOnlineStatus() {
            if (!playerId) return;
            
            // Mettre √† jour le statut en ligne
            database.ref('online/' + playerId).set({
                name: playerName || "Anonyme",
                lastSeen: Date.now()
            });
            
            // Nettoyer quand le joueur quitte
            window.addEventListener('beforeunload', () => {
                if (playerId) {
                    database.ref('online/' + playerId).remove();
                }
            });
        }

        function updateStats() {
            // Compter les joueurs en ligne
            database.ref('online').once('value').then((snapshot) => {
                const online = snapshot.val();
                const count = online ? Object.keys(online).length : 0;
                document.getElementById('onlinePlayers').textContent = count;
            });
            
            // Compter les salles actives
            database.ref('rooms').once('value').then((snapshot) => {
                const rooms = snapshot.val();
                let activeCount = 0;
                
                if (rooms) {
                    for (let roomId in rooms) {
                        if (rooms[roomId].status === 'waiting' || rooms[roomId].status === 'playing') {
                            activeCount++;
                        }
                    }
                }
                
                document.getElementById('activeRooms').textContent = activeCount;
            });
        }

        function showScreen(screenName) {
            // Masquer tous les √©crans
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('waitingScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            
            // Afficher l'√©cran demand√©
            document.getElementById(screenName).style.display = 'block';
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function copyRoomCode() {
            const code = document.getElementById('shareCode').textContent;
            navigator.clipboard.writeText(code)
                .then(() => showNotification("‚úÖ Code copi√© dans le presse-papier!"))
                .catch(() => showNotification("‚ùå Erreur lors de la copie"));
        }

        function resetGame() {
            gameActive = false;
            currentRoomId = null;
            clearInterval(gameTimerInterval);
            canvas.style.display = 'none';
            
            // Arr√™ter les √©couteurs Firebase
            if (currentRoomId) {
                database.ref('rooms/' + currentRoomId).off();
                database.ref('rooms/' + currentRoomId + '/players').off();
            }
        }

        // ================= CONTROLES CLAVIER =================
        document.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            
            switch(e.key) {
                case 'ArrowUp': movePlayer('up'); break;
                case 'ArrowDown': movePlayer('down'); break;
                case 'ArrowLeft': movePlayer('left'); break;
                case 'ArrowRight': movePlayer('right'); break;
                case 'w': case 'W': movePlayer('up'); break;
                case 's': case 'S': movePlayer('down'); break;
                case 'a': case 'A': movePlayer('left'); break;
                case 'd': case 'D': movePlayer('right'); break;
            }
        });
    </script>
</body>
</html>
