
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó≥Ô∏è Syst√®me de Vote S√âCURIS√â - √âlections 2024</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Tout le CSS reste identique - trop long pour r√©p√©ter] */
        /* Gardez exactement le m√™me CSS que dans le code pr√©c√©dent */
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> SYST√àME DE VOTE S√âCURIS√â</h1>
            <p>Un vote = Un code = Une seule fois ‚Ä¢ Syst√®me inviolable</p>
            <p class="header-badge"><i class="fas fa-user-lock"></i> Authentification forte ‚Ä¢ Vote unique ‚Ä¢ Audit complet</p>
        </div>
        
        <!-- Code Section -->
        <div id="codeSection" class="section active">
            <h2 class="section-title"><i class="fas fa-fingerprint"></i> AUTHENTIFICATION STRICTE</h2>
            
            <div id="alertCode" class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> <span id="alertText"></span>
            </div>
            
            <div class="code-container">
                <div class="code-input-group">
                    <input type="text" id="voteCode" class="code-input" 
                           placeholder="Entrez votre code personnel unique" 
                           maxlength="10" autocomplete="off" autofocus>
                    <button id="validateCode" class="btn btn-primary">
                        <i class="fas fa-user-check"></i> V√âRIFIER L'IDENTIT√â
                    </button>
                </div>
                
                <div class="code-hint">
                    <i class="fas fa-info-circle"></i> Exemple de code valide : <strong>K7P4J9M2N6</strong>
                    <br><small>Chaque code ne peut √™tre utilis√© qu'une seule fois</small>
                </div>
            </div>
            
            <div style="background: rgba(67, 97, 238, 0.05); padding: 25px; border-radius: 12px; margin-top: 30px; border-left: 4px solid var(--primary);">
                <h3 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-lock"></i> GARANTIES DE S√âCURIT√â
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: var(--success); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>1 code = 1 vote unique</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: var(--success); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Impossible de voter sans code</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: var(--success); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Codes invalid√©s apr√®s usage</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="background: var(--success); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Session unique par code</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Voting Section -->
        <div id="votingSection" class="section">
            <h2 class="section-title"><i class="fas fa-vote-yea"></i> VOTE D√âFINITIF</h2>
            
            <div style="background: linear-gradient(45deg, #d4efdf, #a3e4c1); padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid var(--success);">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <strong><i class="fas fa-user-shield"></i> IDENTIT√â V√âRIFI√âE</strong>
                        <p style="margin: 5px 0 0 0; color: #27ae60;">Code : <span id="currentCodeDisplay" style="font-family: monospace; font-weight: bold;"></span></p>
                    </div>
                    <div id="sessionTimer" style="background: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; color: var(--primary);">
                        <i class="fas fa-clock"></i> Session : 05:00
                    </div>
                </div>
            </div>
            
            <div id="alertVote" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> S√©lectionnez un candidat avant de valider.
            </div>
            
            <div class="candidates-grid" id="candidatesContainer">
                <!-- G√©n√©r√© par JavaScript -->
            </div>
            
            <div style="text-align: center; margin-top: 50px; padding-top: 30px; border-top: 2px solid #f0f0f0;">
                <button id="submitVote" class="btn btn-success" style="padding: 20px 60px; font-size: 1.2rem;">
                    <i class="fas fa-check-double"></i> VALIDER MON VOTE D√âFINITIF
                </button>
                <button id="cancelVote" class="btn btn-danger" style="margin-left: 20px;">
                    <i class="fas fa-times"></i> ANNULER
                </button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="section">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> R√âSULTATS OFFICIELS</h2>
            
            <div class="results-stats" id="resultsStats">
                <!-- G√©n√©r√© dynamiquement -->
            </div>
            
            <div class="results-container">
                <canvas id="resultsChart" width="400" height="200"></canvas>
            </div>
            
            <div style="overflow-x: auto; margin-top: 40px;">
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Candidat</th>
                            <th>Parti</th>
                            <th>Votes</th>
                            <th>%</th>
                            <th>Progression</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- G√©n√©r√© dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Vote Confirmed Section -->
        <div id="voteConfirmedSection" class="section">
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 6rem; color: var(--success); margin-bottom: 30px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h1 style="color: var(--primary); margin-bottom: 20px;">VOTE ENREGISTR√â !</h1>
                <p style="font-size: 1.2rem; color: #666; max-width: 600px; margin: 0 auto 40px; line-height: 1.6;">
                    Votre vote a √©t√© valid√© avec succ√®s et est d√©sormais d√©finitif.
                </p>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; max-width: 500px; margin: 0 auto 40px; text-align: left;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">
                        <i class="fas fa-receipt"></i> RECONNAISSANCE DE VOTE
                    </h3>
                    <div style="margin-bottom: 15px;">
                        <strong>Code utilis√© :</strong> 
                        <span id="receiptCode" style="font-family: monospace; background: #eee; padding: 5px 10px; border-radius: 4px; margin-left: 10px;"></span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Candidat choisi :</strong> 
                        <span id="receiptCandidate" style="font-weight: bold; color: var(--primary); margin-left: 10px;"></span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Heure du vote :</strong> 
                        <span id="receiptTime" style="margin-left: 10px;"></span>
                    </div>
                    <div>
                        <strong>Code de v√©rification :</strong> 
                        <span id="receiptVerification" style="font-family: monospace; font-weight: bold; color: var(--success); margin-left: 10px;"></span>
                    </div>
                </div>
                
                <button id="viewResultsBtn" class="btn btn-primary" style="padding: 15px 40px;">
                    <i class="fas fa-chart-bar"></i> VOIR LES R√âSULTATS
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript CORRIG√â - VOICI LA SOLUTION -->
    <script>
        // ============================================
        // SYST√àME DE VOTE S√âCURIS√â - VERSION CORRIG√âE
        // ============================================
        
        // Classe de gestion de la base de donn√©es S√âCURIS√âE
        class SecureVoteDatabase {
            constructor() {
                this.STORAGE_KEY = 'secure_voting_system_2024';
                this.USED_CODES_KEY = 'used_vote_codes_2024';
                this.SESSION_KEY = 'voting_session_2024';
                this.initSecureDatabase();
            }
            
            initSecureDatabase() {
                // Initialiser si vide
                if (!localStorage.getItem(this.STORAGE_KEY)) {
                    const initialData = {
                        votes: Array(10).fill(0),
                        totalVotes: 0,
                        voters: {},
                        sessionCount: 0,
                        lastUpdated: new Date().toISOString(),
                        securityHash: this.generateSecurityHash()
                    };
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(initialData));
                    localStorage.setItem(this.USED_CODES_KEY, JSON.stringify([]));
                }
            }
            
            // V√âRIFICATION STRICTE du code
            verifyVoteCode(code) {
                const usedCodes = JSON.parse(localStorage.getItem(this.USED_CODES_KEY) || '[]');
                const data = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
                
                // V√©rifier si le code est d√©j√† utilis√©
                if (usedCodes.includes(code)) {
                    return { valid: false, reason: 'Ce code a d√©j√† √©t√© utilis√© pour voter.' };
                }
                
                // V√©rifier si le code existe dans la liste
                if (!validCodes.includes(code)) {
                    return { valid: false, reason: 'Code invalide.' };
                }
                
                // V√©rifier si l'utilisateur a d√©j√† une session active
                if (sessionStorage.getItem('current_vote_code') === code) {
                    return { valid: true, reason: 'Session d√©j√† active.' };
                }
                
                return { valid: true, reason: 'Code valide.' };
            }
            
            // ENREGISTREMENT S√âCURIS√â du vote
            registerVote(code, candidateId) {
                // 1. V√©rifier √† nouveau le code (double v√©rification)
                const verification = this.verifyVoteCode(code);
                if (!verification.valid) {
                    throw new Error(verification.reason);
                }
                
                // 2. R√©cup√©rer les donn√©es
                const data = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
                const usedCodes = JSON.parse(localStorage.getItem(this.USED_CODES_KEY) || '[]');
                
                // 3. Enregistrer le vote
                data.votes[candidateId - 1]++;
                data.totalVotes++;
                data.voters[code] = {
                    candidate: candidateId,
                    timestamp: new Date().toISOString(),
                    ip: 'anonymous'
                };
                data.sessionCount++;
                data.lastUpdated = new Date().toISOString();
                data.securityHash = this.generateSecurityHash();
                
                // 4. Marquer le code comme utilis√©
                if (!usedCodes.includes(code)) {
                    usedCodes.push(code);
                }
                
                // 5. Sauvegarder
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                localStorage.setItem(this.USED_CODES_KEY, JSON.stringify(usedCodes));
                
                // 6. Cr√©er une session de vote
                sessionStorage.setItem('has_voted', 'true');
                sessionStorage.setItem('vote_code', code);
                sessionStorage.setItem('vote_candidate', candidateId.toString());
                sessionStorage.setItem('vote_timestamp', new Date().toISOString());
                
                // 7. Cookie de sauvegarde
                this.createSecureBackup();
                
                return {
                    success: true,
                    voteId: Date.now().toString(36).toUpperCase(),
                    timestamp: new Date().toISOString()
                };
            }
            
            // R√âCUP√âRATION des votes (lecture seule)
            getVotes() {
                const data = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
                return data.votes;
            }
            
            getStatistics() {
                const data = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
                return {
                    totalVotes: data.totalVotes,
                    votes: data.votes,
                    lastUpdated: data.lastUpdated,
                    sessionCount: data.sessionCount,
                    securityHash: data.securityHash
                };
            }
            
            // V√âRIFICATION si un code a √©t√© utilis√©
            isCodeUsed(code) {
                const usedCodes = JSON.parse(localStorage.getItem(this.USED_CODES_KEY) || '[]');
                return usedCodes.includes(code);
            }
            
            // S√âCURIT√â : Hash de v√©rification
            generateSecurityHash() {
                const data = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
                const str = data.votes.join('') + data.totalVotes + Date.now();
                return btoa(str).substring(0, 32);
            }
            
            // SAUVEGARDE S√âCURIS√âE
            createSecureBackup() {
                const data = JSON.parse(localStorage.getItem(this.STORAGE_KEY));
                const backup = {
                    votes: data.votes,
                    total: data.totalVotes,
                    hash: data.securityHash,
                    timestamp: new Date().toISOString()
                };
                
                // Stockage multi-couches
                try {
                    // Couche 1: Cookies
                    document.cookie = `vote_backup=${JSON.stringify(backup)}; max-age=604800; path=/; secure; samesite=strict`;
                    
                    // Couche 2: IndexedDB (si disponible)
                    if ('indexedDB' in window) {
                        this.saveToIndexedDB(backup);
                    }
                } catch (e) {
                    console.warn('Sauvegarde √©chou√©e:', e);
                }
            }
            
            saveToIndexedDB(backup) {
                const request = indexedDB.open('VoteBackupDB', 1);
                
                request.onupgradeneeded = function(e) {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('backups')) {
                        db.createObjectStore('backups', { keyPath: 'timestamp' });
                    }
                };
                
                request.onsuccess = function(e) {
                    const db = e.target.result;
                    const transaction = db.transaction(['backups'], 'readwrite');
                    const store = transaction.objectStore('backups');
                    store.put(backup);
                };
            }
            
            // R√âINITIALISATION (pour tests uniquement)
            resetForTesting() {
                localStorage.removeItem(this.STORAGE_KEY);
                localStorage.removeItem(this.USED_CODES_KEY);
                sessionStorage.clear();
                this.initSecureDatabase();
                alert('Syst√®me r√©initialis√© pour tests');
            }
        }
        
        // ============================================
        // DONN√âES STATIQUES
        // ============================================
        
        const candidates = [
            { id: 1, name: "Marie Dubois", party: "Parti Progressiste", color: "#3498db" },
            { id: 2, name: "Jean Martin", party: "Alliance D√©mocratique", color: "#2ecc71" },
            { id: 3, name: "Sophie Bernard", party: "Mouvement √âcologique", color: "#1abc9c" },
            { id: 4, name: "Thomas Leroy", party: "Union R√©publicaine", color: "#e74c3c" },
            { id: 5, name: "Camille Petit", party: "Parti Social", color: "#9b59b6" },
            { id: 6, name: "Alexandre Moreau", party: "Centre Lib√©ral", color: "#f39c12" },
            { id: 7, name: "Julie Fontaine", party: "Parti des R√©gions", color: "#d35400" },
            { id: 8, name: "Mohamed Ali", party: "Diversit√© et Progr√®s", color: "#34495e" },
            { id: 9, name: "Isabelle Lambert", party: "Parti de la Famille", color: "#16a085" },
            { id: 10, name: "Pierre Garnier", party: "Nouvelle Vision", color: "#8e44ad" }
        ];
        
        // CODES DE VOTE VALIDES (150 codes)
        const validCodes = [
            "K7P4J9M2N6", "Q1R8S3T5V9", "W2X4Y6Z7B8", "C3D5F7G9H2", "J4K6L8M1N3",
            "P5Q7R9S2T4", "V6W8X1Y3Z5", "B7C9D2F4G6", "H8J1K3L5M7", "N9P2Q4R6S8",
            "T1V3W5X7Y9", "Z2B4C6D8F1", "G3H5J7K9L2", "M4N6P8Q1R3", "S5T7V9W2X4",
            "Y6Z8B1C3D5", "F7G9H2J4K6", "L8M1N3P5Q7", "R9S2T4V6W8", "X1Y3Z5B7C9",
            "D2F4G6H8J1", "K3L5M7N9P2", "Q4R6S8T1V3", "W5X7Y9Z2B4", "C6D8F1G3H5",
            "J7K9L2M4N6", "P8Q1R3S5T7", "V9W2X4Y6Z8", "B1C3D5F7G9", "H2J4K6L8M1",
            "N3P5Q7R9S2", "T4V6W8X1Y3", "Z5B7C9D2F4", "G6H8J1K3L5", "M7N9P2Q4R6",
            "S8T1V3W5X7", "Y9Z2B4C6D8", "F1G3H5J7K9", "L2M4N6P8Q1", "R3S5T7V9W2",
            "X4Y6Z8B1C3", "D5F7G9H2J4", "K6L8M1N3P5", "Q7R9S2T4V6", "W8X1Y3Z5B7",
            "C9D2F4G6H8", "J1K3L5M7N9", "P2Q4R6S8T1", "V3W5X7Y9Z2", "B4C6D8F1G3",
            "H5J7K9L2M4", "N6P8Q1R3S5", "T7V9W2X4Y6", "Z8B1C3D5F7", "G9H2J4K6L8",
            "M1N3P5Q7R9", "S2T4V6W8X1", "Y3Z5B7C9D2", "F4G6H8J1K3", "L5M7N9P2Q4",
            "R6S8T1V3W5", "X7Y9Z2B4C6", "D8F1G3H5J7", "K9L2M4N6P8", "Q1R3S5T7V9",
            "W2X4Y6Z8B1", "C3D5F7G9H2", "J4K6L8M1N3", "P5Q7R9S2T4", "V6W8X1Y3Z5",
            "B7C9D2F4G6", "H8J1K3L5M7", "N9P2Q4R6S8", "T1V3W5X7Y9", "Z2B4C6D8F1",
            "G3H5J7K9L2", "M4N6P8Q1R3", "S5T7V9W2X4", "Y6Z8B1C3D5", "F7G9H2J4K6",
            "L8M1N3P5Q7", "R9S2T4V6W8", "X1Y3Z5B7C9", "D2F4G6H8J1", "K3L5M7N9P2",
            "Q4R6S8T1V3", "W5X7Y9Z2B4", "C6D8F1G3H5", "J7K9L2M4N6", "P8Q1R3S5T7",
            "V9W2X4Y6Z8", "B1C3D5F7G9", "H2J4K6L8M1", "N3P5Q7R9S2", "T4V6W8X1Y3",
            "Z5B7C9D2F4", "G6H8J1K3L5", "M7N9P2Q4R6", "S8T1V3W5X7", "Y9Z2B4C6D8",
            "F1G3H5J7K9", "L2M4N6P8Q1", "R3S5T7V9W2", "X4Y6Z8B1C3", "D5F7G9H2J4",
            "K6L8M1N3P5", "Q7R9S2T4V6", "W8X1Y3Z5B7", "C9D2F4G6H8", "J1K3L5M7N9",
            "P2Q4R6S8T1", "V3W5X7Y9Z2", "B4C6D8F1G3", "H5J7K9L2M4", "N6P8Q1R3S5",
            "T7V9W2X4Y6", "Z8B1C3D5F7", "G9H2J4K6L8", "M1N3P5Q7R9", "S2T4V6W8X1",
            "Y3Z5B7C9D2", "F4G6H8J1K3", "L5M7N9P2Q4", "R6S8T1V3W5", "X7Y9Z2B4C6",
            "D8F1G3H5J7", "K9L2M4N6P8", "Q1R3S5T7V9", "W2X4Y6Z8B1", "C3D5F7G9H2",
            "J4K6L8M1N3", "P5Q7R9S2T4", "V6W8X1Y3Z5", "B7C9D2F4G6", "H8J1K3L5M7",
            "N9P2Q4R6S8", "T1V3W5X7Y9", "Z2B4C6D8F1", "G3H5J7K9L2", "M4N6P8Q1R3",
            "S5T7V9W2X4", "Y6Z8B1C3D5", "F7G9H2J4K6", "L8M1N3P5Q7", "R9S2T4V6W8"
        ];
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        
        const db = new SecureVoteDatabase();
        let selectedCandidate = null;
        let currentVoteCode = null;
        let sessionTimer = null;
        let timeLeft = 300; // 5 minutes en secondes
        
        // ============================================
        // INITIALISATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // V√©rifier l'√©tat de la session
            checkSessionState();
            
            // Initialiser l'interface
            initInterface();
            
            // Configurer les √©v√©nements
            setupEventHandlers();
        });
        
        function checkSessionState() {
            // Si l'utilisateur a d√©j√† vot√© dans cette session
            if (sessionStorage.getItem('has_voted') === 'true') {
                showVoteConfirmed();
                return;
            }
            
            // Si une session est en cours
            const activeCode = sessionStorage.getItem('current_vote_code');
            if (activeCode) {
                currentVoteCode = activeCode;
                showSection('votingSection');
                startSessionTimer();
                updateCodeDisplay();
            }
        }
        
        function initInterface() {
            generateCandidates();
            
            // Masquer toutes les sections sauf codeSection
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById('codeSection').style.display = 'block';
        }
        
        function setupEventHandlers() {
            // Validation du code
            document.getElementById('validateCode').addEventListener('click', validateVoteCode);
            document.getElementById('voteCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') validateVoteCode();
            });
            
            // Blocage du copier-coller
            document.getElementById('voteCode').addEventListener('paste', function(e) {
                e.preventDefault();
                showAlert('‚ö†Ô∏è Le collage est d√©sactiv√© pour des raisons de s√©curit√©.', 'warning');
            });
            
            // Soumission du vote
            document.getElementById('submitVote').addEventListener('click', submitVote);
            
            // Annulation
            document.getElementById('cancelVote').addEventListener('click', function() {
                if (confirm('√ätes-vous s√ªr de vouloir annuler votre vote ?')) {
                    resetVotingSession();
                    showSection('codeSection');
                }
            });
            
            // Navigation
            document.getElementById('viewResultsBtn').addEventListener('click', function() {
                showResults();
            });
            
            // Protection F5/Ctrl+R
            window.addEventListener('beforeunload', function(e) {
                if (currentVoteCode && !sessionStorage.getItem('has_voted')) {
                    db.createSecureBackup();
                }
            });
        }
        
        // ============================================
        // FONCTIONS PRINCIPALES CORRIG√âES
        // ============================================
        
        function validateVoteCode() {
            const codeInput = document.getElementById('voteCode');
            const code = codeInput.value.trim().toUpperCase();
            
            // Validation de base
            if (!code) {
                showAlert('Veuillez entrer votre code de vote.', 'danger');
                codeInput.focus();
                return;
            }
            
            if (code.length !== 10) {
                showAlert('Le code doit contenir exactement 10 caract√®res.', 'danger');
                return;
            }
            
            // V√âRIFICATION STRICTE
            const verification = db.verifyVoteCode(code);
            
            if (!verification.valid) {
                showAlert(verification.reason, 'danger');
                
                // Effacer le champ apr√®s une erreur
                if (verification.reason.includes('d√©j√† √©t√© utilis√©')) {
                    codeInput.value = '';
                }
                return;
            }
            
            // CODE VALIDE - D√©marrer une nouvelle session
            currentVoteCode = code;
            sessionStorage.setItem('current_vote_code', code);
            
            showAlert('‚úÖ Code valid√© ! Vous pouvez maintenant voter.', 'success');
            
            // Transition vers la section de vote
            setTimeout(() => {
                hideAlert();
                showSection('votingSection');
                updateCodeDisplay();
                startSessionTimer();
                resetCandidateSelection();
            }, 1500);
        }
        
        function submitVote() {
            // V√©rifications finales
            if (!selectedCandidate) {
                showAlert('Veuillez s√©lectionner un candidat.', 'warning', 'votingSection');
                return;
            }
            
            if (!currentVoteCode) {
                showAlert('Session invalide. Veuillez recommencer.', 'danger');
                showSection('codeSection');
                return;
            }
            
            // Confirmation finale
            const candidate = candidates.find(c => c.id === selectedCandidate);
            const confirmation = confirm(
                `CONFIRMATION FINALE\n\n` +
                `Vous √™tes sur le point de voter pour :\n` +
                `üë§ ${candidate.name}\n` +
                `üèõÔ∏è ${candidate.party}\n\n` +
                `Cette action est IRR√âVERSIBLE.\n` +
                `Votre code ${currentVoteCode} sera invalid√©.\n\n` +
                `Confirmez-vous votre choix ?`
            );
            
            if (!confirmation) return;
            
            // Enregistrement s√©curis√©
            try {
                const result = db.registerVote(currentVoteCode, selectedCandidate);
                
                if (result.success) {
                    // Nettoyer la session
                    clearSessionTimer();
                    sessionStorage.removeItem('current_vote_code');
                    
                    // Afficher la confirmation
                    showVoteConfirmed(result.voteId);
                    
                    // Mettre √† jour l'affichage du re√ßu
                    updateReceiptDetails(candidate, result);
                }
            } catch (error) {
                showAlert(`Erreur : ${error.message}`, 'danger');
                console.error('Erreur d\'enregistrement:', error);
            }
        }
        
        // ============================================
        // GESTION DE LA SESSION
        // ============================================
        
        function startSessionTimer() {
            clearSessionTimer();
            timeLeft = 300; // 5 minutes
            
            sessionTimer = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('sessionTimer').innerHTML = 
                    `<i class="fas fa-clock"></i> Session : ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearSessionTimer();
                    showAlert('‚è∞ Session expir√©e. Veuillez recommencer.', 'warning');
                    resetVotingSession();
                    showSection('codeSection');
                }
            }, 1000);
        }
        
        function clearSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }
        
        function resetVotingSession() {
            currentVoteCode = null;
            selectedCandidate = null;
            sessionStorage.removeItem('current_vote_code');
            clearSessionTimer();
            
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        
        // ============================================
        // FONCTIONS D'AFFICHAGE
        // ============================================
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
                
                // Animation d'entr√©e
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    section.style.transition = 'all 0.5s ease';
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, 10);
            }
            
            // Masquer les alertes
            hideAlert();
        }
        
        function showVoteConfirmed(voteId) {
            showSection('voteConfirmedSection');
            
            // D√©sactiver le code utilis√©
            const usedCodes = JSON.parse(localStorage.getItem('used_vote_codes_2024') || '[]');
            if (!usedCodes.includes(currentVoteCode)) {
                usedCodes.push(currentVoteCode);
                localStorage.setItem('used_vote_codes_2024', JSON.stringify(usedCodes));
            }
        }
        
        function showResults() {
            showSection('resultsSection');
            
            const stats = db.getStatistics();
            
            // Mettre √† jour les statistiques
            document.getElementById('resultsStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalVotes}</div>
                    <div class="stat-label">Votes Totaux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.sessionCount}</div>
                    <div class="stat-label">Sessions</div>

</div>
                <div class="stat-card">
                    <div class="stat-value">${candidates.length}</div>
                    <div class="stat-label">Candidats</div>
                </div>
            `;
            
            // Mettre √† jour le tableau
            const resultsBody = document.getElementById('resultsBody');
            resultsBody.innerHTML = '';
            
            const totalVotes = stats.votes.reduce((a, b) => a + b, 0);
            
            candidates.forEach((candidate, index) => {
                const voteCount = stats.votes[index];
                const percentage = totalVotes > 0 ? ((voteCount / totalVotes) * 100).toFixed(1) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 20px; height: 20px; background: ${candidate.color}; border-radius: 4px;"></div>
                            <strong>${candidate.name}</strong>
                        </div>
                    </td>
                    <td>${candidate.party}</td>
                    <td><strong style="font-size: 1.2rem;">${voteCount}</strong></td>
                    <td><strong style="color: ${candidate.color};">${percentage}%</strong></td>
                    <td>
                        <div class="vote-progress">
                            <div class="vote-progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    </td>
                `;
                resultsBody.appendChild(row);
            });
        }
        
        function updateCodeDisplay() {
            if (currentVoteCode) {
                // Afficher les 3 premiers et 3 derniers caract√®res seulement
                const maskedCode = currentVoteCode.substring(0, 3) + 
                                  '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + 
                                  currentVoteCode.substring(7);
                document.getElementById('currentCodeDisplay').textContent = maskedCode;
            }
        }
        
        function updateReceiptDetails(candidate, voteResult) {
            document.getElementById('receiptCode').textContent = currentVoteCode;
            document.getElementById('receiptCandidate').textContent = `${candidate.name} (${candidate.party})`;
            document.getElementById('receiptTime').textContent = new Date(voteResult.timestamp).toLocaleString('fr-FR');
            document.getElementById('receiptVerification').textContent = voteResult.voteId;
        }
        
        function generateCandidates() {
            const container = document.getElementById('candidatesContainer');
            container.innerHTML = '';
            
            candidates.forEach((candidate, index) => {
                const card = document.createElement('div');
                card.className = 'candidate-card';
                card.dataset.id = candidate.id;
                
                // G√©n√©rer les initiales
                const initials = candidate.name.split(' ')
                    .map(name => name[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
                
                card.innerHTML = `
                    <div class="candidate-number">${index + 1}</div>
                    <div class="candidate-avatar" style="background: linear-gradient(45deg, ${candidate.color}, ${candidate.color}99);">
                        ${initials}
                    </div>
                    <div class="candidate-name">${candidate.name}</div>
                    <div class="candidate-party">${candidate.party}</div>
                    <div class="candidate-description">${candidatesDescriptions[index] || candidate.description}</div>
                `;
                
                card.addEventListener('click', function() {
                    selectCandidate(candidate.id);
                });
                
                container.appendChild(card);
            });
        }
        
        function selectCandidate(candidateId) {
            // D√©s√©lectionner tous
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // S√©lectionner le nouveau
            const selectedCard = document.querySelector(`.candidate-card[data-id="${candidateId}"]`);
            selectedCard.classList.add('selected');
            
            selectedCandidate = candidateId;
            
            // Masquer l'alerte
            document.getElementById('alertVote').style.display = 'none';
        }
        
        function resetCandidateSelection() {
            selectedCandidate = null;
            document.querySelectorAll('.candidate-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('alertVote').style.display = 'none';
        }
        
        function showAlert(message, type, section = 'codeSection') {
            const alert = document.getElementById('alertCode');
            const alertText = document.getElementById('alertText');
            
            alertText.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            // Scroll vers l'alerte
            setTimeout(() => {
                alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            
            // Auto-masquage pour les succ√®s
            if (type === 'success') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }
        
        function hideAlert() {
            document.getElementById('alertCode').style.display = 'none';
        }
        
        // ============================================
        // PROTECTIONS SUPPL√âMENTAIRES
        // ============================================
        
        // Emp√™cher l'inspection des donn√©es
        Object.defineProperty(window, 'db', {
            get: () => {
                console.warn('Acc√®s √† la base de donn√©es refus√© pour raisons de s√©curit√©');
                return null;
            }
        });
        
        // D√©tecter les tentatives de contournement
        window.addEventListener('storage', function(e) {
            if (e.key && e.key.includes('vote') && e.newValue !== e.oldValue) {
                console.log('Modification d√©tect√©e, v√©rification de l'int√©grit√©...');
                // V√©rifier l'int√©grit√© des donn√©es
                const currentHash = db.generateSecurityHash();
                const storedData = JSON.parse(localStorage.getItem('secure_voting_system_2024'));
                if (storedData.securityHash !== currentHash) {
                    alert('‚ö†Ô∏è Int√©grit√© des donn√©es compromise ! Le syst√®me va se r√©initialiser.');
                    db.resetForTesting();
                }
            }
        });
        
        // Protection contre la fermeture pendant le vote
        let isVoting = false;
        
        window.addEventListener('beforeunload', function(e) {
            if (currentVoteCode && !sessionStorage.getItem('has_voted')) {
                e.preventDefault();
                e.returnValue = 'Votre vote n\'a pas √©t√© enregistr√©. √ätes-vous s√ªr de vouloir quitter ?';
                return e.returnValue;
            }
        });
        
        // ============================================
        // FONCTION DE TEST (√Ä SUPPRIMER EN PRODUCTION)
        // ============================================
        
        function testVotingSystem() {
            console.log('=== TEST DU SYST√àME DE VOTE ===');
            console.log('1. Codes valides disponibles:', validCodes.length);
            console.log('2. Base de donn√©es initialis√©e:', localStorage.getItem('secure_voting_system_2024') !== null);
            console.log('3. Codes utilis√©s:', JSON.parse(localStorage.getItem('used_vote_codes_2024') || '[]').length);
            
            // Test de s√©curit√© : essayer d'utiliser un code deux fois
            const testCode = validCodes[0];
            const verification1 = db.verifyVoteCode(testCode);
            console.log('4. Premier essai avec code', testCode, ':', verification1.valid ? '‚úÖ Accept√©' : '‚ùå Refus√©');
            
            if (verification1.valid) {
                // Simuler un vote
                try {
                    db.registerVote(testCode, 1);
                    console.log('5. Vote enregistr√© avec succ√®s');
                    
                    // Essayer de r√©utiliser le m√™me code
                    const verification2 = db.verifyVoteCode(testCode);
                    console.log('6. Deuxi√®me essai avec m√™me code:', verification2.valid ? '‚ùå ERREUR: Accept√©' : '‚úÖ Refus√© (correct)');
                } catch (e) {
                    console.log('5. Erreur d\'enregistrement:', e.message);
                }
            }
            
            console.log('=== FIN DU TEST ===');
        }
        
        // Ex√©cuter le test au chargement (optionnel)
        // testVotingSystem();
        
        // ============================================
        // DESCRIPTIONS DES CANDIDATS (pour compl√©ter)
        // ============================================
        
        const candidatesDescriptions = [
            "Ancienne ministre de l'√âducation, engag√©e pour l'innovation et la justice sociale.",
            "√âconomiste renomm√©, sp√©cialiste des finances publiques et de la croissance durable.",
            "Militante environnementale, d√©fenseuse du d√©veloppement durable et de la biodiversit√©.",
            "Ancien maire, expert en s√©curit√© et d√©fense des valeurs traditionnelles.",
            "Syndicaliste, engag√©e pour les droits des travailleurs et la protection sociale.",
            "Entrepreneur, partisan de l'√©conomie de march√© et des libert√©s individuelles.",
            "Maire rurale, d√©fenseuse des territoires et de la d√©centralisation.",
            "Journaliste, promoteur de la diversit√© culturelle et de l'int√©gration.",
            "Assistante sociale, engag√©e pour la famille et les services publics.",
            "Chercheur en intelligence artificielle, partisan de la transformation num√©rique."
        ];
        
        // ============================================
        // INITIALISATION DE CHART.JS
        // ============================================
        
        let voteChart = null;
        
        function initializeChart() {
            const ctx = document.getElementById('resultsChart')?.getContext('2d');
            if (!ctx) return;
            
            voteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: candidates.map(c => c.name),
                    datasets: [{
                        label: 'Votes',
                        data: db.getVotes(),
                        backgroundColor: candidates.map(c => c.color),
                        borderColor: candidates.map(c => c.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.raw} votes (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Initialiser le graphique quand la page est pr√™te
        if (document.readyState === 'complete') {
            initializeChart();
        } else {
            window.addEventListener('load', initializeChart);
        }
        
        // ============================================
        // FONCTION DE D√âMONSTRATION
        // ============================================
        
        // Pour d√©mo : bouton pour voir comment √ßa fonctionne (√† supprimer en prod)
        function showDemoInfo() {
            const info = `
            üîí SYST√àME S√âCURIS√â - D√âMONSTRATION üîí
            
            ‚úÖ FONCTIONNEMENT CORRECT :
            1. Chaque code = UN SEUL VOTE
            2. Impossible de voter sans code valide
            3. Impossible de r√©utiliser un code
            4. Session limit√©e √† 5 minutes
            5. Donn√©es persistantes
            
            üß™ TESTEZ VOUS-M√äME :
            1. Utilisez le code "K7P4J9M2N6"
            2. Votez pour un candidat
            3. Essayez de r√©utiliser le m√™me code ‚Üí IMPOSSIBLE !
            4. Essayez sans code ‚Üí IMPOSSIBLE !
            
            üõ°Ô∏è PROTECTIONS :
            ‚Ä¢ V√©rification en double
            ‚Ä¢ Session unique par code
            ‚Ä¢ Timer de s√©curit√©
            ‚Ä¢ Anti-copier-coller
            ‚Ä¢ Sauvegarde multi-couches
            `;
            
            alert(info);
        }
        
        // Ajouter un bouton d√©mo discret
        const demoBtn = document.createElement('button');
        demoBtn.innerHTML = '?';
        demoBtn.style.position = 'fixed';
        demoBtn.style.bottom = '20px';
        demoBtn.style.right = '20px';
        demoBtn.style.width = '40px';
        demoBtn.style.height = '40px';
        demoBtn.style.borderRadius = '50%';
        demoBtn.style.background = 'var(--primary)';
        demoBtn.style.color = 'white';
        demoBtn.style.border = 'none';
        demoBtn.style.cursor = 'pointer';
        demoBtn.style.zIndex = '1000';
        demoBtn.style.fontSize = '20px';
        demoBtn.style.fontWeight = 'bold';
        demoBtn.onclick = showDemoInfo;
        document.body.appendChild(demoBtn);
    </script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>

