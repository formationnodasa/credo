<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Vote en Ligne</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 900px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .title {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 1.2em;
        }
        
        .content {
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .section-title {
            color: #4f46e5;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #475569;
            font-weight: 600;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #4f46e5;
        }
        
        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .option:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
        }
        
        .option.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .timer {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .timer-title {
            font-size: 1.2em;
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .time-left {
            font-size: 2.5em;
            font-weight: bold;
            color: #92400e;
            font-family: 'Courier New', monospace;
        }
        
        .resultats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .result-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .result-votes {
            font-size: 2em;
            font-weight: bold;
            color: #4f46e5;
            margin: 10px 0;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }
        
        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .alert.warning {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #f59e0b;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .title {
                font-size: 2em;
            }
            
            .time-left {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üó≥Ô∏è Syst√®me de Vote en Ligne</h1>
            <p class="subtitle">Votez en utilisant votre code unique - Un seul vote par personne</p>
        </div>
        
        <div class="content">
            <!-- Chronom√®tre -->
            <div class="timer">
                <div class="timer-title">Temps restant pour voter</div>
                <div class="time-left" id="countdown">00j 00h 00m 00s</div>
            </div>
            
            <!-- Section du code -->
            <div class="section" id="codeSection">
                <h2 class="section-title">üîë Code d'Acc√®s</h2>
                <div class="form-group">
                    <label for="codeInput">Entrez votre code de vote unique :</label>
                    <input type="text" id="codeInput" placeholder="Ex: VOTE2026-7A9B3C" maxlength="20">
                </div>
                <button class="btn" id="verifyCodeBtn">V√©rifier le Code</button>
                <div class="alert" id="codeAlert"></div>
            </div>
            
            <!-- Section du vote (cach√©e initialement) -->
            <div class="section hidden" id="voteSection">
                <h2 class="section-title">‚úì Vote en Cours</h2>
                <p>Code valide : <strong id="currentCode"></strong></p>
                <p>Choisissez votre option :</p>
                
                <div class="options-grid">
                    <div class="option" data-choice="option1">
                        <h3>üçé Option 1</h3>
                        <p>Description de l'option 1</p>
                    </div>
                    <div class="option" data-choice="option2">
                        <h3>üçä Option 2</h3>
                        <p>Description de l'option 2</p>
                    </div>
                    <div class="option" data-choice="option3">
                        <h3>üçá Option 3</h3>
                        <p>Description de l'option 3</p>
                    </div>
                </div>
                
                <button class="btn" id="submitVoteBtn" disabled>Soumettre le Vote</button>
                <div class="alert" id="voteAlert"></div>
            </div>
            
            <!-- Section r√©sultats (cach√©e initialement) -->
            <div class="section hidden" id="resultsSection">
                <h2 class="section-title">üìä R√©sultats du Vote</h2>
                <div class="resultats" id="resultsContainer">
                    <!-- Les r√©sultats seront charg√©s ici -->
                </div>
                <button class="btn" id="refreshResultsBtn">üîÑ Actualiser</button>
            </div>
            
            <!-- Message de fin -->
            <div class="section hidden" id="endSection">
                <h2 class="section-title">‚è∞ Vote Termin√©</h2>
                <p>Le vote est maintenant termin√©. Merci √† tous les participants !</p>
                <p>Les r√©sultats finaux sont disponibles ci-dessous.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAUYpCBlPUnnsCyvqrfMmY5uacjHLGVRh0",
            authDomain: "match-a2ac6.firebaseapp.com",
            projectId: "match-a2ac6",
            storageBucket: "match-a2ac6.firebasestorage.app",
            messagingSenderId: "376894292796",
            appId: "1:376894292796:web:1eb138830c92aae8df5439",
            measurementId: "G-2RSRSSFCDZ"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Date de fin du vote : 1er janvier 2026, 23:59:59
        const VOTE_END_DATE = new Date('2026-01-01T23:59:59');

        // Variables d'√©tat
        let currentCode = null;
        let selectedChoice = null;

        // Initialisation des codes dans Firestore (√† ex√©cuter une fois)
        async function initialiserCodes() {
            const codesRef = db.collection('codes');
            const snapshot = await codesRef.get();
            
            if (snapshot.empty) {
                console.log("Initialisation des codes...");
                // Importer les codes depuis le fichier codes-vote.js
                const codes = [
                    "VOTE2026-7A9B3C", "VOTE2026-D4E5F6", "VOTE2026-1G2H3I",
                    "VOTE2026-J4K5L6", "VOTE2026-M7N8O9", "VOTE2026-P0Q1R2",
                    "VOTE2026-S3T4U5", "VOTE2026-V6W7X8", "VOTE2026-Y9Z0A1",
                    "VOTE2026-B2C3D4", "VOTE2026-E5F6G7", "VOTE2026-H8I9J0",
                    "VOTE2026-K1L2M3", "VOTE2026-N4O5P6", "VOTE2026-Q7R8S9",
                    "VOTE2026-T0U1V2", "VOTE2026-W3X4Y5", "VOTE2026-Z6A7B8",
                    "VOTE2026-C9D0E1", "VOTE2026-F2G3H4"
                ];

                const batch = db.batch();
                
                codes.forEach(code => {
                    const codeRef = codesRef.doc(code);
                    batch.set(codeRef, {
                        code: code,
                        estValide: true,
                        utilise: false,
                        dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
                        dateUtilisation: null
                    });
                });

                await batch.commit();
                console.log("20 codes ont √©t√© initialis√©s dans Firestore");
            }
        }

        // Mettre √† jour le chronom√®tre
        function updateCountdown() {
            const now = new Date();
            const timeLeft = VOTE_END_DATE - now;
            
            if (timeLeft <= 0) {
                document.getElementById('countdown').textContent = "VOTE TERMIN√â";
                finDuVote();
                return;
            }
            
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            document.getElementById('countdown').textContent = 
                `${days}j ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
        }

        // Fonction appel√©e √† la fin du vote
        function finDuVote() {
            document.getElementById('codeSection').classList.add('hidden');
            document.getElementById('voteSection').classList.add('hidden');
            document.getElementById('endSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // D√©sactiver les boutons de vote
            document.getElementById('verifyCodeBtn').disabled = true;
            document.getElementById('codeInput').disabled = true;
            
            // Afficher les r√©sultats finaux
            afficherResultats();
        }

        // V√©rifier si le code est valide
        async function verifierCode(code) {
            try {
                const codeRef = db.collection('codes').doc(code);
                const doc = await codeRef.get();
                
                if (!doc.exists) {
                    showAlert('error', 'Code invalide. Veuillez v√©rifier votre code.');
                    return false;
                }
                
                const codeData = doc.data();
                
                if (!codeData.estValide) {
                    showAlert('error', 'Ce code a √©t√© d√©sactiv√©.');
                    return false;
                }
                
                if (codeData.utilise) {
                    showAlert('error', 'Ce code a d√©j√† √©t√© utilis√© pour voter.');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Erreur de v√©rification:', error);
                showAlert('error', 'Erreur de connexion. R√©essayez.');
                return false;
            }
        }

        // Enregistrer le vote
        async function enregistrerVote(code, choix) {
            try {
                // V√©rifier d'abord que le vote n'est pas termin√©
                if (new Date() > VOTE_END_DATE) {
                    showAlert('error', 'Le vote est termin√©.');
                    return false;
                }

                const batch = db.batch();
                const codeRef = db.collection('codes').doc(code);
                const voteRef = db.collection('votes').doc();
                
                // Marquer le code comme utilis√©
                batch.update(codeRef, {
                    utilise: true,
                    dateUtilisation: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Enregistrer le vote
                batch.set(voteRef, {
                    code: code,
                    choix: choix,
                    dateVote: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent
                });
                
                await batch.commit();
                return true;
            } catch (error) {
                console.error('Erreur d\'enregistrement:', error);
                return false;
            }
        }

        // Calculer et afficher les r√©sultats
        async function afficherResultats() {
            try {
                const votesRef = db.collection('votes');
                const snapshot = await votesRef.get();
                
                const resultats = {
                    option1: 0,
                    option2: 0,
                    option3: 0
                };
                
                snapshot.forEach(doc => {
                    const vote = doc.data();
                    if (resultats[vote.choix] !== undefined) {
                        resultats[vote.choix]++;
                    }
                });
                
                const totalVotes = resultats.option1 + resultats.option2 + resultats.option3;
                const container = document.getElementById('resultsContainer');
                
                container.innerHTML = `
                    <div class="result-item">
                        <h3>üçé Option 1</h3>
                        <div class="result-votes">${resultats.option1}</div>
                        <div>${totalVotes > 0 ? Math.round((resultats.option1 / totalVotes) * 100) : 0}%</div>
                    </div>
                    <div class="result-item">
                        <h3>üçä Option 2</h3>
                        <div class="result-votes">${resultats.option2}</div>
                        <div>${totalVotes > 0 ? Math.round((resultats.option2 / totalVotes) * 100) : 0}%</div>
                    </div>
                    <div class="result-item">
                        <h3>üçá Option 3</h3>
                        <div class="result-votes">${resultats.option3}</div>
                        <div>${totalVotes > 0 ? Math.round((resultats.option3 / totalVotes) * 100) : 0}%</div>
                    </div>
                    <div class="result-item">
                        <h3>Total</h3>
                        <div class="result-votes">${totalVotes}</div>
                        <div>Votes</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erreur de calcul:', error);
            }
        }

        // Afficher une alerte
        function showAlert(type, message) {
            const alert = document.getElementById(type === 'success' ? 'voteAlert' : 'codeAlert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Gestionnaires d'√©v√©nements
        document.addEventListener('DOMContentLoaded', () => {
            // Initialisation
            updateCountdown();
            setInterval(updateCountdown, 1000);
            
            // V√©rifier si le vote est termin√©
            if (new Date() > VOTE_END_DATE) {
                finDuVote();
            } else {
                // Initialiser les codes (√† faire une seule fois)
                initialiserCodes().catch(console.error);
                
                // Afficher les r√©sultats
                afficherResultats();
            }
            
            // Bouton de v√©rification du code
            document.getElementById('verifyCodeBtn').addEventListener('click', async () => {
                const codeInput = document.getElementById('codeInput');
                const code = codeInput.value.trim().toUpperCase();
                
                if (!code) {
                    showAlert('error', 'Veuillez entrer un code.');
                    return;
                }
                
                const isValid = await verifierCode(code);
                
                if (isValid) {
                    currentCode = code;
                    document.getElementById('currentCode').textContent = code;
                    document.getElementById('codeSection').classList.add('hidden');
                    document.getElementById('voteSection').classList.remove('hidden');
                }
            });
            
            // S√©lection des options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', () => {
                    // Retirer la s√©lection pr√©c√©dente
                    document.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Ajouter la nouvelle s√©lection
                    option.classList.add('selected');
                    selectedChoice = option.dataset.choice;
                    document.getElementById('submitVoteBtn').disabled = false;
                });
            });
            
            // Soumission du vote
            document.getElementById('submitVoteBtn').addEventListener('click', async () => {
                if (!currentCode || !selectedChoice) {
                    showAlert('error', 'Veuillez s√©lectionner une option.');
                    return;
                }
                
                const success = await enregistrerVote(currentCode, selectedChoice);
                
                if (success) {
                    showAlert('success', 'Votre vote a √©t√© enregistr√© avec succ√®s !');
                    
                    // Masquer la section de vote et afficher les r√©sultats
                    document.getElementById('voteSection').classList.add('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                    
                    // Mettre √† jour les r√©sultats
                    afficherResultats();
                } else {
                    showAlert('error', 'Erreur lors de l\'enregistrement du vote.');
                }
            });
            
            // Rafra√Æchir les r√©sultats
            document.getElementById('refreshResultsBtn').addEventListener('click', afficherResultats);
            
            // Retour √† l'entr√©e du code
            document.getElementById('codeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('verifyCodeBtn').click();
                }
            });
        });
    </script>
</body>
</html>