<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Multijoueur - Synchronisation Temps RÃ©el</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .menu {
            text-align: center;
            margin-bottom: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #00b894, #00a085);
        }

        .btn-primary {
            background: linear-gradient(45deg, #0984e3, #074b83);
        }

        .input-field {
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #0984e3;
            border-radius: 10px;
            color: #333;
            margin: 15px 0;
            text-align: center;
        }

        .session-code {
            font-size: 4rem;
            font-weight: bold;
            color: #ffeaa7;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 234, 167, 0.5);
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            border: 3px solid #ffeaa7;
        }

        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .player-card.active {
            border-color: #00b894;
            background: rgba(0, 184, 148, 0.2);
            transform: scale(1.05);
        }

        .player-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffeaa7;
        }

        .player-score {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .online { background: #00b894; box-shadow: 0 0 10px #00b894; }
        .offline { background: #ff6b6b; }

        .game-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .chat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-message {
            margin: 8px 0;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 3px solid #0984e3;
        }

        .message-sender {
            font-weight: bold;
            color: #ffeaa7;
        }

        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .online-counter {
            text-align: center;
            margin: 15px 0;
            font-size: 1.1rem;
            color: #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ® Test Multijoueur Temps RÃ©el</h1>
        
        <!-- Menu Principal -->
        <div id="mainMenu" class="menu">
            <p style="margin-bottom: 20px; font-size: 1.2rem;">
                Testez la synchronisation en temps rÃ©el entre plusieurs joueurs !
            </p>
            <button class="btn" onclick="showNameInput()">DÃ©marrer le Test</button>
        </div>

        <!-- Saisie du nom -->
        <div id="nameInput" class="menu hidden">
            <h3>Quel est votre nom ?</h3>
            <input type="text" class="input-field" id="playerNameInput" placeholder="Votre nom" maxlength="15">
            <br>
            <button class="btn btn-success" onclick="setPlayerName()">Continuer</button>
        </div>

        <!-- Menu Multijoueur -->
        <div id="multiplayerMenu" class="menu hidden">
            <button class="btn btn-primary" onclick="createSession()">CrÃ©er une Session</button>
            <button class="btn btn-primary" onclick="showJoinSession()">Rejoindre une Session</button>
        </div>

        <!-- Rejoindre une session -->
        <div id="joinSession" class="menu hidden">
            <h3>Rejoindre une Session</h3>
            <input type="text" class="input-field" id="sessionCodeInput" placeholder="Code session (4 lettres)" maxlength="4" style="text-transform: uppercase;">
            <br>
            <button class="btn btn-success" onclick="joinSession()">Rejoindre</button>
            <button class="btn" onclick="showMultiplayerMenu()">Retour</button>
        </div>

        <!-- Session CrÃ©Ã©e -->
        <div id="sessionCreated" class="hidden">
            <h3>âœ… Session CrÃ©Ã©e !</h3>
            <p>Partagez ce code avec vos amis :</p>
            <div class="session-code" id="sessionCodeDisplay">----</div>
            
            <div class="online-counter">
                <span id="onlineCount">1</span>/<span id="maxPlayers">8</span> joueurs connectÃ©s
            </div>
            
            <div class="players-container" id="playersList">
                <!-- Liste des joueurs dynamique -->
            </div>

            <div class="controls">
                <button class="control-btn" onclick="updatePlayerColor('red')">ðŸ”´ Rouge</button>
                <button class="control-btn" onclick="updatePlayerColor('blue')">ðŸ”µ Bleu</button>
                <button class="control-btn" onclick="updatePlayerColor('green')">ðŸŸ¢ Vert</button>
                <button class="control-btn" onclick="incrementScore()">âž• Score +1</button>
                <button class="control-btn" onclick="decrementScore()">âž– Score -1</button>
                <button class="control-btn" onclick="sendRandomMessage()">ðŸ’¬ Message Test</button>
            </div>

            <div class="game-area">
                <h4>Chat en Temps RÃ©el</h4>
                <div class="chat-box" id="chatBox">
                    <!-- Messages de chat -->
                </div>
                <input type="text" class="input-field" id="chatInput" placeholder="Tapez un message..." style="max-width: 400px;">
                <button class="btn" onclick="sendChatMessage()">Envoyer</button>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="leaveSession()">Quitter la Session</button>
                <button class="btn btn-success" onclick="startGameTest()" id="startGameBtn">DÃ©marrer le Jeu Test</button>
            </div>
        </div>

        <!-- Zone de Jeu Test -->
        <div id="gameTest" class="hidden">
            <h3>ðŸŽ¯ Jeu Test Actif</h3>
            <div class="game-area">
                <p>Timer synchronisÃ©: <span id="gameTimer">10</span>s</p>
                <p>Ã‰tat du jeu: <span id="gameState">En attente...</span></p>
                <div id="gameContent">
                    <!-- Contenu du jeu dynamique -->
                </div>
            </div>
            <button class="btn" onclick="endGameTest()">ArrÃªter le Jeu</button>
        </div>
    </div>

    <script>
        // ============================
        // CONFIGURATION FIREBASE
        // ============================
        const firebaseConfig = {
            apiKey: "AIzaSyBr8Fzdvh1En3rAxGFipOYfgr0YDeeM_Bo",
            authDomain: "match-en-ligne.firebaseapp.com",
            projectId: "match-en-ligne",
            storageBucket: "match-en-ligne.firebasestorage.app",
            messagingSenderId: "706011207623",
            appId: "1:706011207623:web:17374990a6202b64f0abe2",
            measurementId: "G-D9XYRE3W2M"
        };

        // Initialisation Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.log("Firebase dÃ©jÃ  initialisÃ©");
        }
        const db = firebase.firestore();

        // ============================
        // VARIABLES GLOBALES
        // ============================
        let currentSession = null;
        let players = [];
        let playerId = Math.random().toString(36).substr(2, 9);
        let playerName = "";
        let isHost = false;
        let sessionUnsubscribe = null;
        let gameTimerInterval = null;

        // ============================
        // GESTION DE LA NAVIGATION
        // ============================
        function showNameInput() {
            showSection('nameInput');
            document.getElementById('playerNameInput').focus();
        }

        function setPlayerName() {
            const name = document.getElementById('playerNameInput').value.trim();
            if (name.length < 2) {
                alert("Choisissez un nom d'au moins 2 caractÃ¨res");
                return;
            }
            playerName = name;
            showMultiplayerMenu();
        }

        function showMultiplayerMenu() {
            showSection('multiplayerMenu');
        }

        function showJoinSession() {
            showSection('joinSession');
            document.getElementById('sessionCodeInput').focus();
        }

        function showSection(sectionId) {
            // Cacher toutes les sections
            const sections = ['mainMenu', 'nameInput', 'multiplayerMenu', 'joinSession', 'sessionCreated', 'gameTest'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            // Afficher la section demandÃ©e
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // ============================
        // GESTION DES SESSIONS
        // ============================
        async function createSession() {
            try {
                const sessionCode = generateSessionCode();
                currentSession = sessionCode;
                isHost = true;

                const playerData = {
                    id: playerId,
                    name: playerName,
                    score: 0,
                    color: 'blue',
                    isOnline: true,
                    lastSeen: new Date()
                };

                await db.collection('test_sessions').doc(sessionCode).set({
                    code: sessionCode,
                    host: playerId,
                    players: [playerData],
                    status: 'waiting',
                    gameState: 'lobby',
                    chatMessages: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSessionCreated(sessionCode);
                listenToSessionChanges();
                showNotification("Session crÃ©Ã©e avec succÃ¨s !");
                
            } catch (error) {
                console.error("Erreur crÃ©ation session:", error);
                alert("Erreur lors de la crÃ©ation de la session");
            }
        }

        function showSessionCreated(code) {
            document.getElementById('sessionCodeDisplay').textContent = code;
            showSection('sessionCreated');
        }

        async function joinSession() {
            const code = document.getElementById('sessionCodeInput').value.toUpperCase().trim();
            
            if (code.length !== 4) {
                alert("Le code doit avoir 4 caractÃ¨res");
                return;
            }

            try {
                const sessionDoc = await db.collection('test_sessions').doc(code).get();
                
                if (!sessionDoc.exists) {
                    alert("Session non trouvÃ©e");
                    return;
                }

                currentSession = code;
                
                const playerData = {
                    id: playerId,
                    name: playerName,
                    score: 0,
                    color: 'green',
                    isOnline: true,
                    lastSeen: new Date()
                };

                await db.collection('test_sessions').doc(code).update({
                    players: firebase.firestore.FieldValue.arrayUnion(playerData),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSessionCreated(code);
                listenToSessionChanges();
                showNotification("Session rejointe avec succÃ¨s !");
                
            } catch (error) {
                console.error("Erreur rejoindre session:", error);
                alert("Erreur lors de la connexion Ã  la session");
            }
        }

        function listenToSessionChanges() {
            if (sessionUnsubscribe) {
                sessionUnsubscribe();
            }
            
            sessionUnsubscribe = db.collection('test_sessions').doc(currentSession).onSnapshot((doc) => {
                if (doc.exists) {
                    const sessionData = doc.data();
                    players = sessionData.players || [];
                    
                    updatePlayersList();
                    updateOnlineCounter();
                    updateChat(sessionData.chatMessages || []);
                    
                    // Mettre Ã  jour le bouton de dÃ©marrage
                    const startBtn = document.getElementById('startGameBtn');
                    if (startBtn) {
                        startBtn.disabled = players.length < 2;
                        startBtn.textContent = players.length < 2 ? 
                            `En attente d'amis... (${players.length}/2)` : 
                            'DÃ©marrer le Jeu Test';
                    }

                    // GÃ©rer les Ã©tats de jeu
                    if (sessionData.status === 'playing') {
                        showGameTest(sessionData);
                    }
                    
                } else {
                    // Session supprimÃ©e
                    resetInterface();
                    showNotification("La session a Ã©tÃ© fermÃ©e");
                }
            });
        }

        function updatePlayersList() {
            const container = document.getElementById('playersList');
            if (!container) return;
            
            container.innerHTML = players.map(player => `
                <div class="player-card ${player.id === playerId ? 'active' : ''}" style="border-left-color: ${player.color}">
                    <div class="player-name">
                        <span class="status-indicator ${player.isOnline ? 'online' : 'offline'}"></span>
                        ${player.name} ${player.id === playerId ? '(Vous)' : ''}
                        ${player.id === players.find(p => p.isHost)?.id ? 'ðŸ‘‘' : ''}
                    </div>
                    <div class="player-score">${player.score} pts</div>
                    <div style="color: ${player.color}; font-size: 0.9rem;">
                        Couleur: ${player.color}
                    </div>
                </div>
            `).join('');
        }

        function updateOnlineCounter() {
            const onlinePlayers = players.filter(p => p.isOnline).length;
            document.getElementById('onlineCount').textContent = onlinePlayers;
        }

        // ============================
        // INTERACTIONS TEMPS RÃ‰EL
        // ============================
        async function updatePlayerColor(color) {
            if (!currentSession) return;
            
            try {
                const updatedPlayers = players.map(p => 
                    p.id === playerId ? { ...p, color: color } : p
                );
                
                await db.collection('test_sessions').doc(currentSession).update({
                    players: updatedPlayers
                });
                
            } catch (error) {
                console.error("Erreur mise Ã  jour couleur:", error);
            }
        }

        async function incrementScore() {
            if (!currentSession) return;
            
            try {
                const currentPlayer = players.find(p => p.id === playerId);
                const updatedPlayers = players.map(p => 
                    p.id === playerId ? { ...p, score: (p.score || 0) + 1 } : p
                );
                
                await db.collection('test_sessions').doc(currentSession).update({
                    players: updatedPlayers
                });
                
            } catch (error) {
                console.error("Erreur incrÃ©ment score:", error);
            }
        }

        async function decrementScore() {
            if (!currentSession) return;
            
            try {
                const updatedPlayers = players.map(p => 
                    p.id === playerId ? { ...p, score: Math.max(0, (p.score || 0) - 1) } : p
                );
                
                await db.collection('test_sessions').doc(currentSession).update({
                    players: updatedPlayers
                });
                
            } catch (error) {
                console.error("Erreur dÃ©crÃ©ment score:", error);
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !currentSession) return;
            
            try {
                const chatMessage = {
                    sender: playerName,
                    senderId: playerId,
                    text: message,
                    timestamp: new Date()
                };
                
                await db.collection('test_sessions').doc(currentSession).update({
                    chatMessages: firebase.firestore.FieldValue.arrayUnion(chatMessage)
                });
                
                input.value = ''; // Vider le champ
                
            } catch (error) {
                console.error("Erreur envoi message:", error);
            }
        }

        async function sendRandomMessage() {
            const messages = [
                "Salut tout le monde ! ðŸ‘‹",
                "La synchronisation fonctionne ! ðŸŽ¯",
                "Test de message en temps rÃ©el âš¡",
                "Quelqu'un veut tester les couleurs ? ðŸŽ¨",
                "Les scores se mettent Ã  jour en direct ! ðŸ“Š"
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            try {
                const chatMessage = {
                    sender: playerName,
                    senderId: playerId,
                    text: randomMessage,
                    timestamp: new Date()
                };
                
                await db.collection('test_sessions').doc(currentSession).update({
                    chatMessages: firebase.firestore.FieldValue.arrayUnion(chatMessage)
                });
                
            } catch (error) {
                console.error("Erreur envoi message alÃ©atoire:", error);
            }
        }

        function updateChat(messages) {
            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;
            
            chatBox.innerHTML = messages.slice(-20).map(msg => `
                <div class="chat-message">
                    <span class="message-sender">${msg.sender}:</span> ${msg.text}
                    <div style="font-size: 0.8rem; color: #ccc;">
                        ${new Date(msg.timestamp?.toDate?.() || msg.timestamp).toLocaleTimeString()}
                    </div>
                </div>
            `).join('');
            
            // Scroll vers le bas
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ============================
        // JEU TEST SYNCHRONISÃ‰
        // ============================
        async function startGameTest() {
            if (!isHost) return;
            
            try {
                await db.collection('test_sessions').doc(currentSession).update({
                    status: 'playing',
                    gameState: 'countdown',
                    gameTimer: 10,
                    gameStartTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error("Erreur dÃ©marrage jeu:", error);
            }
        }

        function showGameTest(sessionData) {
            showSection('gameTest');
            
            const gameState = sessionData.gameState || 'countdown';
            const timer = sessionData.gameTimer || 10;
            
            document.getElementById('gameState').textContent = gameState;
            document.getElementById('gameTimer').textContent = timer;
            
            let gameContent = '';
            
            switch(gameState) {
                case 'countdown':
                    gameContent = `<p>DÃ©marrage dans ${timer} secondes...</p>`;
                    break;
                case 'playing':
                    gameContent = `
                        <p>ðŸŽ® Jeu en cours !</p>
                        <p>Testez les interactions ci-dessous :</p>
                        <div class="controls">
                            <button class="control-btn" onclick="sendGameAction('action1')">Action 1</button>
                            <button class="control-btn" onclick="sendGameAction('action2')">Action 2</button>
                        </div>
                    `;
                    break;
                case 'finished':
                    gameContent = `<p>ðŸŽ‰ Jeu terminÃ© !</p>`;
                    break;
            }
            
            document.getElementById('gameContent').innerHTML = gameContent;
            
            // GÃ©rer le timer
            if (gameTimerInterval) clearInterval(gameTimerInterval);
            
            if (gameState === 'countdown' && isHost) {
                gameTimerInterval = setInterval(async () => {
                    const newTimer = timer - 1;
                    
                    if (newTimer <= 0) {
                        clearInterval(gameTimerInterval);
                        await db.collection('test_sessions').doc(currentSession).update({
                            gameState: 'playing',
                            gameTimer: 60
                        });
                    } else {
                        await db.collection('test_sessions').doc(currentSession).update({
                            gameTimer: newTimer
                        });
                    }
                }, 1000);
            }
        }

        async function sendGameAction(action) {
            if (!currentSession) return;
            
            try {
                const actionMessage = {
                    sender: playerName,
                    action: action,
                    timestamp: new Date()
                };
                
                // Ajouter l'action au chat
                await db.collection('test_sessions').doc(currentSession).update({
                    chatMessages: firebase.firestore.FieldValue.arrayUnion({
                        sender: playerName,
                        senderId: playerId,
                        text: `ðŸ”¹ Action: ${action}`,
                        timestamp: new Date()
                    })
                });
                
            } catch (error) {
                console.error("Erreur action jeu:", error);
            }
        }

        async function endGameTest() {
            if (!isHost) return;
            
            try {
                await db.collection('test_sessions').doc(currentSession).update({
                    status: 'waiting',
                    gameState: 'lobby'
                });
                
                showSection('sessionCreated');
                
            } catch (error) {
                console.error("Erreur fin jeu:", error);
            }
        }

        // ============================
        // FONCTIONS UTILITAIRES
        // ============================
        function generateSessionCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        async function leaveSession() {
            if (currentSession) {
                try {
                    if (isHost) {
                        await db.collection('test_sessions').doc(currentSession).delete();
                    } else {
                        const updatedPlayers = players.filter(p => p.id !== playerId);
                        await db.collection('test_sessions').doc(currentSession).update({
                            players: updatedPlayers
                        });
                    }
                } catch (error) {
                    console.error("Erreur dÃ©part session:", error);
                }
            }
            
            resetInterface();
        }

        function resetInterface() {
            if (gameTimerInterval) clearInterval(gameTimerInterval);
            if (sessionUnsubscribe) sessionUnsubscribe();
            
            currentSession = null;
            players = [];
            isHost = false;
            
            showSection('mainMenu');
        }

        // Gestion de la touche EntrÃ©e pour le chat
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>