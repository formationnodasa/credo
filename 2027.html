<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shonexika Duel — Quiz Multijoueur</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:20px auto;padding:10px}
  .row{display:flex;gap:10px;margin-bottom:8px}
  input,textarea,button,select{padding:8px;font-size:1rem}
  #log{white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:6px;height:160px;overflow:auto}
  .hidden{display:none}
  .player{border:1px solid #ddd;padding:8px;border-radius:6px;margin-bottom:6px}
</style>
</head>
<body>

<h1>Shonexika Duel — Quiz Multijoueur</h1>
<p>Hébergé sur GitHub Pages. Utilise Firebase Realtime Database pour synchroniser les salles (config à ajouter).</p>

<!-- SECTION: Connexion rapide -->
<div id="login">
  <div class="row">
    <input id="name" placeholder="Ton pseudo (ex: CoachCreed)" />
    <button id="createRoomBtn">Créer une salle</button>
    <input id="joinCode" placeholder="Code salle (ex: 123456)"/>
    <button id="joinRoomBtn">Rejoindre</button>
  </div>
  <div class="row">
    <small>Si tu veux tester en local: ouvre deux onglets et rejoins la même salle.</small>
  </div>
</div>

<!-- SECTION: Salle / Interface jeu -->
<div id="roomUI" class="hidden">
  <div class="row">
    <div>
      <strong>Salle :</strong> <span id="roomIdText"></span><br/>
      <strong>Ton rôle :</strong> <span id="roleText"></span>
    </div>
    <div>
      <button id="leaveBtn">Quitter</button>
    </div>
  </div>

  <div id="playersList"></div>

  <hr/>
  <h3>Q: Charger / coller questions (hôte)</h3>
  <div id="questionEditor">
    <textarea id="questionsJSON" rows="6" placeholder='Format: [{"q":"Question...","a":"Réponse"} , ...]'></textarea>
    <div class="row">
      <button id="pushQuestionsBtn">Publier les questions (sur la salle)</button>
      <button id="startBtn">Démarrer le match</button>
    </div>
  </div>

  <hr/>
  <div id="gameArea" class="hidden">
    <h3>Question <span id="qIndex">0</span> / <span id="qTotal">0</span></h3>
    <div id="currentQ" style="font-size:1.2rem;margin-bottom:8px"></div>

    <div class="row">
      <input id="answerInput" placeholder="Ta réponse ici..." />
      <button id="submitAnswerBtn">Envoyer réponse</button>
    </div>

    <div id="feedback" style="margin-top:8px"></div>

    <div style="margin-top:12px;">
      <button id="nextBtn" class="hidden">Question suivante (host)</button>
    </div>

    <h4>Scores</h4>
    <div id="scores"></div>

    <h4>Journal</h4>
    <div id="log"></div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* =============== CONFIG FIREBASE ===============
  -> Crée un projet Firebase (console.firebase.google.com),
  -> Active Realtime Database en mode test (ou règles restreintes si tu sais configurer),
  -> Copie-colle ici la config (apiKey, authDomain, databaseURL, projectId etc.)
================================================= */
const firebaseConfig = {
  apiKey: "REPLACE_API_KEY",
  authDomain: "REPLACE_AUTH_DOMAIN",
  databaseURL: "REPLACE_DATABASE_URL",
  projectId: "REPLACE_PROJECT_ID",
  storageBucket: "REPLACE",
  messagingSenderId: "REPLACE",
  appId: "REPLACE"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- Utilitaires ---------- */
const $ = id => document.getElementById(id);
const uid = () => Math.random().toString(36).slice(2,10);

/* ---------- UI refs ---------- */
const createRoomBtn = $('createRoomBtn');
const joinRoomBtn = $('joinRoomBtn');
const leaveBtn = $('leaveBtn');
const pushQuestionsBtn = $('pushQuestionsBtn');
const startBtn = $('startBtn');
const submitAnswerBtn = $('submitAnswerBtn');
const nextBtn = $('nextBtn');

let me = {name:null,id:null};
let roomId = null;
let isHost = false;
let roomRef = null;
let localQuestions = []; // if host pushes

/* ---------- ROOM ACTIONS ---------- */
createRoomBtn.addEventListener('click', async ()=>{
  const name = $('name').value.trim() || 'Host';
  me = {name, id: uid()};
  isHost = true;
  roomId = (Math.floor(100000 + Math.random()*900000)).toString();
  $('roomIdText').textContent = roomId;
  $('roleText').textContent = 'Hôte';
  enterRoomUI();
  // create room object
  roomRef = db.ref('rooms/' + roomId);
  await roomRef.set({
    hostId: me.id,
    hostName: me.name,
    createdAt: Date.now(),
    players: {
      [me.id]: {name: me.name, joinedAt: Date.now(), lastPing: Date.now()}
    },
    questions: [],
    currentIndex: -1,
    started: false,
    answers: {},
    scores: {}
  });
  listenRoom();
});

joinRoomBtn.addEventListener('click', async ()=>{
  const code = $('joinCode').value.trim();
  if(!code) return alert('Entre le code de la salle.');
  const name = $('name').value.trim() || 'Joueur';
  me = {name, id: uid()};
  roomId = code;
  roomRef = db.ref('rooms/' + roomId);
  const snap = await roomRef.get();
  if(!snap.exists()) return alert('Salle introuvable.');
  isHost = false;
  $('roomIdText').textContent = roomId;
  $('roleText').textContent = 'Joueur';
  enterRoomUI();
  // add to players
  await roomRef.child('players').child(me.id).set({name:me.name, joinedAt:Date.now(), lastPing:Date.now()});
  listenRoom();
});

leaveBtn.addEventListener('click', async ()=>{
  if(!roomRef) return location.reload();
  await roomRef.child('players').child(me.id).remove();
  stopListening();
  location.reload();
});

/* ---------- Push questions (host) ---------- */
pushQuestionsBtn.addEventListener('click', async ()=>{
  if(!isHost) return alert('Seul l’hôte peut publier les questions.');
  const raw = $('questionsJSON').value.trim();
  if(!raw) return alert('Colle des questions au format JSON.');
  try{
    const q = JSON.parse(raw);
    if(!Array.isArray(q)) throw new Error('Liste attendue.');
    localQuestions = q.map(x => ({q: x.q, a: (''+x.a).trim()}));
    await roomRef.child('questions').set(localQuestions);
    log('Questions publiées ('+localQuestions.length+')');
  }catch(err){
    alert('JSON invalide: ' + err.message);
  }
});

/* ---------- Start match ---------- */
startBtn.addEventListener('click', async ()=>{
  if(!isHost) return alert('Seul l’hôte peut démarrer.');
  const snap = await roomRef.child('questions').get();
  if(!snap.exists() || snap.val().length===0) return alert('Pas de questions publiées.');
  await roomRef.update({started:true, currentIndex:0});
  log('Match démarré.');
});

/* ---------- Submit answer ---------- */
submitAnswerBtn.addEventListener('click', async ()=>{
  const ans = $('answerInput').value.trim();
  if(ans==='') return;
  const idx = (await roomRef.child('currentIndex').get()).val();
  if(idx === null || idx < 0) return alert('Match non démarré.');
  // push answer under answers/{idx}/{playerId}
  const ansPath = `answers/${idx}/${me.id}`;
  await roomRef.child(ansPath).set({answer: ans, at: Date.now(), name: me.name});
  $('answerInput').value = '';
  log('Réponse envoyée.');
});

/* ---------- Next question (host) ---------- */
nextBtn.addEventListener('click', async ()=>{
  if(!isHost) return;
  const snap = await roomRef.get();
  const data = snap.val();
  const next = (data.currentIndex ?? -1) + 1;
  const total = (data.questions || []).length;
  if(next >= total){
    await roomRef.update({currentIndex:-1, started:false});
    log('Match terminé.');
  } else {
    await roomRef.update({currentIndex: next});
    log('Passage à la question ' + next);
    // reset answers for next question (optional)
    await roomRef.child('answers').child(next).remove();
  }
});

/* ---------- Listening to room changes ---------- */
let roomListener = null;
function listenRoom(){
  if(!roomRef) return;
  // Listen to whole room for simplicity (for production listen only to needed nodes)
  roomListener = roomRef.on('value', snap=>{
    if(!snap.exists()) { log('Salle supprimée.'); stopListening(); return; }
    const data = snap.val();
    renderPlayers(data.players || {});
    renderQuestions(data.questions || [], data.currentIndex, data.started);
    renderScores(data.scores || {});
    renderAnswers(data.answers || {});
  });
  // ping presence every 10s
  setInterval(()=> {
    if(me && roomRef){
      roomRef.child('players').child(me.id).child('lastPing').set(Date.now());
    }
  }, 10000);
}

function stopListening(){
  if(roomRef && roomListener) roomRef.off('value', roomListener);
}

/* ---------- Rendering helpers ---------- */
function enterRoomUI(){
  $('login').classList.add('hidden');
  $('roomUI').classList.remove('hidden');
}

function renderPlayers(players){
  const el = $('playersList'); el.innerHTML = '<h4>Joueurs</h4>';
  for(const [id,p] of Object.entries(players || {})){
    const div = document.createElement('div'); div.className = 'player';
    div.innerHTML = `<strong>${p.name}</strong> ${id===me.id? '(Vous)':''} <br/>${p.lastPing? 'actif':'inactif'}`;
    el.appendChild(div);
  }
}

function renderQuestions(questions, currentIndex, started){
  $('qTotal').textContent = questions.length;
  if(started && currentIndex>=0){
    $('gameArea').classList.remove('hidden');
    const qObj = questions[currentIndex];
    $('qIndex').textContent = (currentIndex + 1);
    $('currentQ').textContent = qObj.q || '[Question vide]';
    // host shows next button
    if(isHost) nextBtn.classList.remove('hidden'); else nextBtn.classList.add('hidden');
  } else {
    $('gameArea').classList.add('hidden');
  }
}

function renderAnswers(answers){
  // show feedback if answers exist for currentIndex
  const snapIdx = $('qIndex').textContent ? parseInt($('qIndex').textContent)-1 : null;
  if(snapIdx === null || isNaN(snapIdx)) return;
  const byIdx = (answers && answers[snapIdx]) || {};
  const fb = [];
  for(const [pid, info] of Object.entries(byIdx)){
    fb.push(`${info.name}: ${info.answer}`);
  }
  $('feedback').textContent = fb.join('\n') || '';
  // auto compute score: if host provided correct answer earlier, we can assign points
  computeScoresForIndex(snapIdx, byIdx);
}

async function computeScoresForIndex(idx, answersObj){
  // get correct answer
  const qSnap = await roomRef.child('questions').child(idx).get();
  if(!qSnap.exists()) return;
  const correct = ('' + qSnap.val().a).trim().toLowerCase();
  let updates = {};
  for(const [pid, info] of Object.entries(answersObj || {})){
    const given = ('' + info.answer).trim().toLowerCase();
    const got = (given === correct) ? 1 : 0;
    // increment score
    const scoreSnap = await roomRef.child('scores').child(pid).get();
    const prev = scoreSnap.exists() ? (scoreSnap.val().points||0) : 0;
    updates[pid + '/points'] = prev + got;
  }
  if(Object.keys(updates).length>0){
    await roomRef.child('scores').update(updates);
  }
}

function renderScores(scores){
  const el = $('scores'); el.innerHTML = '';
  for(const [pid, s] of Object.entries(scores || {})){
    const div = document.createElement('div');
    div.textContent = `${s.name || pid} : ${s.points || 0} pts`;
    el.appendChild(div);
  }
}

function log(msg){
  const l = $('log');
  l.textContent = (new Date()).toLocaleTimeString() + ' — ' + msg + '\n' + l.textContent;
}

/* ensure we don't leak listeners when closing tab */
window.addEventListener('beforeunload', ()=> {
  if(roomRef && me) roomRef.child('players').child(me.id).remove();
});
</script>
</body>
</html>