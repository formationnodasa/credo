import React, { useState, useEffect } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { View, StyleSheet, Text, TouchableOpacity, Alert, TextInput } from 'react-native';
import { RadioButton } from 'react-native-paper';

const Stack = createNativeStackNavigator();

// Données des questions
const quizQuestions = [
  {
    category: "Champ lexical 'able'",
    questions: [
      { question: "Qui mérite d'être admiré ?", answer: "admirable", options: ["admirable", "agréable", "excusable", "évitable"] },
      { question: "Qui peut être excusé ?", answer: "excusable", options: ["excusable", "regrettable", "appréciable", "tolérable"] },
      { question: "Qui peut être évité ?", answer: "évitable", options: ["évitable", "comptable", "corrigeable", "louable"] },
    ]
  },
  {
    category: "Champ lexical 'eur'",
    questions: [
      { question: "Celui qui chante ?", answer: "chanteur", options: ["chanteur", "vendeur", "lecteur", "formateur"] },
      { question: "Celui qui vend ?", answer: "vendeur", options: ["vendeur", "spectateur", "traducteur", "orateur"] },
      { question: "Celui qui lit ?", answer: "lecteur", options: ["lecteur", "inventeur", "auteur", "directeur"] },
    ]
  }
];

// Écran d'accueil
function HomeScreen({ navigation }) {
  return (
    <View style={styles.container}>
      <View style={styles.card}>
        <Text style={styles.title}>Quiz Multijoueur</Text>
        <Text style={styles.paragraph}>
          Affrontez vos amis dans un quiz passionnant sur les champs lexicaux français !
        </Text>
      </View>

      <View style={styles.buttonContainer}>
        <TouchableOpacity 
          style={[styles.button, styles.primaryButton]}
          onPress={() => navigation.navigate('CreateRoom')}
        >
          <Text style={styles.buttonText}>Créer une salle</Text>
        </TouchableOpacity>
        
        <TouchableOpacity 
          style={[styles.button, styles.secondaryButton]}
          onPress={() => navigation.navigate('JoinRoom')}
        >
          <Text style={[styles.buttonText, styles.secondaryButtonText]}>Rejoindre une salle</Text>
        </TouchableOpacity>
      </View>

      <View style={styles.infoCard}>
        <Text style={styles.infoTitle}>Comment jouer ?</Text>
        <Text style={styles.infoText}>• Créez une salle ou rejoignez-en une</Text>
        <Text style={styles.infoText}>• Partagez le code avec votre ami</Text>
        <Text style={styles.infoText}>• Répondez aux questions le plus vite possible</Text>
        <Text style={styles.infoText}>• Le gagnant est celui avec le meilleur score !</Text>
      </View>
    </View>
  );
}

// Écran de création de salle
function CreateRoomScreen({ navigation }) {
  const [roomCode, setRoomCode] = useState('');

  const generateRoomCode = () => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    setRoomCode(code);
  };

  const createRoom = () => {
    if (roomCode) {
      navigation.navigate('Waiting', { 
        roomCode: roomCode, 
        isHost: true 
      });
    }
  };

  useEffect(() => {
    generateRoomCode();
  }, []);

  return (
    <View style={styles.container}>
      <View style={styles.card}>
        <Text style={styles.title}>Créer une salle</Text>
        <Text style={styles.paragraph}>
          Partagez ce code avec votre ami pour qu'il puisse vous rejoindre
        </Text>
        
        <View style={styles.roomCodeContainer}>
          <Text style={styles.roomCodeLabel}>Code de la salle :</Text>
          <Text style={styles.roomCode}>{roomCode}</Text>
        </View>

        <TouchableOpacity 
          style={[styles.button, styles.primaryButton]}
          onPress={createRoom}
        >
          <Text style={styles.buttonText}>Créer la salle</Text>
        </TouchableOpacity>

        <TouchableOpacity 
          style={[styles.button, styles.secondaryButton]}
          onPress={generateRoomCode}
        >
          <Text style={[styles.buttonText, styles.secondaryButtonText]}>Générer un nouveau code</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

// Écran de rejoindre une salle
function JoinRoomScreen({ navigation }) {
  const [roomCode, setRoomCode] = useState('');

  const joinRoom = () => {
    if (roomCode.length === 6) {
      navigation.navigate('Waiting', { 
        roomCode: roomCode.toUpperCase(), 
        isHost: false 
      });
    } else {
      Alert.alert('Erreur', 'Le code doit contenir 6 caractères');
    }
  };

  return (
    <View style={styles.container}>
      <View style={styles.card}>
        <Text style={styles.title}>Rejoindre une salle</Text>
        <Text style={styles.paragraph}>
          Entrez le code de la salle partagé par votre ami
        </Text>
        
        <View style={styles.inputContainer}>
          <Text style={styles.inputLabel}>Code de la salle :</Text>
          <TextInput
            style={styles.textInput}
            value={roomCode}
            onChangeText={setRoomCode}
            placeholder="Ex: ABC123"
            maxLength={6}
            autoCapitalize="characters"
          />
        </View>

        <TouchableOpacity 
          style={[styles.button, styles.primaryButton, !roomCode && styles.disabledButton]}
          onPress={joinRoom}
          disabled={!roomCode}
        >
          <Text style={styles.buttonText}>Rejoindre la salle</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

// Écran d'attente
function WaitingScreen({ route, navigation }) {
  const { roomCode, isHost } = route.params;
  const [players, setPlayers] = useState(isHost ? 1 : 2);

  const startGame = () => {
    navigation.navigate('Quiz', { 
      roomCode: roomCode,
      isHost: isHost 
    });
  };

  useEffect(() => {
    // Simulation d'un deuxième joueur qui rejoint après 3 secondes
    if (isHost) {
      const timer = setTimeout(() => {
        setPlayers(2);
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [isHost]);

  return (
    <View style={styles.container}>
      <View style={styles.card}>
        <Text style={styles.title}>
          {isHost ? 'En attente des joueurs...' : 'En attente du début du jeu...'}
        </Text>
        
        <View style={styles.roomCodeContainer}>
          <Text style={styles.roomCodeLabel}>Code de la salle :</Text>
          <Text style={styles.roomCode}>{roomCode}</Text>
        </View>

        <View style={styles.playersContainer}>
          <Text style={styles.playersText}>Joueurs connectés : {players}/2</Text>
          <View style={styles.playersList}>
            <Text style={styles.player}>• Joueur 1 {isHost ? '(Hôte)' : ''}</Text>
            {players > 1 && <Text style={styles.player}>• Joueur 2 {!isHost ? '(Hôte)' : ''}</Text>}
          </View>
        </View>

        {isHost && players === 2 && (
          <TouchableOpacity 
            style={[styles.button, styles.primaryButton]}
            onPress={startGame}
          >
            <Text style={styles.buttonText}>Commencer le quiz</Text>
          </TouchableOpacity>
        )}

        {!isHost && (
          <Text style={styles.waitingText}>
            En attente que l'hôte commence le jeu...
          </Text>
        )}
      </View>
    </View>
  );
}

// Écran du quiz
function QuizScreen({ route, navigation }) {
  const { roomCode, isHost } = route.params;
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [score, setScore] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState('');
  const [timeLeft, setTimeLeft] = useState(30);
  const [gameFinished, setGameFinished] = useState(false);

  // Sélection aléatoire de 3 questions
  const selectedQuestions = React.useMemo(() => {
    const allQuestions = quizQuestions.flatMap(category => category.questions);
    const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 3);
  }, []);

  const currentQ = selectedQuestions[currentQuestion];

  const handleAnswer = () => {
    if (selectedAnswer === currentQ.answer) {
      setScore(score + 1);
    }

    if (currentQuestion < selectedQuestions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      setSelectedAnswer('');
      setTimeLeft(30);
    } else {
      setGameFinished(true);
    }
  };

  useEffect(() => {
    if (timeLeft > 0 && !gameFinished) {
      const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
      return () => clearTimeout(timer);
    } else if (timeLeft === 0 && !gameFinished) {
      if (currentQuestion < selectedQuestions.length - 1) {
        setCurrentQuestion(currentQuestion + 1);
        setSelectedAnswer('');
        setTimeLeft(30);
      } else {
        setGameFinished(true);
      }
    }
  }, [timeLeft, gameFinished]);

  const restartGame = () => {
    setCurrentQuestion(0);
    setScore(0);
    setSelectedAnswer('');
    setTimeLeft(30);
    setGameFinished(false);
  };

  if (gameFinished) {
    return (
      <View style={styles.container}>
        <View style={styles.card}>
          <Text style={styles.title}>Quiz Terminé !</Text>
          <Text style={styles.score}>
            Votre score : {score}/{selectedQuestions.length}
          </Text>
          <Text style={styles.percentage}>
            {Math.round((score / selectedQuestions.length) * 100)}%
          </Text>
          
          <TouchableOpacity 
            style={[styles.button, styles.primaryButton]}
            onPress={restartGame}
          >
            <Text style={styles.buttonText}>Rejouer</Text>
          </TouchableOpacity>
          
          <TouchableOpacity 
            style={[styles.button, styles.secondaryButton]}
            onPress={() => navigation.navigate('Home')}
          >
            <Text style={[styles.buttonText, styles.secondaryButtonText]}>Retour à l'accueil</Text>
          </TouchableOpacity>
        </View>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <View style={styles.quizHeader}>
        <Text style={styles.timer}>Temps: {timeLeft}s</Text>
        <Text style={styles.scoreText}>Score: {score}</Text>
        <Text style={styles.questionCount}>
          Question {currentQuestion + 1}/{selectedQuestions.length}
        </Text>
      </View>

      <View style={styles.card}>
        <Text style={styles.question}>{currentQ.question}</Text>
        
        <RadioButton.Group onValueChange={setSelectedAnswer} value={selectedAnswer}>
          {currentQ.options.map((option, index) => (
            <View key={index} style={styles.option}>
              <RadioButton value={option} color="#2196F3" />
              <Text style={styles.optionText}>{option}</Text>
            </View>
          ))}
        </RadioButton.Group>

        <TouchableOpacity 
          style={[styles.button, styles.primaryButton, !selectedAnswer && styles.disabledButton]}
          onPress={handleAnswer}
          disabled={!selectedAnswer}
        >
          <Text style={styles.buttonText}>
            {currentQuestion < selectedQuestions.length - 1 ? 'Question suivante' : 'Terminer le quiz'}
          </Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

// Styles
const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 20,
    backgroundColor: '#f5f5f5',
  },
  card: {
    backgroundColor: 'white',
    padding: 20,
    borderRadius: 10,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    textAlign: 'center',
    marginBottom: 10,
    color: '#333',
  },
  paragraph: {
    fontSize: 16,
    textAlign: 'center',
    marginBottom: 20,
    color: '#666',
    lineHeight: 22,
  },
  buttonContainer: {
    marginTop: 20,
  },
  button: {
    padding: 15,
    borderRadius: 8,
    marginVertical: 8,
    alignItems: 'center',
  },
  primaryButton: {
    backgroundColor: '#2196F3',
  },
  secondaryButton: {
    backgroundColor: 'transparent',
    borderWidth: 2,
    borderColor: '#2196F3',
  },
  disabledButton: {
    backgroundColor: '#ccc',
  },
  buttonText: {
    fontSize: 16,
    fontWeight: 'bold',
    color: 'white',
  },
  secondaryButtonText: {
    color: '#2196F3',
  },
  infoCard: {
    marginTop: 30,
    padding: 15,
    backgroundColor: '#e3f2fd',
    borderRadius: 8,
  },
  infoTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 10,
    color: '#1976d2',
  },
  infoText: {
    fontSize: 14,
    color: '#555',
    marginBottom: 5,
  },
  roomCodeContainer: {
    alignItems: 'center',
    marginVertical: 20,
  },
  roomCodeLabel: {
    fontSize: 16,
    marginBottom: 10,
  },
  roomCode: {
    fontSize: 32,
    fontWeight: 'bold',
    letterSpacing: 5,
    color: '#2196F3',
  },
  inputContainer: {
    marginVertical: 20,
  },
  inputLabel: {
    fontSize: 16,
    marginBottom: 10,
  },
  textInput: {
    borderWidth: 1,
    borderColor: '#ddd',
    borderRadius: 8,
    padding: 15,
    fontSize: 16,
    textAlign: 'center',
  },
  playersContainer: {
    marginVertical: 20,
  },
  playersText: {
    fontSize: 16,
    fontWeight: 'bold',
    marginBottom: 10,
  },
  playersList: {
    marginLeft: 10,
  },
  player: {
    fontSize: 14,
    marginBottom: 5,
  },
  waitingText: {
    textAlign: 'center',
    fontStyle: 'italic',
    color: '#666',
    marginTop: 20,
  },
  quizHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 20,
  },
  timer: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#f44336',
  },
  scoreText: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#4caf50',
  },
  questionCount: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#2196F3',
  },
  question: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 20,
    textAlign: 'center',
  },
  option: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 10,
    padding: 10,
    backgroundColor: '#f9f9f9',
    borderRadius: 5,
  },
  optionText: {
    fontSize: 16,
    marginLeft: 10,
  },
  score: {
    fontSize: 20,
    fontWeight: 'bold',
    textAlign: 'center',
    marginVertical: 10,
  },
  percentage: {
    fontSize: 32,
    fontWeight: 'bold',
    textAlign: 'center',
    color: '#2196F3',
    marginBottom: 20,
  },
});

export default function App() {
  return (
    <NavigationContainer>
      <Stack.Navigator initialRouteName="Home">
        <Stack.Screen name="Home" component={HomeScreen} options={{ title: 'Quiz Multijoueur' }} />
        <Stack.Screen name="CreateRoom" component={CreateRoomScreen} options={{ title: 'Créer une salle' }} />
        <Stack.Screen name="JoinRoom" component={JoinRoomScreen} options={{ title: 'Rejoindre une salle' }} />
        <Stack.Screen name="Waiting" component={WaitingScreen} options={{ title: 'En attente' }} />
        <Stack.Screen name="Quiz" component={QuizScreen} options={{ title: 'Quiz en cours', headerBackVisible: false }} />
      </Stack.Navigator>
    </NavigationContainer>
  );
}
{
  "name": "quizmultiplayer",
  "version": "1.0.0",
  "main": "node_modules/expo/AppEntry.js",
  "scripts": {
    "start": "expo start",
    "android": "expo start --android",
    "ios": "expo start --ios",
    "web": "expo start --web"
  },
  "dependencies": {
    "expo": "~49.0.0",
    "expo-status-bar": "~1.6.0",
    "react": "18.2.0",
    "react-native": "0.72.3",
    "@react-navigation/native": "^6.1.7",
    "@react-navigation/native-stack": "^6.9.13",
    "react-native-paper": "^5.9.1",
    "react-native-screens": "~3.22.0",
    "react-native-safe-area-context": "4.6.3"
  },
  "devDependencies": {
    "@babel/core": "^7.20.0"
  },
  "private": true
}