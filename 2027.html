import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
import { getDatabase, ref, onValue, set, push, update } from "firebase/database";

// Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBr8Fzdvh1En3rAxGFipOYfgr0YDeeM_Bo",
  authDomain: "match-en-ligne.firebaseapp.com",
  projectId: "match-en-ligne",
  storageBucket: "match-en-ligne.firebasestorage.app",
  messagingSenderId: "706011207623",
  appId: "1:706011207623:web:17374990a6202b64f0abe2",
  measurementId: "G-D9XYRE3W2M",
  databaseURL: "https://match-en-ligne-default-rtdb.firebaseio.com/" // Ajoutez cette ligne
};

// Initialisation Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const database = getDatabase(app);

class FirebaseRealtime {
  constructor() {
    this.matchesRef = ref(database, 'matches');
    this.usersRef = ref(database, 'users');
  }

  // Écouter les changements en temps réel
  listenToMatches(callback) {
    return onValue(this.matchesRef, (snapshot) => {
      const data = snapshot.val();
      callback(data);
    });
  }

  // Écouter un match spécifique
  listenToMatch(matchId, callback) {
    const matchRef = ref(database, `matches/${matchId}`);
    return onValue(matchRef, (snapshot) => {
      const data = snapshot.val();
      callback(data);
    });
  }

  // Créer un nouveau match
  async createMatch(matchData) {
    try {
      const newMatchRef = push(this.matchesRef);
      await set(newMatchRef, {
        ...matchData,
        createdAt: Date.now(),
        status: 'en_attente'
      });
      return newMatchRef.key;
    } catch (error) {
      console.error('Erreur création match:', error);
      throw error;
    }
  }

  // Mettre à jour un match
  async updateMatch(matchId, updates) {
    try {
      const matchRef = ref(database, `matches/${matchId}`);
      await update(matchRef, {
        ...updates,
        updatedAt: Date.now()
      });
    } catch (error) {
      console.error('Erreur mise à jour match:', error);
      throw error;
    }
  }

  // Ajouter un utilisateur
  async addUser(userData) {
    try {
      const newUserRef = push(this.usersRef);
      await set(newUserRef, {
        ...userData,
        createdAt: Date.now(),
        isOnline: true
      });
      return newUserRef.key;
    } catch (error) {
      console.error('Erreur ajout utilisateur:', error);
      throw error;
    }
  }
}

// Exemple d'utilisation
const firebaseRT = new FirebaseRealtime();

// Écouter tous les matches en temps réel
firebaseRT.listenToMatches((matches) => {
  console.log('Matches mis à jour:', matches);
  // Mettre à jour votre interface utilisateur ici
});

// Exporter pour utilisation dans d'autres fichiers
export default firebaseRT;