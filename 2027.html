<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match en Ligne - Jeu Ã‰ducatif</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        /* Votre style CSS ici... */
    </style>
</head>
<body>
    <div class="audio-controls">
        <button class="audio-btn" id="toggleAudio" title="Activer/DÃ©sactiver le son">ğŸ”Š</button>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ® MATCH EN LIGNE ğŸ®</h1>
            <p class="subtitle">âœ¨ Apprends en t'amusant avec tes amis ! âœ¨</p>
            <div class="online-status" id="onlineStatus" style="display: none;">
                <div class="presence-indicator presence-online"></div>
                <span class="status-text">0/0 joueurs en ligne</span>
            </div>
        </header>

        <!-- Menu Principal -->
        <div class="game-mode" id="gameMode">
            <div class="mode-card" onclick="selectMode('solo')">
                <div class="mode-icon">ğŸ¯</div>
                <h3>Mode Solo</h3>
                <p>EntraÃ®ne-toi seul et deviens un champion ! ğŸ’ª</p>
                <button class="btn">Jouer en Solo</button>
            </div>
            <div class="mode-card" onclick="selectMode('multiplayer')">
                <div class="mode-icon">ğŸ‘¥</div>
                <h3>Mode Multiplayer</h3>
                <p>Joue avec tes amis et dÃ©fie-les ! ğŸ†</p>
                <button class="btn">Jouer Ã  Plusieurs</button>
            </div>
        </div>

        <!-- Saisie du nom -->
        <div class="name-input-area" id="nameInputArea">
            <h3>ğŸ‘¤ Choisis ton nom de super hÃ©ros !</h3>
            <p>Comment veux-tu qu'on t'appelle ?</p>
            <input type="text" class="input-field" id="playerNameInput" placeholder="Ex: SuperJoueur123" maxlength="20">
            <button class="btn btn-success" onclick="confirmName()">C'est parti ! ğŸš€</button>
        </div>

        <!-- Interface Multiplayer -->
        <div class="session-interface" id="multiplayerInterface">
            <div class="mode-card" onclick="createSession()">
                <div class="mode-icon">ğŸ </div>
                <h3>CrÃ©er une Salle</h3>
                <p>CrÃ©e ta propre salle et invite tes amis ! ğŸ“¨</p>
                <button class="btn">CrÃ©er une Salle</button>
            </div>
            <div class="mode-card" onclick="showJoinInterface()">
                <div class="mode-icon">ğŸ”—</div>
                <h3>Rejoindre une Salle</h3>
                <p>Rejoins une salle avec le code de ton ami ! ğŸ”¢</p>
                <button class="btn">Rejoindre</button>
            </div>
            <button class="btn" onclick="showMainMenu()">Retour au menu</button>
        </div>

        <!-- Interface Rejoindre -->
        <div class="session-interface" id="joinInterface">
            <h3>ğŸ”— Rejoindre une Salle</h3>
            <p>Entre le code de la salle de ton ami :</p>
            <input type="text" class="input-field" id="joinCodeInput" placeholder="4 lettres (ex: ABCD)" maxlength="4" style="text-transform: uppercase;">
            <button class="btn btn-success" onclick="joinSession()">Rejoindre la partie ! ğŸ‰</button>
            <button class="btn" onclick="showMultiplayerInterface()">Retour</button>
        </div>

        <!-- Interface CrÃ©ation de Salle -->
        <div class="session-interface" id="createSessionInterface">
            <h3>ğŸ‰ Super ! Ta salle est crÃ©Ã©e !</h3>
            <p>Partage ce code magique avec tes amis :</p>
            <div class="code-display" id="sessionCode">----</div>
            <div class="online-status" id="sessionOnlineStatus">
                <div class="presence-indicator presence-online"></div>
                <span class="status-text">1/1 joueurs en ligne</span>
            </div>
            <div class="players-container" id="playersList"></div>
            <button class="btn btn-success" onclick="startGame()" id="startBtn">DÃ©marrer la Partie ! ğŸš€</button>
            <button class="btn" onclick="leaveSession()">Quitter</button>
        </div>

        <!-- Zone de Jeu -->
        <div class="game-area" id="gameArea">
            <div class="game-header">
                <h2 class="game-title" id="gameTitle">Chargement... â³</h2>
                <div class="game-timer" id="gameTimer">12</div>
            </div>
            <div class="game-content" id="gameContent">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>

    <script>
        // ============================
        // CONFIGURATION FIREBASE
        // ============================
        const firebaseConfig = {
            apiKey: "AIzaSyBr8Fzdvh1En3rAxGFipOYfgr0YDeeM_Bo",
            authDomain: "match-en-ligne.firebaseapp.com",
            projectId: "match-en-ligne",
            storageBucket: "match-en-ligne.firebasestorage.app",
            messagingSenderId: "706011207623",
            appId: "1:706011207623:web:17374990a6202b64f0abe2",
            measurementId: "G-D9XYRE3W2M"
        };

        // Initialisation Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("ğŸ”¥ Firebase initialisÃ© avec succÃ¨s !");
        } catch (error) {
            console.log("Firebase dÃ©jÃ  initialisÃ©");
        }
        const db = firebase.firestore();

        // ============================
        // VARIABLES GLOBALES
        // ============================
        let currentSession = null;
        let players = [];
        let playerId = Math.random().toString(36).substr(2, 9);
        let playerName = "";
        let isHost = false;

        // ============================
        // INITIALISATION
        // ============================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ğŸ® Match en Ligne - Initialisation");
        });

        // ============================
        // GESTION DE LA NAVIGATION
        // ============================
        function selectMode(mode) {
            createConfetti(20);
            document.getElementById('gameMode').style.display = 'none';
            if (mode === 'multiplayer') {
                showNameInput();
            } else {
                startSoloGame();
            }
        }

        function showNameInput() {
            document.getElementById('nameInputArea').style.display = 'block';
            document.getElementById('playerNameInput').focus();
        }

        function confirmName() {
            const nameInput = document.getElementById('playerNameInput').value.trim();
            if (nameInput.length < 2) {
                showError("Choisis un nom d'au moins 2 lettres ! âœï¸");
                return;
            }
            
            playerName = nameInput;
            document.getElementById('nameInputArea').style.display = 'none';
            showMultiplayerInterface();
            showFunMessage(`Bienvenue ${playerName} ! ğŸ‰`);
        }

        function showMainMenu() {
            resetInterface();
        }

        function showMultiplayerInterface() {
            document.getElementById('multiplayerInterface').style.display = 'block';
        }

        function showJoinInterface() {
            document.getElementById('multiplayerInterface').style.display = 'none';
            document.getElementById('joinInterface').style.display = 'block';
            document.getElementById('joinCodeInput').focus();
        }

        // ============================
        // GESTION DES SESSIONS - CRÃ‰ATION DE SALLE FONCTIONNELLE
        // ============================
        async function createSession() {
            try {
                showFunMessage("CrÃ©ation de ta salle magique... âœ¨");
                
                const sessionCode = generateSessionCode();
                currentSession = sessionCode;
                isHost = true;

                const playerData = {
                    id: playerId,
                    name: playerName,
                    score: 0,
                    isOnline: true,
                    hasAnswered: false
                };

                await db.collection('sessions').doc(sessionCode).set({
                    code: sessionCode,
                    host: playerId,
                    players: [playerData],
                    status: 'waiting',
                    gameState: 'lobby',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showCreateSessionInterface(sessionCode);
                listenToSessionChanges();
                showFunMessage(`ğŸŠ Salle crÃ©Ã©e ! Code: ${sessionCode}`);
                
            } catch (error) {
                console.error("Erreur crÃ©ation:", error);
                showFunMessage("Erreur de crÃ©ation. RÃ©essayez !");
            }
        }

        function showCreateSessionInterface(code) {
            document.getElementById('multiplayerInterface').style.display = 'none';
            document.getElementById('joinInterface').style.display = 'none';
            document.getElementById('createSessionInterface').style.display = 'block';
            document.getElementById('sessionCode').textContent = code;
        }

        async function joinSession() {
            const code = document.getElementById('joinCodeInput').value.toUpperCase().trim();
            if (code.length !== 4) {
                showError("Le code doit avoir 4 lettres ! ğŸ”¤");
                return;
            }

            try {
                showFunMessage("Connexion Ã  la salle... ğŸ”—");
                
                const sessionDoc = await db.collection('sessions').doc(code).get();
                if (!sessionDoc.exists) {
                    showError("Salle non trouvÃ©e ! VÃ©rifie le code. ğŸ”");
                    return;
                }

                const sessionData = sessionDoc.data();
                if (sessionData.status !== 'waiting') {
                    showError("La partie a dÃ©jÃ  commencÃ© ! â°");
                    return;
                }

                currentSession = code;
                
                const playerData = {
                    id: playerId,
                    name: playerName,
                    score: 0,
                    isOnline: true,
                    hasAnswered: false
                };

                await db.collection('sessions').doc(code).update({
                    players: firebase.firestore.FieldValue.arrayUnion(playerData)
                });

                showCreateSessionInterface(code);
                listenToSessionChanges();
                showFunMessage(`ğŸ¯ ConnectÃ© Ã  la salle ${code} !`);
                
            } catch (error) {
                console.error("Erreur connexion:", error);
                showError("Impossible de se connecter. RÃ©essaie ! ğŸ”„");
            }
        }

        function listenToSessionChanges() {
            db.collection('sessions').doc(currentSession).onSnapshot((doc) => {
                const sessionData = doc.data();
                players = sessionData.players;
                updatePlayersList();
            });
        }

        function updatePlayersList() {
            const container = document.getElementById('playersList');
            if (!container) return;

            container.innerHTML = players.map(player => `
                <div class="player-card ${player.id === playerId ? 'active' : ''}">
                    <div class="player-header">
                        <div class="player-name">${player.name}</div>
                        <div class="presence-indicator ${player.isOnline ? 'presence-online' : 'presence-offline'}"></div>
                    </div>
                    <div class="player-score">${player.score} pts</div>
                </div>
            `).join('');
        }

        function generateSessionCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function resetInterface() {
            const interfaces = [
                'createSessionInterface', 'gameArea', 'multiplayerInterface',
                'joinInterface', 'nameInputArea'
            ];
            interfaces.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });

            document.getElementById('gameMode').style.display = 'grid';
        }

        function showError(message) {
            alert(message);
        }

        function showFunMessage(message) {
            alert(message);
        }
    </script>
</body>
</html>