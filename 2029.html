<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeu de Calcul Mental</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(270deg, #6a11cb, #2575fc, #6a11cb);
      background-size: 600% 600%;
      animation: gradientAnimation 15s ease infinite;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    @keyframes gradientAnimation {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }

    .container {
      background: rgba(255, 255, 255, 0.1);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(12px);
      max-width: 600px;
      width: 90%;
      text-align: center;
      animation: fadeIn 1.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      font-weight: 800;
      margin-bottom: 12px;
      font-size: 2rem;
      text-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    }

    #metaBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      opacity:.95;
      font-weight:600;
      flex-wrap: wrap;
    }

    #pageInfo, #difficultyBadge{
      background: rgba(255,255,255,.15);
      padding: 6px 10px;
      border-radius: 10px;
    }

    #timer {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: .06em;
      text-shadow: 0 0 10px rgba(0,0,0,.25);
      margin: 10px 0 6px;
      min-width: 2ch;
      text-align: center;
    }

    #questionDisplay {
      font-size: 2.2rem;
      font-weight: bold;
      letter-spacing: 0.12em;
      margin-bottom: 20px;
      min-height: 50px;
    }

    input[type="text"] {
      font-size: 1.4rem;
      padding: 15px;
      border-radius: 10px;
      border: none;
      width: 100%;
      margin-bottom: 14px;
      background-color: #fff;
      color: #333;
      outline: none;
      box-shadow: inset 0 0 0 rgba(0, 0, 0, 0);
      transition: all 0.3s ease;
    }

    input[type="text"]:focus {
      box-shadow: 0 0 10px #2575fc;
      caret-color: #2575fc;
    }

    .buttons, .pager {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 6px;
    }

    .pager {
      margin-top: 14px;
      align-items: center;
    }

    button {
      flex: 1 1 40%;
      padding: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #fff;
      color: #2575fc;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .pager button {
      flex: 0 0 auto;
      min-width: 140px;
    }

    button:hover {
      background: #2575fc;
      color: #fff;
      box-shadow: 0 0 12px #ffffff99, 0 0 18px #2575fcaa;
    }

    #message {
      margin-top: 12px;
      font-size: 1.15rem;
      font-weight: 700;
      min-height: 32px;
      text-shadow: 0 0 8px rgba(0,0,0,0.1);
      transition: color 0.3s ease;
    }

    #pageJump {
      width: 90px;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1> Calcul Mental</h1>

    <!-- Barre m√©ta : page & difficult√© & timer -->
    <div id="metaBar">
      <div id="pageInfo">Page 1 / 1</div>
      <div id="difficultyBadge">Difficult√© : ‚Äî</div>
      <div id="timer">‚Äî</div>
    </div>

    <div id="questionDisplay">Question</div>
    <input type="text" id="answer" placeholder="R√©ponse..." />

    <div class="buttons">
      <button id="btnPlay">‚ñ∂Ô∏è Jouer</button>
      <button id="btnSlow">üê¢ Ralentir</button>
      <button id="btnFast">üêá Acc√©l√©rer</button>
      <button id="btnRepeat">üîÅ R√©p√©ter</button>
      <button id="btnSkip">‚è≠ Passer</button>
      <button id="btnBack">‚¨ÖÔ∏è Retour</button>
    </div>

    <!-- Pagination contr√¥l√©e par l‚Äôutilisateur -->
    <div class="pager">
      <button id="btnPrevPage">‚¨ÖÔ∏è Page pr√©c√©dente</button>
      <div>
        Aller √† la page :
        <input type="number" id="pageJump" min="1" value="1"/>
        <button id="btnGoPage">Aller</button>
      </div>
      <button id="btnNextPage">Page suivante ‚û°Ô∏è</button>
    </div>

    <div id="message"></div>
  </div>


  <script>
/* --------------------
 * 1) QUESTIONS (inchang√©)
 * -------------------- */
const questions = [
  { question: "81 √∑ 9", answer: 9 },
  { question: "6 √ó 2 + 4 √∑ 2", answer: 14 },
  { question: "12 √ó 3 - 4", answer: 32 },
  { question: "25 √ó 4 √∑ 5", answer: 20 },
  { question: "15 √ó 5", answer: 75 },
  { question: "7 + 5 √ó 3", answer: 22 },
  { question: "81 √∑ 9 + 3", answer: 12 },
  { question: "100 √∑ 2 - 10", answer: 40 },
  { question: "9 √ó 8 - 20", answer: 52 },
  { question: "12 √ó 5 √∑ 3", answer: 20 },
  { question: "10 √∑ 2 + 3 √ó 4", answer: 17 },
  { question: "5 √ó 3 + 6 √∑ 2", answer: 18 },
  { question: "12 √∑ 3 + 4 √ó 2", answer: 12 },
  { question: "7 √ó 2 + 8 √∑ 4", answer: 16 },
  { question: "8 √∑ 2 + 5 √ó 3", answer: 19 },
  { question: "6 √ó 3 + 9 √∑ 3", answer: 21 },
  { question: "16 √∑ 4 + 2 √ó 6", answer: 16 },
  { question: "9 √ó 2 + 4 √∑ 2", answer: 20 },
  { question: "12 √∑ 2 + 3 √ó 2", answer: 12 },
  { question: "7 √ó 3 + 6 √∑ 3", answer: 23 },
  { question: "10 √∑ 5 + 4 √ó 4", answer: 18 },
  { question: "8 √ó 2 + 10 √∑ 2", answer: 21 },
  { question: "18 √∑ 3 + 5 √ó 2", answer: 16 },
  { question: "6 √ó 4 + 8 √∑ 4", answer: 26 },
  { question: "15 √∑ 3 + 3 √ó 5", answer: 20 },
  { question: "4 √ó 2 + 12 √∑ 3", answer: 12 },
  { question: "16 √∑ 4 + 6 √ó 2", answer: 16 },
  { question: "3 √ó 5 + 9 √∑ 3", answer: 18 },
  { question: "20 √∑ 5 + 4 √ó 2", answer: 12 },
  { question: "6 √ó 3 + 8 √∑ 4", answer: 20 },
  { question: "12 √∑ 2 + 7 √ó 1", answer: 13 },
  { question: "8 √ó 2 + 6 √∑ 3", answer: 18 },
  { question: "9 √∑ 3 + 4 √ó 3", answer: 15 },
  { question: "5 √ó 2 + 18 √∑ 6", answer: 13 },
  { question: "14 √∑ 2 + 3 √ó 3", answer: 16 },
  { question: "3 √ó 4 + 8 √∑ 4", answer: 14 },
  { question: "18 √∑ 6 + 5 √ó 2", answer: 13 },
  { question: "10 √ó 1 + 9 √∑ 3", answer: 13 },
  { question: "6 √∑ 2 + 7 √ó 2", answer: 17 },
  { question: "8 √ó 3 + 6 √∑ 2", answer: 27 },
  { question: "15 √∑ 5 + 2 √ó 4", answer: 11 },
  { question: "9 √ó 2 + 10 √∑ 5", answer: 22 },
  { question: "12 √∑ 3 + 6 √ó 2", answer: 16 },
  { question: "4 √ó 4 + 12 √∑ 3", answer: 20 },
  { question: "18 √∑ 3 + 2 √ó 3", answer: 12 },
  { question: "5 √ó 3 + 9 √∑ 3", answer: 18 },
  { question: "14 √∑ 2 + 3 √ó 4", answer: 19 },
  { question: "7 √ó 2 + 10 √∑ 2", answer: 19 },
  { question: "10 √∑ 2 + 6 √ó 2", answer: 17 },
  /* ... garde le reste de tes 804 questions ... */
];

/* ---------------------------------------------------------
 * 2) Variables existantes + nouveaux √©l√©ments (IDs inchang√©s)
 * --------------------------------------------------------- */
let currentQuestionIndex = 0;
const questionDisplay = document.getElementById("questionDisplay");
const answerInput = document.getElementById("answer");
const message = document.getElementById("message");
const btnPlay = document.getElementById("btnPlay");
const btnSlow = document.getElementById("btnSlow");
const btnFast = document.getElementById("btnFast");
const btnRepeat = document.getElementById("btnRepeat");
const btnSkip = document.getElementById("btnSkip");
const btnBack = document.getElementById("btnBack");

const timerEl = document.getElementById("timer");
const pageInfoEl = document.getElementById("pageInfo");
const difficultyBadge = document.getElementById("difficultyBadge");

// Pagination UI
const btnPrevPage = document.getElementById("btnPrevPage");
const btnNextPage = document.getElementById("btnNextPage");
const pageJump = document.getElementById("pageJump");
const btnGoPage = document.getElementById("btnGoPage");

let speechRate = 1;

/* --------------------------------------
 * 3) Utilitaires de discours
 * -------------------------------------- */
function replaceOperators(text) {
  return text
    .replace(/√∑/g, "diviser par")
    .replace(/√ó/g, "fois")
    .replace(/-/g, "moins")
    .replace(/\+/g, "plus");
}

// Encha√Æne plusieurs messages vocaux, puis appelle un callback
function speakSequence(texts, onDone){
  if (!('speechSynthesis' in window)) {
    onDone?.(); // si pas de TTS, on d√©marre tout de suite le chrono
    return;
  }
  speechSynthesis.cancel();
  let i = 0;
  const speakNext = () => {
    if (i >= texts.length){
      onDone?.();
      return;
    }
    const u = new SpeechSynthesisUtterance(texts[i]);
    u.lang = "fr-FR";
    u.rate = speechRate;
    u.onend = () => {
      i++;
      speakNext();
    };
    speechSynthesis.speak(u);
  };
  speakNext();
}

function speakQuestion(text){ speakSequence([text]); }
function speakMessage(text){ speakSequence([text]); }

/* ---------------------------------------------------
 * 4) Heuristique de difficult√© + ordre √©quilibr√©
 * --------------------------------------------------- */
function difficultyOf(expression){
  const nums = expression.match(/-?\d+(\.\d+)?/g)?.map(Number) || [];
  const maxN = nums.length ? Math.max(...nums) : 0;
  const hasMul = /√ó/.test(expression);
  const hasDiv = /√∑/.test(expression);
  const opsCount = (expression.match(/[+\-√ó√∑]/g) || []).length;
  const len = expression.length;

  let score = 0;
  if (maxN >= 50) score += 2;
  if (maxN >= 100) score += 3;
  if (hasMul) score += 1.5;
  if (hasDiv) score += 1.5;
  if (opsCount >= 3) score += 1.5;
  if (len >= 10) score += 1;

  return score >= 3 ? 'difficile' : 'facile';
}

function reorderBalanced(list){
  const easy = [], hard = [];
  list.forEach(q => (difficultyOf(q.question) === 'facile' ? easy : hard).push(q));
  const merged = [];
  while (easy.length || hard.length){
    if (easy.length) merged.push(easy.shift());
    if (hard.length) merged.push(hard.shift());
  }
  return merged;
}
let orderedQuestions = reorderBalanced(questions);

/* --------------------------------------
 * 5) Chronom√®tre (d√©marre APR√àS la lecture audio)
 * -------------------------------------- */
let countdownId = null;
let timeLeft = 0;

function clearCountdown(){
  if (countdownId){
    clearInterval(countdownId);
    countdownId = null;
  }
}

function startCountdown(seconds, onExpire){
  clearCountdown();
  timeLeft = seconds;
  timerEl.textContent = timeLeft.toString();
  countdownId = setInterval(() => {
    timeLeft--;
    timerEl.textContent = timeLeft >= 0 ? timeLeft.toString() : "0";
    if (timeLeft <= 0){
      clearCountdown();
      onExpire?.();
    }
  }, 1000);
}

/* --------------------------------------
 * 5bis) Reconnaissance vocale (r√©ponse parl√©e)
 * -------------------------------------- */
let recognition = null;
let listening = false;

function initSpeechRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;
  const r = new SR();
  r.lang = "fr-FR";
  r.interimResults = false;
  r.continuous = false;
  r.maxAlternatives = 3;
  return r;
}

function stopListening(){
  if (recognition && listening){
    try { recognition.onresult = null; recognition.onerror = null; recognition.onend = null; recognition.stop(); } catch(e){}
    listening = false;
  }
}

function parseNumberFromTranscript(tx){
  // normaliser virgules et mots courants
  let s = String(tx).toLowerCase().replace(',', '.').trim();
  // enlever le texte non num√©rique
  const numMatch = s.match(/-?\d+(\.\d+)?/);
  if (!numMatch) return NaN;
  return parseFloat(numMatch[0]);
}

function startListeningForAnswer(expectedAnswer, onCorrect){
  if (!recognition){
    recognition = initSpeechRecognition();
    if (!recognition) return; // non support√©
  }
  stopListening();
  listening = true;

  recognition.onresult = (ev) => {
    if (!listening) return;
    const altTexts = [];
    for (let i=0;i<ev.results.length;i++){
      for (let j=0;j<ev.results[i].length;j++){
        altTexts.push(ev.results[i][j].transcript);
      }
    }
    // Essayer chaque alternative
    for (const tx of altTexts){
      const n = parseNumberFromTranscript(tx);
      if (!Number.isNaN(n) && Math.abs(n - Number(expectedAnswer)) < 1e-9){
        stopListening();
        onCorrect?.();
        return;
      }
    }
    // Si incorrect, on peut continuer d'√©couter durant le chrono
    // Relancer une √©coute unique pendant que le timer tourne
    if (listening){
      try { recognition.start(); } catch(e){}
    }
  };

  recognition.onerror = () => {
    // silencieux : on n'interrompt pas le jeu
  };
  recognition.onend = () => {
    // Tant que le timer court, on relance l‚Äô√©coute pour capter une nouvelle tentative
    if (listening && countdownId){
      try { recognition.start(); } catch(e){}
    }
  };

  try {
    recognition.start();
    // message visuel
    message.textContent = "üéôÔ∏è Dites votre r√©ponse ou tapez-la‚Ä¶";
    message.style.color = "#fff";
  } catch(e){}
}

/* --------------------------------------
 * 6) Explication (optionnel)
 * -------------------------------------- */
function explainMathCalculation(question) {
  let explanation = '';
  if (question === "6 √ó 2 + 4 √∑ 2") {
    explanation = "D'abord, on effectue la multiplication : 6 √ó 2 = 12. Ensuite, on fait la division : 4 √∑ 2 = 2. Puis, on additionne : 12 + 2 = 14.";
  }
  return explanation;
}

/* --------------------------------------
 * 7) Affichage + logique principale
 * -------------------------------------- */
function totalPages(){
  return Math.max(1, Math.ceil(orderedQuestions.length / 10));
}

function currentPage(){
  return Math.floor(currentQuestionIndex / 10) + 1;
}

function updatePageMeta(){
  const page = currentPage();
  pageInfoEl.textContent = `Page ${page} / ${totalPages()}`;
  pageJump.value = page;
}

function playQuestion() {
  const current = orderedQuestions[currentQuestionIndex];
  if (!current){
    message.textContent = "üéâ Bravo, vous avez compl√©t√© la liste !";
    questionDisplay.textContent = "";
    answerInput.value = "";
    answerInput.disabled = true;
    btnPlay.disabled = true;
    btnSlow.disabled = true;
    btnFast.disabled = true;
    btnRepeat.disabled = true;
    btnSkip.disabled = true;
    btnBack.disabled = true;
    timerEl.textContent = "‚Äî";
    speakMessage("Bravo, vous avez termin√© le jeu !");
    stopListening();
    return;
  }

  updatePageMeta();

  const level = difficultyOf(current.question);
  difficultyBadge.textContent = `Difficult√© : ${level === 'facile' ? 'Facile' : 'Difficile'}`;
  const duration = level === 'facile' ? 5 : 10;

  const questionText = replaceOperators(current.question);
  questionDisplay.textContent = current.question;

  // Pr√©parer messages √† lire avant de d√©marrer le chrono
  const seq = [`R√©solvez cette question : ${questionText}`];
  const explanation = explainMathCalculation(current.question);
  if (explanation) seq.push(explanation);

  message.textContent = "Entrez la r√©ponse correcte.";
  message.style.color = "#fff";
  answerInput.value = "";
  answerInput.disabled = false;
  answerInput.focus();

  // LECTURE AUDIO ‚Üí √Ä LA FIN ‚Üí D√âMARRER LE CHRONO + MICRO
  speakSequence(seq, () => {
    startCountdown(duration, () => {
      // expiration
      stopListening();
      const correct = current.answer;
      message.textContent = `‚åõ Temps √©coul√©. R√©ponse : ${correct}`;
      message.style.color = "#ffd54f";
      speakMessage(`Temps √©coul√©. La bonne r√©ponse est ${correct}.`);
      setTimeout(() => {
        nextQuestion();
      }, 900);
    });

    // D√©marre l'√©coute vocale pendant le chrono
    startListeningForAnswer(current.answer, () => {
      clearCountdown();
      markCorrectAndNext();
    });
  });
}

function playQuestionSlow() {
  speechRate = Math.max(0.5, speechRate - 0.25);
  playQuestion();
}

function playQuestionFast() {
  speechRate = Math.min(2, speechRate + 0.25);
  playQuestion();
}

function repeatQuestion() {
  const current = orderedQuestions[currentQuestionIndex];
  if (!current) return;
  const qt = replaceOperators(current.question);
  // On r√©p√®te seulement l‚Äô√©nonc√© SANS red√©marrer le chrono
  speakSequence([`R√©p√©tons : ${qt}`]);
}

/* --------------------------------------
 * 8) Validation (texte)
 * -------------------------------------- */
function markCorrectAndNext(){
  message.textContent = "‚úÖ Correct ! Bien jou√©.";
  message.style.color = "#00e676";
  speakMessage("Bravo, vous avez trouv√© la bonne r√©ponse !");
  stopListening();
  setTimeout(() => {
    nextQuestion();
  }, 700);
}

function checkAnswer() {
  if (answerInput.disabled) return;
  const current = orderedQuestions[currentQuestionIndex];
  if (!current) return;

  const userAnswer = parseFloat(String(answerInput.value).replace(',', '.'));
  const correctAnswer = Number(current.answer);

  if (!Number.isNaN(userAnswer) && Math.abs(userAnswer - correctAnswer) < 1e-9) {
    clearCountdown();
    markCorrectAndNext();
  } else {
    message.textContent = `‚ùå Incorrect. La bonne r√©ponse √©tait : ${correctAnswer}`;
    message.style.color = "#ff5252";
    speakMessage(`D√©sol√©, la r√©ponse correcte √©tait ${correctAnswer}.`);
  }
}

function nextQuestion() {
  clearCountdown();
  stopListening();
  currentQuestionIndex++;
  playQuestion();
}

/* --------------------------------------
 * 9) Navigation question & pagination
 * -------------------------------------- */
btnBack.addEventListener("click", () => {
  if (currentQuestionIndex > 0) {
    clearCountdown();
    stopListening();
    currentQuestionIndex--;
    message.textContent = "";
    playQuestion();
  }
});

btnPlay.addEventListener("click", () => {
  clearCountdown();
  stopListening();
  playQuestion();
});
btnSlow.addEventListener("click", playQuestionSlow);
btnFast.addEventListener("click", playQuestionFast);
btnRepeat.addEventListener("click", repeatQuestion);
btnSkip.addEventListener("click", () => {
  clearCountdown();
  stopListening();
  nextQuestion();
});

answerInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    checkAnswer();
  }
});

// Contr√¥les de page
function goToPage(pageNumber){
  const tp = totalPages();
  let p = Math.max(1, Math.min(tp, pageNumber|0));
  // Aller au premier item de la page demand√©e
  const targetIndex = (p - 1) * 10;
  if (targetIndex !== currentQuestionIndex){
    clearCountdown();
    stopListening();
    currentQuestionIndex = targetIndex;
    message.textContent = "";
    playQuestion();
  }
}

btnPrevPage.addEventListener("click", () => {
  goToPage(currentPage() - 1);
});
btnNextPage.addEventListener("click", () => {
  goToPage(currentPage() + 1);
});
btnGoPage.addEventListener("click", () => {
  goToPage(parseInt(pageJump.value, 10));
});
pageJump.addEventListener("keydown", (e) => {
  if (e.key === 'Enter'){
    goToPage(parseInt(pageJump.value, 10));
  }
});

/* --------------------------------------
 * 10) D√©marrage auto
 * -------------------------------------- */
window.addEventListener("load", playQuestion);
  </script>
</body>
</html>