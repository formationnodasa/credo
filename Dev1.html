<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Champs Lexicaux - Jeu Chronom√©tr√© MULTIJOUEUR</title>
  <style>
    :root{
      --bg1:#6a11cb; --bg2:#2575fc;
      --card: rgba(255,255,255,.12);
      --glass: blur(12px);
      --txt:#fff; --accent:#fff; --brand:#2575fc;
      --ok:#00e676; --ko:#ff5252;
      --room-color:#9c27b0;
      --player-color:#4caf50;
      --warning:#ff9800;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(270deg, var(--bg1), var(--bg2), var(--bg1));
      background-size: 600% 600%;
      animation: gradientAnimation 15s ease infinite;
      color: var(--txt);
      min-height: 100vh;
      padding: 12px;
      overflow-x: hidden;
    }
    @keyframes gradientAnimation{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    
    /* Modal Multijoueur */
    .multiplayer-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }
    
    .multiplayer-content {
      background: #1a1a2e;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      border: 2px solid var(--room-color);
      position: relative;
      color: white;
      box-shadow: 0 10px 40px rgba(156, 39, 176, 0.4);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .close-multiplayer {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.8rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: background-color 0.3s;
    }
    
    .close-multiplayer:hover {
      background: rgba(255, 107, 107, 0.1);
    }
    
    .multiplayer-title {
      text-align: center;
      color: #e1bee7;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }
    
    .multiplayer-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .multiplayer-btn {
      padding: 18px;
      background: linear-gradient(90deg, var(--room-color), #7b1fa2);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
    }
    
    .multiplayer-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(156, 39, 176, 0.5);
    }
    
    .multiplayer-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .multiplayer-btn.join {
      background: linear-gradient(90deg, var(--player-color), #2e7d32);
    }
    
    .multiplayer-btn.join:hover:not(:disabled) {
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.5);
    }
    
    .room-section {
      margin-top: 25px;
      border-top: 2px solid rgba(255, 255, 255, 0.1);
      padding-top: 20px;
    }
    
    .room-input {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: 2px solid rgba(156, 39, 176, 0.4);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1.1rem;
      margin-bottom: 15px;
      transition: border-color 0.3s;
    }
    
    .room-input:focus {
      outline: none;
      border-color: var(--room-color);
    }
    
    .room-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .room-info {
      background: rgba(156, 39, 176, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 2px solid rgba(156, 39, 176, 0.3);
      max-height: 300px;
      overflow-y: auto;
    }
    
    .room-info h4 {
      color: #e1bee7;
      margin-bottom: 15px;
      font-size: 1.3rem;
      position: sticky;
      top: 0;
      background: rgba(26, 26, 46, 0.95);
      padding: 10px 5px;
      margin: -10px -5px 15px;
      backdrop-filter: blur(5px);
    }
    
    .players-list {
      list-style: none;
      padding: 0;
    }
    
    .players-list li {
      padding: 12px 15px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background-color 0.3s;
    }
    
    .players-list li:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .players-list li .player-badge {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--player-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .players-list li.you {
      background: rgba(76, 175, 80, 0.2);
      border-left: 4px solid var(--player-color);
    }
    
    .room-id-display {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
      font-size: 1.4rem;
      letter-spacing: 2px;
      color: #e1bee7;
      border: 2px dashed rgba(156, 39, 176, 0.4);
    }
    
    .copy-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 10px auto 0;
      transition: all 0.3s;
      width: 100%;
      justify-content: center;
      font-weight: 600;
    }
    
    .copy-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }
    
    /* Interface multijoueur dans le jeu */
    .multiplayer-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 15px;
      border: 2px solid var(--room-color);
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .room-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      background: rgba(156, 39, 176, 0.2);
      border-radius: 10px;
      border: 2px solid var(--room-color);
      flex: 1;
      min-width: 200px;
    }
    
    .players-in-room {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      flex: 2;
    }
    
    .player-bubble {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--player-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      position: relative;
      border: 3px solid white;
      flex-shrink: 0;
      transition: transform 0.3s;
    }
    
    .player-bubble:hover {
      transform: scale(1.1);
    }
    
    .player-bubble.you {
      border-color: #ffeb3b;
      box-shadow: 0 0 15px #ffeb3b;
    }
    
    .player-bubble .score {
      position: absolute;
      bottom: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 0.9rem;
      color: white;
      background: rgba(0,0,0,0.8);
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 30px;
    }
    
    .leave-room-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .leave-room-btn:hover {
      background: #ff5252;
      transform: scale(1.05);
    }
    
    .multiplayer-message {
      background: rgba(156, 39, 176, 0.2);
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
      border-left: 4px solid var(--room-color);
      text-align: center;
      font-weight: bold;
      animation: fadeIn 0.5s ease;
    }
    
    /* Affichage des manches */
    .rounds-display {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .round-bubble {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      border: 2px solid rgba(255, 255, 255, 0.3);
      flex-shrink: 0;
      transition: all 0.3s;
    }
    
    .round-bubble.active {
      background: var(--room-color);
      border-color: #fff;
      box-shadow: 0 0 15px var(--room-color);
      transform: scale(1.1);
    }
    
    .round-bubble.completed {
      background: var(--ok);
      border-color: #fff;
    }
    
    /* Container principal */
    .container{
      background: var(--card);
      backdrop-filter: var(--glass);
      width: min(1200px, 94vw);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,.25);
      animation: fadeIn .9s ease;
      margin: 20px auto;
      min-height: auto;
      overflow: visible;
    }
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)}}
    
    /* Header */
    header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    h1{
      font-weight:800;
      margin:0;
      font-size: clamp(26px, 3.4vw, 40px);
      text-shadow: 0 3px 8px rgba(0,0,0,.3);
      letter-spacing:.3px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .multiplayer-btn-header {
      background-color: var(--room-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-size: 1rem;
      white-space: nowrap;
    }
    
    .multiplayer-btn-header:hover {
      background-color: #7b1fa2;
      transform: scale(1.05);
    }
    
    .admin-btn {
      background-color: #d4af37;
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-size: 1rem;
      white-space: nowrap;
    }
    
    .admin-btn:hover {
      background-color: #f7ef8a;
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
    }
    
    .status{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      font-weight: 600;
      opacity: .95;
    }
    .pill{
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.16);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    
    /* Zone d'affichage */
    .display{
      margin: 24px 0 10px;
      display: grid;
      gap: 15px;
    }
    #prefixDisplay{
      font-size: clamp(36px, 5vw, 64px);
      font-weight:900;
      letter-spacing:.18em;
      text-align:center;
      text-shadow: 0 3px 8px rgba(0,0,0,.28);
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #definitionDisplay{
      font-size: clamp(18px, 2.2vw, 22px);
      line-height:1.6;
      text-align:center;
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding: 25px;
      min-height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Chronom√®tre */
    .chrono-section {
      background: rgba(0,0,0,0.2);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .chrono-label {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: #fff;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #chrono {
      font-size: 4rem;
      font-weight: bold;
      color: #fff;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      padding: 20px 40px;
      display: inline-block;
      min-width: 200px;
      transition: all 0.3s ease;
      font-family: 'Courier New', monospace;
      margin: 10px 0;
    }
    #chrono.warning {
      color: #ff9800;
      animation: pulse 1s infinite;
    }
    #chrono.danger {
      color: #ff5252;
      animation: pulse 0.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    /* Zone de r√©ponse */
    .answer-section {
      margin: 20px 0;
      position: relative;
    }
    
    #answer{
      font-size:1.2rem;
      padding:16px 20px;
      border-radius:12px;
      border:none;
      width:100%;
      background:#fff;
      color:#222;
      outline:none;
      transition:.25s;
      margin: 0;
    }
    #answer:focus{
      box-shadow:0 0 15px var(--brand);
      caret-color:var(--brand);
    }
    #answer:disabled {
      background: #f0f0f0;
      color: #888;
      cursor: not-allowed;
    }
    
    /* Contr√¥les */
    .controls-section {
      margin: 20px 0;
    }
    
    .controls{
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
    button{
      padding: 14px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      background: #fff;
      color: var(--brand);
      transition: .25s;
      box-shadow: 0 4px 10px rgba(0,0,0,.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:hover:not(:disabled){
      background: var(--brand);
      color: #fff;
      box-shadow: 0 0 12px #ffffff99, 0 0 18px #2575fcaa;
      transform: translateY(-2px);
    }
    button:disabled{
      opacity: .55;
      cursor: not-allowed;
      background: #666;
      color: #999;
      transform: none;
    }
    
    /* Message */
    #message{
      min-height: 40px;
      font-size: 1.1rem;
      font-weight: 700;
      text-align: center;
      margin: 15px 0 0;
      padding: 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    /* Banque d'initiales */
    .bank-section {
      margin: 25px 0 15px;
    }
    
    .bank{
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .bank button{
      background: rgba(255,255,255,.12);
      color: #fff;
      font-weight: 800;
      letter-spacing: .08em;
      border: 2px solid rgba(255,255,255,.18);
      min-width: 60px;
      padding: 15px 0;
      flex: 1 0 auto;
      max-width: 100px;
    }
    .bank button:hover:not(:disabled){
      background: rgba(255,255,255,.2);
      color: var(--brand);
    }
    .bank button.active{
      background: #fff;
      color: var(--brand);
      border-color: var(--brand);
    }
    .bank button:disabled{
      background: rgba(255,255,255,.05);
      color: #666;
      border-color: #666;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .controls {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .bank button {
        min-width: 50px;
        padding: 12px 0;
        font-size: 1rem;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      #chrono {
        font-size: 3rem;
        padding: 15px 30px;
        min-width: 150px;
      }
      
      .multiplayer-status {
        flex-direction: column;
        gap: 15px;
      }
      
      .room-indicator {
        min-width: 100%;
      }
      
      .players-in-room {
        width: 100%;
        gap: 10px;
      }
      
      .player-bubble {
        width: 45px;
        height: 45px;
      }
    }
    
    @media (max-width: 480px) {
      .controls {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .status {
        flex-direction: column;
        align-items: stretch;
      }
      
      header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      
      .admin-btn, .multiplayer-btn-header {
        align-self: stretch;
        justify-content: center;
      }
      
      .pill {
        justify-content: center;
      }
      
      .multiplayer-content {
        padding: 20px 15px;
      }
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Scrollbar personnalis√©e */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--room-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #7b1fa2;
    }
    
    /* Animations suppl√©mentaires */
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .shake {
      animation: shake 0.5s ease;
    }
    
    @keyframes correctAnswer {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .correct-animation {
      animation: correctAnswer 0.5s ease;
    }
    
    /* Modal Admin */
    .admin-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
    }
    
    .admin-content {
      background: #1a1a2e;
      border-radius: 20px;
      padding: 25px;
      max-width: 800px;
      width: 100%;
      border: 2px solid #d4af37;
      position: relative;
      color: white;
      box-shadow: 0 10px 40px rgba(212, 175, 55, 0.4);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .close-admin {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.8rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: background-color 0.3s;
    }
    
    .close-admin:hover {
      background: rgba(255, 107, 107, 0.1);
    }
    
    .admin-title {
      text-align: center;
      color: #f7ef8a;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }
    
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: rgba(212, 175, 55, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid rgba(212, 175, 55, 0.3);
    }
    
    .stat-value {
      font-size: 2.2rem;
      font-weight: bold;
      color: #f7ef8a;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #a0c8ff;
      font-size: 0.9rem;
    }
    
    .admin-password-input {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: 2px solid rgba(212, 175, 55, 0.4);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      margin-bottom: 20px;
    }
    
    .admin-login-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(90deg, #d4af37, #f7ef8a);
      color: #1a1a2e;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .admin-login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
    }
    
    .results-table-container {
      max-height: 400px;
      overflow-y: auto;
      margin: 20px 0;
      border-radius: 10px;
      border: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .results-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
    }
    
    .results-table th {
      background: rgba(212, 175, 55, 0.2);
      color: #f7ef8a;
      padding: 12px 15px;
      text-align: left;
      position: sticky;
      top: 0;
      border-bottom: 2px solid rgba(212, 175, 55, 0.4);
    }
    
    .results-table td {
      padding: 12px 15px;
      color: #cccccc;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .results-table tr:hover {
      background: rgba(212, 175, 55, 0.1);
    }
    
    .export-btn {
      display: block;
      width: 100%;
      padding: 16px;
      background: linear-gradient(90deg, #4CAF50, #2E7D32);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      text-align: center;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
    }
    
    .view-results-btn {
      padding: 8px 12px;
      background: linear-gradient(90deg, #1e90ff, #0d47a1);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .view-results-btn:hover {
      background: linear-gradient(90deg, #4fc3f7, #0288d1);
      transform: translateY(-1px);
    }
    
    .admin-section {
      margin-top: 25px;
      border-top: 2px solid rgba(255, 255, 255, 0.1);
      padding-top: 20px;
    }
    
    .admin-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .admin-action-btn {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(212, 175, 55, 0.4);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .admin-action-btn:hover {
      background: rgba(212, 175, 55, 0.2);
      border-color: #d4af37;
      transform: translateY(-2px);
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Modal Multijoueur -->
  <div class="multiplayer-modal hidden" id="multiplayerModal">
    <div class="multiplayer-content">
      <button class="close-multiplayer" id="closeMultiplayerModal" aria-label="Fermer">&times;</button>
      
      <h2 class="multiplayer-title">
        <i class="fas fa-users"></i> MODE MULTIJOUEUR
      </h2>
      
      <div class="room-section">
        <input type="text" id="playerNameInput" class="room-input" 
               placeholder="Ton nom (ex: Miriam, Mo√Øse, Aubaine‚Ä¶)" maxlength="20" value="">
      </div>
      
      <div class="multiplayer-buttons">
        <button class="multiplayer-btn" id="createRoomBtn">
          <i class="fas fa-plus-circle"></i> Cr√©er une salle
        </button>
        <button class="multiplayer-btn join" id="joinRoomBtn">
          <i class="fas fa-sign-in-alt"></i> Rejoindre une salle
        </button>
      </div>
      
      <div id="createRoomSection" class="room-section hidden">
        <h3>Cr√©er une nouvelle salle</h3>
        <input type="text" id="roomNameInput" class="room-input" 
               placeholder="Nom de la salle (ex: Champions du lexique)" maxlength="30">
        <input type="number" id="maxPlayersInput" class="room-input" 
               placeholder="Nombre maximum de joueurs (2-8)" min="2" max="8" value="4">
        <button id="createRoomConfirm" class="multiplayer-btn">
          <i class="fas fa-gamepad"></i> Cr√©er et d√©marrer
        </button>
      </div>
      
      <div id="joinRoomSection" class="room-section hidden">
        <h3>Rejoindre une salle</h3>
        <input type="text" id="roomCodeInput" class="room-input" 
               placeholder="Code de la salle (ex: ABCD)" maxlength="6" style="text-transform:uppercase">
        <button id="joinRoomConfirm" class="multiplayer-btn join">
          <i class="fas fa-sign-in-alt"></i> Rejoindre la salle
        </button>
      </div>
      
      <div id="roomInfoSection" class="room-section hidden">
        <div class="room-id-display" id="roomIdDisplay">
          SALLE: ABCD
        </div>
        
        <button class="copy-btn" id="copyRoomCodeBtn">
          <i class="fas fa-copy"></i> Copier le code
        </button>
        
        <div class="room-info">
          <h4>Joueurs dans la salle (<span id="playerCount">0</span>/<span id="maxPlayers">4</span>)</h4>
          <ul class="players-list" id="playersList">
            <!-- Les joueurs seront ajout√©s ici -->
          </ul>
        </div>
        
        <button id="startGameBtn" class="multiplayer-btn hidden">
          <i class="fas fa-play-circle"></i> D√©marrer la partie
        </button>
        
        <button id="leaveRoomBtn" class="leave-room-btn" style="width:100%">
          <i class="fas fa-sign-out-alt"></i> Quitter la salle
        </button>
      </div>
      
      <div id="waitingSection" class="room-section hidden">
        <div style="text-align:center; padding:30px;">
          <i class="fas fa-hourglass-half fa-3x" style="color:#e1bee7; margin-bottom:20px;"></i>
          <h3>En attente du cr√©ateur...</h3>
          <p>Le cr√©ateur de la salle va d√©marrer la partie</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Admin -->
  <div class="admin-modal hidden" id="adminModal">
    <div class="admin-content">
      <button class="close-admin" id="closeAdminModal" aria-label="Fermer">&times;</button>
      
      <h2 class="admin-title">
        <i class="fas fa-lock"></i> PANEL ADMINISTRATEUR
      </h2>
      
      <div id="adminLoginSection">
        <div style="text-align: center; margin-bottom: 20px;">
          <i class="fas fa-key fa-3x" style="color:#d4af37; margin-bottom:10px;"></i>
          <p style="color:#a0c8ff;">Acc√®s r√©serv√© √† l'administrateur</p>
        </div>
        
        <input type="password" id="adminPassword" class="admin-password-input" 
               placeholder="Entrez le mot de passe administrateur">
        
        <button id="adminLoginBtn" class="admin-login-btn">
          <i class="fas fa-sign-in-alt"></i> SE CONNECTER
        </button>
        
        <div style="text-align: center; margin-top: 20px; font-size: 0.9rem; color: rgba(255,255,255,0.6);">
          <i class="fas fa-info-circle"></i> Mot de passe par d√©faut: <code>admin123</code>
        </div>
      </div>
      
      <div id="adminDashboard" class="hidden">
        <div class="admin-stats">
          <div class="stat-card">
            <div class="stat-value" id="totalRooms">0</div>
            <div class="stat-label">Salles Actives</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-value" id="totalPlayers">0</div>
            <div class="stat-label">Joueurs Connect√©s</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-value" id="totalGames">0</div>
            <div class="stat-label">Parties Jou√©es</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-value" id="avgScore">0</div>
            <div class="stat-label">Score Moyen</div>
          </div>
        </div>
        
        <div class="admin-section">
          <h3 style="color:#f7ef8a; margin-bottom:15px;">
            <i class="fas fa-list-ol"></i> R√©sultats D√©tail√©s
          </h3>
          
          <div class="results-table-container">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Salle</th>
                  <th>Cr√©ateur</th>
                  <th>Joueurs</th>
                  <th>Score</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="adminResultsList">
                <!-- Les r√©sultats seront ajout√©s ici -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="admin-actions">
          <button id="refreshAdminBtn" class="admin-action-btn">
            <i class="fas fa-sync-alt"></i> Actualiser
          </button>
          <button id="exportAdminBtn" class="admin-action-btn">
            <i class="fas fa-download"></i> Exporter
          </button>
          <button id="clearOldBtn" class="admin-action-btn" style="background:rgba(255,107,107,0.1); border-color:#ff6b6b;">
            <i class="fas fa-trash"></i> Nettoyer
          </button>
        </div>
        
        <button id="adminLogoutBtn" class="export-btn" style="background:linear-gradient(90deg, #ff9800, #f57c00); margin-top:15px;">
          <i class="fas fa-sign-out-alt"></i> D√âCONNEXION
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <h1><i class="fas fa-brain"></i> Champs Lexicaux ‚Äì MULTIJOUEUR</h1>
      <div class="status">
        <span class="pill" id="progressPill">
          <i class="fas fa-list-ol"></i> <span id="questionCounter">0/0</span>
        </span>
        <span class="pill" id="scorePill">
          <i class="fas fa-star"></i> Score: <span id="scoreValue">0</span>
        </span>
        <button class="multiplayer-btn-header" id="multiplayerButton">
          <i class="fas fa-users"></i> Multijoueur
        </button>
        <button class="admin-btn" id="adminButton">
          <i class="fas fa-lock"></i> Admin
        </button>
      </div>
    </header>

    <!-- Section Multijoueur (visible quand connect√©) -->
    <div id="multiplayerStatus" class="multiplayer-status hidden">
      <div class="room-indicator">
        <i class="fas fa-door-open"></i>
        <div>
          <div style="font-weight:bold; color:#e1bee7;">SALLE: <span id="currentRoomCode">----</span></div>
          <div style="font-size:0.9rem;">Cr√©√©e par: <span id="roomCreator">---</span></div>
        </div>
      </div>
      
      <div class="players-in-room" id="playersInRoom">
        <!-- Les joueurs seront affich√©s ici -->
      </div>
      
      <button class="leave-room-btn" id="leaveRoomBtnInGame">
        <i class="fas fa-sign-out-alt"></i> Quitter
      </button>
    </div>
    
    <div id="multiplayerMessage" class="multiplayer-message hidden">
      <!-- Messages multijoueur -->
    </div>
    
    <!-- Affichage des manches -->
    <div id="roundsDisplay" class="rounds-display hidden">
      <!-- Les bulles des manches seront ajout√©es ici -->
    </div>

    <!-- Zone d'affichage -->
    <div class="display">
      <div id="prefixDisplay">‚Äì ‚Äì</div>
      <div id="definitionDisplay">
        S√©lectionne un champ lexical ci-dessous et clique sur "Jouer".<br>
        Tu as <strong>20 secondes</strong> pour trouver le mot correspondant !
      </div>
    </div>

    <!-- Chronom√®tre -->
    <div class="chrono-section">
      <div class="chrono-label">
        <i class="fas fa-clock"></i> TEMPS RESTANT
      </div>
      <div id="chrono">20</div>
    </div>

    <!-- Zone de r√©ponse -->
    <div class="answer-section">
      <input type="text" id="answer" placeholder="√âcris le mot correct (m√™mes initiales) et appuie sur Entr√©e‚Ä¶" autocomplete="off" />
      <div style="font-size:0.9rem; color:rgba(255,255,255,0.7); margin-top:8px; text-align:center;">
        <i class="fas fa-info-circle"></i> Seul le joueur avec la bonne r√©ponse gagne des points
      </div>
    </div>

    <!-- Contr√¥les -->
    <div class="controls-section">
      <div class="controls" role="group" aria-label="Commandes">
        <button id="btnPlay">
          <i class="fas fa-play"></i> Jouer
        </button>
        <button id="btnSlow">
          <i class="fas fa-turtle"></i> Ralentir
        </button>
        <button id="btnFast">
          <i class="fas fa-rabbit"></i> Acc√©l√©rer
        </button>
        <button id="btnRepeat">
          <i class="fas fa-redo"></i> R√©p√©ter
        </button>
        <button id="btnSkip">
          <i class="fas fa-forward"></i> Passer
        </button>
        <button id="btnBack">
          <i class="fas fa-backward"></i> Retour
        </button>
      </div>
    </div>

    <!-- Message -->
    <div id="message" aria-live="polite"></div>

    <!-- Banque d'initiales -->
    <div class="bank-section">
      <div class="bank" id="initialBank" aria-label="Liste d'initiales (s√©lection rapide)"></div>
    </div>
  </div>

  <script>
    // üî• CONFIGURATION FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyBPBq1uT7lbL9Xp_neAJh2lSe0MRErlYdo",
      authDomain: "evoir-1.firebaseapp.com",
      projectId: "evoir-1",
      storageBucket: "evoir-1.firebasestorage.app",
      messagingSenderId: "504718469638",
      appId: "1:504718469638:web:72707fd51d0ce6ff773187",
      measurementId: "G-ZXPC2SKJHT"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Donn√©es : champs lexicaux (COMPLETS)
    const FIELDS = {
      "Pr": [
        {mot:"Pr√©cision", def:"Le fait de donner des d√©tails exacts et pr√©cis sur quelque chose."},
        {mot:"Profond", def:"Qui se rapporte √† la profondeur ou √† une intensit√© importante."},
        {mot:"Profession", def:"Domaine d'activit√© ou m√©tier dans lequel une personne travaille."},
        {mot:"Progr√®s", def:"Avancement ou am√©lioration dans une situation ou un domaine."},
        {mot:"Promesse", def:"Engagement ou parole donn√©e de faire quelque chose."},
        {mot:"Proverbe", def:"Expression populaire qui contient une sagesse ou un conseil."},
        {mot:"Pr√©cieux", def:"Qui a une grande valeur ou importance."},
        {mot:"Pr√©paration", def:"Action de se pr√©parer en vue d'une activit√©."},
        {mot:"Pr√©caution", def:"Mesure prise pour √©viter un danger ou un probl√®me."},
        {mot:"Privil√®ge", def:"Avantage ou droit sp√©cial accord√© √† certaines personnes."}
      ],
      "Se": [
        {mot:"Sensation", def:"Perception ou ressenti d'un stimulus par les sens."},
        {mot:"S√©duction", def:"Charme ou pouvoir d'attraction envers quelqu'un."},
        {mot:"S√©r√©nit√©", def:"√âtat de calme et de tranquillit√©."},
        {mot:"Secret", def:"Quelque chose qui est cach√© ou inconnu du public."},
        {mot:"S√©paration", def:"Acte de se s√©parer ou de se diviser."},
        {mot:"S√©rieux", def:"√âtat de responsabilit√© et de gravit√©."},
        {mot:"Sentiment", def:"√âmotion ou affection ressentie envers quelqu'un ou quelque chose."},
        {mot:"Service", def:"Action d'aider ou d'assister quelqu'un."},
        {mot:"Seconde", def:"Unit√© de temps ou rang apr√®s la premi√®re."},
        {mot:"Septi√®me", def:"Position dans une s√©rie apr√®s le sixi√®me."}
      ],
      "Tr": [
        {mot:"Transformation", def:"Changement ou m√©tamorphose d'une chose en une autre."},
        {mot:"Tristesse", def:"√âtat de chagrin ou de m√©lancolie."},
        {mot:"Travail", def:"Emploi ou activit√© professionnelle."},
        {mot:"Traitement", def:"Action de soigner ou de proc√©der √† une proc√©dure m√©dicale."},
        {mot:"Tradition", def:"Coutume transmise de g√©n√©ration en g√©n√©ration."},
        {mot:"Trag√©die", def:"Drame qui provoque de la tristesse ou du d√©sespoir."},
        {mot:"Trenti√®me", def:"Position dans une s√©rie apr√®s le vingt-neuvi√®me."},
        {mot:"Triomphe", def:"Victoire √©clatante √† l'issue d'une lutte."},
        {mot:"Transparence", def:"Clart√© d'une substance ou d'une situation."},
        {mot:"Tr√©sor", def:"Richesse ou bien pr√©cieux √† valeur sentimentale ou mat√©rielle."}
      ],
      "Ac": [
        {mot:"Accompagnement", def:"Soutien ou aide fournie √† quelqu'un."},
        {mot:"Acc√®s", def:"Possibilit√© d'entrer dans un lieu ou d'obtenir quelque chose."},
        {mot:"Action", def:"Acte de faire quelque chose."},
        {mot:"Activit√©", def:"Occupation ou exercice d'une action."},
        {mot:"Achat", def:"Acquisition d'un bien."},
        {mot:"Accident", def:"√âv√©nement impr√©vu, souvent tragique."},
        {mot:"Accord", def:"Entente ou consensus entre plusieurs personnes."},
        {mot:"Acquisition", def:"Obtention d'une chose."},
        {mot:"Acteur", def:"Personne qui joue un r√¥le au th√©√¢tre ou au cin√©ma."},
        {mot:"Acclamation", def:"Applaudissements ou √©loges enthousiastes."}
      ],
      "Ca": [
        {mot:"Caract√®re", def:"Ensemble de traits distinctifs d'une personne ou d'une chose."},
        {mot:"Carte", def:"Document repr√©sentant une r√©gion ou un territoire."},
        {mot:"Cascade", def:"Chute d'eau sur une piste."},
        {mot:"Cadeau", def:"Objet offert pour une occasion ou par affection."},
        {mot:"Caisse", def:"Contenant destin√© au transport d'objets."},
        {mot:"Cam√©ra", def:"Appareil pour prendre des photos ou filmer."},
        {mot:"Campagne", def:"R√©gion rurale, √©loign√©e de la ville."},
        {mot:"Canal", def:"Voie d'eau artificielle pour le transport."},
        {mot:"Capacit√©", def:"Aptitude √† faire, comprendre ou apprendre."},
        {mot:"Capitale", def:"Ville principale d'un pays ou d'une r√©gion."}
      ],
      "Me": [
        {mot:"M√©moire", def:"Capacit√© de se souvenir et de rappeler des informations."},
        {mot:"M√©thode", def:"Mani√®re sp√©cifique d'effectuer une t√¢che."},
        {mot:"M√©lodie", def:"S√©quence agr√©able de notes musicales."},
        {mot:"Menu", def:"Liste de plats ou d'options dans un programme."},
        {mot:"M√©contentement", def:"Sentiment de ne pas √™tre satisfait."},
        {mot:"Mesure", def:"Quantit√© ou √©chelle pour √©valuer quelque chose."},
        {mot:"Merveille", def:"Chose tr√®s impressionnante ou √©tonnante."},
        {mot:"M√©ditation", def:"Pratique de relaxation et de concentration."},
        {mot:"Messagerie", def:"Syst√®me d'envoi et de r√©ception de messages."},
        {mot:"M√©morable", def:"Qui m√©rite d'√™tre rappel√©."}
      ]
    };

    // √âl√©ments DOM
    const prefixDisplay = document.getElementById("prefixDisplay");
    const definitionDisplay = document.getElementById("definitionDisplay");
    const answerInput = document.getElementById("answer");
    const message = document.getElementById("message");
    const btnPlay = document.getElementById("btnPlay");
    const btnSlow = document.getElementById("btnSlow");
    const btnFast = document.getElementById("btnFast");
    const btnRepeat = document.getElementById("btnRepeat");
    const btnSkip = document.getElementById("btnSkip");
    const btnBack = document.getElementById("btnBack");
    const initialBank = document.getElementById("initialBank");
    const progressPill = document.getElementById("progressPill");
    const scorePill = document.getElementById("scorePill");
    const chronoDisplay = document.getElementById("chrono");
    const roundsDisplay = document.getElementById("roundsDisplay");
    const questionCounter = document.getElementById("questionCounter");
    const scoreValue = document.getElementById("scoreValue");

    // √âl√©ments Multijoueur
    const multiplayerModal = document.getElementById("multiplayerModal");
    const multiplayerButton = document.getElementById("multiplayerButton");
    const closeMultiplayerModal = document.getElementById("closeMultiplayerModal");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const joinRoomBtn = document.getElementById("joinRoomBtn");
    const createRoomSection = document.getElementById("createRoomSection");
    const joinRoomSection = document.getElementById("joinRoomSection");
    const roomInfoSection = document.getElementById("roomInfoSection");
    const waitingSection = document.getElementById("waitingSection");
    const createRoomConfirm = document.getElementById("createRoomConfirm");
    const joinRoomConfirm = document.getElementById("joinRoomConfirm");
    const roomIdDisplay = document.getElementById("roomIdDisplay");
    const copyRoomCodeBtn = document.getElementById("copyRoomCodeBtn");
    const playersList = document.getElementById("playersList");
    const startGameBtn = document.getElementById("startGameBtn");
    const leaveRoomBtn = document.getElementById("leaveRoomBtn");
    const multiplayerStatus = document.getElementById("multiplayerStatus");
    const playersInRoom = document.getElementById("playersInRoom");
    const currentRoomCode = document.getElementById("currentRoomCode");
    const roomCreator = document.getElementById("roomCreator");
    const leaveRoomBtnInGame = document.getElementById("leaveRoomBtnInGame");
    const multiplayerMessage = document.getElementById("multiplayerMessage");
    const playerNameInput = document.getElementById("playerNameInput");

    // √âl√©ments Admin
    const adminModal = document.getElementById("adminModal");
    const adminButton = document.getElementById("adminButton");
    const closeAdminModal = document.getElementById("closeAdminModal");
    const adminPassword = document.getElementById("adminPassword");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const adminLoginSection = document.getElementById("adminLoginSection");
    const adminDashboard = document.getElementById("adminDashboard");
    const adminResultsList = document.getElementById("adminResultsList");
    const refreshAdminBtn = document.getElementById("refreshAdminBtn");
    const exportAdminBtn = document.getElementById("exportAdminBtn");
    const clearOldBtn = document.getElementById("clearOldBtn");
    const adminLogoutBtn = document.getElementById("adminLogoutBtn");
    const totalRooms = document.getElementById("totalRooms");
    const totalPlayers = document.getElementById("totalPlayers");
    const totalGames = document.getElementById("totalGames");
    const avgScore = document.getElementById("avgScore");

    // √âtat du jeu
    let currentPrefix = null;
    let currentIndex = 0;
    let speechRate = 1;
    let score = 0;
    let chronoTimer = null;
    let timeLeft = 20;
    let gameActive = false;
    let playerName = "Joueur";

    // Variables Multijoueur
    let currentRoomId = null;
    let isRoomCreator = false;
    let players = [];
    let playerId = null;
    let roomUnsubscribe = null;
    let gameStateUnsubscribe = null;
    let multiplayerGameActive = false;
    let currentRound = 1;
    let totalRounds = 3;
    let answeredThisQuestion = false;
    let gameStateListenerActive = false;
    let lastSyncTime = 0;
    const SYNC_INTERVAL = 100;

    // Variables Admin
    const ADMIN_PASSWORD = "admin123";
    let adminAuthenticated = false;
    let adminData = [];

    // üî• AM√âLIORATION : Points seulement pour la bonne r√©ponse
    // Pas de points pour les mauvaises r√©ponses, on passe simplement √† la question suivante

    // G√©n√©rer un ID de joueur unique
    function generatePlayerId() {
      return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // G√©n√©rer un code de salle unique
    function generateRoomCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 4; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // üî• FONCTION CRITIQUE : Mettre √† jour les contr√¥les selon le r√¥le
    function updatePlayerControls() {
      const canControl = isRoomCreator && multiplayerGameActive && gameActive;
      
      btnPlay.disabled = !canControl;
      btnSkip.disabled = !canControl;
      btnBack.disabled = !canControl;
      
      // Les boutons de vitesse et r√©p√©tition sont toujours actifs
      btnSlow.disabled = !multiplayerGameActive || !gameActive;
      btnFast.disabled = !multiplayerGameActive || !gameActive;
      btnRepeat.disabled = !multiplayerGameActive || !gameActive;
      
      // D√©sactiver la banque d'initiales en mode multijoueur
      document.querySelectorAll('#initialBank button').forEach(btn => {
        btn.disabled = multiplayerGameActive;
      });
      
      answerInput.disabled = !multiplayerGameActive || !gameActive;
    }

    // üî• RENDRE LA CARTE DEPUIS FIRESTORE
    function renderCard(){
      if(!currentPrefix){
        prefixDisplay.textContent = "‚Äì ‚Äì";
        definitionDisplay.innerHTML = `
          ${multiplayerGameActive ? 
            'En attente du cr√©ateur pour d√©marrer...' : 
            'S√©lectionne un champ lexical ci-dessous et clique sur "Jouer".<br>Tu as <strong>20 secondes</strong> pour trouver le mot correspondant !'}
        `;
        updatePills();
        return;
      }
      
      const item = FIELDS[currentPrefix]?.[currentIndex];
      if (!item) {
        console.error("Item non trouv√©:", currentPrefix, currentIndex);
        return;
      }
      
      prefixDisplay.textContent = currentPrefix.toUpperCase();
      definitionDisplay.textContent = item.def;
      
      if (multiplayerGameActive) {
        message.textContent = `Manche ${currentRound}/${totalRounds} - Question ${currentIndex + 1}/10 - Mot doit commencer par ${currentPrefix}`;
        message.style.color = "#fff";
      } else {
        message.textContent = `Temps restant: ${timeLeft}s - Mot doit commencer par ${currentPrefix}`;
        message.style.color = "#fff";
      }
      
      answerInput.value = "";
      answerInput.placeholder = `√âcris un mot qui commence par ¬´ ${currentPrefix} ¬ª‚Ä¶`;
      answerInput.disabled = !gameActive;
      updatePills();
      answerInput.focus();
    }

    // üî• SYNCHRONISATION AVEC FIRESTORE
    function subscribeToGameState(roomCode) {
      if (gameStateUnsubscribe) gameStateUnsubscribe();
      
      gameStateListenerActive = true;
      let lastGameState = null;
      
      gameStateUnsubscribe = db.collection('multiplayer_rooms').doc(roomCode)
        .onSnapshot((doc) => {
          if (!doc.exists) return;
          
          const roomData = doc.data();
          const gameState = roomData.gameState;
          const now = Date.now();
          
          // √âviter les mises √† jour trop fr√©quentes
          if (lastGameState && 
              lastGameState.currentPrefix === gameState.currentPrefix &&
              lastGameState.currentIndex === gameState.currentIndex &&
              now - lastSyncTime < SYNC_INTERVAL) {
            return;
          }
          
          lastGameState = { ...gameState };
          lastSyncTime = now;
          
          if (gameState.active) {
            currentPrefix = gameState.currentPrefix;
            currentIndex = gameState.currentIndex;
            currentRound = gameState.currentRound || 1;
            totalRounds = gameState.totalRounds || 3;
            
            renderCard();
            updatePlayerControls();
            
            answeredThisQuestion = false;
            
            if (gameActive === false && gameState.currentPrefix) {
              gameActive = true;
              multiplayerGameActive = true;
              if (gameState.questionStartTime) {
                startChronoFromTime(gameState.questionStartTime);
              } else {
                startChrono();
              }
            }
            
            updateRoundsDisplay(currentRound, totalRounds);
            
            multiplayerMessage.classList.remove('hidden');
            multiplayerMessage.innerHTML = `
              <i class="fas fa-gamepad"></i> Partie multijoueur - 
              Manche ${currentRound}/${totalRounds} - 
              Question ${currentIndex + 1}/10 - Champ lexical: <strong>${currentPrefix}</strong>
            `;
          } else {
            gameActive = false;
            multiplayerGameActive = false;
            stopChrono();
            updatePlayerControls();
            multiplayerMessage.innerHTML = `<i class="fas fa-gamepad"></i> Partie en pause...`;
          }
        }, (error) => {
          console.error("Erreur d'√©coute de l'√©tat du jeu:", error);
          gameStateListenerActive = false;
        });
    }

    // D√©marrer le chrono depuis un temps donn√©
    function startChronoFromTime(startTime) {
      if (!startTime) {
        startChrono();
        return;
      }
      
      const elapsed = Date.now() - startTime;
      const timeElapsed = Math.floor(elapsed / 1000);
      timeLeft = Math.max(0, 20 - timeElapsed);
      
      if (chronoTimer) clearInterval(chronoTimer);
      
      if (timeLeft <= 0) {
        chronoDisplay.textContent = "0";
        chronoDisplay.className = "danger";
        return;
      }
      
      chronoDisplay.textContent = timeLeft;
      updateChronoStyle();
      
      chronoTimer = setInterval(() => {
        timeLeft--;
        chronoDisplay.textContent = timeLeft;
        updateChronoStyle();
        
        if (timeLeft <= 0) {
          clearInterval(chronoTimer);
          timeUp();
        }
      }, 1000);
    }

    // Gestion du temps √©coul√©
    function timeUp() {
      if (!gameActive) return;
      
      const item = FIELDS[currentPrefix][currentIndex];
      message.innerHTML = `‚è∞ <strong>Temps √©coul√© !</strong> La r√©ponse √©tait : ${item.mot}`;
      message.style.color = "#ff5252";
      message.classList.add('shake');
      
      // Pas de points pour le temps √©coul√©
      if (multiplayerGameActive && isRoomCreator) {
        setTimeout(() => {
          updateGameStateForNextWord();
        }, 2000);
      }
    }

    // Mettre √† jour l'√©tat du jeu pour le mot suivant
    async function updateGameStateForNextWord() {
      if (!currentRoomId || !isRoomCreator) return;
      
      const list = FIELDS[currentPrefix];
      const nextIndex = currentIndex + 1;
      
      if (nextIndex >= list.length) {
        await endRound();
      } else {
        await db.collection('multiplayer_rooms').doc(currentRoomId).update({
          'gameState.currentIndex': nextIndex,
          'gameState.questionStartTime': Date.now(),
          lastUpdate: Date.now()
        });
      }
    }

    // Terminer une manche
    async function endRound() {
      if (!currentRoomId || !isRoomCreator) return;
      
      const nextRound = currentRound + 1;
      
      if (nextRound > totalRounds) {
        await endGame();
      } else {
        const prefixes = Object.keys(FIELDS);
        const randomPrefix = prefixes[Math.floor(Math.random() * prefixes.length)];
        
        await db.collection('multiplayer_rooms').doc(currentRoomId).update({
          'gameState.currentRound': nextRound,
          'gameState.currentPrefix': randomPrefix,
          'gameState.currentIndex': 0,
          'gameState.questionStartTime': Date.now(),
          lastUpdate: Date.now()
        });
        
        multiplayerMessage.innerHTML = `
          <i class="fas fa-flag"></i> Manche ${currentRound} termin√©e ! 
          D√©but de la manche ${nextRound} - Champ lexical: <strong>${randomPrefix}</strong>
        `;
      }
    }

    // Terminer la partie
    async function endGame() {
      if (!currentRoomId || !isRoomCreator) return;
      
      const roomDoc = await db.collection('multiplayer_rooms').doc(currentRoomId).get();
      const roomData = roomDoc.data();
      const players = roomData.players;
      
      let winner = players[0];
      let maxScore = winner.score;
      
      for (let player of players) {
        if (player.score > maxScore) {
          maxScore = player.score;
          winner = player;
        }
      }
      
      multiplayerMessage.innerHTML = `
        <i class="fas fa-flag-checkered"></i> <strong>PARTIE TERMIN√âE !</strong> 
        <br>üéâ <strong>GAGNANT: ${winner.name}</strong> avec ${winner.score} points !
        <br>Merci d'avoir jou√© !
      `;
      
      await db.collection('multiplayer_rooms').doc(currentRoomId).update({
        'gameState.active': false,
        lastUpdate: Date.now()
      });
      
      gameActive = false;
      multiplayerGameActive = false;
      stopChrono();
      updatePlayerControls();
    }

    // Mettre √† jour le score du joueur
    async function updatePlayerScore(newScore) {
      if (!currentRoomId) return;
      
      try {
        const roomDoc = await db.collection('multiplayer_rooms').doc(currentRoomId).get();
        const roomData = roomDoc.data();
        
        const updatedPlayers = roomData.players.map(p => {
          if (p.id === playerId) {
            return { 
              ...p, 
              score: newScore,
              lastAnswerTime: Date.now()
            };
          }
          return p;
        });
        
        await db.collection('multiplayer_rooms').doc(currentRoomId).update({
          players: updatedPlayers,
          lastUpdate: Date.now()
        });
        
        score = newScore;
        updatePills();
        
      } catch (error) {
        console.error("Erreur lors de la mise √† jour du score:", error);
      }
    }

    // üî• AM√âLIORATION : V√©rification des r√©ponses avec logique am√©lior√©e
    async function check(){
      if(!currentPrefix || !gameActive || answeredThisQuestion) return;
      
      const item = FIELDS[currentPrefix][currentIndex];
      const user = normalize(answerInput.value);
      const target = normalize(item.mot);
      const timeUsed = 20 - timeLeft;

      if(user && user.startsWith(normalize(currentPrefix)) && user === target){
        // üî• CORRECT : Le joueur gagne 1 point
        stopChrono();
        const newScore = score + 1;
        
        // Animation visuelle pour la bonne r√©ponse
        prefixDisplay.classList.add('correct-animation');
        setTimeout(() => prefixDisplay.classList.remove('correct-animation'), 500);
        
        message.innerHTML = `‚úÖ <strong>Correct !</strong> +1 point ! Temps: ${timeUsed}s - Score: ${newScore}`;
        message.style.color = "#00e676";
        
        if (multiplayerGameActive) {
          answeredThisQuestion = true;
          await updatePlayerScore(newScore);
          
          if (isRoomCreator) {
            setTimeout(() => {
              updateGameStateForNextWord();
            }, 1500);
          }
        } else {
          score = newScore;
          setTimeout(next, 1500);
        }
      } else {
        // üî• INCORRECT : Pas de point, on passe √† la question suivante
        message.innerHTML = `‚ùå <strong>Incorrect.</strong> La r√©ponse √©tait : ${item.mot}`;
        message.style.color = "#ff5252";
        message.classList.add('shake');
        setTimeout(() => message.classList.remove('shake'), 500);
        
        if (multiplayerGameActive) {
          answeredThisQuestion = true;
          
          if (isRoomCreator) {
            setTimeout(() => {
              updateGameStateForNextWord();
            }, 2000);
          }
        } else {
          setTimeout(next, 2000);
        }
      }
    }

    // üî• INTERFACE MULTIJOUEUR - Gestion compl√®te
    function showMainMenu() {
      createRoomSection.classList.add('hidden');
      joinRoomSection.classList.add('hidden');
      roomInfoSection.classList.add('hidden');
      waitingSection.classList.add('hidden');
    }

    // Cr√©er une salle
    createRoomConfirm.addEventListener('click', async () => {
      const roomName = document.getElementById('roomNameInput').value || "Salle de Jeu";
      const maxPlayers = parseInt(document.getElementById('maxPlayersInput').value) || 4;
      playerName = playerNameInput.value.trim() || "Cr√©ateur";
      
      if (!playerName) {
        alert("Veuillez entrer un nom de joueur");
        return;
      }
      
      if (maxPlayers < 2 || maxPlayers > 8) {
        alert("Le nombre de joueurs doit √™tre entre 2 et 8");
        return;
      }
      
      const roomCode = generateRoomCode();
      playerId = generatePlayerId();
      
      const roomData = {
        code: roomCode,
        name: roomName,
        creatorId: playerId,
        creatorName: playerName,
        maxPlayers: maxPlayers,
        players: [{
          id: playerId,
          name: playerName,
          score: 0,
          isReady: false,
          isCreator: true,
          lastAnswerTime: 0
        }],
        gameState: {
          active: false,
          currentPrefix: null,
          currentIndex: 0,
          currentRound: 1,
          totalRounds: 3,
          startedAt: null,
          questionStartTime: null
        },
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastUpdate: Date.now()
      };
      
      try {
        await db.collection('multiplayer_rooms').doc(roomCode).set(roomData);
        currentRoomId = roomCode;
        isRoomCreator = true;
        joinRoom(roomCode);
      } catch (error) {
        console.error("Erreur lors de la cr√©ation de la salle:", error);
        alert("Erreur lors de la cr√©ation de la salle");
      }
    });

    // Rejoindre une salle
    joinRoomConfirm.addEventListener('click', async () => {
      const roomCode = document.getElementById('roomCodeInput').value.toUpperCase();
      playerName = playerNameInput.value.trim() || "Joueur";
      
      if (!playerName) {
        alert("Veuillez entrer un nom de joueur");
        return;
      }
      
      if (!roomCode || roomCode.length !== 4) {
        alert("Veuillez entrer un code de salle valide (4 caract√®res)");
        return;
      }
      
      try {
        const roomDoc = await db.collection('multiplayer_rooms').doc(roomCode).get();
        
        if (!roomDoc.exists) {
          alert("Cette salle n'existe pas");
          return;
        }
        
        const roomData = roomDoc.data();
        
        if (roomData.players.length >= roomData.maxPlayers) {
          alert("Cette salle est pleine");
          return;
        }
        
        playerId = generatePlayerId();
        currentRoomId = roomCode;
        isRoomCreator = false;
        joinRoom(roomCode);
      } catch (error) {
        console.error("Erreur lors de la jointure de la salle:", error);
        alert("Erreur lors de la jointure de la salle");
      }
    });

    // Rejoindre une salle
    async function joinRoom(roomCode) {
      try {
        await db.collection('multiplayer_rooms').doc(roomCode).update({
          players: firebase.firestore.FieldValue.arrayUnion({
            id: playerId,
            name: playerName,
            score: 0,
            isReady: false,
            isCreator: isRoomCreator,
            lastAnswerTime: 0
          }),
          lastUpdate: Date.now()
        });
        
        showRoomInfo(roomCode);
        subscribeToRoomUpdates(roomCode);
        
        multiplayerStatus.classList.remove('hidden');
        currentRoomCode.textContent = roomCode;
        updatePlayerControls();
        
      } catch (error) {
        console.error("Erreur lors de la jointure:", error);
        alert("Erreur lors de la jointure √† la salle");
      }
    }

    // Afficher les informations de la salle
    function showRoomInfo(roomCode) {
      showMainMenu();
      roomInfoSection.classList.remove('hidden');
      roomIdDisplay.textContent = `SALLE: ${roomCode}`;
      
      if (isRoomCreator) {
        startGameBtn.classList.remove('hidden');
      } else {
        startGameBtn.classList.add('hidden');
      }
    }

    // S'abonner aux mises √† jour de la salle
    function subscribeToRoomUpdates(roomCode) {
      if (roomUnsubscribe) roomUnsubscribe();
      
      roomUnsubscribe = db.collection('multiplayer_rooms').doc(roomCode)
        .onSnapshot((doc) => {
          if (!doc.exists) return;
          
          const roomData = doc.data();
          updatePlayersList(roomData.players);
          updatePlayersInGame(roomData.players);
          
          document.getElementById('playerCount').textContent = roomData.players.length;
          document.getElementById('maxPlayers').textContent = roomData.maxPlayers;
          roomCreator.textContent = roomData.creatorName;
          
          if (roomData.gameState.active) {
            multiplayerGameActive = true;
            waitingSection.classList.remove('hidden');
            roomInfoSection.classList.add('hidden');
            
            if (!gameStateListenerActive) {
              subscribeToGameState(roomCode);
            }
          } else {
            multiplayerGameActive = false;
            gameActive = false;
            stopChrono();
            updatePlayerControls();
          }
        }, (error) => {
          console.error("Erreur d'√©coute de la salle:", error);
        });
    }

    // D√©marrer le jeu (cr√©ateur seulement)
    startGameBtn.addEventListener('click', async () => {
      if (!currentRoomId || !isRoomCreator) return;
      
      const prefixes = Object.keys(FIELDS);
      const randomPrefix = prefixes[Math.floor(Math.random() * prefixes.length)];
      
      await db.collection('multiplayer_rooms').doc(currentRoomId).update({
        'gameState.active': true,
        'gameState.currentPrefix': randomPrefix,
        'gameState.currentIndex': 0,
        'gameState.currentRound': 1,
        'gameState.totalRounds': 3,
        'gameState.startedAt': firebase.firestore.FieldValue.serverTimestamp(),
        'gameState.questionStartTime': Date.now(),
        lastUpdate: Date.now()
      });
      
      const roomDoc = await db.collection('multiplayer_rooms').doc(currentRoomId).get();
      const roomData = roomDoc.data();
      
      const resetPlayers = roomData.players.map(p => ({
        ...p,
        score: 0,
        lastAnswerTime: 0
      }));
      
      await db.collection('multiplayer_rooms').doc(currentRoomId).update({
        players: resetPlayers,
        lastUpdate: Date.now()
      });
      
      multiplayerMessage.classList.remove('hidden');
      multiplayerMessage.innerHTML = `
        <i class="fas fa-gamepad"></i> La partie a commenc√© ! Manche 1/3 - Champ lexical: <strong>${randomPrefix}</strong>
      `;
      
      updatePlayerControls();
    });

    // üî• FONCTIONS DE BASE DU JEU
    function startChrono() {
      if (chronoTimer) clearInterval(chronoTimer);
      timeLeft = 20;
      chronoDisplay.textContent = timeLeft;
      chronoDisplay.className = "";
      
      chronoTimer = setInterval(() => {
        timeLeft--;
        chronoDisplay.textContent = timeLeft;
        updateChronoStyle();
        
        if (timeLeft <= 0) {
          clearInterval(chronoTimer);
          timeUp();
        }
      }, 1000);
    }

    function stopChrono() {
      if (chronoTimer) {
        clearInterval(chronoTimer);
        chronoTimer = null;
      }
    }

    function updateChronoStyle() {
      if (timeLeft <= 5) {
        chronoDisplay.className = "danger";
      } else if (timeLeft <= 10) {
        chronoDisplay.className = "warning";
      } else {
        chronoDisplay.className = "";
      }
    }

    function updateRoundsDisplay(currentRound, totalRounds) {
      roundsDisplay.classList.remove('hidden');
      roundsDisplay.innerHTML = '';
      
      for (let i = 1; i <= totalRounds; i++) {
        const roundBubble = document.createElement('div');
        roundBubble.className = 'round-bubble';
        
        if (i < currentRound) {
          roundBubble.classList.add('completed');
          roundBubble.innerHTML = `<i class="fas fa-check"></i>`;
        } else if (i === currentRound) {
          roundBubble.classList.add('active');
          roundBubble.textContent = i;
        } else {
          roundBubble.textContent = i;
        }
        
        roundsDisplay.appendChild(roundBubble);
      }
    }

    function updatePlayersList(playersArray) {
      playersList.innerHTML = '';
      players = playersArray;
      
      playersArray.forEach(player => {
        const li = document.createElement('li');
        if (player.id === playerId) {
          li.classList.add('you');
        }
        
        li.innerHTML = `
          <span class="player-badge">${player.name.charAt(0).toUpperCase()}</span>
          <span>${player.name} ${player.isCreator ? '(Cr√©ateur)' : ''}</span>
          <span style="margin-left:auto; font-weight:bold;">Score: ${player.score}</span>
        `;
        
        playersList.appendChild(li);
      });
    }

    function updatePlayersInGame(playersArray) {
      playersInRoom.innerHTML = '';
      
      playersArray.forEach(player => {
        const bubble = document.createElement('div');
        bubble.className = `player-bubble ${player.id === playerId ? 'you' : ''}`;
        
        bubble.innerHTML = `
          ${player.name.charAt(0).toUpperCase()}
          <div class="score">${player.score}</div>
        `;
        
        playersInRoom.appendChild(bubble);
      });
    }

    // Utilitaires
    const normalize = s => s
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z\-' ]/g,'')
      .trim();

    function updatePills(){
      const total = currentPrefix ? FIELDS[currentPrefix].length : 0;
      questionCounter.textContent = `${currentIndex+1}/${total}`;
      scoreValue.textContent = score;
    }

    function ttsCancel(){ if ('speechSynthesis' in window) speechSynthesis.cancel(); }
    function speak(text, rate=speechRate){
      if(!('speechSynthesis' in window)) { return; }
      ttsCancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR';
      u.rate = rate;
      speechSynthesis.speak(u);
    }

    function announce(){
      if(!currentPrefix) return;
      const item = FIELDS[currentPrefix][currentIndex];
      const intro = `Toutes les bonnes r√©ponses commencent par les lettres : ${currentPrefix}.`;
      const def  = item.def;
      speak(`${intro} D√©finition : ${def}`);
      if (!multiplayerGameActive) {
        startChrono();
      }
      gameActive = true;
    }

    function setPrefix(prefix){
      if(!FIELDS[prefix]) return;
      currentPrefix = prefix;
      currentIndex = 0;
      score = 0;
      highlightBank(prefix);
      renderCard();
      gameActive = false;
      stopChrono();
      answerInput.focus();
    }

    function next(){
      if(!currentPrefix) return;
      currentIndex++;
      const list = FIELDS[currentPrefix];
      if(currentIndex >= list.length){
        currentIndex = list.length-1;
        message.innerHTML = `üéâ <strong>${playerName.toUpperCase()}</strong> a termin√© le champ lexical ${currentPrefix} avec un score de ${score}/${list.length}.`;
        message.style.color = "#00e676";
        answerInput.disabled = true;
        gameActive = false;
        stopChrono();
        speak(`Bravo ${playerName} ! Tu as termin√© le champ lexical ${currentPrefix} avec un score de ${score} sur ${list.length}.`);
        return;
      }
      renderCard();
      announce();
    }

    function back(){
      if(!currentPrefix) return;
      if(currentIndex > 0){
        currentIndex--;
        gameActive = false;
        stopChrono();
        renderCard();
        answerInput.focus();
      }
    }

    function repeat(){ 
      if (gameActive) {
        announce(); 
      }
    }

    function slower(){
      speechRate = Math.max(0.5, speechRate - 0.25);
      if (gameActive) announce();
    }
    
    function faster(){
      speechRate = Math.min(2, speechRate + 0.25);
      if (gameActive) announce();
    }

    // Banque d'initiales
    function buildBank(){
      const keys = Object.keys(FIELDS);
      keys.sort((a,b)=>a.localeCompare(b,'fr'));
      initialBank.innerHTML = "";
      for(const k of keys){
        const btn = document.createElement("button");
        btn.textContent = k.toUpperCase();
        btn.setAttribute("aria-label", `Choisir le champ lexical ${k}`);
        btn.addEventListener("click", ()=> setPrefix(k));
        initialBank.appendChild(btn);
      }
    }
    
    function highlightBank(k){
      [...initialBank.children].forEach(b=>{
        b.classList.toggle('active', b.textContent === k.toUpperCase());
      });
    }

    // üî• FONCTIONS ADMIN
    function showAdminModal() {
      adminModal.classList.remove('hidden');
      if (!adminAuthenticated) {
        adminLoginSection.classList.remove('hidden');
        adminDashboard.classList.add('hidden');
      } else {
        adminLoginSection.classList.add('hidden');
        adminDashboard.classList.remove('hidden');
        loadAdminData();
      }
      document.body.style.overflow = 'hidden';
    }

    function hideAdminModal() {
      adminModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    async function loadAdminData() {
      try {
        // Charger toutes les salles
        const roomsSnapshot = await db.collection('multiplayer_rooms').get();
        adminData = [];
        let totalPlayersCount = 0;
        let totalScore = 0;
        let totalGamesCount = 0;
        
        roomsSnapshot.forEach(doc => {
          const roomData = doc.data();
          adminData.push({
            id: doc.id,
            ...roomData,
            createdAt: roomData.createdAt ? roomData.createdAt.toDate() : new Date()
          });
          
          totalPlayersCount += roomData.players.length;
          totalScore += roomData.players.reduce((sum, player) => sum + player.score, 0);
          if (roomData.gameState && roomData.gameState.startedAt) {
            totalGamesCount++;
          }
        });
        
        // Mettre √† jour les statistiques
        totalRooms.textContent = adminData.length;
        totalPlayers.textContent = totalPlayersCount;
        totalGames.textContent = totalGamesCount;
        avgScore.textContent = totalPlayersCount > 0 ? 
          Math.round(totalScore / totalPlayersCount) : '0';
        
        // Mettre √† jour le tableau
        updateAdminResultsTable();
        
      } catch (error) {
        console.error("Erreur lors du chargement des donn√©es admin:", error);
      }
    }

    function updateAdminResultsTable() {
      adminResultsList.innerHTML = '';
      
      if (adminData.length === 0) {
        adminResultsList.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 30px;">
              Aucune donn√©e disponible
            </td>
          </tr>
        `;
        return;
      }
      
      // Trier par date (plus r√©cent d'abord)
      adminData.sort((a, b) => b.createdAt - a.createdAt);
      
      adminData.forEach(room => {
        const row = document.createElement('tr');
        const date = room.createdAt.toLocaleString('fr-FR');
        const avgPlayerScore = room.players.length > 0 ? 
          Math.round(room.players.reduce((sum, p) => sum + p.score, 0) / room.players.length) : 0;
        
        row.innerHTML = `
          <td>
            <strong style="color:#f7ef8a;">${room.code}</strong><br>
            <small style="color:#cccccc;">${room.name}</small>
          </td>
          <td style="color:#e1bee7;">${room.creatorName}</td>
          <td>
            ${room.players.map(p => 
              `<span style="display:inline-block; margin:2px; padding:4px 8px; background:rgba(76,175,80,0.2); border-radius:4px; font-size:0.9rem;">
                ${p.name} (${p.score})
              </span>`
            ).join('')}
          </td>
          <td style="font-weight:bold; color:#4CAF50;">${avgPlayerScore}</td>
          <td style="font-size:0.9rem; color:#cccccc;">${date}</td>
          <td>
            <button class="view-results-btn" onclick="viewRoomDetails('${room.code}')">
              <i class="fas fa-search"></i> D√©tails
            </button>
          </td>
        `;
        adminResultsList.appendChild(row);
      });
    }

    function viewRoomDetails(roomCode) {
      const room = adminData.find(r => r.code === roomCode);
      if (!room) return;
      
      let details = `üìä **D√©tails de la salle: ${room.code}**\n\n`;
      details += `**Nom:** ${room.name}\n`;
      details += `**Cr√©ateur:** ${room.creatorName}\n`;
      details += `**Date:** ${room.createdAt.toLocaleString('fr-FR')}\n`;
      details += `**Statut:** ${room.gameState?.active ? 'En cours' : 'Termin√©'}\n\n`;
      details += `**Joueurs:**\n`;
      
      room.players.forEach((player, index) => {
        details += `${index + 1}. ${player.name} - Score: ${player.score} ${player.isCreator ? '(Cr√©ateur)' : ''}\n`;
      });
      
      alert(details);
    }

    function exportAdminData() {
      if (adminData.length === 0) {
        alert("Aucune donn√©e √† exporter");
        return;
      }
      
      let csv = "Code,Nom,Cr√©ateur,Nombre de Joueurs,Score Moyen,Date Cr√©ation\n";
      
      adminData.forEach(room => {
        const avgPlayerScore = room.players.length > 0 ? 
          Math.round(room.players.reduce((sum, p) => sum + p.score, 0) / room.players.length) : 0;
        const date = room.createdAt.toLocaleString('fr-FR');
        
        csv += `"${room.code}","${room.name}","${room.creatorName}","${room.players.length}","${avgPlayerScore}","${date}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `champs_lexicaux_stats_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      alert(`Donn√©es export√©es: ${adminData.length} salles`);
    }

    async function clearOldRooms() {
      if (!confirm("Voulez-vous supprimer les salles inactives (plus de 7 jours) ?")) {
        return;
      }
      
      try {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - 7);
        
        let deletedCount = 0;
        
        for (const room of adminData) {
          if (room.createdAt < cutoffDate) {
            await db.collection('multiplayer_rooms').doc(room.code).delete();
            deletedCount++;
          }
        }
        
        alert(`${deletedCount} salles inactives ont √©t√© supprim√©es`);
        loadAdminData();
        
      } catch (error) {
        console.error("Erreur lors de la suppression:", error);
        alert("Erreur lors de la suppression des salles");
      }
    }

    // üî• √âCOUTEURS D'√âV√âNEMENTS PRINCIPAUX
    btnPlay.addEventListener("click", ()=>{
      if (multiplayerGameActive && !isRoomCreator) {
        message.textContent = "‚ùå Seul le cr√©ateur peut d√©marrer le jeu en mode multijoueur";
        message.classList.add('shake');
        setTimeout(() => message.classList.remove('shake'), 500);
        return;
      }
      
      if(!currentPrefix){
        const first = Object.keys(FIELDS).sort((a,b)=>a.localeCompare(b,'fr'))[0];
        setPrefix(first);
        announce();
      }else{
        announce();
      }
    });
    
    btnSlow.addEventListener("click", slower);
    btnFast.addEventListener("click", faster);
    btnRepeat.addEventListener("click", repeat);
    
    btnSkip.addEventListener("click", () => {
      if (multiplayerGameActive && !isRoomCreator) {
        message.textContent = "‚ùå Seul le cr√©ateur peut passer √† la question suivante";
        message.classList.add('shake');
        setTimeout(() => message.classList.remove('shake'), 500);
        return;
      }
      next();
    });
    
    btnBack.addEventListener("click", () => {
      if (multiplayerGameActive && !isRoomCreator) {
        message.textContent = "‚ùå Seul le cr√©ateur peut revenir √† la question pr√©c√©dente";
        message.classList.add('shake');
        setTimeout(() => message.classList.remove('shake'), 500);
        return;
      }
      back();
    });

    answerInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && gameActive && !answeredThisQuestion) check();
    });

    // Gestion de l'interface multijoueur
    multiplayerButton.addEventListener('click', () => {
      multiplayerModal.classList.remove('hidden');
      showMainMenu();
      document.body.style.overflow = 'hidden';
    });

    closeMultiplayerModal.addEventListener('click', () => {
      multiplayerModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    });

    multiplayerModal.addEventListener('click', (e) => {
      if (e.target === multiplayerModal) {
        multiplayerModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
    });

    createRoomBtn.addEventListener('click', () => {
      showMainMenu();
      createRoomSection.classList.remove('hidden');
    });

    joinRoomBtn.addEventListener('click', () => {
      showMainMenu();
      joinRoomSection.classList.remove('hidden');
    });

    // Copier le code de la salle
    copyRoomCodeBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(currentRoomId)
        .then(() => {
          const originalText = copyRoomCodeBtn.innerHTML;
          copyRoomCodeBtn.innerHTML = '<i class="fas fa-check"></i> Copi√© !';
          copyRoomCodeBtn.style.background = 'rgba(76, 175, 80, 0.3)';
          setTimeout(() => {
            copyRoomCodeBtn.innerHTML = originalText;
            copyRoomCodeBtn.style.background = '';
          }, 2000);
        })
        .catch(err => {
          console.error('Erreur lors de la copie:', err);
        });
    });

    // Quitter la salle
    leaveRoomBtn.addEventListener('click', leaveRoom);
    leaveRoomBtnInGame.addEventListener('click', leaveRoom);

    async function leaveRoom() {
      if (!currentRoomId) return;
      
      if (!confirm("Voulez-vous vraiment quitter la salle ?")) {
        return;
      }
      
      try {
        const roomDoc = await db.collection('multiplayer_rooms').doc(currentRoomId).get();
        if (roomDoc.exists) {
          const roomData = roomDoc.data();
          const player = roomData.players.find(p => p.id === playerId);
          
          if (player) {
            await db.collection('multiplayer_rooms').doc(currentRoomId).update({
              players: firebase.firestore.FieldValue.arrayRemove(player),
              lastUpdate: Date.now()
            });
          }
          
          if (isRoomCreator) {
            // Si le cr√©ateur quitte, supprimer la salle
            await db.collection('multiplayer_rooms').doc(currentRoomId).delete();
          }
        }
        
        resetMultiplayerState();
        
      } catch (error) {
        console.error("Erreur lors de la sortie de la salle:", error);
      }
    }

    // R√©initialiser l'√©tat multijoueur
    function resetMultiplayerState() {
      if (roomUnsubscribe) {
        roomUnsubscribe();
        roomUnsubscribe = null;
      }
      
      if (gameStateUnsubscribe) {
        gameStateUnsubscribe();
        gameStateUnsubscribe = null;
      }
      
      currentRoomId = null;
      isRoomCreator = false;
      multiplayerGameActive = false;
      gameStateListenerActive = false;
      players = [];
      currentRound = 1;
      answeredThisQuestion = false;
      lastSyncTime = 0;
      
      multiplayerModal.classList.add('hidden');
      multiplayerStatus.classList.add('hidden');
      multiplayerMessage.classList.add('hidden');
      roundsDisplay.classList.add('hidden');
      
      gameActive = false;
      stopChrono();
      updatePlayerControls();
      document.body.style.overflow = 'auto';
      
      // R√©initialiser le jeu solo
      setPrefix(Object.keys(FIELDS)[0]);
    }

    // üî• GESTION ADMIN
    adminButton.addEventListener('click', showAdminModal);
    
    closeAdminModal.addEventListener('click', hideAdminModal);
    
    adminModal.addEventListener('click', (e) => {
      if (e.target === adminModal) {
        hideAdminModal();
      }
    });

    adminLoginBtn.addEventListener('click', () => {
      if (adminPassword.value === ADMIN_PASSWORD) {
        adminAuthenticated = true;
        adminLoginSection.classList.add('hidden');
        adminDashboard.classList.remove('hidden');
        loadAdminData();
        adminPassword.value = '';
      } else {
        alert("Mot de passe incorrect. Essayez: admin123");
      }
    });

    adminPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        adminLoginBtn.click();
      }
    });

    refreshAdminBtn.addEventListener('click', loadAdminData);
    
    exportAdminBtn.addEventListener('click', exportAdminData);
    
    clearOldBtn.addEventListener('click', clearOldRooms);
    
    adminLogoutBtn.addEventListener('click', () => {
      adminAuthenticated = false;
      hideAdminModal();
      alert("D√©connect√© du panel admin");
    });

    // Initialisation
    window.addEventListener("load", ()=>{
      buildBank();
      renderCard();
      if(!('speechSynthesis' in window)){
        message.innerHTML = "‚ö†Ô∏è La synth√®se vocale n'est pas disponible sur ce navigateur.";
      }
      
      // G√©n√©rer un nom par d√©faut
      const defaultNames = ["Alex", "Sam", "Morgan", "Jordan", "Taylor", "Casey", "Riley", "Quinn"];
      const randomName = defaultNames[Math.floor(Math.random() * defaultNames.length)];
      playerNameInput.value = randomName;
      playerName = randomName;
      
      // Pr√©venir l'utilisateur des r√®gles
      setTimeout(() => {
        message.innerHTML = '<i class="fas fa-info-circle"></i> Seul le joueur avec la bonne r√©ponse gagne des points !';
        message.style.color = "#ff9800";
      }, 1000);
    });

    // Exposer les fonctions globales
    window.viewRoomDetails = viewRoomDetails;

    // Nettoyage
    window.addEventListener('beforeunload', () => {
      if (currentRoomId) {
        leaveRoom();
      }
    });
  </script>
</body>
</html>