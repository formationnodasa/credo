<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Champs Lexicaux - Jeu Chronom√©tr√©</title>
  <style>
    :root{
      --bg1:#6a11cb; --bg2:#2575fc;
      --card: rgba(255,255,255,.12);
      --glass: blur(12px);
      --txt:#fff; --accent:#fff; --brand:#2575fc;
      --ok:#00e676; --ko:#ff5252;
    }
    *{box-sizing:border-box}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(270deg, var(--bg1), var(--bg2), var(--bg1));
      background-size: 600% 600%;
      animation: gradientAnimation 15s ease infinite;
      color: var(--txt);
      min-height: 100vh;
      margin: 0;
      padding: 12px;
    }
    @keyframes gradientAnimation{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .container{
      background: var(--card);
      backdrop-filter: var(--glass);
      width: min(1200px, 94vw);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,.25);
      animation: fadeIn .9s ease;
      margin: 20px auto;
    }
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)}}
    
    /* Styles pour le modal admin */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal-content {
      background: #1a1a2e;
      border-radius: 20px;
      padding: 25px;
      max-width: 800px;
      margin: 0 auto;
      border: 2px solid #d4af37;
      position: relative;
      color: white;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.8rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: rgba(212, 175, 55, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid rgba(212, 175, 55, 0.3);
    }
    
    .stat-value {
      font-size: 2.2rem;
      font-weight: bold;
      color: #f7ef8a;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #a0c8ff;
      font-size: 0.9rem;
    }
    
    .results-table-container {
      max-height: 400px;
      overflow-y: auto;
      margin: 20px 0;
      border-radius: 10px;
      border: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .results-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
    }
    
    .results-table th {
      background: rgba(212, 175, 55, 0.2);
      color: #f7ef8a;
      padding: 12px 15px;
      text-align: left;
      position: sticky;
      top: 0;
      border-bottom: 2px solid rgba(212, 175, 55, 0.4);
    }
    
    .results-table td {
      padding: 12px 15px;
      color: #cccccc;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .results-table tr:hover {
      background: rgba(212, 175, 55, 0.1);
    }
    
    .export-btn {
      display: block;
      width: 100%;
      padding: 16px;
      background: linear-gradient(90deg, #4CAF50, #2E7D32);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      text-align: center;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap
    }
    h1{
      font-weight:800; margin:0; font-size: clamp(26px, 3.4vw, 40px);
      text-shadow: 0 3px 8px rgba(0,0,0,.3);
      letter-spacing:.3px;
    }
    .admin-btn {
      background-color: #ff6b6b;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-size: 1rem;
    }
    
    .admin-btn:hover {
      background-color: #ff5252;
      transform: scale(1.05);
    }
    
    .status{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:600;
      opacity:.95;
    }
    .pill{
      padding:8px 16px; border-radius:999px; background:rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.16);
      font-size:1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .display{
      margin:24px 0 10px; display:grid; gap:10px;
    }
    #prefixDisplay{
      font-size: clamp(36px, 5vw, 64px);
      font-weight:900; letter-spacing:.18em; text-align:center;
      text-shadow: 0 3px 8px rgba(0,0,0,.28);
    }
    #definitionDisplay{
      font-size: clamp(18px, 2.2vw, 22px);
      line-height:1.6; text-align:center;
      background: rgba(0,0,0,.16);
      border-radius:14px; padding:20px;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chrono-container {
      text-align: center;
      margin: 20px 0;
    }
    #chrono {
      font-size: 3rem;
      font-weight: bold;
      color: #fff;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      padding: 15px;
      display: inline-block;
      min-width: 200px;
      transition: all 0.3s ease;
    }
    #chrono.warning {
      color: #ff9800;
      animation: pulse 1s infinite;
    }
    #chrono.danger {
      color: #ff5252;
      animation: pulse 0.5s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    .controls{
      display:grid; grid-template-columns: repeat(6,1fr); gap:10px; margin:12px 0 6px;
    }
    button{
      padding:12px; font-size:1.1rem; font-weight:700; border-radius:14px; border:none;
      cursor:pointer; background:#fff; color:var(--brand);
      transition:.25s; box-shadow:0 4px 10px rgba(0,0,0,.1);
    }
    button:hover{ background:var(--brand); color:#fff; box-shadow:0 0 12px #ffffff99, 0 0 18px #2575fcaa }
    button:disabled{opacity:.55; cursor:not-allowed}
    input[type="text"]{
      font-size:1.2rem; padding:14px 16px; border-radius:12px; border:none; width:100%;
      margin:10px 0 14px; background:#fff; color:#222; outline:none; transition:.25s;
    }
    input[type="text"]:focus{ box-shadow:0 0 10px var(--brand); caret-color:var(--brand) }
    #message{ min-height:28px; font-size:1.1rem; font-weight:700; text-align:center; margin:6px 0 0 }
    .divider{ height:1px; background:rgba(255,255,255,.18); margin:18px 0 }
    .bank{
      display:flex; flex-wrap:wrap; gap:12px; justify-content:center;
    }
    .bank button{
      background:rgba(255,255,255,.12); color:#fff; font-weight:800; letter-spacing:.08em;
      border:1px solid rgba(255,255,255,.18);
    }
    .bank button.active{ background:#fff; color:var(--brand) }
    .footnote{
      margin-top:10px; text-align:center; opacity:.85; font-size:.95rem
    }
    .player-info {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .player-select {
      flex: 1;
      min-width: 200px;
    }
    .player-select select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      font-size: 1rem;
    }
    .github-link {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
    }
    .github-link a {
      color: #f7ef8a;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: bold;
    }
    .github-link a:hover {
      text-decoration: underline;
    }
    .hidden { display: none !important; }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
</head>
<body>
  <!-- Modal Admin -->
  <div class="modal-overlay" id="adminModal">
    <div class="modal-content">
      <button class="close-modal" id="closeAdminModal">&times;</button>
      
      <h2><i class="fas fa-lock"></i> PANEL ADMIN - JEU DES CHAMPS LEXICAUX</h2>
      
      <div id="passwordSection">
        <p style="color: #a0c8ff; text-align: center; margin-bottom: 20px;">
          Acc√®s r√©serv√© √† l'administrateur
        </p>
        <div class="form-group">
          <input type="password" id="adminPassword" 
                 placeholder="Entrez le mot de passe administrateur"
                 class="form-input">
        </div>
        <button id="loginButton" class="submit-button">
          <i class="fas fa-sign-in-alt"></i> SE CONNECTER
        </button>
      </div>
      
      <div id="adminPanel" class="hidden">
        <h3 style="color: #f7ef8a; text-align: center; margin-bottom: 20px;">
          Statistiques du Jeu
        </h3>
        
        <!-- Statistiques -->
        <div class="admin-stats">
          <div class="stat-card">
            <div class="stat-value" id="totalGames">0</div>
            <div class="stat-label">Parties Jou√©es</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-value" id="averageScore">0%</div>
            <div class="stat-label">Moyenne Score</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-value" id="bestScore">0</div>
            <div class="stat-label">Meilleur Score</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-value" id="todayGames">0</div>
            <div class="stat-label">Aujourd'hui</div>
          </div>
        </div>
        
        <!-- Tableau des r√©sultats -->
        <div class="results-table-container">
          <table class="results-table">
            <thead>
              <tr>
                <th>Joueur</th>
                <th>Score</th>
                <th>Temps R√©ponse</th>
                <th>Date</th>
                <th>Champ</th>
              </tr>
            </thead>
            <tbody id="gamesList">
              <!-- Les r√©sultats seront ins√©r√©s ici -->
            </tbody>
          </table>
        </div>
        
        <button id="exportButton" class="export-btn">
          <i class="fas fa-download"></i> EXPORTER LES R√âSULTATS
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <h1>Champs Lexicaux ‚Äì Jeu Chronom√©tr√©</h1>
      <div class="status">
        <span class="pill" id="progressPill">0 / 0</span>
        <span class="pill" id="scorePill">Score: 0</span>
        <span class="pill">
          <i class="fas fa-clock"></i>
          <span id="hintPill">Temps: 20s</span>
        </span>
        <button class="admin-btn" id="adminButton">
          <i class="fas fa-lock"></i> Admin
        </button>
      </div>
    </header>

    <div class="player-info">
      <div class="player-select">
        <select id="playerSelect">
          <option value="moise">Mo√Øse</option>
          <option value="credo">Credo</option>
          <option value="visiteur">Visiteur</option>
        </select>
      </div>
    </div>

    <div class="display">
      <div id="prefixDisplay">‚Äì ‚Äì</div>
      <div id="definitionDisplay">S√©lectionne un champ lexical et clique sur Jouer. Tu as 20 secondes pour r√©pondre.</div>
    </div>

    <div class="chrono-container">
      <div id="chrono">20</div>
    </div>

    <input type="text" id="answer" placeholder="√âcris le mot correct (m√™me initiales) et appuie sur Entr√©e‚Ä¶" autocomplete="off" />

    <div class="controls" role="group" aria-label="Commandes">
      <button id="btnPlay">‚ñ∂Ô∏è Jouer</button>
      <button id="btnSlow">üê¢ Ralentir</button>
      <button id="btnFast">üêá Acc√©l√©rer</button>
      <button id="btnRepeat">üîÅ R√©p√©ter</button>
      <button id="btnSkip">‚è≠ Passer</button>
      <button id="btnBack">‚¨ÖÔ∏è Retour</button>
    </div>

    <div id="message" aria-live="polite"></div>

    <div class="divider"></div>

    <div class="bank" id="initialBank" aria-label="Liste d'initiales (s√©lection rapide)"></div>
    <div class="footnote">Astuce : tu as 20 secondes pour r√©pondre √† chaque question. La vitesse de lecture peut √™tre ajust√©e.</div>
    
    <div class="github-link">
      <a href="https://github.com/legende360" target="_blank">
        <i class="fab fa-github"></i> Voir le code sur GitHub (legende360)
      </a>
    </div>
  </div>

  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBPBq1uT7lbL9Xp_neAJh2lSe0MRErlYdo",
      authDomain: "evoir-1.firebaseapp.com",
      projectId: "evoir-1",
      storageBucket: "evoir-1.firebasestorage.app",
      messagingSenderId: "504718469638",
      appId: "1:504718469638:web:72707fd51d0ce6ff773187",
      measurementId: "G-ZXPC2SKJHT"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Admin credentials
    const ADMIN_PASSWORD = "legende360@";

    // Donn√©es : champs lexicaux
    const FIELDS = {
      "Pr": [
        {mot:"Pr√©cision", def:"Le fait de donner des d√©tails exacts et pr√©cis sur quelque chose."},
        {mot:"Profond", def:"Qui se rapporte √† la profondeur ou √† une intensit√© importante."},
        {mot:"Profession", def:"Domaine d'activit√© ou m√©tier dans lequel une personne travaille."},
        {mot:"Progr√®s", def:"Avancement ou am√©lioration dans une situation ou un domaine."},
        {mot:"Promesse", def:"Engagement ou parole donn√©e de faire quelque chose."},
        {mot:"Proverbe", def:"Expression populaire qui contient une sagesse ou un conseil."},
        {mot:"Pr√©cieux", def:"Qui a une grande valeur ou importance."},
        {mot:"Pr√©paration", def:"Action de se pr√©parer en vue d'une activit√©."},
        {mot:"Pr√©caution", def:"Mesure prise pour √©viter un danger ou un probl√®me."},
        {mot:"Privil√®ge", def:"Avantage ou droit sp√©cial accord√© √† certaines personnes."}
      ],
      "Se": [
        {mot:"Sensation", def:"Perception ou ressenti d'un stimulus par les sens."},
        {mot:"S√©duction", def:"Charme ou pouvoir d'attraction envers quelqu'un."},
        {mot:"S√©r√©nit√©", def:"√âtat de calme et de tranquillit√©."},
        {mot:"Secret", def:"Quelque chose qui est cach√© ou inconnu du public."},
        {mot:"S√©paration", def:"Acte de se s√©parer ou de se diviser."},
        {mot:"S√©rieux", def:"√âtat de responsabilit√© et de gravit√©."},
        {mot:"Sentiment", def:"√âmotion ou affection ressentie envers quelqu'un ou quelque chose."},
        {mot:"Service", def:"Action d'aider ou d'assister quelqu'un."},
        {mot:"Seconde", def:"Unit√© de temps ou rang apr√®s la premi√®re."},
        {mot:"Septi√®me", def:"Position dans une s√©rie apr√®s le sixi√®me."}
      ],
      "Tr": [
        {mot:"Transformation", def:"Changement ou m√©tamorphose d'une chose en une autre."},
        {mot:"Tristesse", def:"√âtat de chagrin ou de m√©lancolie."},
        {mot:"Travail", def:"Emploi ou activit√© professionnelle."},
        {mot:"Traitement", def:"Action de soigner ou de proc√©der √† une proc√©dure m√©dicale."},
        {mot:"Tradition", def:"Coutume transmise de g√©n√©ration en g√©n√©ration."},
        {mot:"Trag√©die", def:"Drame qui provoque de la tristesse ou du d√©sespoir."},
        {mot:"Trenti√®me", def:"Position dans une s√©rie apr√®s le vingt-neuvi√®me."},
        {mot:"Triomphe", def:"Victoire √©clatante √† l'issue d'une lutte."},
        {mot:"Transparence", def:"Clart√© d'une substance ou d'une situation."},
        {mot:"Tr√©sor", def:"Richesse ou bien pr√©cieux √† valeur sentimentale ou mat√©rielle."}
      ],
      "Ac": [
        {mot:"Accompagnement", def:"Soutien ou aide fournie √† quelqu'un."},
        {mot:"Acc√®s", def:"Possibilit√© d'entrer dans un lieu ou d'obtenir quelque chose."},
        {mot:"Action", def:"Acte de faire quelque chose."},
        {mot:"Activit√©", def:"Occupation ou exercice d'une action."},
        {mot:"Achat", def:"Acquisition d'un bien."},
        {mot:"Accident", def:"√âv√©nement impr√©vu, souvent tragique."},
        {mot:"Accord", def:"Entente ou consensus entre plusieurs personnes."},
        {mot:"Acquisition", def:"Obtention d'une chose."},
        {mot:"Acteur", def:"Personne qui joue un r√¥le au th√©√¢tre ou au cin√©ma."},
        {mot:"Acclamation", def:"Applaudissements ou √©loges enthousiastes."}
      ],
      "Ca": [
        {mot:"Caract√®re", def:"Ensemble de traits distinctifs d'une personne ou d'une chose."},
        {mot:"Carte", def:"Document repr√©sentant une r√©gion ou un territoire."},
        {mot:"Cascade", def:"Chute d'eau sur une pente."},
        {mot:"Cadeau", def:"Objet offert pour une occasion ou par affection."},
        {mot:"Caisse", def:"Contenant destin√© au transport d'objets."},
        {mot:"Cam√©ra", def:"Appareil pour prendre des photos ou filmer."},
        {mot:"Campagne", def:"R√©gion rurale, √©loign√©e de la ville."},
        {mot:"Canal", def:"Voie d'eau artificielle pour le transport."},
        {mot:"Capacit√©", def:"Aptitude √† faire, comprendre ou apprendre."},
        {mot:"Capitale", def:"Ville principale d'un pays ou d'une r√©gion."}
      ],
      "Me": [
        {mot:"M√©moire", def:"Capacit√© de se souvenir et de rappeler des informations."},
        {mot:"M√©thode", def:"Mani√®re sp√©cifique d'effectuer une t√¢che."},
        {mot:"M√©lodie", def:"S√©quence agr√©able de notes musicales."},
        {mot:"Menu", def:"Liste de plats ou d'options dans un programme."},
        {mot:"M√©contentement", def:"Sentiment de ne pas √™tre satisfait."},
        {mot:"Mesure", def:"Quantit√© ou √©chelle pour √©valuer quelque chose."},
        {mot:"Merveille", def:"Chose tr√®s impressionnante ou √©tonnante."},
        {mot:"M√©ditation", def:"Pratique de relaxation et de concentration."},
        {mot:"Messagerie", def:"Syst√®me d'envoi et de r√©ception de messages."},
        {mot:"M√©morable", def:"Qui m√©rite d'√™tre rappel√©."}
      ]
    };

    // √âl√©ments DOM
    const prefixDisplay = document.getElementById("prefixDisplay");
    const definitionDisplay = document.getElementById("definitionDisplay");
    const answerInput = document.getElementById("answer");
    const message = document.getElementById("message");
    const btnPlay = document.getElementById("btnPlay");
    const btnSlow = document.getElementById("btnSlow");
    const btnFast = document.getElementById("btnFast");
    const btnRepeat = document.getElementById("btnRepeat");
    const btnSkip = document.getElementById("btnSkip");
    const btnBack = document.getElementById("btnBack");
    const initialBank = document.getElementById("initialBank");
    const progressPill = document.getElementById("progressPill");
    const scorePill = document.getElementById("scorePill");
    const chronoDisplay = document.getElementById("chrono");
    const playerSelect = document.getElementById("playerSelect");

    // √âtat du jeu
    let currentPrefix = null;
    let currentIndex = 0;
    let speechRate = 1;
    let score = 0;
    let chronoTimer = null;
    let timeLeft = 20;
    let gameActive = false;
    let playerName = "moise";

    // Variables admin
    let allGames = [];

    // Initialiser le joueur
    playerSelect.addEventListener('change', function() {
      playerName = this.value;
    });

    // Chronom√®tre
    function startChrono() {
      if (chronoTimer) clearInterval(chronoTimer);
      timeLeft = 20;
      chronoDisplay.textContent = timeLeft;
      chronoDisplay.className = "";
      
      chronoTimer = setInterval(() => {
        timeLeft--;
        chronoDisplay.textContent = timeLeft;
        
        if (timeLeft <= 5) {
          chronoDisplay.className = "danger";
        } else if (timeLeft <= 10) {
          chronoDisplay.className = "warning";
        }
        
        if (timeLeft <= 0) {
          clearInterval(chronoTimer);
          timeUp();
        }
      }, 1000);
    }

    function stopChrono() {
      if (chronoTimer) {
        clearInterval(chronoTimer);
        chronoTimer = null;
      }
    }

    function timeUp() {
      if (!gameActive) return;
      
      const item = FIELDS[currentPrefix][currentIndex];
      message.textContent = `‚è∞ Temps √©coul√© ! La r√©ponse √©tait : ${item.mot}`;
      message.style.color = "#ff5252";
      speak(`Temps √©coul√© ! La r√©ponse √©tait : ${item.mot}`);
      
      // Sauvegarder le r√©sultat (temps √©coul√©)
      saveGameResult(false, 0);
      
      setTimeout(next, 2000);
    }

    // Utilitaires
    const normalize = s => s
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z\-' ]/g,'')
      .trim();

    function updatePills(){
      const total = currentPrefix ? FIELDS[currentPrefix].length : 0;
      progressPill.textContent = total ? `${currentIndex+1} / ${total}` : `0 / 0`;
      scorePill.textContent = `Score: ${score}`;
    }

    function ttsCancel(){ if ('speechSynthesis' in window) speechSynthesis.cancel(); }
    function speak(text, rate=speechRate){
      if(!('speechSynthesis' in window)) { return; }
      ttsCancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR';
      u.rate = rate;
      speechSynthesis.speak(u);
    }

    function announce(){
      if(!currentPrefix) return;
      const item = FIELDS[currentPrefix][currentIndex];
      const intro = `Toutes les bonnes r√©ponses commencent par les lettres : ${currentPrefix}.`;
      const def  = item.def;
      speak(`${intro} D√©finition : ${def}`);
      startChrono();
      gameActive = true;
    }

    function renderCard(){
      if(!currentPrefix){
        prefixDisplay.textContent = "‚Äì ‚Äì";
        definitionDisplay.textContent = "Choisis un champ lexical ci-dessous pour commencer.";
        updatePills();
        return;
      }
      const item = FIELDS[currentPrefix][currentIndex];
      prefixDisplay.textContent = currentPrefix;
      definitionDisplay.textContent = item.def;
      message.textContent = "Tu as 20 secondes pour r√©pondre. Le mot doit commencer par " + currentPrefix;
      message.style.color = "#fff";
      answerInput.value = "";
      answerInput.placeholder = `Un mot qui commence par ¬´ ${currentPrefix} ¬ª‚Ä¶`;
      answerInput.disabled = false;
      updatePills();
      answerInput.focus();
    }

    function setPrefix(prefix){
      if(!FIELDS[prefix]) return;
      currentPrefix = prefix;
      currentIndex = 0;
      score = 0;
      highlightBank(prefix);
      renderCard();
      gameActive = false;
      stopChrono();
      answerInput.focus();
    }

    function next(){
      if(!currentPrefix) return;
      currentIndex++;
      const list = FIELDS[currentPrefix];
      if(currentIndex >= list.length){
        // Fin du champ courant
        currentIndex = list.length-1;
        message.textContent = `üéâ Bravo ! Tu as termin√© le champ lexical ${currentPrefix} avec un score de ${score}/${list.length}.`;
        message.style.color = "#00e676";
        answerInput.disabled = true;
        gameActive = false;
        stopChrono();
        speak(`Bravo ! Tu as termin√© le champ lexical ${currentPrefix} avec un score de ${score} sur ${list.length}.`);
        return;
      }
      renderCard();
      announce();
    }

    function back(){
      if(!currentPrefix) return;
      if(currentIndex > 0){
        currentIndex--;
        gameActive = false;
        stopChrono();
        renderCard();
        answerInput.focus();
      }
    }

    function repeat(){ 
      if (gameActive) {
        announce(); 
      }
    }

    function slower(){
      speechRate = Math.max(0.5, speechRate - 0.25);
      announce();
    }
    
    function faster(){
      speechRate = Math.min(2, speechRate + 0.25);
      announce();
    }

    async function check(){
      if(!currentPrefix || !gameActive) return;
      
      const item = FIELDS[currentPrefix][currentIndex];
      const user = normalize(answerInput.value);
      const target = normalize(item.mot);
      const timeUsed = 20 - timeLeft;

      // V√©rifier la r√©ponse
      if(user && user.startsWith(normalize(currentPrefix)) && user === target){
        stopChrono();
        score++;
        message.textContent = `‚úÖ Correct ! Temps: ${timeUsed}s`;
        message.style.color = "#00e676";
        speak("Correct !");
        
        // Sauvegarder le r√©sultat
        await saveGameResult(true, timeUsed);
        
        setTimeout(next, 1500);
      }else{
        message.textContent = `‚ùå Incorrect. La r√©ponse √©tait : ${item.mot}`;
        message.style.color = "#ff5252";
        speak(`Incorrect. La r√©ponse √©tait : ${item.mot}`);
        
        // Sauvegarder le r√©sultat
        await saveGameResult(false, timeUsed);
        
        setTimeout(next, 2000);
      }
    }

    // Sauvegarder le r√©sultat dans Firebase
    async function saveGameResult(isCorrect, timeUsed) {
      try {
        const gameData = {
          player: playerName,
          prefix: currentPrefix,
          wordIndex: currentIndex,
          word: FIELDS[currentPrefix][currentIndex].mot,
          isCorrect: isCorrect,
          timeUsed: timeUsed,
          score: score,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          date: new Date().toISOString()
        };
        
        await db.collection('jeu_champs_lexicaux').add(gameData);
        console.log(`R√©sultat sauvegard√© pour ${playerName}`);
        
      } catch (error) {
        console.error("Erreur lors de la sauvegarde:", error);
      }
    }

    // Banque d'initiales
    function buildBank(){
      const keys = Object.keys(FIELDS);
      keys.sort((a,b)=>a.localeCompare(b,'fr'));
      initialBank.innerHTML = "";
      for(const k of keys){
        const btn = document.createElement("button");
        btn.textContent = k.toUpperCase();
        btn.setAttribute("aria-label", `Choisir le champ lexical ${k}`);
        btn.addEventListener("click", ()=> setPrefix(k));
        initialBank.appendChild(btn);
      }
    }
    
    function highlightBank(k){
      [...initialBank.children].forEach(b=>{
        b.classList.toggle('active', b.textContent === k.toUpperCase());
      });
    }

    // √âcouteurs d'√©v√©nements
    btnPlay.addEventListener("click", ()=>{
      if(!currentPrefix){
        const first = Object.keys(FIELDS).sort((a,b)=>a.localeCompare(b,'fr'))[0];
        setPrefix(first);
        announce();
      }else{
        announce();
      }
    });
    
    btnSlow.addEventListener("click", slower);
    btnFast.addEventListener("click", faster);
    btnRepeat.addEventListener("click", repeat);
    btnSkip.addEventListener("click", next);
    btnBack.addEventListener("click", back);

    answerInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && gameActive) check();
    });

    // Gestion du panel admin
    const adminModal = document.getElementById('adminModal');
    const adminButton = document.getElementById('adminButton');
    const closeAdminModal = document.getElementById('closeAdminModal');
    const loginButton = document.getElementById('loginButton');
    const exportButton = document.getElementById('exportButton');

    // Ouvrir modal admin
    adminButton.addEventListener('click', () => {
      adminModal.style.display = 'block';
      document.getElementById('passwordSection').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('adminPassword').value = '';
      document.body.style.overflow = 'hidden';
    });

    // Fermer modal admin
    closeAdminModal.addEventListener('click', () => {
      adminModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    });

    // Fermer modal en cliquant √† l'ext√©rieur
    adminModal.addEventListener('click', (e) => {
      if (e.target === adminModal) {
        adminModal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    });

    // Login admin
    loginButton.addEventListener('click', () => {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        document.getElementById('passwordSection').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        loadGamesData();
      } else {
        alert("Mot de passe incorrect. Le mot de passe est : legende360@");
      }
    });

    // Charger les donn√©es des jeux
    async function loadGamesData() {
      try {
        const snapshot = await db.collection('jeu_champs_lexicaux')
          .orderBy('timestamp', 'desc')
          .limit(100)
          .get();
        
        allGames = [];
        let totalScore = 0;
        let bestScore = 0;
        const today = new Date().toDateString();
        let todayCount = 0;
        let correctCount = 0;
        
        snapshot.forEach(doc => {
          const data = doc.data();
          allGames.push({
            ...data,
            id: doc.id
          });
          
          if (data.isCorrect) correctCount++;
          if (data.score > bestScore) {
            bestScore = data.score;
          }
          
          // Compter les jeux d'aujourd'hui
          if (data.timestamp) {
            const gameDate = data.timestamp.toDate ? 
              data.timestamp.toDate().toDateString() : 
              new Date(data.date).toDateString();
            if (gameDate === today) {
              todayCount++;
            }
          }
        });
        
        // Update statistics
        document.getElementById('totalGames').textContent = allGames.length;
        document.getElementById('averageScore').textContent = allGames.length > 0 ? 
          Math.round((correctCount / allGames.length) * 100) + '%' : '0%';
        document.getElementById('bestScore').textContent = bestScore;
        document.getElementById('todayGames').textContent = todayCount;
        
        // Display results table
        displayGamesTable();
        
      } catch (error) {
        console.error("Erreur lors du chargement des jeux:", error);
        const listElement = document.getElementById('gamesList');
        listElement.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 30px; color: #ff6b6b;">
              Erreur de connexion √† la base de donn√©es.
            </td>
          </tr>
        `;
      }
    }

    function displayGamesTable() {
      const tableBody = document.getElementById('gamesList');
      tableBody.innerHTML = '';
      
      if (allGames.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 30px;">
              Aucun r√©sultat trouv√©.
            </td>
          </tr>
        `;
        return;
      }
      
      allGames.forEach((game) => {
        const row = document.createElement('tr');
        const date = game.timestamp ? 
          new Date(game.timestamp.toDate()).toLocaleString('fr-FR') : 
          new Date(game.date).toLocaleString('fr-FR');
        
        // Cr√©er une couleur pour le r√©sultat
        let resultColor = game.isCorrect ? '#4CAF50' : '#ff6b6b';
        let resultIcon = game.isCorrect ? '‚úÖ' : '‚ùå';
        
        row.innerHTML = `
          <td style="font-weight: bold; color: #f7ef8a;">
            ${game.player.charAt(0).toUpperCase() + game.player.slice(1)}
          </td>
          <td style="color: ${resultColor}; font-weight: bold;">
            ${resultIcon} ${game.isCorrect ? 'Correct' : 'Incorrect'}
          </td>
          <td style="color: #a0c8ff;">
            ${game.timeUsed}s
          </td>
          <td style="color: #cccccc; font-size: 0.9rem;">
            ${date}
          </td>
          <td style="color: #cccccc;">
            ${game.prefix}
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Export des donn√©es
    exportButton.addEventListener('click', exportGamesData);

    function exportGamesData() {
      if (allGames.length === 0) {
        alert("Aucune donn√©e √† exporter");
        return;
      }
      
      let csv = "Joueur,R√©sultat,Mot,Champ Lexical,Temps utilis√©,Score,Date\n";
      
      allGames.forEach(game => {
        const date = game.timestamp ? 
          new Date(game.timestamp.toDate()).toLocaleString('fr-FR') : 
          new Date(game.date).toLocaleString('fr-FR');
        
        const result = game.isCorrect ? 'Correct' : 'Incorrect';
        
        csv += `"${game.player}","${result}","${game.word}","${game.prefix}","${game.timeUsed}s","${game.score}","${date}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `resultats_champs_lexicaux_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Initialisation
    window.addEventListener("load", ()=>{
      buildBank();
      renderCard();
      if(!('speechSynthesis' in window)){
        message.innerHTML = "‚ÑπÔ∏è La synth√®se vocale n'est pas disponible sur ce navigateur.";
      }
      
      // Charger les donn√©es admin au d√©marrage
      loadGamesData();
    });
  </script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</body>
</html>