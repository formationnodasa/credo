<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application de Dictée - Perfectionnement</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow-x: hidden;
            min-height: 100vh;
        }

        #galaxy-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #0a0a2a, #1a1a4a, #2a2a6a);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1, h2, h3 {
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        #player-name {
            padding: 12px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            width: 300px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .mode-selection {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }

        .mode-selection.active {
            display: flex;
        }

        .mode-btn {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            min-width: 200px;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }

        .mode-btn.disabled {
            background: linear-gradient(45deg, #666, #999);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .mode-btn.disabled:hover {
            transform: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .start-btn-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #start-btn {
            background: linear-gradient(45deg, #00b09b, #96c93d);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }

        #start-btn:disabled {
            background: linear-gradient(45deg, #666, #999);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .btn {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
        }

        .btn:disabled {
            background: linear-gradient(45deg, #666, #999);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .menu-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .dictation-container, .results-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .text-display {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            min-height: 150px;
            margin: 15px 0;
            line-height: 1.6;
            font-size: 1.1rem;
        }

        #user-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            resize: vertical;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            margin: 15px 0;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .stats p {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .history-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            max-height: 500px;
            overflow-y: auto;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }

        .calendar-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
        }

        .motivation {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .motivation p {
            margin-bottom: 10px;
        }

        .error {
            background-color: rgba(255, 0, 0, 0.3);
            text-decoration: underline;
            text-decoration-color: red;
        }

        .reading-status {
            text-align: center;
            margin: 10px 0;
            font-style: italic;
            color: #ffa726;
        }

        .current-sentence {
            background: rgba(255, 215, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid gold;
        }

        .timer-container {
            text-align: center;
            margin: 15px 0;
            font-size: 1.2rem;
        }

        #countdown-timer {
            font-weight: bold;
            color: #ffa726;
            font-size: 1.4rem;
        }

        /* Animation des étoiles */
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 5s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        /* Styles pour le calendrier */
        .calendar {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            position: relative;
        }
        .calendar-day.today {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid gold;
        }
        .calendar-day.practiced {
            background: rgba(0, 255, 0, 0.2);
        }
        .calendar-day.empty {
            background: transparent;
        }
        .practice-indicator {
            font-size: 0.7rem;
            color: gold;
            margin-top: 2px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .mode-selection {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div id="galaxy-background"></div>
    
    <div class="container">
        <!-- Écran d'accueil -->
        <div id="welcome-screen" class="screen active">
            <h1>Application de Dictée</h1>
            <div class="player-info">
                <input type="text" id="player-name" placeholder="Entrez votre nom">
                <div class="start-btn-container">
                    <button id="start-btn" disabled>Commencer</button>
                </div>
            </div>
            <div class="mode-selection">
                <button id="initiation-btn" class="mode-btn">Mode Initiation</button>
                <button id="bible-btn" class="mode-btn disabled">Mode Bible (Bientôt)</button>
            </div>
            <div class="menu-buttons">
                <button id="history-btn" class="btn">Historique</button>
                <button id="calendar-btn" class="btn">Calendrier</button>
            </div>
        </div>

        <!-- Écran de dictée -->
        <div id="dictation-screen" class="screen">
            <div class="header">
                <h2>Dictée en cours - <span id="current-mode">Initiation</span></h2>
                <div class="player-display">Joueur: <span id="current-player"></span></div>
            </div>
            
            <div class="dictation-container">
                <div class="section">
                    <h3>Écoutez attentivement :</h3>
                    <div id="text-to-dictate" class="text-display"></div>
                    <div id="current-sentence" class="current-sentence"></div>
                    <div id="reading-status" class="reading-status"></div>
                    <div class="action-buttons">
                        <button id="play-dictation" class="btn">Lire la dictée</button>
                        <button id="stop-dictation" class="btn secondary" disabled>Arrêter</button>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Écrivez votre dictée :</h3>
                    <textarea id="user-input" placeholder="Écrivez votre texte ici..." disabled></textarea>
                    <div id="timer-container" class="timer-container" style="display: none;">
                        <p>Temps restant pour soumettre : <span id="countdown-timer">20</span> secondes</p>
                    </div>
                    <button id="submit-dictation" class="btn" disabled>Soumettre</button>
                </div>
            </div>
            
            <button id="back-to-menu" class="btn secondary">Retour au menu</button>
        </div>

        <!-- Écran de correction -->
        <div id="correction-screen" class="screen">
            <div class="header">
                <h2>Résultats de la dictée</h2>
                <div class="score-display">Score: <span id="score-value">0</span>%</div>
            </div>
            
            <div class="results-container">
                <div class="section">
                    <h3>Votre texte avec les erreurs :</h3>
                    <div id="user-text-with-errors" class="text-display"></div>
                </div>
                
                <div class="section">
                    <h3>Texte correct :</h3>
                    <div id="correct-text" class="text-display"></div>
                </div>
                
                <div class="stats">
                    <p>Nombre total de mots: <span id="total-words">0</span></p>
                    <p>Nombre d'erreurs: <span id="error-count">0</span></p>
                    <p>Score: <span id="final-score">0</span>%</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="new-dictation" class="btn">Nouvelle dictée</button>
                <button id="back-to-menu-2" class="btn secondary">Retour au menu</button>
            </div>
        </div>

        <!-- Écran historique -->
        <div id="history-screen" class="screen">
            <div class="header">
                <h2>Historique des scores - <span id="history-player-name"></span></h2>
                <button id="back-from-history" class="btn secondary">Retour</button>
            </div>
            <div id="history-list" class="history-container"></div>
        </div>

        <!-- Écran calendrier -->
        <div id="calendar-screen" class="screen">
            <div class="header">
                <h2>Calendrier d'entraînement</h2>
                <button id="back-from-calendar" class="btn secondary">Retour</button>
            </div>
            <div class="calendar-container">
                <div class="motivation">
                    <p>Pour progresser, pratiquez une dictée chaque jour du lundi au vendredi !</p>
                    <p>Cela ne prend que 5 minutes par jour.</p>
                </div>
                <div id="calendar-display"></div>
            </div>
        </div>
    </div>

    <script>
        // Données de l'application
        const appData = {
            playerName: '',
            currentMode: 'initiation',
            dictationText: '',
            currentParagraphs: [],
            userInput: '',
            history: JSON.parse(localStorage.getItem('dictationHistory')) || {},
            isReading: false,
            currentUtterance: null,
            currentChunkIndex: 0,
            dictationChunks: [],
            countdownTimer: null,
            countdownSeconds: 20,
            currentReadingPhase: 0, // 0: première lecture, 1: deuxième lecture, 2: troisième lecture
            dictationBook: `La rapidité avec laquelle les groupes KA (Kizito-Anuarite) se sont multipliés à Kinshasa, à travers tout le Congo jusqu'aux villages éloignés, et même en dehors du pays, prouve qu'il était urgent de présenter aux enfants et pré-adolescents africains un programme d'éducation chrétienne.
L'originalité de cette éducation KA est de présenter, non une série de leçons, mais des MODELES capables d'entraîner l'esprit, le cœur, l'enthousiasme de nos jeunes dans un cadre initiatique qui leur est familier. Nous avons une chance fantastique, une grâce même, d'avoir des modèles si proches tels que les MARTYRS DE L'OUGANDA et ANUARITE du Congo.
Beaucoup de communautés chrétiennes dans le monde pourraient nous envier cette grâce. Mais en profitons-nous assez?
Une expérience de 18 ans nous permet de constater la fiabilité de cette méthode initiatique, mais... prenons bien garde! Nous risquons de souffrir d'un enlisement dangereux. Si les encadreurs n'imitent plus ceux dont ils portent le nom, et si nous n'actualisons pas nos méthodes, l'œuvre si bien commencée existera-t-elle encore dans 10 ans?
Ainsi, les K.A. parlent toujours de "voyages". Et il nous faut tenir au sens des voyages qu'ils font en tant qu'étapes de leur formation. Leur voyage ne signifie pas une simple période au bout de laquelle on déclare que le voyage est terminé. Il ne faut donc pas penser que la formation K.A. se termine avec la fin du 4e voyage ou étape.
Tout le monde sait que pour faire un voyage, il faut, dès le départ, en connaître la destination et ensuite prendre le chemin qui y conduit. C'est ainsi qu'en revivant les étapes de la vie de nos Saints Patrons, et en nous inspirant des slogans des voyages, nous pouvons fixer les destinations de la manière, suivante:
1er voyage: Etape de la mise en pratique de notre vie chrétienne.
2e voyage: Etape d'approfondissement de notre Foi et de son rayonnement par une Bonté plus sincère.
3e voyage: Etape du témoignage évangélique contre les antivaleurs de ce monde et qui menacent notre société.
4e voyage: Etape de l'orientation de notre vie sur le chemin de la vérité afin de réaliser la Vocation par laquelle Dieu nous conduit.
De cette manière, on crée un ESPRIT K.A., qui vaut encore à 20 ans, à 30 ans, et même au delà.
Félicitons l'auteur de ce volume qui a bien voulu refondre l'inspiration première de l'initiation K.A., sous une forme et un langage plus adaptés à notre milieu socio-culturel.
Félicitons aussi tous ceux qui ont apporté leur concours à la rédaction de cet ouvrage ainsi que tous ceux qui accepteront de consacrer leur temps et leurs talents à enrichir l'œuvre K.A. de jour en jour.`
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            createGalaxy();
            initializeEventListeners();
            generateCalendar();
        });

        // Création de l'animation galaxie
        function createGalaxy() {
            const galaxy = document.getElementById('galaxy-background');
            const starCount = 200;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // Taille aléatoire
                const size = Math.random() * 3;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                
                // Position aléatoire
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                
                // Animation avec délai aléatoire
                star.style.animationDelay = `${Math.random() * 5}s`;
                
                galaxy.appendChild(star);
            }
        }

        // Initialisation des écouteurs d'événements
        function initializeEventListeners() {
            // Activation du bouton Commencer quand un nom est saisi
            document.getElementById('player-name').addEventListener('input', function() {
                const startBtn = document.getElementById('start-btn');
                startBtn.disabled = this.value.trim() === '';
            });

            // Bouton Commencer
            document.getElementById('start-btn').addEventListener('click', function() {
                document.querySelector('.mode-selection').classList.add('active');
                this.style.display = 'none';
            });

            // Boutons de mode
            document.getElementById('initiation-btn').addEventListener('click', () => startDictation('initiation'));
            document.getElementById('bible-btn').addEventListener('click', () => {
                alert('Le mode Bible sera disponible prochainement !');
            });

            // Boutons de navigation
            document.getElementById('history-btn').addEventListener('click', showHistory);
            document.getElementById('calendar-btn').addEventListener('click', showCalendar);
            document.getElementById('back-to-menu').addEventListener('click', showWelcomeScreen);
            document.getElementById('back-to-menu-2').addEventListener('click', showWelcomeScreen);
            document.getElementById('back-from-history').addEventListener('click', showWelcomeScreen);
            document.getElementById('back-from-calendar').addEventListener('click', showWelcomeScreen);
            
            // Boutons de dictée
            document.getElementById('play-dictation').addEventListener('click', playDictation);
            document.getElementById('stop-dictation').addEventListener('click', stopDictation);
            document.getElementById('submit-dictation').addEventListener('click', submitDictation);
            document.getElementById('new-dictation').addEventListener('click', () => startDictation(appData.currentMode));
        }

        // Navigation entre les écrans
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showWelcomeScreen() {
            // Arrêter toute lecture en cours
            stopDictation();
            // Arrêter le chronomètre
            stopCountdown();
            // Réinitialiser l'interface d'accueil
            document.querySelector('.mode-selection').classList.remove('active');
            document.getElementById('start-btn').style.display = 'block';
            showScreen('welcome-screen');
        }

        function showHistory() {
            const playerName = document.getElementById('player-name').value.trim() || 'Invité';
            document.getElementById('history-player-name').textContent = playerName;
            updateHistoryDisplay();
            showScreen('history-screen');
        }

        function showCalendar() {
            showScreen('calendar-screen');
        }

        // Sélection aléatoire des paragraphes
        function selectRandomParagraphs() {
            const paragraphs = appData.dictationBook.split('\n').filter(p => p.trim().length > 0);
            const totalParagraphs = paragraphs.length;
            
            // Choisir entre 3 et 5 paragraphes selon la longueur
            let numParagraphs;
            const avgLength = paragraphs.reduce((sum, p) => sum + p.length, 0) / totalParagraphs;
            
            if (avgLength > 200) {
                numParagraphs = 3; // Textes longs : 3 paragraphes
            } else {
                numParagraphs = 5; // Textes courts : 5 paragraphes
            }
            
            // Sélectionner des paragraphes aléatoires
            const selected = [];
            const usedIndices = new Set();
            
            while (selected.length < numParagraphs && selected.length < totalParagraphs) {
                const randomIndex = Math.floor(Math.random() * totalParagraphs);
                if (!usedIndices.has(randomIndex)) {
                    selected.push(paragraphs[randomIndex]);
                    usedIndices.add(randomIndex);
                }
            }
            
            return selected;
        }

        // Préparer le texte pour la PREMIÈRE LECTURE (lente)
        function prepareTextForFirstReading(text) {
            const chunks = [];
            
            // Instruction de début
            chunks.push("Première lecture, écoutez attentivement");
            chunks.push("PAUSE_LONGUE");
            
            // Séparer le texte en phrases
            const sentences = text.split(/(?<=[.!?])\s+/);
            
            for (let sentence of sentences) {
                if (sentence.trim()) {
                    chunks.push(sentence.trim());
                    // Pause d'une seconde après chaque point
                    if (sentence.trim().endsWith('.')) {
                        chunks.push("PAUSE_COURTE");
                    }
                }
            }
            
            return chunks.filter(chunk => chunk !== '');
        }

        // Préparer le texte pour la DEUXIÈME LECTURE (lente avec toutes les ponctuations)
        function prepareTextForSecondReading(text) {
            const chunks = [];
            
            // Instruction de début
            chunks.push("Deuxième lecture, écrivez maintenant");
            chunks.push("PAUSE_LONGUE");
            
            // Traiter chaque phrase avec prononciation des ponctuations
            const sentences = text.split(/(?<=[.!?])\s+/);
            
            for (let sentence of sentences) {
                if (sentence.trim()) {
                    // Remplacer les ponctuations par leur prononciation
                    let processedSentence = sentence
                        .replace(/\(/g, ' parenthèse ouverte ')
                        .replace(/\)/g, ' parenthèse fermée ')
                        .replace(/,/g, ' virgule ')
                        .replace(/;/g, ' point-virgule ')
                        .replace(/:/g, ' deux-points ')
                        .replace(/!/g, ' point d exclamation ')
                        .replace(/\?/g, ' point d interrogation ')
                        .replace(/\./g, ' point ');
                    
                    chunks.push(processedSentence.trim());
                    
                    // Pause après chaque phrase
                    chunks.push("PAUSE_LONGUE");
                }
            }
            
            return chunks.filter(chunk => chunk !== '');
        }

        // Préparer le texte pour la TROISIÈME LECTURE (normale pour correction)
        function prepareTextForThirdReading(text) {
            const chunks = [];
            
            // Instruction de début
            chunks.push("Dernière lecture pour corriger vos erreurs");
            chunks.push("PAUSE_LONGUE");
            
            // Lecture avec toutes les ponctuations prononcées
            const sentences = text.split(/(?<=[.!?])\s+/);
            
            for (let sentence of sentences) {
                if (sentence.trim()) {
                    // Remplacer les ponctuations par leur prononciation
                    let processedSentence = sentence
                        .replace(/\(/g, ' parenthèse ouverte ')
                        .replace(/\)/g, ' parenthèse fermée ')
                        .replace(/,/g, ' virgule ')
                        .replace(/;/g, ' point-virgule ')
                        .replace(/:/g, ' deux-points ')
                        .replace(/!/g, ' point d exclamation ')
                        .replace(/\?/g, ' point d interrogation ')
                        .replace(/\./g, ' point ');
                    
                    chunks.push(processedSentence.trim());
                    
                    // Pause d'une seconde après chaque point
                    if (sentence.trim().endsWith('.')) {
                        chunks.push("PAUSE_COURTE");
                    }
                }
            }
            
            return chunks.filter(chunk => chunk !== '');
        }

        // Démarrer une nouvelle dictée
        function startDictation(mode) {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                alert('Veuillez entrer votre nom');
                return;
            }
            
            appData.playerName = playerName;
            appData.currentMode = mode;
            appData.currentParagraphs = selectRandomParagraphs();
            appData.dictationText = appData.currentParagraphs.join('\n\n');
            appData.currentReadingPhase = 0; // Commencer par la première lecture
            
            document.getElementById('current-player').textContent = playerName;
            document.getElementById('current-mode').textContent = mode === 'initiation' ? 'Initiation' : 'Bible';
            document.getElementById('text-to-dictate').textContent = appData.dictationText;
            document.getElementById('user-input').value = '';
            document.getElementById('user-input').disabled = true;
            document.getElementById('reading-status').textContent = '';
            document.getElementById('current-sentence').textContent = '';
            document.getElementById('play-dictation').disabled = false;
            document.getElementById('stop-dictation').disabled = true;
            document.getElementById('submit-dictation').disabled = true;
            document.getElementById('timer-container').style.display = 'none';
            document.getElementById('play-dictation').textContent = 'Première lecture';
            
            showScreen('dictation-screen');
        }

        // Lecture de la dictée
        function playDictation() {
            if (!appData.dictationText || appData.isReading) return;
            
            // Utiliser la synthèse vocale du navigateur
            if ('speechSynthesis' in window) {
                appData.isReading = true;
                document.getElementById('play-dictation').disabled = true;
                document.getElementById('stop-dictation').disabled = false;
                
                // Préparer le texte selon la phase de lecture
                switch(appData.currentReadingPhase) {
                    case 0: // Première lecture
                        appData.dictationChunks = prepareTextForFirstReading(appData.dictationText);
                        document.getElementById('reading-status').textContent = 'Première lecture - Écoutez attentivement';
                        break;
                    case 1: // Deuxième lecture
                        appData.dictationChunks = prepareTextForSecondReading(appData.dictationText);
                        document.getElementById('reading-status').textContent = 'Deuxième lecture - Écrivez maintenant';
                        break;
                    case 2: // Troisième lecture
                        appData.dictationChunks = prepareTextForThirdReading(appData.dictationText);
                        document.getElementById('reading-status').textContent = 'Dernière lecture - Correction';
                        break;
                }
                
                appData.currentChunkIndex = 0;
                readNextChunk();
            } else {
                alert('La synthèse vocale n\'est pas supportée par votre navigateur. Veuillez lire le texte affiché.');
            }
        }

        // Lecture du chunk suivant
        function readNextChunk() {
            if (appData.currentChunkIndex >= appData.dictationChunks.length || !appData.isReading) {
                // Fin de la lecture actuelle
                appData.isReading = false;
                document.getElementById('play-dictation').disabled = false;
                document.getElementById('stop-dictation').disabled = true;
                document.getElementById('current-sentence').textContent = '';
                
                // Gérer la transition entre les phases
                if (appData.currentReadingPhase === 0) {
                    // Fin de la première lecture, passer à la deuxième après 5 secondes
                    appData.currentReadingPhase = 1;
                    document.getElementById('reading-status').textContent = 'Première lecture terminée - Deuxième lecture dans 5 secondes';
                    
                    setTimeout(() => {
                        document.getElementById('play-dictation').textContent = 'Deuxième lecture';
                        document.getElementById('reading-status').textContent = 'Prêt pour la deuxième lecture - Le clavier est activé';
                        // Activer le textarea et donner le focus
                        document.getElementById('user-input').disabled = false;
                        document.getElementById('user-input').focus();
                    }, 5000);
                    
                } else if (appData.currentReadingPhase === 1) {
                    // Fin de la deuxième lecture, activer la soumission
                    appData.currentReadingPhase = 2;
                    document.getElementById('reading-status').textContent = 'Deuxième lecture terminée - Vous pouvez continuer à écrire';
                    document.getElementById('play-dictation').textContent = 'Dernière lecture';
                    document.getElementById('submit-dictation').disabled = false;
                } else if (appData.currentReadingPhase === 2) {
                    // Fin de la troisième lecture, démarrer le chronomètre
                    document.getElementById('reading-status').textContent = 'Dernière lecture terminée - Soumettez votre dictée';
                    startCountdown();
                }
                
                return;
            }
            
            const chunk = appData.dictationChunks[appData.currentChunkIndex];
            
            // Afficher le statut selon la phase
            let phaseText = '';
            switch(appData.currentReadingPhase) {
                case 0: phaseText = 'Première lecture'; break;
                case 1: phaseText = 'Deuxième lecture'; break;
                case 2: phaseText = 'Dernière lecture'; break;
            }
            document.getElementById('reading-status').textContent = `${phaseText}... (${appData.currentChunkIndex + 1}/${appData.dictationChunks.length})`;
            
            if (chunk === 'PAUSE_LONGUE' || chunk === 'PAUSE_COURTE') {
                // Pause
                const pauseDuration = chunk === 'PAUSE_LONGUE' ? 2000 : 1000; // 2 secondes pour PAUSE_LONGUE, 1 seconde pour PAUSE_COURTE
                document.getElementById('current-sentence').textContent = '...';
                
                setTimeout(() => {
                    if (appData.isReading) {
                        appData.currentChunkIndex++;
                        readNextChunk();
                    }
                }, pauseDuration);
            } else {
                // Lecture du texte
                document.getElementById('current-sentence').textContent = chunk;
                
                const utterance = new SpeechSynthesisUtterance(chunk);
                utterance.lang = 'fr-FR';
                
                // Ajuster la vitesse selon la phase - TOUTES les lectures sont lentes maintenant
                utterance.rate = 0.7; // Vitesse lente pour toutes les lectures
                utterance.pitch = 1;
                utterance.volume = 1;
                
                utterance.onend = function() {
                    if (appData.isReading) {
                        appData.currentChunkIndex++;
                        readNextChunk();
                    }
                };
                
                utterance.onerror = function(event) {
                    console.error('Erreur de synthèse vocale:', event);
                    appData.isReading = false;
                    document.getElementById('play-dictation').disabled = false;
                    document.getElementById('stop-dictation').disabled = true;
                    document.getElementById('reading-status').textContent = 'Erreur de lecture';
                    document.getElementById('current-sentence').textContent = '';
                };
                
                // Annuler toute lecture en cours avant de démarrer une nouvelle
                speechSynthesis.cancel();
                speechSynthesis.speak(utterance);
                appData.currentUtterance = utterance;
            }
        }

        // Arrêter la lecture
        function stopDictation() {
            speechSynthesis.cancel();
            appData.isReading = false;
            appData.currentChunkIndex = 0;
            document.getElementById('play-dictation').disabled = false;
            document.getElementById('stop-dictation').disabled = true;
            document.getElementById('reading-status').textContent = 'Lecture arrêtée';
            document.getElementById('current-sentence').textContent = '';
        }

        // Démarrer le compte à rebours
        function startCountdown() {
            appData.countdownSeconds = 20;
            document.getElementById('timer-container').style.display = 'block';
            document.getElementById('countdown-timer').textContent = appData.countdownSeconds;
            
            appData.countdownTimer = setInterval(function() {
                appData.countdownSeconds--;
                document.getElementById('countdown-timer').textContent = appData.countdownSeconds;
                
                if (appData.countdownSeconds <= 0) {
                    stopCountdown();
                    submitDictation();
                }
            }, 1000);
        }

        // Arrêter le compte à rebours
        function stopCountdown() {
            if (appData.countdownTimer) {
                clearInterval(appData.countdownTimer);
                appData.countdownTimer = null;
            }
            document.getElementById('timer-container').style.display = 'none';
        }

        // Soumission de la dictée
        function submitDictation() {
            const userInput = document.getElementById('user-input').value.trim();
            if (!userInput) {
                alert('Veuillez écrire votre dictée avant de soumettre');
                return;
            }
            
            // Arrêter la lecture si elle est en cours
            stopDictation();
            // Arrêter le chronomètre
            stopCountdown();
            
            appData.userInput = userInput;
            correctDictation();
        }

        // Correction de la dictée
        function correctDictation() {
            const originalText = appData.dictationText;
            const userText = appData.userInput;
            
            // Préparation des textes pour comparaison
            const originalWords = originalText.toLowerCase().replace(/[.,!?;:]/g, '').split(/\s+/);
            const userWords = userText.toLowerCase().replace(/[.,!?;:]/g, '').split(/\s+/);
            
            // Calcul du score
            const totalWords = originalWords.length;
            let errorCount = 0;
            
            // Comparaison mot par mot
            const maxLength = Math.max(originalWords.length, userWords.length);
            let userTextWithErrors = '';
            let correctTextDisplay = '';
            
            for (let i = 0; i < maxLength; i++) {
                const originalWord = originalWords[i] || '';
                const userWord = userWords[i] || '';
                
                if (originalWord !== userWord) {
                    errorCount++;
                    userTextWithErrors += `<span class="error">${userWord || '[manquant]'}</span> `;
                } else {
                    userTextWithErrors += `${userWord} `;
                }
                
                correctTextDisplay += `${originalWord} `;
            }
            
            // Calcul du score en pourcentage
            const score = Math.max(0, ((totalWords - errorCount) / totalWords) * 100);
            
            // Affichage des résultats
            document.getElementById('user-text-with-errors').innerHTML = userTextWithErrors;
            document.getElementById('correct-text').textContent = correctTextDisplay;
            document.getElementById('total-words').textContent = totalWords;
            document.getElementById('error-count').textContent = errorCount;
            document.getElementById('final-score').textContent = score.toFixed(1);
            document.getElementById('score-value').textContent = score.toFixed(1);
            
            // Sauvegarde dans l'historique
            saveToHistory(score, errorCount, totalWords);
            
            showScreen('correction-screen');
        }

        // Sauvegarde dans l'historique
        function saveToHistory(score, errors, totalWords) {
            const playerName = appData.playerName;
            
            // Initialiser l'historique du joueur s'il n'existe pas
            if (!appData.history[playerName]) {
                appData.history[playerName] = [];
            }
            
            const historyEntry = {
                date: new Date().toLocaleDateString('fr-FR'),
                player: playerName,
                score: score,
                errors: errors,
                totalWords: totalWords,
                mode: appData.currentMode
            };
            
            appData.history[playerName].unshift(historyEntry);
            
            // Garder seulement les 20 dernières entrées par joueur
            if (appData.history[playerName].length > 20) {
                appData.history[playerName] = appData.history[playerName].slice(0, 20);
            }
            
            // Sauvegarde dans le localStorage
            localStorage.setItem('dictationHistory', JSON.stringify(appData.history));
            
            updateHistoryDisplay();
        }

        // Mise à jour de l'affichage de l'historique
        function updateHistoryDisplay() {
            const historyList = document.getElementById('history-list');
            const playerName = document.getElementById('player-name').value.trim() || 'Invité';
            
            historyList.innerHTML = '';
            
            if (!appData.history[playerName] || appData.history[playerName].length === 0) {
                historyList.innerHTML = '<p>Aucun historique pour le moment.</p>';
                return;
            }
            
            appData.history[playerName].forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>
                        <strong>${entry.date}</strong> - ${entry.mode}
                    </div>
                    <div>
                        Score: ${entry.score.toFixed(1)}% (${entry.errors} erreurs / ${entry.totalWords} mots)
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // Génération du calendrier
        function generateCalendar() {
            const calendarDisplay = document.getElementById('calendar-display');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Premier jour du mois
            const firstDay = new Date(currentYear, currentMonth, 1);
            // Dernier jour du mois
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            
            let calendarHTML = '<div class="calendar">';
            calendarHTML += `<h3>${firstDay.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</h3>`;
            calendarHTML += '<div class="calendar-grid">';
            
            // Jours de la semaine
            const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            days.forEach(day => {
                calendarHTML += `<div class="calendar-header">${day}</div>`;
            });
            
            // Cases vides avant le premier jour
            const firstDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Ajustement pour lundi=0
            for (let i = 0; i < firstDayOfWeek; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }
            
            // Jours du mois
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayOfWeek = date.getDay();
                const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5; // Lundi à vendredi
                const isToday = date.toDateString() === today.toDateString();
                const playerName = document.getElementById('player-name').value.trim() || 'Invité';
                const hasPractice = appData.history[playerName] && 
                    appData.history[playerName].some(entry => 
                        entry.date === date.toLocaleDateString('fr-FR')
                    );
                
                let dayClass = 'calendar-day';
                if (isToday) dayClass += ' today';
                if (hasPractice) dayClass += ' practiced';
                
                calendarHTML += `<div class="${dayClass}">`;
                calendarHTML += `<span>${day}</span>`;
                if (isWeekday) {
                    calendarHTML += '<div class="practice-indicator">★</div>';
                }
                calendarHTML += '</div>';
            }
            
            calendarHTML += '</div></div>';
            calendarDisplay.innerHTML = calendarHTML;
        }
    </script>
</body>
</html>