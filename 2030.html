<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0"
/>
<title>Épilation Biblique – Entraînement & Concours</title>
<style>
  :root{
    --bg:#faf6f0;
    --ink:#333;
    --brand:#734f2f;
    --accent:#d4a574;
    --card:#fff;
    --line:#e7dfd8;
    --good:#1f7a1f;
    --bad:#b1002e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Poppins", sans-serif;
    background:var(--bg);
    color:var(--ink);
  }

  /* Header / Logo */
  header{
    background:var(--brand);
    color:#fff;
    padding:18px 16px;
  }
  .logo{
    display:inline-block;
    background:rgba(255,255,255,.08);
    padding:10px 18px;
    border-radius:40px;
    font-weight:700;
    letter-spacing:.3px;
    box-shadow:0 4px 10px rgba(0,0,0,.2);
  }
  .logo .accent{ color:#f3d4a2; }

  /* Nav tabs */
  nav{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    padding:12px 16px;
    border-bottom:1px solid var(--line);
    background:#fffaf4;
  }
  nav button{
    border:1px solid var(--line);
    background:#fff;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
  }
  nav button.active{
    background:var(--brand);
    color:#fff;
    border-color:var(--brand);
  }

  main{ padding:16px; }

  /* Cards / lists */
  .tools{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:12px;
  }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
  }
  .word{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 12px;
    border-bottom:1px dashed var(--line);
  }
  .word:last-child{ border-bottom:none }
  .word b{ font-size:1.05rem; }
  .word button{
    background:var(--accent);
    color:#fff;
    border:none;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
  }

  .controls{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  input[type="text"], select{
    padding:8px 10px;
    border:1px solid #bbb;
    border-radius:8px;
    background:#fff;
  }
  .pager{
    display:flex; gap:8px; align-items:center; justify-content:center; margin-top:12px;
  }
  .pager button{
    border:1px solid var(--line);
    background:#fff;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
  }
  .small{ font-size:.9rem; color:#666 }

  /* Train */
  .train{
    display:grid;
    gap:12px;
    grid-template-columns:1fr;
    max-width:720px;
  }
  .inline{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .cta{
    background:var(--brand);
    color:#fff;
    border:none;
    border-radius:10px;
    padding:10px 14px;
    cursor:pointer;
  }
  .ghost{
    background:#fff; color:var(--brand);
    border:1px solid var(--brand);
  }
  .result{ font-weight:700; }
  .result.good{ color:var(--good) }
  .result.bad{ color:var(--bad) }

  /* Contest */
  .contest-grid{
    display:grid; gap:12px; grid-template-columns:1fr;
    max-width:820px;
  }
  progress{ width:100%; height:16px; }
  .score-pill{
    display:inline-block; background:#fff; border:1px solid var(--line);
    border-radius:999px; padding:6px 10px; font-weight:600;
  }

  /* Stats */
  .stats{
    display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px;
  }
  .kpi{
    border-left:6px solid var(--brand);
  }
  .table{
    width:100%; border-collapse:collapse;
  }
  .table th, .table td{
    border-bottom:1px solid var(--line);
    padding:8px;
    text-align:left;
  }

  /* Verses */
  .verse{ padding:10px 0; border-bottom:1px dashed var(--line); }
  .verse:last-child{ border-bottom:none; }

  footer{
    padding:20px; text-align:center; color:#888; font-size:.9rem;
  }

  @media (min-width:900px){
    .layout{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:16px;
      align-items:start;
    }
  }
</style>
</head>
<body>
  <header>
    <div class="logo">📖 <span class="accent">Épilation</span> Biblique 🔊</div>
  </header>

  <nav>
    <button class="tabBtn active" data-tab="bibli">🔤 Bibliothèque</button>
    <button class="tabBtn" data-tab="train">🎯 Entraînement</button>
    <button class="tabBtn" data-tab="contest">⏱️ Mini-concours</button>
    <button class="tabBtn" data-tab="stats">📈 Suivi</button>
    <button class="tabBtn" data-tab="verses">📚 Versets clés</button>
  </nav>

  <main>
    <!-- Bibliothèque -->
    <section id="bibli" class="tab">
      <div class="tools">
        <div class="controls card">
          <b>Filtrer :</b>
          <input type="text" id="searchInput" placeholder="Rechercher un mot..." />
          <select id="pageSize">
            <option value="10" selected>10 / page</option>
            <option value="20">20 / page</option>
            <option value="50">50 / page</option>
          </select>
          <button id="clearSearch" class="ghost">Effacer</button>
        </div>
      </div>

      <div class="layout">
        <div class="card" id="wordList"></div>

        <div class="card">
          <h3>ℹ️ Astuces</h3>
          <ul>
            <li>Clique 🔊 pour écouter la prononciation (synthèse vocale).</li>
            <li>Utilise la recherche pour cibler un mot compliqué.</li>
            <li>La pagination affiche 10 mots par page (modifiable).</li>
            <li>Ajoute des favoris : ✅ pour “maîtrisé”, 🕓 pour “à revoir”.</li>
          </ul>
          <div class="pager" id="pager"></div>
        </div>
      </div>
    </section>

    <!-- Entraînement -->
    <section id="train" class="tab" style="display:none">
      <div class="train">
        <div class="card">
          <h3>🎧 Écoute & répète</h3>
          <div class="inline">
            <button class="cta" id="playWord">🔊 Écouter</button>
            <button class="cta ghost" id="replayWord">↻ Rejouer</button>
            <span class="small" id="currentTarget">Mot ciblé : <i>—</i></span>
          </div>
          <div class="inline" style="margin-top:8px">
            <input type="text" id="trainInput" placeholder="Tape le mot entendu..." />
            <button class="cta" id="checkTrain">Vérifier</button>
            <span id="trainResult" class="result"></span>
          </div>
        </div>

        <div class="card">
          <h3>⚙️ Options d’entraînement</h3>
          <div class="inline">
            <label>Source des mots :</label>
            <select id="trainPool">
              <option value="all" selected>Tous les mots</option>
              <option value="review">À revoir seulement</option>
              <option value="mastered">Maîtrisés</option>
            </select>
            <button class="ghost" id="nextWord">⏭️ Mot suivant</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Mini-concours -->
    <section id="contest" class="tab" style="display:none">
      <div class="contest-grid">
        <div class="card">
          <h3>⏱️ Mini-concours</h3>
          <div class="inline">
            <label>Nombre de mots :</label>
            <select id="contestCount">
              <option value="10" selected>10</option>
              <option value="20">20</option>
            </select>
            <button class="cta" id="startContest">Démarrer</button>
            <span class="score-pill">⏳ Temps : <span id="timer">00:00</span></span>
            <span class="score-pill">✅ <span id="contestGood">0</span> | ❌ <span id="contestBad">0</span></span>
          </div>

          <div id="contestZone" style="margin-top:12px; display:none">
            <div class="inline">
              <button class="cta" id="contestPlay">🔊 Écouter</button>
              <button class="cta ghost" id="contestReplay">↻ Rejouer</button>
              <span class="small" id="contestProgress">1 / 10</span>
            </div>
            <div class="inline" style="margin-top:8px">
              <input type="text" id="contestInput" placeholder="Tape le mot entendu..." />
              <button class="cta" id="contestCheck">Vérifier</button>
              <span id="contestResult" class="result"></span>
            </div>
            <progress id="contestBar" value="0" max="100"></progress>
          </div>

          <div id="contestEnd" class="card" style="display:none; margin-top:12px; background:#fdf7ee">
            <h3>🏁 Résultats</h3>
            <p><b>Score :</b> <span id="finalScore">0</span>/<span id="finalTotal">0</span> — <b>Temps :</b> <span id="finalTime">00:00</span></p>
            <button class="cta" id="retryContest">Rejouer</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Suivi -->
    <section id="stats" class="tab" style="display:none">
      <div class="stats">
        <div class="card kpi">
          <h3>📊 Taux de réussite global</h3>
          <p style="font-size:1.6rem; margin:.2rem 0" id="kpiRate">—%</p>
          <p class="small">Basé sur toutes tes vérifications.</p>
        </div>
        <div class="card kpi">
          <h3>✅ Mots maîtrisés</h3>
          <p style="font-size:1.6rem; margin:.2rem 0" id="kpiMastered">0</p>
          <p class="small">Correct ≥ 3 fois de suite.</p>
        </div>
        <div class="card kpi">
          <h3>🕓 À revoir</h3>
          <p style="font-size:1.6rem; margin:.2rem 0" id="kpiReview">0</p>
          <p class="small">Erreurs récentes.</p>
        </div>
      </div>

      <div class="card" style="margin-top:12px; overflow:auto">
        <h3>Détails par mot</h3>
        <table class="table" id="statsTable">
          <thead>
            <tr>
              <th>Mot</th>
              <th>✅ Correct</th>
              <th>❌ Incorrect</th>
              <th>État</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Versets clés -->
    <section id="verses" class="tab" style="display:none">
      <div class="layout">
        <div class="card">
          <h3>📚 Versets clés (exemples)</h3>
          <div id="verseList"></div>
        </div>
        <div class="card">
          <h3>➕ Ajouter un verset</h3>
          <div class="inline">
            <input type="text" id="vRef" placeholder="Réf. (ex: Genèse 1:1)" />
            <input type="text" id="vText" placeholder="Texte du verset..." style="flex:1" />
          </div>
          <div class="inline" style="margin-top:8px">
            <input type="text" id="vWords" placeholder="Mots difficiles (séparés par des virgules)" style="flex:1" />
            <button class="cta" id="addVerse">Ajouter</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>© Épilation Biblique – entraînement & concours</footer>

<script>
/* =========================
   Données : liste complète
   ========================= */
const WORDS = [
"Dodéka","Tsar","Yeshayahu","Iôannès","Shomrô","Tora","Pentateuchus","Biblos","Beréshit","Wayyiqra",
"Yahvé","Courdoyer","Boismard","Bemidbar","Debarîm","Patriarcarle","Figure","Sinaï","Tabernacle","Jéricho",
"Steppes de Moab","Cadène","Canaan","Les Madianites","Gad","Ruben","Transjordanie","Deutéronomique","Graf","Wellhausen",
"Yahviste","Élohiste","Proche-Orient","Décortiquer","Fragmentaire","Caïn-Qenâ’","Mériba","Décalogue","Osée","Salarié",
"Josias","Dessein","Homogène","Loi de sainteté","Assyriens","Ézéchias","Scribes","Naziréat","Protévangile","Israélite",
"Abîmé","Symétrique","Chaos","Semence","Verdure","Une bestiole","Chôma","Un flot","Glaise du sol","Jardin en Éden",
"Pishôn","Havila","Cornaline","Orient d’assur","Euphrate","Tunique","Glaive","Premiers-nés","Sol fertile","Pays de Nod",
"Hénok","Mehuyaël","Metushaël","Lamek","Ada","Çilla","Yabal","Yubal","La lyre","Du Chalumeau",
"Çilla","Tubal-caïn","Naama ( sœur de Tubal-Caïn )","Meurtrissure","Adam","Seth","Énosh","Qénân","Mahalaléel","Yéred",
"Sem","Cham","Japhet","Noé","Les Nephilim ( Genèse 6 : 4 )","Tu la feras en roseaux","Inondation","La décrue","Arche","Holocauste",
"Semailles et moissons","Froidure et chaleur","La terre fourmille","Pullulez sur la terre","La nuée","Gomer","Magog","Les mèdes","Yavân","Tubal",
"Moshek","Tiras","Ashkenaz","Riphat","Togarma","Élisha","Tarsis","Les Kittim ( sans S )","Les Dananéens","Kush",
"Miçrayim","Put","Séba","Havila","Sabta","Rama","Sabteka","Nemrod ( premier potentat sur la terre )","Babel","Érek",
"Akkad","Kalneth","Shinéar","Ashshur","Ninive","Rehobot-Ir","Kalah","Rèsèn","Lud de Anam","De Lehab",
"De Naphtuh","De patros","De Kasluh","De Kaphtor","Les philistins","Sidon","Hèt","Le Jesubéen","L’Amorite","Le Girgashite",
"Le Hivvite","L’Arqite","Le sinite","L’arvadite","Le Çemarite","Le Hamatite","Gérar","Gaza","Sodome","Gomorrhe",
"Adma","Çeboyim","Lésha","Éber","Élam","Arpakshad","Lud","Aram","Uç","Hul",
"Géter","Mash","Shélah","Péleg","Yoqtân","Almodad","Shéleph","Haçarmavet","Yérah","Hadoram",
"Uzal","Diqla","Obal","Abimaël","Sheba","Ophir","Havila","Yobab","Mesha","Sephar",
"Tour de Babel","Shinéar","Le bitume","Mortier","Shélah","Réu","Serug","Nahor","Térah","Abram ( fils de Térah Né Abram : le Père est exalté )",
"Abraham « père d'une multitude de nations »","Harân","Lot","Milka","Yiska","Saraï","Ur ou d’ur","Sichem","Chêne de Moré","Des chaldéens",
"Béthel à l’ouest","Aï à l’est","Négeb","Pharaon","Perizzites","Pâtres","Irriguée","Çoar","Aux chênes de Mambré","Hébron",
"Amraphel ( ancien roi de Shinéar)","D’Aryok ( roi d’Ellasar)","De Kedor-Laomer ( Roi d’Élam )","De Tidéal ( Roi des Goyim )","Béra","Birsha","Shinéab ( Roi d’Adma)","Shémeéber ( Roi de Çeboyim)","Çoar ( Béla )","Mer du sel",
"Les Zuzim à Ham","Les Émim dans la plaine","Les Patriarches","Rephaïm","Ashterot-Qarnayim","Qiryatayim","Les horites","Séïr","El-Parân","Amalécites",
"Les Amorites","Haçaçôn-Tamar","Adma","Vallée de siddim","Élam","Tidéal","Goyim","Un Rescapé","Eshkol","D’Aner",
"Hoba","Damas","Melchisédech","Vallée de Shavé","Shalem","Dieu très-haut","Courroie","Une tourterelle","Pigeonneau","Fleuve d’euphrate",
"Les Qénites","Les Qenizzites","Les Qadmonites","Les hittites","Les Perizzites","Les girgashites","Les jésubéens","Agar","Saraï","El-Roi",
"Onagre","Lahaï-Roï","Bérèd","Ismaël","El Shaddaï","Sara","Isaac","Mambré","Monseigneur","Kullah",
"Berlue","L’aurore","Soufre","Fournaise","Les Ammonites","Les Moabites","Moab","Ben-Ammi","Bené-Ammon","Gérar",
"Shur","Abimélek","Bersabée","Désert de Parân","Pikol","Troupeau","Moriyya","Bélier","Nahor","Buz",
"Qemuel","Késed","Hazo","Pildash","Yidlaph","Bétuel","Rébecca","Réuma","Tébah","Gaham",
"Tahash","Maaka","Qiryat-Arba","Gaham","Hèt","Hébétons","D’éphrôn ou Éphrôn","Makpéla","Désaltérer","Gîter",
"Laban","Myriades","Lahaï-roï","Qetura","Zimrân","Yoqshân","Sheba","Dedân","Les Ashshurites","Les Letushim",
"Les Lummim","Madiân","Épha","Épher","Hanok","Abida","Eldaa","Makpéla","Nebayot","Qédar",
"Adbéel","Mibsam","Mishma","Duma","Massa","Hadad","Téma","Têtue","Naphish","Qédma",
"Douars ( leurs douars)","Shur","Assyrie","Ésaü","L’Araméen de Paddân-Aram"
];

/* =========================
   État & persistance
   ========================= */
const STATE = {
  page: 1,
  pageSize: 10,
  search: "",
  ttsLang: "fr-FR",
  trainTarget: null,
  trainPool: "all",
  contest: {
    running:false, total:10, index:0, good:0, bad:0, start:0, elapsed:0, list:[]
  }
};

const STORAGE_KEY = "epilation_stats_v1"; // {word:{ok,ko,streak}}

/* Charger stats */
function loadStats(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
  }catch(e){ return {}; }
}
/* Sauver stats */
function saveStats(stats){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
}

/* =========================
   Utilitaires
   ========================= */
function speak(text, lang=STATE.ttsLang){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  speechSynthesis.cancel(); // stop any ongoing
  speechSynthesis.speak(u);
}
function fmtTime(ms){
  const s = Math.floor(ms/1000);
  const m = Math.floor(s/60).toString().padStart(2,"0");
  const ss = (s%60).toString().padStart(2,"0");
  return `${m}:${ss}`;
}
function paginate(arr, page, pageSize){
  const start = (page-1)*pageSize;
  return arr.slice(start, start+pageSize);
}
function applySearch(arr, q){
  if(!q) return arr;
  const s = q.toLowerCase();
  return arr.filter(w=>w.toLowerCase().includes(s));
}

/* =========================
   Bibliothèque (liste)
   ========================= */
const wordListDiv = document.getElementById("wordList");
const pagerDiv    = document.getElementById("pager");
const searchInput = document.getElementById("searchInput");
const clearSearch = document.getElementById("clearSearch");
const pageSizeSel = document.getElementById("pageSize");

function renderList(){
  const filtered = applySearch(WORDS, STATE.search);
  const totalPages = Math.max(1, Math.ceil(filtered.length / STATE.pageSize));
  if(STATE.page>totalPages) STATE.page = totalPages;

  const chunk = paginate(filtered, STATE.page, STATE.pageSize);
  wordListDiv.innerHTML = "";
  const stats = loadStats();

  chunk.forEach(word=>{
    const row = document.createElement("div");
    row.className = "word";
    const st = stats[word] || {ok:0,ko:0,streak:0};
    const badge = st.streak>=3 ? "✅" : (st.ko>st.ok ? "🕓" : "•");
    row.innerHTML = `
      <b>${word}</b>
      <span class="inline">
        <button data-word="${word}" class="speakBtn">🔊</button>
        <button data-word="${word}" class="markOk" title="Marquer maîtrisé">✅</button>
        <button data-word="${word}" class="markKo" title="Marquer à revoir">🕓</button>
        <span class="small">${badge}</span>
      </span>
    `;
    wordListDiv.appendChild(row);
  });

  // Bind buttons
  wordListDiv.querySelectorAll(".speakBtn").forEach(b=>{
    b.onclick = ()=> speak(b.dataset.word);
  });
  wordListDiv.querySelectorAll(".markOk").forEach(b=>{
    b.onclick = ()=>{
      const stats = loadStats();
      const w = b.dataset.word;
      const s = stats[w] || {ok:0,ko:0,streak:0};
      s.ok++; s.streak = Math.min(999,(s.streak||0)+1);
      stats[w]=s; saveStats(stats); renderList(); renderStats();
    };
  });
  wordListDiv.querySelectorAll(".markKo").forEach(b=>{
    b.onclick = ()=>{
      const stats = loadStats();
      const w = b.dataset.word;
      const s = stats[w] || {ok:0,ko:0,streak:0};
      s.ko++; s.streak = 0;
      stats[w]=s; saveStats(stats); renderList(); renderStats();
    };
  });

  // Pager
  pagerDiv.innerHTML = "";
  const prev = document.createElement("button");
  prev.textContent = "⬅️ Précédent";
  prev.disabled = STATE.page<=1;
  prev.onclick = ()=>{ STATE.page--; renderList(); };
  const info = document.createElement("span");
  info.textContent = `Page ${STATE.page} / ${totalPages}`;
  const next = document.createElement("button");
  next.textContent = "Suivant ➡️";
  next.disabled = STATE.page>=totalPages;
  next.onclick = ()=>{ STATE.page++; renderList(); };

  pagerDiv.append(prev, info, next);
}

// Search + page size
searchInput.oninput = ()=>{ STATE.search = searchInput.value.trim(); STATE.page = 1; renderList(); };
clearSearch.onclick = ()=>{ searchInput.value=""; STATE.search=""; STATE.page=1; renderList(); };
pageSizeSel.onchange = ()=>{ STATE.pageSize = parseInt(pageSizeSel.value,10); STATE.page = 1; renderList(); };

/* =========================
   Entraînement
   ========================= */
const playWordBtn   = document.getElementById("playWord");
const replayWordBtn = document.getElementById("replayWord");
const checkTrainBtn = document.getElementById("checkTrain");
const trainInput    = document.getElementById("trainInput");
const currentTarget = document.getElementById("currentTarget");
const trainResult   = document.getElementById("trainResult");
const trainPoolSel  = document.getElementById("trainPool");
const nextWordBtn   = document.getElementById("nextWord");

let lastSpoken = null;

function pickTrainWord(){
  const stats = loadStats();
  let pool = [];
  if(STATE.trainPool==="all"){
    pool = WORDS.slice();
  }else if(STATE.trainPool==="review"){
    pool = WORDS.filter(w=>{
      const s = stats[w]; return s && (s.ko>0 || (s.streak||0)<3);
    });
  }else if(STATE.trainPool==="mastered"){
    pool = WORDS.filter(w=>{
      const s = stats[w]; return s && (s.streak||0)>=3;
    });
  }
  if(pool.length===0) pool = WORDS.slice();
  const w = pool[Math.floor(Math.random()*pool.length)];
  STATE.trainTarget = w;
  currentTarget.innerHTML = `Mot ciblé : <i>${w.replace(/</g,"&lt;")}</i>`;
  lastSpoken = w;
  trainResult.textContent = "";
  trainInput.value = "";
}

playWordBtn.onclick = ()=>{ if(!STATE.trainTarget) pickTrainWord(); speak(STATE.trainTarget); };
replayWordBtn.onclick = ()=>{ if(lastSpoken) speak(lastSpoken); else if(STATE.trainTarget) speak(STATE.trainTarget); };
trainPoolSel.onchange = ()=>{ STATE.trainPool = trainPoolSel.value; pickTrainWord(); };
nextWordBtn.onclick = ()=> pickTrainWord();

checkTrainBtn.onclick = ()=>{
  if(!STATE.trainTarget){ pickTrainWord(); return; }
  const guess = (trainInput.value||"").trim();
  const target = STATE.trainTarget;
  if(!guess){ trainResult.textContent="Tape ta réponse."; trainResult.className="result"; return; }
  const good = guess.toLowerCase()===target.toLowerCase();
  const stats = loadStats();
  const s = stats[target] || {ok:0,ko:0,streak:0};
  if(good){ s.ok++; s.streak = Math.min(999, (s.streak||0)+1); }
  else { s.ko++; s.streak = 0; }
  stats[target]=s; saveStats(stats);
  trainResult.textContent = good ? "✅ Correct !" : `❌ Incorrect. Réponse : ${target}`;
  trainResult.className = "result " + (good?"good":"bad");
  pickTrainWord();
};

/* =========================
   Mini-concours
   ========================= */
const contestCountSel = document.getElementById("contestCount");
const startContestBtn = document.getElementById("startContest");
const contestZone     = document.getElementById("contestZone");
const contestPlayBtn  = document.getElementById("contestPlay");
const contestReplayBtn= document.getElementById("contestReplay");
const contestInput    = document.getElementById("contestInput");
const contestCheckBtn = document.getElementById("contestCheck");
const contestResult   = document.getElementById("contestResult");
const contestBar      = document.getElementById("contestBar");
const contestGoodEl   = document.getElementById("contestGood");
const contestBadEl    = document.getElementById("contestBad");
const contestProg     = document.getElementById("contestProgress");
const timerEl         = document.getElementById("timer");
const contestEndCard  = document.getElementById("contestEnd");
const finalScoreEl    = document.getElementById("finalScore");
const finalTotalEl    = document.getElementById("finalTotal");
const finalTimeEl     = document.getElementById("finalTime");
const retryContestBtn = document.getElementById("retryContest");

let timerInterval = null;

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function startTimer(){
  STATE.contest.start = Date.now();
  timerInterval = setInterval(()=>{
    STATE.contest.elapsed = Date.now() - STATE.contest.start;
    timerEl.textContent = fmtTime(STATE.contest.elapsed);
  }, 200);
}
function stopTimer(){
  clearInterval(timerInterval);
  timerInterval = null;
}

function startContest(){
  STATE.contest.total = parseInt(contestCountSel.value,10);
  STATE.contest.list = shuffle(WORDS).slice(0, STATE.contest.total);
  STATE.contest.index = 0; STATE.contest.good=0; STATE.contest.bad=0;
  contestGoodEl.textContent = "0";
  contestBadEl.textContent  = "0";
  contestBar.value = 0; contestBar.max = 100;
  contestZone.style.display = "block";
  contestEndCard.style.display = "none";
  STATE.contest.running = true;
  startTimer();
  showContestWord();
}
function showContestWord(){
  const idx = STATE.contest.index;
  contestProg.textContent = `${idx+1} / ${STATE.contest.total}`;
  const w = STATE.contest.list[idx];
  contestInput.value = "";
  contestResult.textContent = "";
  speak(w);
}
function endContest(){
  STATE.contest.running=false;
  stopTimer();
  contestZone.style.display = "none";
  finalScoreEl.textContent = STATE.contest.good;
  finalTotalEl.textContent = STATE.contest.total;
  finalTimeEl.textContent = fmtTime(STATE.contest.elapsed);
  contestEndCard.style.display = "block";
}
function checkContest(){
  const guess = (contestInput.value||"").trim();
  const w = STATE.contest.list[STATE.contest.index];
  if(!guess){ contestResult.textContent="Tape ta réponse."; contestResult.className="result"; return; }
  const good = guess.toLowerCase()===w.toLowerCase();
  const stats = loadStats();
  const s = stats[w] || {ok:0,ko:0,streak:0};
  if(good){ s.ok++; s.streak = Math.min(999,(s.streak||0)+1); STATE.contest.good++; }
  else { s.ko++; s.streak = 0; STATE.contest.bad++; }
  stats[w]=s; saveStats(stats);

  contestResult.textContent = good ? "✅ Correct !" : `❌ Incorrect. Réponse : ${w}`;
  contestResult.className = "result " + (good?"good":"bad");
  contestGoodEl.textContent = STATE.contest.good;
  contestBadEl.textContent  = STATE.contest.bad;

  STATE.contest.index++;
  contestBar.value = Math.floor((STATE.contest.index/STATE.contest.total)*100);

  if(STATE.contest.index>=STATE.contest.total){
    endContest();
  }else{
    showContestWord();
  }
}

startContestBtn.onclick = startContest;
contestPlayBtn.onclick  = ()=> speak(STATE.contest.list[STATE.contest.index]);
contestReplayBtn.onclick= ()=> speak(STATE.contest.list[STATE.contest.index]);
contestCheckBtn.onclick = checkContest;
retryContestBtn.onclick = startContest;

/* =========================
   Suivi des progrès
   ========================= */
const kpiRateEl = document.getElementById("kpiRate");
const kpiMasteredEl = document.getElementById("kpiMastered");
const kpiReviewEl = document.getElementById("kpiReview");
const statsTableBody = document.querySelector("#statsTable tbody");

function renderStats(){
  const stats = loadStats();
  let ok=0, ko=0, mastered=0, review=0;
  statsTableBody.innerHTML = "";

  WORDS.forEach(w=>{
    const s = stats[w] || {ok:0,ko:0,streak:0};
    ok += s.ok||0; ko += s.ko||0;
    const state = (s.streak||0)>=3 ? "Maîtrisé" : (s.ko>(s.ok||0) ? "À revoir" : "En cours");
    if(state==="Maîtrisé") mastered++;
    if(state==="À revoir") review++;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${w}</td>
      <td>${s.ok||0}</td>
      <td>${s.ko||0}</td>
      <td>${state}</td>
      <td>
        <button data-w="${w}" class="asOk">✅ +1</button>
        <button data-w="${w}" class="asKo">❌ +1</button>
        <button data-w="${w}" class="reset">♻️ reset</button>
      </td>
    `;
    statsTableBody.appendChild(tr);
  });

  const rate = (ok+ko) ? Math.round( (ok/(ok+ko))*100 ) : 0;
  kpiRateEl.textContent = rate+"%";
  kpiMasteredEl.textContent = mastered;
  kpiReviewEl.textContent = review;

  // bind row buttons
  statsTableBody.querySelectorAll(".asOk").forEach(b=>{
    b.onclick = ()=>{
      const w=b.dataset.w; const st=loadStats(); const s=st[w]||{ok:0,ko:0,streak:0};
      s.ok++; s.streak=Math.min(999,(s.streak||0)+1); st[w]=s; saveStats(st); renderStats(); renderList();
    };
  });
  statsTableBody.querySelectorAll(".asKo").forEach(b=>{
    b.onclick = ()=>{
      const w=b.dataset.w; const st=loadStats(); const s=st[w]||{ok:0,ko:0,streak:0};
      s.ko++; s.streak=0; st[w]=s; saveStats(st); renderStats(); renderList();
    };
  });
  statsTableBody.querySelectorAll(".reset").forEach(b=>{
    b.onclick = ()=>{
      const w=b.dataset.w; const st=loadStats(); delete st[w]; saveStats(st); renderStats(); renderList();
    };
  });
}

/* =========================
   Versets clés (demo + ajout)
   ========================= */
const verseList = document.getElementById("verseList");
const vRef = document.getElementById("vRef");
const vText = document.getElementById("vText");
const vWords = document.getElementById("vWords");
const addVerseBtn = document.getElementById("addVerse");
const VERSE_KEY = "epilation_verses_v1";

function loadVerses(){
  try{ return JSON.parse(localStorage.getItem(VERSE_KEY)) || []; }
  catch(e){ return []; }
}
function saveVerses(list){ localStorage.setItem(VERSE_KEY, JSON.stringify(list)); }

function defaultVerses(){
  if(loadVerses().length) return;
  saveVerses([
    {ref:"Genèse 1:1", text:"Au commencement, Dieu créa les cieux et la terre.", words:["Beréshit","Élohim","Terre"]},
    {ref:"Genèse 2:7", text:"L'Éternel forma l’homme de la glaise du sol.", words:["Glaise du sol"]},
    {ref:"Genèse 3:24", text:"Il posta des chérubins et la flamme du glaive.", words:["Glaive"]},
  ]);
}
function renderVerses(){
  verseList.innerHTML="";
  const list = loadVerses();
  list.forEach((v,i)=>{
    const box = document.createElement("div");
    box.className="verse";
    box.innerHTML = `
      <b>${v.ref}</b><br/>
      <span>${v.text}</span><br/>
      <span class="small">Mots : ${v.words.join(", ")}</span><br/>
      <div class="inline" style="margin-top:6px">
        ${v.words.map(w=>`<button class="cta ghost vSpeak" data-word="${w}">🔊 ${w}</button>`).join(" ")}
        <button class="cta" data-idx="${i}" onclick="removeVerse(${i})">🗑️ Supprimer</button>
      </div>
    `;
    verseList.appendChild(box);
  });
  verseList.querySelectorAll(".vSpeak").forEach(b=>{
    b.onclick = ()=> speak(b.dataset.word);
  });
}
function removeVerse(i){
  const list = loadVerses();
  list.splice(i,1);
  saveVerses(list);
  renderVerses();
}
addVerseBtn.onclick = ()=>{
  const ref = vRef.value.trim(), text=vText.value.trim();
  const words = vWords.value.split(",").map(s=>s.trim()).filter(Boolean);
  if(!ref || !text){ alert("Merci de remplir la référence et le texte."); return; }
  const list = loadVerses();
  list.push({ref,text,words});
  saveVerses(list);
  vRef.value=""; vText.value=""; vWords.value="";
  renderVerses();
}

/* =========================
   Tabs
   ========================= */
document.querySelectorAll(".tabBtn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tab").forEach(s=>s.style.display="none");
    document.getElementById(btn.dataset.tab).style.display="block";
    if(btn.dataset.tab==="stats") renderStats();
  };
});

/* =========================
   Init
   ========================= */
defaultVerses();
renderList();
renderVerses();

</script>
</body>
</html>